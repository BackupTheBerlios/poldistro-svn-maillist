<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Poldistro-svn] r359 - in trunk/096/pkg/mobiles: . oldAI oldAI/combat oldAI/main oldAI/setup
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/poldistro-svn/2005-October/index.html" >
   <LINK REL="made" HREF="mailto:poldistro-svn%40lists.berlios.de?Subject=Re%3A%20%5BPoldistro-svn%5D%20r359%20-%20in%20trunk/096/pkg/mobiles%3A%20.%20oldAI%20oldAI/combat%20oldAI/main%20oldAI/setup&In-Reply-To=%3C200510021039.j92AdxrO025050%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000336.html">
   <LINK REL="Next"  HREF="000337.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Poldistro-svn] r359 - in trunk/096/pkg/mobiles: . oldAI oldAI/combat oldAI/main oldAI/setup</H1>
    <B>Austin Heilman at BerliOS</B> 
    <A HREF="mailto:poldistro-svn%40lists.berlios.de?Subject=Re%3A%20%5BPoldistro-svn%5D%20r359%20-%20in%20trunk/096/pkg/mobiles%3A%20.%20oldAI%20oldAI/combat%20oldAI/main%20oldAI/setup&In-Reply-To=%3C200510021039.j92AdxrO025050%40sheep.berlios.de%3E"
       TITLE="[Poldistro-svn] r359 - in trunk/096/pkg/mobiles: . oldAI oldAI/combat oldAI/main oldAI/setup">austin at berlios.de
       </A><BR>
    <I>Sun Oct  2 12:39:59 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000336.html">[Poldistro-svn] r358 - in trunk/096/scripts: control misc
</A></li>
        <LI>Next message: <A HREF="000337.html">[Poldistro-svn] r360 - trunk/096/pkg/mobiles/oldAI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#359">[ date ]</a>
              <a href="thread.html#359">[ thread ]</a>
              <a href="subject.html#359">[ subject ]</a>
              <a href="author.html#359">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: austin
Date: 2005-10-02 12:39:25 +0200 (Sun, 02 Oct 2005)
New Revision: 359

Added:
   trunk/096/pkg/mobiles/oldAI/
   trunk/096/pkg/mobiles/oldAI/animal.src
   trunk/096/pkg/mobiles/oldAI/barber.src
   trunk/096/pkg/mobiles/oldAI/barker.src
   trunk/096/pkg/mobiles/oldAI/battleMage.src
   trunk/096/pkg/mobiles/oldAI/bladeSpirit.src
   trunk/096/pkg/mobiles/oldAI/bucsTownHealer.src
   trunk/096/pkg/mobiles/oldAI/cat.src
   trunk/096/pkg/mobiles/oldAI/chicken.src
   trunk/096/pkg/mobiles/oldAI/combat/
   trunk/096/pkg/mobiles/oldAI/combat/animalCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/bladeCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/bladeFight.inc
   trunk/096/pkg/mobiles/oldAI/combat/defaultCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/fight.inc
   trunk/096/pkg/mobiles/oldAI/combat/fireCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/healerCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/immobileFight.inc
   trunk/096/pkg/mobiles/oldAI/combat/packFight.inc
   trunk/096/pkg/mobiles/oldAI/combat/packFireCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/poisonCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/slimeCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/spellCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/spellFireEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/spiderCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/vortexCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/combat/warriorcombatevent.inc
   trunk/096/pkg/mobiles/oldAI/cow.src
   trunk/096/pkg/mobiles/oldAI/crier.src
   trunk/096/pkg/mobiles/oldAI/davesHealer.src
   trunk/096/pkg/mobiles/oldAI/dumbKillPCs.src
   trunk/096/pkg/mobiles/oldAI/employed.src
   trunk/096/pkg/mobiles/oldAI/entranced.src
   trunk/096/pkg/mobiles/oldAI/escortee.src
   trunk/096/pkg/mobiles/oldAI/firebreather.src
   trunk/096/pkg/mobiles/oldAI/goodCaster.src
   trunk/096/pkg/mobiles/oldAI/helpPCs.src
   trunk/096/pkg/mobiles/oldAI/immobile.src
   trunk/096/pkg/mobiles/oldAI/immobileSpell.src
   trunk/096/pkg/mobiles/oldAI/killAny.src
   trunk/096/pkg/mobiles/oldAI/killPCs.src
   trunk/096/pkg/mobiles/oldAI/main/
   trunk/096/pkg/mobiles/oldAI/main/closeDistance.inc
   trunk/096/pkg/mobiles/oldAI/main/defaultNonCombatEvent.inc
   trunk/096/pkg/mobiles/oldAI/main/killPCsLoop.inc
   trunk/096/pkg/mobiles/oldAI/main/loot.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoop.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopAnimal.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopBarker.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopBladeSpirit.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopCat.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopChicken.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopCow.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopCrier.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopGood.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopImmobile.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopKillAny.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopMeek.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopQuestie.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopSheep.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopSlime.inc
   trunk/096/pkg/mobiles/oldAI/main/mainLoopWolf.inc
   trunk/096/pkg/mobiles/oldAI/main/meanLoop.inc
   trunk/096/pkg/mobiles/oldAI/main/packKillPCsLoop.inc
   trunk/096/pkg/mobiles/oldAI/main/setup.inc
   trunk/096/pkg/mobiles/oldAI/main/sleepMode.inc
   trunk/096/pkg/mobiles/oldAI/main/sleepModeCow.inc
   trunk/096/pkg/mobiles/oldAI/main/sleepModeSheep.inc
   trunk/096/pkg/mobiles/oldAI/meek.src
   trunk/096/pkg/mobiles/oldAI/merchant.src
   trunk/096/pkg/mobiles/oldAI/packFirebreather.src
   trunk/096/pkg/mobiles/oldAI/person.src
   trunk/096/pkg/mobiles/oldAI/pirate.src
   trunk/096/pkg/mobiles/oldAI/pkg.cfg
   trunk/096/pkg/mobiles/oldAI/poisonElemental.src
   trunk/096/pkg/mobiles/oldAI/poisonKillPCs.src
   trunk/096/pkg/mobiles/oldAI/setup/
   trunk/096/pkg/mobiles/oldAI/setup/animalSetup.inc
   trunk/096/pkg/mobiles/oldAI/setup/archerSetup.inc
   trunk/096/pkg/mobiles/oldAI/setup/crierSetup.inc
   trunk/096/pkg/mobiles/oldAI/setup/killPCsSetup.inc
   trunk/096/pkg/mobiles/oldAI/setup/setup.inc
   trunk/096/pkg/mobiles/oldAI/setup/sheepSetup.inc
   trunk/096/pkg/mobiles/oldAI/setup/spellSetup.inc
   trunk/096/pkg/mobiles/oldAI/sheep.src
   trunk/096/pkg/mobiles/oldAI/slime.src
   trunk/096/pkg/mobiles/oldAI/spellFire.src
   trunk/096/pkg/mobiles/oldAI/spellKillPCs.src
   trunk/096/pkg/mobiles/oldAI/spiders.src
   trunk/096/pkg/mobiles/oldAI/tamed.src
   trunk/096/pkg/mobiles/oldAI/townGuard.src
   trunk/096/pkg/mobiles/oldAI/townHealer.src
   trunk/096/pkg/mobiles/oldAI/townPerson.src
   trunk/096/pkg/mobiles/oldAI/undead.src
   trunk/096/pkg/mobiles/oldAI/undeadKillPCs.src
   trunk/096/pkg/mobiles/oldAI/vortexAI.src
   trunk/096/pkg/mobiles/oldAI/wolf.src
   trunk/096/pkg/mobiles/oldAI/worker.src
Log:
scripts/AI being packaged

Added: trunk/096/pkg/mobiles/oldAI/animal.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/animal.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/animal.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,37 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopAnimal&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/animalSetup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile(&quot;npcdesc&quot;);
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+
+program KillPlayers()
+	SetWarMode(0);
+	main_AI_loop();
+endprogram
+
+function CloseDistance(opponent)
+	case (Distance(me, opponent))
+		1:
+		0: return 1;
+		default: WalkToward(opponent); return 0;
+	endcase
+endfunction
+

Added: trunk/096/pkg/mobiles/oldAI/barber.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/barber.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/barber.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,165 @@
+use npc;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;include/utility&quot;;
+include &quot;include/mrcSpawn&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;include/client&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/findCity&quot;;
+include &quot;include/dist&quot;;
+include &quot;:begging:begging&quot;;
+include &quot;include/attributes&quot;;
+include &quot;:npcutils:trainSkill&quot;;
+
+const MAX_SKILLS      := 48;
+
+var me := Self();
+me.hidden := 1;
+var inv_fs, inv_pb, inv_1c, inv_rs;
+var merchant_type := GetObjProperty(me,&quot;MerchantType&quot;);
+var equipt        := GetObjProperty(me, &quot;Equipt&quot;);
+var npccfg        := ReadConfigFile(&quot;npcdesc&quot;);
+
+set_priority(50);
+
+
+program barber()
+	if (!merchant_type) SetObjProperty(me, &quot;MerchantType&quot;, &quot;Mage&quot;);
+		merchant_type := &quot;Mage&quot;;
+	endif
+	start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+	var myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+	if (myanchor)
+		MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+	endif
+	drop_anchor();
+	myanchor     := GetObjProperty(me, &quot;Anchor&quot;);
+	var spawnname := merchant_type + &quot; &quot; + myanchor[1] + &quot; &quot; + myanchor[2] + &quot; &quot; + myanchor[3];
+	inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+	inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+	inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+	inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+	while ((!inv_rs) or(!inv_fs) or(!inv_pb) or(!inv_1c))
+		sleep(5);
+		inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+		inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+		inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+		inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+	endwhile
+	me.hidden := 0;
+	EnableEvents(SYSEVENT_ITEM_GIVEN);
+	DisableEvents(SYSEVENT_SPEECH);
+	if (GetObjProperty(me, &quot;frozen&quot;))
+		me.frozen := 1;
+	endif
+	var next_wander := ReadGameClock() + 10;
+	const loops := 0;
+	var ev;
+	while(1)
+	ev := os::wait_for_event(120);
+	if(ev)
+		case(ev.type)
+			EVID_NODE:
+				var txt := lower(ev.text);
+				if ((ev.source.cmdlevel &gt; 2) &amp;&amp; (txt[&quot;showinventory&quot;]))
+					SendOpenSpecialContainer(ev.source, inv_fs);
+				else
+					if (txt[&quot;buy&quot;])
+						TurnToward(ev.source);
+						var res := SendBuyWindow(ev.source, inv_fs, Self(), inv_pb);
+					elseif (txt[&quot;sell&quot;])
+						if (GetObjProperty(inv_rs, &quot;MyGold&quot;) &gt;= 1000)
+							TurnToward(ev.source);
+							var count := ModifyPCSellList(merchant_type, (ev.source).backpack);
+							if (count &gt;= 1)
+								var res := SendSellWindow(ev.source, Self(), inv_fs, inv_pb, inv_1c);
+							else
+								PrintTextAbovePrivate(Self(), &quot;You don't have anything I would be interested in.&quot;, ev.source);
+							endif
+						else
+							PrintTextAbovePrivate(Self(), &quot;I cannot afford any more of that.&quot;, ev.source );
+						endif
+					elseif ((txt[&quot;vendor train&quot;]) || (txt[&quot;vendor teach&quot;]) || (txt[&quot;merchant train&quot;]) || (txt[&quot;merchant teach&quot;]))
+						TurnToward(ev.source);
+						MerchantTrain(me, ev.source, ev.text);
+					endif
+				endif
+			SYSEVENT_MERCHANT_BOUGHT:
+				TurnToward(ev.source);
+				PrintTextAbovePrivate(me, &quot;The total of thy sale is &quot; + ev.amount + &quot;.&quot;, ev.source);
+				if (lower(merchant_type) != &quot;appraiser&quot;)
+					var mygold := GetObjProperty(inv_rs, &quot;MyGold&quot;);
+					mygold := mygold - ev.amount;
+					SetObjProperty(inv_rs, &quot;MyGold&quot;, mygold);
+				endif
+				foreach thing in EnumerateItemsInContainer(inv_pb)
+                                    if(MoveItemToContainer(thing, inv_fs))
+                                      SetObjProperty(thing,&quot;ClearRestock&quot;, (ReadGameClock() + 1800));
+                                      thing.buyprice  := itemconfig[thing.objtype].VendorBuysFor;
+                                      thing.sellprice := itemconfig[thing.objtype].VendorSellsFor;
+                                    else
+                                      DestroyItem(thing);
+                                    endif
+                                  endforeach
+                                  PlaySoundEffect(me, 0x38);
+        SYSEVENT_MERCHANT_SOLD:   TurnToward(ev.source);
+                                  PrintTextAbovePrivate(me, &quot;The total of thy purchase is &quot; + ev.amount + &quot;.&quot;, ev.source);
+                                  var mygold := GetObjProperty(inv_rs, &quot;MyGold&quot;);
+                                  mygold := mygold + ev.amount;
+                                  SetObjProperty(inv_rs, &quot;MyGold&quot;, mygold);
+                                  foreach item in EnumerateItemsInContainer( ev.source.backpack)
+                                    EraseObjProperty(item, &quot;ClearRestock&quot;);
+                                    var hairwhere := GetObjProperty(item, &quot;faceloc&quot;);
+                                    if(hairwhere)
+                                      if(hairwhere == 11)
+                                        EraseObjProperty(item, &quot;faceloc&quot;);
+                                        DestroyItem(GetEquipmentByLayer(ev.source, 0x0b));
+                                        EquipItem(ev.source, item);
+                                      elseif(hairwhere == 16)
+                                        EraseObjProperty(item, &quot;faceloc&quot;);
+                                        DestroyItem(GetEquipmentByLayer(ev.source, 0x10));
+                                        if(ev.source.graphic == 0x191)
+                                          say(&quot;Silly woman, thou canst not grow a beard!&quot;);
+                                          DestroyItem(item);
+                                        else
+                                          EquipItem(ev.source, item);
+                                        endif
+                                      endif
+                                    endif
+                                  endforeach
+                                  PlaySoundEffect(me, 0x38);
+			endcase
+		endif
+		if(ReadGameClock() &gt;= next_wander)
+			begpurse(me);
+			wander();
+			if(coordist(me.x, me.y, myanchor[1], myanchor[2]) &gt; 5)
+				MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+			endif
+			next_wander := ReadGameClock() +(RandomInt(9) + 21);
+		endif
+	endwhile
+endprogram
+
+
+function Lookiehere(who, npc)
+	var ev;
+	ev := array;
+	ev.+ type;
+	ev.+ source;
+	ev.type := SYSEVENT_SPEECH;
+	ev.text := &quot;node&quot;;
+	ev.source := npc;
+	foreach thing in ListItemsNearLocationOfType(who.x, who.y, who.z, 15, 0x887b, who.realm)
+		SendEvent(thing, ev);
+	endforeach
+
+	return;
+endfunction
+

Added: trunk/096/pkg/mobiles/oldAI/barker.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/barker.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/barker.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,37 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopBarker&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/animalSetup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;:npcutils:vetement&quot;;
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/battleMage.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/battleMage.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/battleMage.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,288 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/client&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;include/skillLists&quot;;
+include &quot;:poisonwatcher:poisons&quot;;
+
+var flee_point := 0;
+var npccfg := ReadConfigFile(&quot;::npcdesc&quot;);
+
+const HALT_THRESHOLD := 10;
+var me := Self();
+var cfgfile     := ReadConfigFile(&quot;::gzone&quot;);
+var keys        := GetConfigStringKeys(cfgfile);
+var nextchk     := ReadGameClock() + 120;
+
+program CastleGuard()
+  SetObjProperty(me, &quot;MerchantType&quot;, &quot;BattleMage&quot;);
+  me.concealed := 1;
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+  var myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  if(myanchor)
+    MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+  endif
+  drop_anchor();
+  myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  EnableEvents(SYSEVENT_ENGAGED);
+  EnableEvents(EVID_NODE);
+  SetWarMode(0);
+  set_priority(100);
+  var ev;
+  var evtext;
+  var next_wander := ReadGameClock() + 10;
+  var wanders := 9;
+  var txt;
+  var ph := SplitWords(me.name);
+  var myname := lower(ph[1]);
+  while (1)
+    ev := os::wait_for_event(120);
+	if (ev)
+      case(ev.type)
+        EVID_NODE:           foreach thing in (ev.crims)
+                               Fight(thing);
+                             endforeach
+        SYSEVENT_ENGAGED:    if((ev.source) &amp;&amp; (!ev.source.dead))
+		                       say(&quot;Thou wilt regret thine actions, swine!&quot;);
+                               Fight(ev.source);
+                             endif
+        SYSEVENT_DAMAGED:    if((ev.source) &amp;&amp; (!ev.source.dead))
+		                       say(&quot;Thou wilt regret thine actions, swine!&quot;);
+                               Fight(ev.source);
+                             endif
+      endcase
+	endif
+	if(ReadGameClock() &gt;= next_wander)
+      if(coordist(me.x, me.y, myanchor[1], myanchor[2]) &gt; 15)
+        MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+      endif
+      next_wander := ReadGameClock() + 10;
+    endif
+    if(ReadGameClock() &gt; nextchk)
+      lookiehere();
+      nextchk := ReadGameClock() + 120;
+    endif
+  endwhile
+endprogram
+
+function WanderMe()
+  wander();
+  if(coordist(me.x, me.y, myanchor[1], myanchor[2]) &gt; 15)
+    MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+  endif
+endfunction
+
+function lookiehere()
+  foreach npc in ListMobilesNearLocation(me.x, me.y, me.z, 15, me.realm)
+    foreach listing in keys
+      var range := SplitWords(cfgfile[listing].range);  //check to see if npc is in guard zone, and act accordingly
+      if((npc.x &gt;= CInt(range[1])) &amp;&amp; (npc.x &lt;= CInt(range[3])) &amp;&amp; (npc.y &gt;= CInt(range[2])) &amp;&amp; (npc.y &lt;= CInt(range[4])))
+        var timer := Cint(GetObjProperty(npc, &quot;guardstimer&quot;));
+      	if((npc.criminal) and (!npc.dead))
+          if(timer &lt; ReadGameClock())
+            SetObjProperty(npc, &quot;#guardstimer&quot;, ReadGameClock() + 15);
+      	    Fight(npc);
+          endif
+      	elseif(((npc.script == &quot;tamed&quot;) || (npc.script == &quot;employed&quot;)) and (npc.criminal))
+          if(timer &lt; ReadGameClock())
+            SetObjProperty(npc, &quot;#guardstimer&quot;, ReadGameClock() + 15);
+      	    Fight(npc);
+          endif
+        elseif((!npccfg[npc.npctemplate].guardignore) and (npc.isA(POLCLASS_NPC)))
+          if(timer &lt; ReadGameClock())
+            SetObjProperty(npc, &quot;#guardstimer&quot;, ReadGameClock() + 15);
+      	    Fight(npc);
+          endif
+        endif
+        break;
+      endif
+    endforeach
+  endforeach
+endfunction
+
+function Fight(opponent)
+  SetAnchor( me.x, me.y, 20, 0 );
+  if(opponent.isA(POLCLASS_NPC))
+	SetObjProperty(opponent, &quot;guardkill&quot;, 1);
+  endif
+  if((opponent.cmdlevel &gt; 0) || (opponent.serial == me.serial))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  if(opponent.multi.serial)
+	if(me.multi.serial != opponent.multi.serial)
+      SetWarMode(0);
+      opponent := 0;
+	  return;
+	endif
+  endif
+  var parms := {};
+  parms[1] := me.x;
+  parms[2] := me.y;
+  parms[3] := me.z;
+  SetObjProperty(me, &quot;StartCoords&quot;, parms);
+  var tries := 0;
+  while(((Distance(me, opponent) &gt; 7) || (!CheckLineOfSight(me, opponent))) and (tries &lt; 5))
+    var newx := opponent.x + RandomInt(4) - RandomInt(4);
+    var newy := opponent.y + RandomInt(4) - RandomInt(4);
+    sleepms(500);
+    MoveCharacterToLocation(me, newx, newy, opponent.z, MOVECHAR_FORCELOCATION);
+    tries := tries + 1;
+  endwhile
+  var gate := CreateItemAtLocation(me.x, me.y, me.z, 0xdda, 1, me.realm);
+  PlaySoundEffect(gate, 0x20f);
+  sleepms(200);
+  me.concealed := 0;
+  sleepms(200);
+  DestroyItem(gate);
+  PrintTextAbove(me, &quot;Thou wilt regret thine actions, swine!&quot;);
+  TurnToward(opponent);
+  PerformAction(me, 17);
+  opponent.frozen := 1;
+  sleep(1);
+  PlaySoundEffect(opponent, 0x2a);
+  PlayLightningBoltEffect(opponent);
+  sleepms(100);
+  PlayLightningBoltEffect(opponent);
+  sleepms(100);
+  PlayLightningBoltEffect(opponent);
+  sleepms(100);
+  PlayLightningBoltEffect(opponent);
+  sleepms(100);
+  ApplyRawDamage(opponent, GetHp(opponent) + 10);
+  sleep(1);
+  PerformAction(me, 17);
+  sleepms(200);
+  gate := CreateItemAtLocation(me.x, me.y, me.z, 0xdda, 1, me.realm);
+  PlaySoundEffect(gate, 0x20f);
+  sleepms(200);
+  me.concealed := 1;
+  sleep(1);
+  DestroyItem(gate);
+  var oldprio := set_priority(50);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  post_combat();
+  return;
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode(0);
+  SetOpponent(0);
+  lookiehere();
+  var allpoisons := GetAllPoisons(me);
+  if(allpoisons.size() &gt; 0)
+    sleep(1);
+    PerformAction(me, 0x22);
+    foreach poison in allpoisons
+      CureSpecific(me, poison, -1);
+    endforeach
+    PlaySoundEffect(me, 0x31);
+    sleep(1);
+  endif
+  if(GetHp(me) &lt; GetStrength(me))
+    sleep(1);
+    PerformAction(me, 0x22);
+    SetHp(me, me.strength);
+    PlaySoundEffect(me, 0x32);
+    sleep(1);
+  endif
+  lookiehere();
+  sleep(1);
+  RestartScript(me);
+endfunction
+
+function CloseDistance( opponent )
+  case Distance( me, opponent )
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function CheckForCriminals(jerk)
+  if(jerk.dead)
+	return;
+  endif
+  if(jerk.criminal)
+	say(&quot;Thou wilt regret thine actions, swine!&quot;);
+	Fight(jerk);
+  endif
+endfunction
+
+function cleareventque()
+  var ev;
+  repeat
+  until(!(ev := os::wait_for_event(0)));
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function EnableMainEvents()
+    cleareventque();
+    DisableEvents(SYSEVENT_DISENGAGED);
+    EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED);
+    EnableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function DisableMainEvents()
+    cleareventque();
+    DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED );
+    DisableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function EnableCombatEvents()
+    EnableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function DisableCombatEvents()
+    DisableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  if(GetObjProperty(me, &quot;poison_level&quot;))
+    sleep(1);
+    PerformAction(me, 0x22);
+    EraseObjProperty(me, &quot;poison_level&quot;);
+    PlaySoundEffect(me, 0x31);
+    sleep(1);
+  endif
+  if(GetHp(me) &lt; (GetStrength(me) / 2))
+    sleep(1);
+    PerformAction(me, 0x22);
+    SetHp(me, me.strength);
+    PlaySoundEffect(me, 0x32);
+    sleep(1);
+  endif
+  if(loops &gt; 50)
+	RestartScript(me);
+	return;
+  endif
+endfunction
+
+function GoldForSkillGain( npc_skill, pc_skill, skillid )
+  var maxskill := npc_skill - pc_skill;
+  return maxskill*10;
+endfunction
+
+function SkillGainForGold(npc_level, pc_level, trainskillid, goldreceived)
+  return (goldreceived/10) + pc_level;
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/bladeSpirit.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/bladeSpirit.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/bladeSpirit.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,231 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;ai/main/setup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;:npcutils:animal&quot;;
+
+
+const HALT_THRESHOLD := 10;
+var npccfgfile := ReadConfigFile(&quot;npcdesc&quot;);
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+var masterserial := GetObjProperty(me, &quot;master&quot;);
+
+program KillPlayers()
+  var master;
+  foreach char in EnumerateOnlineCharacters()
+    if(char.serial == masterserial)
+      master := char;
+      break;
+    endif
+  endforeach
+  if(!master)
+    master := SystemFindObjectBySerial(CInt(masterserial), SYSFIND_SEARCH_OFFLINE_MOBILES);
+  endif
+  SetScriptController( master );
+  drop_anchor();
+  EnableEvents(SYSEVENT_ENGAGED);
+  EnableEvents(SYSEVENT_DISENGAGED);
+  EnableEvents(SYSEVENT_DAMAGED);
+  EnableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, HALT_THRESHOLD);
+  EnableEvents(SYSEVENT_OPPONENT_MOVED);
+  SetWarMode(0);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  main_AI_loop();
+endprogram
+
+function main_AI_loop()
+  var ev;
+  var wanders := 0;
+  EnableMainEvents();
+  look_around();
+  while (1)
+    ev := os::wait_for_event(5);
+	if(wanders &gt; 60)
+	  wanders :=0;
+	  ev := sleepmode();
+	endif
+	if(ev)
+	  repeat
+	    case(ev.type)
+          SYSEVENT_ENTEREDAREA:
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED:     Fight(ev.source);
+	    endcase
+      until (! (ev := os::wait_for_event(1)) );
+    endif
+    look_around();
+    wander();
+	wanders := wanders +1;
+  endwhile
+endfunction
+
+function process_noncombat_event(ev)
+  case (ev.type)
+    default: return;
+  endcase
+endfunction
+
+function Fight(opponent)
+  if((opponent.cmdlevel &gt; 0) || (opponent == me))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  var oldprio := set_priority(50);
+  SetOpponent(opponent);
+  prepare_for_fight(opponent);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while((opponent) &amp;&amp; not (opponent.dead || opponent.hidden || opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20) )
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 2;
+	endif
+	in_combat_event_loop(opponent, loops);
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED:
+	  SYSEVENT_ENGAGED: if(ev.source)
+			              if(RandomInt(6)==1)
+					        opponent := ev.source;
+			  		        SetOpponent(opponent);
+					        TurnToward(opponent);
+			              endif
+			            endif
+      EVID_PEACEMADE:   SetWarMode(0);
+			            SetOpponent(0);
+			            sleep(1);
+                        look_around();
+			            return;
+	endcase
+  endwhile
+  post_combat();
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  if(Distance(me,opponent) &lt; 2)
+    var dmg := RandomInt(CInt(GetStrength(opponent) / 25));
+    dmg := dmg * 2;
+    if(dmg &gt; 24)
+      dmg := 12;
+    elseif(dmg &lt; 2)
+      dmg := 2;
+    endif
+	ApplyRawDamage(opponent, RandomInt(dmg));
+  endif
+endfunction
+
+function CloseDistance(opponent)
+  case (Distance(me, opponent))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+		     sleepms(100);
+             return 0;
+  endcase
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  sleep(1);
+  look_around();
+endfunction
+
+function EnableMainEvents()
+  DisableEvents( SYSEVENT_SPEECH + EVID_LEFTAREA + EVID_DISENGAGED + EVID_OPPONENT_MOVED );
+  EnableEvents( EVID_ENGAGED + EVID_DAMAGED + EVID_ENTEREDAREA, HALT_THRESHOLD );
+endfunction
+
+function DisableMainEvents()
+  DisableEvents( EVID_ENGAGED + EVID_DAMAGED + EVID_ENTEREDAREA);
+endfunction
+
+function EnableCombatEvents()
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function DisableCombatEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function look_around()
+  var him, dista;
+  var dis := 20;
+  foreach critter in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    dista := Distance(me, critter);
+    if(dista &lt; dis)
+      if((critter.npctemplate != &quot;bladespirit&quot;) &amp;&amp; (critter.npctemplate != &quot;vortex&quot;))
+        him := critter;
+        dis := dista;
+      endif
+    endif
+  endforeach
+  if(him)
+    Fight(him);
+  endif
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/bucsTownHealer.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/bucsTownHealer.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/bucsTownHealer.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,219 @@
+use npc;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;include/utility&quot;;
+include &quot;include/mrcSpawn&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;include/client&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;include/findCity&quot;;
+include &quot;:begging:begging&quot;;
+include &quot;:npcutils:trainSkill&quot;;
+
+const SOUND_EFFECT_RES := 0x215;
+const ACTION_EFFECT_CAST2 := 0x11;
+const MAX_SKILLS      := 48;
+
+var me := Self();
+me.hidden := 1;
+var inv_fs, inv_pb, inv_1c, inv_rs;
+var merchant_type := GetObjProperty(me, &quot;MerchantType&quot;);
+var npccfg        := ReadConfigFile(&quot;npcdesc&quot;);
+
+set_priority(50);
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+  if(!merchant_type)
+    SetObjProperty(me, &quot;MerchantGroup&quot;, &quot;Mage&quot;);
+    merchant_type := &quot;Mage&quot;;
+  endif
+  var myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  if(myanchor)
+    MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+  endif
+  drop_anchor();
+  myanchor     := GetObjProperty(me, &quot;Anchor&quot;);
+  var spawnname := merchant_type + &quot; &quot; + myanchor[1] + &quot; &quot; + myanchor[2] + &quot; &quot; + myanchor[3];
+  inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+  inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+  inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+  inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+  while((!inv_rs) or (!inv_fs) or (!inv_pb) or (!inv_1c))
+    sleep(5);
+    inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+    inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+    inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+    inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+  endwhile
+  me.hidden := 0;
+  EnableEvents( SYSEVENT_ITEM_GIVEN);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED);
+  EnableEvents(SYSEVENT_ENTEREDAREA, 3);
+  DisableEvents(SYSEVENT_SPEECH);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+    me.frozen := 1;
+  endif
+  if(!GetObjProperty(me, &quot;MyGold&quot;))
+    SetObjProperty(me, &quot;MyGold&quot;, 1000);
+  endif
+  var next_wander := ReadGameClock() + 10;
+  const loops := 0;
+  while (1)
+    var ev;
+    ev := os::wait_for_event(120);
+    if(ev)
+      case (ev.type)
+        SYSEVENT_ENGAGED:         if((ev.source) &amp;&amp; (!(ev.source).dead))
+                                    Lookiehere(me);
+                                  endif
+        SYSEVENT_DAMAGED:         if((ev.source) &amp;&amp; (!(ev.source).dead))
+                                    Lookiehere(me);
+                                  endif
+        EVID_NODE:                if((ev.source.cmdlevel &gt; 2) &amp;&amp; (ev.text[&quot;showinventory&quot;]))
+                                    SendOpenSpecialContainer(ev.source, inv_fs);
+                                  elseif((ev.source.cmdlevel &gt; 2) &amp;&amp; (ev.text[&quot;unloadcfg&quot;]))
+                                    UnloadConfigFile(&quot;::mrcspawn&quot;);
+                                  else
+                                    if(ev.text[&quot;buy&quot;])
+                                      TurnToward(ev.source);
+                                      var res := SendBuyWindow(ev.source, inv_fs, Self(), inv_pb);
+                                      foreach thing in ListRootItemsInContainer((ev.source).backpack)
+                                        EraseObjProperty(thing, &quot;ClearRestock&quot;);
+                                      endforeach
+                                    elseif (ev.text[&quot;sell&quot;])
+                                      if(GetObjProperty(me, &quot;MyGold&quot;) &gt;= 1000)
+                                        TurnToward(ev.source);
+                                        ModifyPCSellList(merchant_type, (ev.source).backpack);
+                                        var res := SendSellWindow(ev.source, Self(), inv_fs, inv_pb, inv_1c);
+                                        if(res)
+                                          PrintTextAbovePrivate(Self(), &quot;You don't have anything I would be interested in.&quot;, ev.source);
+                                        else
+                                          print(&quot;SendSellWindow failed: &quot; + res.errortext);
+                                        endif
+                                      else
+                                        PrintTextAbovePrivate(Self(), &quot;I cannot afford any more of that.&quot;, ev.source );
+                                      endif
+                                    elseif(ev.text[&quot;vendor train&quot;] || ev.text[&quot;vendor teach&quot;] || ev.text[&quot;merchant train&quot;])
+                                      TurnToward(ev.source);
+                                      MerchantTrain(me, ev.source, ev.text);
+                                    endif
+                                  endif
+        SYSEVENT_MERCHANT_BOUGHT: TurnToward(ev.source);
+                                  PrintTextAbovePrivate(Self(), &quot;The total of thy sale is &quot; + ev.amount +&quot;.&quot;, ev.source);
+                                  var mygold := GetObjProperty(me, &quot;MyGold&quot;);
+                                  mygold := mygold - ev.amount;
+                                  SetObjProperty(me, &quot;MyGold&quot;, mygold);
+                                  foreach item in EnumerateItemsInContainer(inv_pb)
+                                    MoveItemToContainer(item, inv_fs);
+                                    SetObjProperty(item,&quot;ClearRestock&quot;, (ReadGameClock() + 1800));
+                                    item.buyprice  := itemconfig[item.objtype].VendorBuysFor;
+                                    item.sellprice := itemconfig[item.objtype].VendorSellsFor;
+                                  endforeach
+                                  PlaySoundEffect(me, 0x38);
+        SYSEVENT_MERCHANT_SOLD:   TurnToward(ev.source);
+                                  PrintTextAbovePrivate(Self(), &quot;The total of thy purchase is &quot; + ev.amount +&quot;.&quot;, ev.source );
+                                  var mygold := GetObjProperty(me, &quot;MyGold&quot;);
+                                  mygold := mygold + ev.amount;
+                                  SetObjProperty(me, &quot;MyGold&quot;, mygold);
+                                  PlaySoundEffect(me, 0x38);
+        SYSEVENT_ITEM_GIVEN:      TrainSkill(me, ev.source, ev.item);
+        SYSEVENT_ENTEREDAREA:     if(!ev.source.isA(POLCLASS_NPC))
+                                    HealerStuff(ev.source);
+                                  endif
+      endcase
+    endif
+	if(ReadGameClock() &gt;= next_wander)
+	  begpurse(me);
+      wander();
+      if(coordist(me.x, me.y, myanchor[1], myanchor[2]) &gt; 5)
+        MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+      endif
+      next_wander := ReadGameClock() + 30;
+    endif
+  endwhile
+
+function HealerStuff(mobile)
+  var parms := {me, mobile};
+  start_script(&quot;doRes&quot;, parms);
+  return;
+endfunction
+
+function Lookiehere(who)
+  var mobiles := ListMobilesNearLocation(who.x, who.y, who.z, 15, who.realm);
+  var guard, num, i, hogcall, guardzone, element, range, timer, elem;
+  var cfgfile := ReadConfigFile(&quot;::gzone&quot;);
+  var entries := GetConfigStringKeys(cfgfile);
+  foreach listing in entries
+    element :=  cfgfile[listing];
+    range := element.range;
+    range := SplitWords(range);
+    if((who.x &gt;= CInt(range[1])) &amp;&amp; (who.x &lt;= CInt(range[3])) &amp;&amp; (who.y &gt;= CInt(range[2])) &amp;&amp; (who.y &lt;= CInt(range[4])))
+      guardzone := 1;
+      break;
+    endif
+  endforeach
+  foreach npc in mobiles
+	if(!npc.acctname)
+	  elem := FindConfigElem(npccfg, npc.npctemplate);
+	  if(!elem.guardignore &amp;&amp; !GetObjProperty(npc, &quot;called&quot;));
+		if(npc.script != &quot;tamed&quot;)
+          case(RandomInt(4) + 1)
+            1: hogcall := &quot;Guards! They're killing people here!&quot;;
+            2: hogcall := &quot;Guards! I pay my taxes and no guards? Guards!&quot;;
+            3: hogcall := &quot;Help! They're dying here! Guards!&quot;;
+            4: hogcall := &quot;Guards! Come save us quick!&quot;;
+            5: hogcall := &quot;Ah! Help us! Guards!&quot;;
+          endcase
+          PrintTextAbove(me, hogcall);
+          if(guardzone == 1)
+		    SetObjProperty(npc, &quot;called&quot;, 1);
+            num := RandomInt(4) + 1;
+            var count := 0;
+            foreach mobile in ListMobilesNearLocation(me.x, me.y, me.z, 25, me.realm)
+              if(count == 3)
+                break;
+              else
+		        if(mobile.npctemplate == &quot;townguard&quot;)
+		          var ev := array;
+                  ev.+ type;
+                  ev.+ source;
+                  ev.type := EVID_PEACEMADE;
+                  ev.source := npc;
+                  SendEvent(mobile, ev);
+                  ev.type := SYSEVENT_ENGAGED;
+                  SendEvent(mobile, ev);
+                  count := count + 1;
+                endif
+              endif
+            endforeach
+          endif
+		endif
+	  endif
+    else
+	  timer := GetObjProperty(npc, &quot;guardstimer&quot;);
+	  if(npc.criminal &amp;&amp; (timer &lt; ReadGameClock() || timer.errortext))
+        foreach mobile in ListMobilesNearLocation(me.x, me.y, me.z, 15, me.realm)
+		  if(mobile.npctemplate == &quot;townguard&quot;)
+		    var ev := array;
+            ev.+ type;
+            ev.+ source;
+            ev.type := EVID_PEACEMADE;
+            ev.source := npc;
+            SendEvent(mobile, ev);
+            ev.type := SYSEVENT_ENGAGED;
+            SendEvent(mobile, ev);
+            SetObjProperty(npc, &quot;guardkill&quot;, 1);
+          endif
+        endforeach
+        SetObjProperty(npc, &quot;guardstimer&quot;, ReadGameClock()+60);
+	  endif
+	endif
+  endforeach
+  sleep(1);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/cat.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/cat.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/cat.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,37 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopCat&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/animalSetup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;:npcutils:vetement&quot;;
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/chicken.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/chicken.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/chicken.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,37 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopChicken&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/animalSetup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;:npcutils:vetement&quot;;
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case Distance( me, opponent )
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/animalCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/animalCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/animalCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,32 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+  if ((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+    EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  return 0;
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  if ( loops &gt; 50 )
+    flee(opponent);
+    return;
+  endif
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  sleep(1);
+  look_around();
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/bladeCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/bladeCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/bladeCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,19 @@
+function in_combat_event_loop(opponent, loops)
+  if(loops &gt; 50)
+	RestartScript(me);
+  endif
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  sleep(1);
+  look_around();
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/bladeFight.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/bladeFight.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/bladeFight.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,51 @@
+function Fight(opponent)
+  if((opponent.cmdlevel &gt; 0) || (opponent == me))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  var oldprio := set_priority(50);
+  SetOpponent(opponent);
+  prepare_for_fight(opponent);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while((opponent) &amp;&amp; not (opponent.dead || opponent.hidden || opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20) )
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	in_combat_event_loop(opponent, loops);
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED:
+	  SYSEVENT_ENGAGED:   if(ev.source)
+			            if(RandomInt(6)==1)
+				          if((!ev.source.npctemplate) || (ev.source.script == &quot;tamed&quot;) || (ev.source.script == &quot;employed&quot;))
+					        opponent := ev.source;
+			  		        SetOpponent(opponent);
+					        TurnToward(opponent);
+				          endif
+			            endif
+			          endif
+      EVID_PEACEMADE: SetWarMode(0);
+			          SetOpponent(0);
+			          sleep(1);
+			          DisableCombatEvents();
+			          EnableMainEvents();
+			          return;
+	endcase
+  endwhile
+  post_combat();
+endfunction
+
+function EnableCombatEvents()
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function DisableCombatEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/defaultCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/defaultCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/defaultCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,36 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+  if((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+	EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  opponent := opponent; // stops ecompile complaining that it's not used
+  return 0;
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  if(loops &gt; 50)
+    if((dist(me, opponent) &gt; 12) &amp;&amp; (!CheckLineOfSight(me, opponent)))
+	  RestartScript(me);
+	  return;
+    endif
+  endif
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode(0);
+  SetOpponent(0);
+  sleep(1);
+  look_around();
+endfunction
+
+function prepare_for_fight(opponent)
+  opponent := opponent; // stops ecompile complaining that it's not used
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/fight.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/fight.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/fight.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,101 @@
+function Fight(opponent)
+  if((opponent.cmdlevel &gt; 0) || (opponent.serial == me.serial))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  /*var oldprio :=*/ set_priority(50); // 'oldprio' unnecessary unless we're going to restore it
+  SetOpponent(opponent);
+  prepare_for_fight(opponent);
+  TurnToward(opponent);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while((opponent) &amp;&amp; (!opponent.dead) &amp;&amp; (!opponent.hidden) &amp;&amp; (!opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20))
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	ev := wait_for_event(waittime);
+	process_combat_event(opponent);
+	if(ev.type != SYSEVENT_SPEECH)
+	  case (ev.type)
+        SYSEVENT_DAMAGED: if((ev.source.npctemplate) and (CheckLineOfSight(me, ev.source)))
+                            opponent := ev.source;
+			  		        SetOpponent(opponent);
+					        TurnToward(opponent);
+                          elseif((dist(me, ev.source) &lt; dist(me, opponent)) || (!CheckLineOfSight(me, opponent)) || (!opponent))
+					        opponent := ev.source;
+			  		        SetOpponent(opponent);
+					        TurnToward(opponent);
+                          elseif(RandomInt(3)==1)
+					        opponent := ev.source;
+			  		        SetOpponent(opponent);
+					        TurnToward(opponent);
+			              endif
+	    SYSEVENT_ENGAGED: if(ev.source)
+			                if(RandomInt(6) == 1)
+					          opponent := ev.source;
+			  		          SetOpponent(opponent);
+					          TurnToward(opponent);
+			                endif
+			              endif
+        EVID_PEACEMADE:   SetWarMode(0);
+			              SetOpponent(0);
+			              sleep(1);
+			              DisableCombatEvents();
+			              EnableMainEvents();
+			              return;
+        EVID_HERDING:     Herding(ev);
+	  endcase
+	endif
+  endwhile
+  post_combat();
+endfunction
+
+function EnableCombatEvents()
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+  DisableEvents(SYSEVENT_SPEECH);
+endfunction
+
+function DisableCombatEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function flee(opponent)
+  if((me.script == &quot;immobile&quot;) || (me.script == &quot;immobilespell&quot;))
+	sleep(2);
+	return;
+  else
+    var numflees := GetObjProperty(me,&quot;#flees&quot;);
+	if(numflees &gt; 10)
+      RestartScript(me);
+	else
+	  numflees := numflees + 1;
+	endif
+    SetObjProperty(me,&quot;#flees&quot;, numflees);
+    var runs := 0;
+    var chk := 0;
+    var ev;
+    while((Distance(me, opponent) &lt; 15) &amp;&amp; (runs &lt; 50) &amp;&amp; (CheckLineOfSight(me, opponent)))
+      ev := wait_for_event(1);
+      chk := process_flee_event(opponent);
+	  WalkAwayFrom(opponent);
+	  runs := runs +1;
+	  case (ev.type)
+        SYSEVENT_DAMAGED: if(((ev.source.npctemplate) and (CheckLineOfSight(me, ev.source))) ||(dist(me, ev.source) &lt; dist(me, opponent)) || (!CheckLineOfSight(me, opponent)) || (!opponent) || (RandomInt(3)==1))
+					        opponent := ev.source;
+			  		        SetOpponent(opponent);
+			              endif
+        EVID_PEACEMADE:   chk := 1;
+        EVID_HERDING:     Herding(ev);
+	  endcase
+	  if(chk)
+	    break;
+	  endif
+    endwhile
+  endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/fireCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/fireCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/fireCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,49 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+  if((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+    EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  return 0;
+endfunction
+
+function spellattack(opponent);
+  if(RandomInt(4) != 1)
+    return;
+  endif
+  if(CheckLineOfSight(me, opponent) &amp;&amp; (dist(me, opponent) &lt; 10))
+    PerformAction(me,0x0c);
+    sleep(1);
+    PlaySoundEffect(me, 0x16b);
+    sleep(1);    
+    var base := Cint(((FLAME_STRENGTH * GetHp(me)) / GetMaxHp(me)) / 2);
+    var dmg :=  RandomInt(base) + base;
+    PlayMovingEffect(me, opponent, 0x36d4, 10, 1, 1);
+    ApplyRawDamage(opponent, dmg);
+  endif
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  spellattack(opponent);
+  if(loops &gt; 50)
+    flee(opponent);
+    return;
+  endif
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  sleep(1);
+  look_around();
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/combat/healerCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/healerCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/healerCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,74 @@
+include &quot;include/attributes&quot;;
+include &quot;include/poisons&quot;;
+
+function process_combat_event(opponent)
+  spellattack(opponent);
+  if ( GetHp(me) &lt; (GetStrength(me)/2))
+    CastSpell(me,me,&quot;gheal&quot;);
+    if (ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 0)
+      CastSpell(me,me,&quot;cure&quot;);
+    endif
+  endif
+  if ((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+    EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function spellattack(opponent)
+  if (!GetObjProperty(me,&quot;#lastbreath&quot;))
+    SetObjProperty(me,&quot;#lastbreath&quot;,ReadGameClock() + 5);
+  endif
+  if (GetObjProperty(me,&quot;#lastbreath&quot;) &gt; ReadGameClock() )
+    return;
+  endif
+  if (RandomInt(2)==1)
+    sleep(1);
+    cast_offensive_spell(me,opponent);
+  endif
+  SetObjProperty(me,&quot;#lastbreath&quot;,ReadGameClock() + 5);
+  foreach myfriend in ListMobilesNearLocation(me.x, me.y, me.z, HALT_THRESHOLD, me.realm)
+    if (myfriend.npctemplate &amp;&amp; myfriend.script != &quot;tamed&quot; )
+      healerstuff(myfriend);
+    endif
+  endforeach
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  spellattack(opponent);
+  if ( loops &gt; 50 )
+    flee(opponent);
+    return;
+  endif
+endfunction
+
+function prepare_for_fight(opponent)
+  if (GetObjProperty(me, &quot;mr&quot;) != &quot;1&quot;)
+    CastSpell(me,me,&quot;reflect&quot;);
+  endif
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  num_casts := 2;
+  sleep(1);
+  look_around();
+endfunction
+
+function healerstuff(mobile)
+  if (!mobile.npctemplate || mobile.npctemplate[&quot;guard&quot;] || mobile.script == &quot;tamed&quot;)
+    return;
+  endif
+    if( ListPoisonsByType(mobile, &quot;defaultPoison&quot;).size() &gt; 0 &amp;&amp; CheckLineOfSight(me,mobile) )
+    TurnToward(mobile);
+    CastSpell(me,mobile,&quot;cure&quot;);
+  elseif( (GetHp(mobile) &lt; (GetMaxHp(mobile)/2)) &amp;&amp; (CheckLineOfSight(me,mobile))  )
+    TurnToward(mobile);
+    CastSpell(me,mobile,&quot;gheal&quot;);
+  endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/immobileFight.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/immobileFight.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/immobileFight.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,85 @@
+function Fight(opponent)
+  if((opponent.cmdlevel &gt; 0) || (opponent.serial == me.serial))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  var oldprio := set_priority(50);
+  SetOpponent(opponent);
+  prepare_for_fight(opponent);
+  TurnToward(opponent);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while((opponent) &amp;&amp; not (opponent.dead || opponent.hidden || opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20) )
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	process_combat_event(opponent);
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: if((dist(me, ev.source) &lt; dist(me, opponent)) || (!CheckLineOfSight(me, opponent)) || (!opponent))
+					      opponent := ev.source;
+			  		      SetOpponent(opponent);
+					      TurnToward(opponent);
+                        elseif(RandomInt(3)==1)
+					      opponent := ev.source;
+			  		      SetOpponent(opponent);
+					      TurnToward(opponent);
+			            endif
+	  SYSEVENT_ENGAGED: if(ev.source)
+			              if(RandomInt(6)==1)
+					        opponent := ev.source;
+			  		        SetOpponent(opponent);
+					        TurnToward(opponent);
+					        process_combat_event(opponent);
+			              endif
+			            endif
+      EVID_PEACEMADE:   SetWarMode(0);
+			            SetOpponent(0);
+			            sleep(1);
+			            DisableCombatEvents();
+			            EnableMainEvents();
+			            return;
+      EVID_HERDING:     Herding(ev);
+	endcase
+  endwhile
+  post_combat();
+endfunction
+
+function EnableCombatEvents()
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function DisableCombatEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function flee(opponent)
+  if((me.script == &quot;immobile&quot;) || (me.script == &quot;immobilespell&quot;))
+	sleep(2);
+	return;
+  endif
+  var numflees := GetObjProperty(me,&quot;#flees&quot;);
+  if(numflees)
+	if(numflees &gt; 10)
+      RestartScript(me);
+	else
+	  numflees := numflees + 1;
+	endif
+  else
+	numflees := 1;
+  endif
+  SetObjProperty(me,&quot;#flees&quot;, numflees);
+  var runs := 0;
+  while((Distance(me, opponent) &lt; 5) &amp;&amp; (runs &lt; 50))
+	WalkAwayFrom(opponent);
+	runs := runs +1;
+	wait_for_event(0);
+  endwhile
+  RestartScript(me);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/packFight.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/packFight.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/packFight.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,112 @@
+include &quot;include/attributes&quot;;
+function Fight( opponent )
+  if ((opponent.cmdlevel &gt; 0) || (opponent.serial == me.serial))
+    SetWarMode(0);
+    opponent := 0;
+    return;
+  endif
+  if (opponent.multi.serial)
+    if (me.multi.serial != opponent.multi.serial)
+      flee(opponent);
+      return;
+    endif
+  endif
+  var oldprio := set_priority(50);
+  SetOpponent( opponent );
+  prepare_for_fight( opponent );
+  TurnToward( opponent );
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while ( (opponent) &amp;&amp; not (opponent.dead || opponent.hidden || opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20) )
+    if (!CloseDistance( opponent ) )
+      loops := loops + 1;
+      waittime := 0;
+    else
+      loops := 0;
+      waittime := 1;
+    endif
+    in_combat_event_loop(opponent, loops);
+    ev := wait_for_event( waittime );
+    case (ev.type)
+      SYSEVENT_DAMAGED:    foreach mobile in ListMobilesInLineOfSight(me, 10);
+                             if(mobile.npctemplate == me.npctemplate)
+                               var evnt := array;
+                               evnt.+ type;
+                               evnt.+ source;
+                               evnt.source := ev.source;
+                               evnt.type := EVID_ALL_ATTACK_CMD;
+                               SendEvent(mobile, evnt);
+                             endif
+                           endforeach
+                           opponent := ev.source;
+                           SetOpponent( opponent );
+      EVID_ALL_ATTACK_CMD: if((RandomInt(4) + 1) &gt;= 3)
+                             Fight(ev.source);
+                           endif
+      SYSEVENT_ENGAGED:    if (ev.source)
+                             foreach mobile in ListMobilesInLineOfSight(me, 10);
+                               if(mobile.npctemplate == me.npctemplate)
+                                 var evnt := array;
+                                 evnt.+ type;
+                                 evnt.+ source;
+                                 evnt.source := ev.source;
+                                 evnt.type := EVID_ALL_ATTACK_CMD;
+                                 SendEvent(mobile, evnt);
+                               endif
+                             endforeach
+                             process_combat_event(opponent);
+                             if (RandomInt(6)==1)
+                               if ((!ev.source.npctemplate) || (ev.source.script == &quot;tamed&quot;) || (ev.source.script == &quot;employed&quot;))
+                                 opponent := ev.source;
+                                 SetOpponent( opponent );
+                                 TurnToward( opponent );
+                               endif
+                             endif
+                           endif
+      EVID_PEACEMADE:      SetWarMode( 0 );
+                           SetOpponent( 0 );
+                           sleep(1);
+                           DisableCombatEvents();
+                           EnableMainEvents();
+                           return;
+      EVID_HERDING:           Herding(ev);
+    endcase
+  endwhile
+  post_combat();
+endfunction
+
+function EnableCombatEvents()
+  EnableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function DisableCombatEvents()
+  DisableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function flee(opponent)
+  if ( (me.script == &quot;immobile&quot;) || (me.script == &quot;immobilespell&quot;) )
+    sleep(2);
+    return;
+  endif
+  var numflees := GetObjProperty(me,&quot;#flees&quot;);
+  if (numflees)
+    if ( numflees &gt; 10 )
+      MoveCharacterToLocation(me,1,1,0,MOVECHAR_FORCELOCATION);
+      SetObjProperty(me,&quot;guardkill&quot;,1);
+      ApplyRawDamage( me, GetMaxHp(me) + 3 );
+    else
+      numflees := numflees + 1;
+    endif
+  else
+    numflees := 1;
+  endif
+  SetObjProperty(me,&quot;#flees&quot;,numflees);
+  var runs := 0;
+  while ( (Distance(me, opponent) &lt; 20) &amp;&amp; (runs &lt; 50) )
+    RunAwayFrom(opponent);
+    runs := runs +1;
+    wait_for_event(0);
+  endwhile
+  RestartScript( me );
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/packFireCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/packFireCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/packFireCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,44 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+  spellattack(opponent);
+  if((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+	EraseObjProperty(me,&quot;#flees&quot;);
+	flee(opponent);
+  endif
+endfunction
+
+function spellattack(opponent);
+  if(RandomInt(3) == 1)
+	return;
+  endif
+  if(CheckLineOfSight(me, opponent))
+    PerformAction(me,0x0c);
+    var dmg := ((RandomInt(9) + 1) + (GetHp(me) / 10));
+    PlaySoundEffect(me, 0x16b);
+    sleep(2);
+    PlayMovingEffect(me, opponent, 0x36d4, 10, 1, 1);
+    ApplyRawDamage(opponent, dmg);
+  endif
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  spellattack(opponent);
+  if(loops &gt; 50)
+	flee(opponent);
+	return;
+  endif
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  sleep(1);
+  look_around();
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/combat/poisonCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/poisonCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/poisonCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,56 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+  DoPoison(opponent);
+  if((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+	EraseObjProperty(me,&quot;#flees&quot;);
+	flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  return 0;
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  DoPoison(opponent);
+  if(loops &gt; 50)
+	flee(opponent);
+	return;
+  endif
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode(0);
+  SetOpponent(0);
+  sleep(1);
+  look_around();
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function DoPoison(you)
+  SetObjProperty(me, &quot;#lastbreath&quot;, ReadGameClock() + 10);
+  if((Distance(me,you) &lt; 2) &amp;&amp; (RandomInt(4)==1))
+	var p_level := CInt(GetMaxHp(me)/20);
+	var poison_level := CInt(GetObjProperty(you, &quot;poison_level&quot;));
+    if(p_level &lt; 1)
+      p_level := 1;
+    endif
+	if(p_level &lt; poison_level)
+	  p_level := poison_level;
+	else
+	  SetObjProperty(you, &quot;poison_level&quot;,CInt(p_level));
+	endif
+	Detach();
+	set_critical(0);
+    SetObjProperty(you, &quot;LastHit&quot;, {me.name, me.serial, &quot;poison spell&quot;});
+	var passparms := {you, me, &quot;snake venom&quot;};
+    SetObjProperty(you, &quot;PoisonStamp&quot;, ReadGameClock());
+	start_script(&quot;:spells:poisonDamage&quot;, passparms);
+  endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/slimeCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/slimeCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/slimeCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,87 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+  do_damage(opponent);
+  if (RandomInt(10) == 1)
+    if ( (!CInt(GetObjProperty(me, &quot;guardkill&quot;))) &amp;&amp; (!CInt(GetObjProperty(me,&quot;killme&quot;))) )
+      var it := CreateNpcFromTemplate(me.npctemplate, me.x, me.y -1, me.z,0,me.realm);
+      if (!it.errortext)
+        PrintTextAbove(me, &quot;The slime splits when struck!&quot;);
+        SetObjProperty(it,&quot;killme&quot;,1);
+      endif
+    endif
+  endif
+  if ((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+    EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  return 0;
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  do_damage(opponent);
+  if ( loops &gt; 50 )
+    flee(opponent);
+    return;
+  endif
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  sleep(1);
+  look_around();
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function do_damage(evsource)
+  if ( (Distance(me, evsource) &lt; 3 ) &amp;&amp; (RandomInt(40) == 1) )
+    PrintTextAbovePrivate(me, &quot;The slime spits acid at you!&quot;, evsource);
+    if (!HasShield(evsource))
+      var dmg := RandomInt(5) + 1;
+      var things := ListEquippedItems( evsource );
+      var thing := things[ CInt(RandomInt(len(things))+1) ];
+      if ( CanEat(evsource, thing) )
+        PrintTextAbovePrivate(evsource, &quot;The corrosive liquid damages &quot;+ thing.desc +&quot;.&quot;, evsource);
+        if (dmg &gt; thing.hp)
+          dmg := thing.hp;
+        endif
+        thing.hp := thing.hp - dmg;
+        if ( (thing.hp &lt;= 0) || (thing.hp &gt; thing.maxhp) )
+          PrintTextAbovePrivate(evsource, thing.desc + &quot; is destroyed!&quot;, evsource);
+          DestroyItem(thing);
+        endif
+      endif
+    endif
+  endif
+endfunction
+
+function CanEat(character, item)
+  if ( ( item.objtype &gt;= 0x2030 ) &amp;&amp; (item.objtype &lt;= 0x2060) )
+    return 0;
+  endif
+  if ( (item.objtype == 0x0e75) || (item.objtype == 0xf021 ) )
+    return 0;
+  endif
+  if (!item.maxhp)
+    return 0;
+  endif
+  return 1;
+endfunction
+
+function HasShield(you)
+  var shield := GetEquipmentByLayer( you, LAYER_HAND2 );
+  if ( (shield.objtype == 0x1bc3) || (shield.objtype == 0x1bc4) )
+    PrintTextAbovePrivate(you,&quot;Your shield blocks the acid!&quot;,you);
+    return 1;
+  endif
+  return 0;
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/spellCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/spellCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/spellCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,64 @@
+include &quot;include/attributes&quot;;
+include &quot;:poisonwatcher:poisons&quot;;
+
+function process_combat_event(opponent)
+  if((GetHp(me) &lt; (GetMaxHP(me) / 2)) &amp;&amp; (RandomInt(8) &gt;= 5))
+    CastSpell(me, me, &quot;gheal&quot;);
+  elseif((ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 0) &amp;&amp; (RandomInt(8) &gt;= 5))
+    CastSpell(me, me, &quot;cure&quot;);
+  else
+    spellattack(opponent);
+  endif
+  if(((GetHp(me) * 100) / GetMaxHp(me)) &lt; flee_point)
+    EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  if((GetHp(me) &lt; (GetMaxHP(me) / 2)) &amp;&amp; (RandomInt(8) &gt;= 3))
+    CastSpell(me, me, &quot;gheal&quot;);
+    return 0;
+  elseif((ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 0) &amp;&amp; (RandomInt(8) &gt;= 3))
+    CastSpell(me, me, &quot;cure&quot;);
+    return 0;
+  else
+    spellattack(opponent);
+  endif
+  if(((GetHp(me) * 100) / GetMaxHp(me)) &gt;= flee_point)
+    return 1;
+  endif
+endfunction
+
+function spellattack(opponent)
+  if(LAST_BREATH &gt; ReadGameClock())
+    return;
+  elseif((CheckLineOfSight(me, opponent)) and (dist(me, opponent) &lt;= 12))
+    cast_offensive_spell(me, opponent);
+    LAST_BREATH := Cint(ReadGameClock() + (RandomInt(4) + 4));
+  endif
+endfunction
+
+function prepare_for_fight(opponent)
+  opponent := opponent; // stops &quot;var not used&quot; ecompile warning
+  if((!CInt(GetObjProperty(me, &quot;mr&quot;))) and (RandomInt(3) == 2))
+    CastSpell(me, me, &quot;reflect&quot;);
+  endif
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function post_combat()
+  if((GetHp(me) &lt; (GetMaxHP(me) / 2)) &amp;&amp; (RandomInt(4) &gt;= 2))
+    CastSpell(me, me, &quot;gheal&quot;);
+  endif
+  if(ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 0)
+    CastSpell(me, me, &quot;cure&quot;);
+  endif
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode(0);
+  SetOpponent(0);
+  sleep(1);
+  look_around();
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/spellFireEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/spellFireEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/spellFireEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,85 @@
+include &quot;include/attributes&quot;;
+include &quot;:poisonwatcher:poisons&quot;;
+
+function process_combat_event(opponent)
+  if((GetHp(me) &lt; (GetMaxHP(me) / 2)) &amp;&amp; (RandomInt(8) &gt;= 5))
+    CastSpell(me, me, &quot;gheal&quot;);
+  elseif((ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 0) &amp;&amp; (RandomInt(8) &gt;= 5))
+    CastSpell(me, me, &quot;cure&quot;);
+  else
+    spellattack(opponent);
+  endif
+  if(((GetHp(me) * 100) / GetMaxHp(me)) &lt; flee_point)
+    EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  if((GetHp(me) &lt; (GetMaxHP(me) / 2)) &amp;&amp; (RandomInt(8) &gt;= 3))
+    CastSpell(me, me, &quot;gheal&quot;);
+    return 0;
+  elseif((ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 0) &amp;&amp; (RandomInt(8) &gt;= 3))
+    CastSpell(me, me, &quot;cure&quot;);
+    return 0;
+  else
+    spellattack(opponent);
+    return 0;
+  endif
+  if(((GetHp(me) * 100) / GetMaxHp(me)) &gt;= flee_point)
+    return 1;
+  endif
+endfunction
+
+function spellattack(opponent)
+  if(LAST_BREATH &gt; ReadGameClock())
+    return;
+  endif
+  if((CheckLineOfSight(me, opponent)) and (dist(me, opponent) &lt;= 15))
+    if(RandomInt(4) == 1)
+      PerformAction(me,0x0c);
+      PlaySoundEffect(me, 0x16b);
+      sleep(2);
+      var base := Cint(((FLAME_STRENGTH * GetHp(me)) / GetMaxHp(me)) / 2);
+      var dmg :=  RandomInt(base) + base;
+      PlayMovingEffect(me, opponent, 0x36d4, 10, 1, 1);
+      ApplyRawDamage(opponent, dmg);
+    else
+	  cast_offensive_spell(me,opponent);
+    endif
+    LAST_BREATH := Cint(ReadGameClock() + (RandomInt(4) + 4));
+  endif
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  spellattack(opponent);
+  if ( loops &gt; 50 )
+	flee(opponent);
+	return;
+  endif
+endfunction
+
+function prepare_for_fight(opponent)
+  if (!CInt(GetObjProperty(me, &quot;mr&quot;)))
+	CastSpell(me,me,&quot;reflect&quot;);
+  endif
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function post_combat()
+  if ( GetHp(me) &lt; (GetStrength(me)-10))
+	CastSpell(me,me,&quot;gheal&quot;);
+  endif
+  if (ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 0)
+    CastSpell(me, me, &quot;cure&quot;);
+    return 0;
+  endif
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  summons := 1;
+  sleep(1);
+  look_around();
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/spiderCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/spiderCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/spiderCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,71 @@
+include &quot;include/attributes&quot;;
+
+function process_combat_event(opponent)
+  send_web(opponent);
+  if ((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+	EraseObjProperty(me,&quot;#flees&quot;);
+	flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  return 0;
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+
+	send_web(opponent);
+
+	if ( loops &gt; 50 )
+		flee(opponent);
+		return;
+	endif
+
+endfunction
+
+
+
+function post_combat()
+
+	DisableCombatEvents();
+	EnableMainEvents();
+
+	SetWarMode( 0 );
+	num_casts := 2;
+
+	sleep(1);
+	look_around();
+
+endfunction
+
+function prepare_for_fight(opponent)
+
+	DisableMainEvents();
+	EnableCombatEvents();
+
+endfunction
+
+function send_web(opponent)
+
+	if (RandomInt(20) != 1)
+		return;
+	endif
+
+	if (!CheckLineOfSight( me, opponent ))
+		return;
+	endif
+
+PrintTextAbove(me, &quot;The spider spits a web!&quot;);
+
+//	-causes client crash-
+//
+//PlayMovingEffectXYZ( me.x, me.y, me.z,
+//                         opponent.x, opponent.y, opponent.z,
+//                         UOBJ_SPIDERWEB, 8, 0, 0, me.realm );
+//
+//	-causes client crash-
+
+sleepms(1250);
+CreateItemAtLocation(opponent.x, opponent.y, opponent.z,UOBJ_SPIDERWEB,  1, opponent.realm);
+
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/vortexCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/vortexCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/vortexCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,32 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+  if(Distance(me,opponent) &lt; 2)
+    var dmg := RandomInt(CInt(GetIntelligence(opponent) / 10));
+    if(dmg &gt; 12)
+      dmg := 12;
+    elseif(dmg &lt; 2)
+      dmg := 2;
+    endif
+	ApplyRawDamage(opponent, dmg);
+  endif
+endfunction
+
+function prepare_for_fight(opponent)
+
+	DisableMainEvents();
+	EnableCombatEvents();
+
+endfunction
+
+function post_combat()
+
+	DisableCombatEvents();
+	EnableMainEvents();
+
+	SetWarMode( 0 );
+	SetOpponent( 0 );
+
+	sleep(1);
+	look_around();
+
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/combat/warriorcombatevent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/combat/warriorcombatevent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/combat/warriorcombatevent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,61 @@
+include &quot;include/attributes&quot;;
+function process_combat_event(opponent)
+    if ((GetHp(me) * 100/GetMaxHp(me)) &lt; flee_point)
+      EraseObjProperty(me,&quot;#flees&quot;);
+      flee(opponent);
+    elseif (GetHp(me) &lt; GetMaxHp(me)/2)
+      ApplyHealing();
+    endif
+endfunction
+
+function process_flee_event(opponent)
+  return 0;
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  if ( loops &gt; 50 )
+    flee(opponent);
+    return;
+  endif
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode( 0 );
+  SetOpponent( 0 );
+  sleep(1);
+  look_around();
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function ApplyHealing()
+  var bandages := Cint(GetObjProperty(me, &quot;bandages&quot;));
+  if(!bandages)
+    var nextrestock := Cint(GetObjProperty(me, &quot;nextrestock&quot;));
+    if (!nextrestock)
+      SetObjProperty(me, &quot;nextrestock&quot;, ReadGameClock() + 1800);
+    endif
+    if(nextrestock &lt; ReadGameClock())
+      bandages := 10 + RandomInt(10);
+      SetObjProperty(me, &quot;bandages&quot;, bandages);
+      SetObjProperty(me, &quot;nextrestock&quot;, ReadGameClock() + 1800);
+    endif
+  endif
+  if((GetObjProperty(me,&quot;#nextheal&quot;) &lt; ReadGameClock()) || !GetObjProperty(me,&quot;#nextheal&quot;))
+    bandages := Cint(GetObjProperty(me, &quot;bandages&quot;));
+    if(bandages)
+      SetHp(me, GetHp(me) + (RandomInt(GetMaxHp(me) - GetHp(me))+1));
+      SetObjProperty(me,&quot;#nextheal&quot;, ReadGameClock()+20);
+      bandages := bandages - 1;
+      if(bandages &lt;= 0)
+        bandages := 0;
+      endif
+      SetObjProperty(me, &quot;bandages&quot;, bandages);
+    endif
+  endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/cow.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/cow.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/cow.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,38 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopCow&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/animalSetup&quot;;
+include &quot;ai/main/sleepModeCow&quot;;
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile(&quot;npcdesc&quot;);
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program cow()
+	SetWarMode(0);
+	main_AI_loop();
+endprogram
+
+function CloseDistance(opponent)
+	case (Distance(me, opponent))
+		1:
+		0:       return 1;
+		default:
+			WalkToward(opponent);
+			return 0;
+	endcase
+endfunction
+

Added: trunk/096/pkg/mobiles/oldAI/crier.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/crier.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/crier.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,78 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+const HALT_THRESHOLD := 8;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopCrier&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;ai/setup/crierSetup&quot;;
+include &quot;:begging:begging&quot;;
+
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program TownCrier()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if(loops &gt;= 30)
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    1:
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/davesHealer.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/davesHealer.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/davesHealer.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,118 @@
+use npc;
+use os;
+use uo;
+
+include &quot;:npcutils:NPCCast&quot;;
+include &quot;include/attributes&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;:npcutils:speech&quot;;
+include &quot;include/client&quot;;
+include &quot;include/res&quot;;
+include &quot;include/resPenalty&quot;;
+include &quot;:begging:begging&quot;;
+
+const SOUND_EFFECT_RES := 0x215;
+const ACTION_EFFECT_CAST2 := 0x11;
+const REACT_THRESHOLD := 3;
+
+var speech := 99;
+var me:= Self();
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+var dmgsound := npccfgfile[me.npctemplate].damagedsound;
+var summons := 1;
+var saywords := 1;
+
+
+program HealerAI()
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+  drop_anchor();
+  SetAnchor(me.x, me.y, 5, 20);
+  var next_wander := ReadGameClock() + 10;
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED);
+  EnableEvents(SYSEVENT_ENTEREDAREA, REACT_THRESHOLD);
+  EnableEvents(SYSEVENT_SPEECH, 5);
+  EnableEvents(SYSEVENT_ITEM_GIVEN);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  var ev;
+  while(1)
+    ev := os::wait_for_event(120);
+    repeat
+    case(ev.type)
+      SYSEVENT_SPEECH:      next_wander := ReadGameClock()+60;
+                            check_speech(ev.text, ev.source);
+      SYSEVENT_ENGAGED:
+      SYSEVENT_DAMAGED:     PlaySoundEffect(me,dmgsound);
+                            if (ev.source)
+                              Fight( ev.source );
+                            endif
+      SYSEVENT_ENTEREDAREA: if(!ev.source.isA(POLCLASS_NPC))
+                              HealerStuff(ev.source);
+                            endif
+      SYSEVENT_ITEM_GIVEN:  next_wander := ReadGameClock()+60;
+		                TakeItem(ev.source,ev.item);
+    endcase
+    until(!(ev := os::wait_for_event(4)));
+    if (ReadGameClock() &gt;= next_wander)
+      begpurse(me);
+      wander();
+      next_wander := ReadGameClock() + 10;
+    endif
+  endwhile
+endprogram
+
+function Fight( opponent )
+  var oldprio := set_priority(50);
+  DisableEvents(SYSEVENT_LEFTAREA);
+  SetOpponent(opponent);
+  var waittime;
+  outer:
+  while (opponent &amp;&amp; not (opponent.dead || opponent.hidden || opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 15))
+    waittime := CloseDistance(opponent) * 15;
+    var ev := wait_for_event(waittime);
+    repeat
+     case (ev.type)
+       SYSEVENT_DISENGAGED:
+       SYSEVENT_ENGAGED:
+       SYSEVENT_DAMAGED:        PlaySoundEffect(me,dmgsound);
+                                if(GetHp(me) &lt; (GetMaxHp(me)/2))
+                                  CastSpell(me, me, &quot;gheal&quot;);
+                                endif
+       SYSEVENT_OPPONENT_MOVED: break;
+       SYSEVENT_ENTEREDAREA:    if(!ev.source.isA(POLCLASS_NPC))
+                                  HealerStuff(ev.source);
+                                endif
+     endcase
+     until(!(ev := wait_for_event(0)));
+   endwhile
+   EnableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, REACT_THRESHOLD);
+   SetWarMode(0);
+   set_priority(oldprio);
+endfunction
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    2:       WalkToward( opponent );
+             return 0;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function HealerStuff(mobile)
+  var parms := {me, mobile};
+  start_script(&quot;doRes&quot;, parms);
+  return;
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/dumbKillPCs.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/dumbKillPCs.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/dumbKillPCs.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,38 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/animalCombatEvent&quot;;
+include &quot;ai/setup/killPCsSetup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+const HALT_THRESHOLD := 8;
+var npccfgfile := ReadConfigFile(&quot;npcdesc&quot;);
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/employed.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/employed.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/employed.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,544 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;:npcutils:NPCCast&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;include/dist&quot;;
+include &quot;:poisonwatcher:poisons&quot;;
+
+set_priority(5);
+
+const  HALT_THRESHOLD := 15;
+const  SYSEVENT_ALL_GUARD_CMD := 0x13;
+
+var me := Self();
+var npccfgfile := ReadConfigFile(&quot;npcdesc&quot;);
+var dmgsound   := npccfgfile[me.npctemplate].dmgsound;
+var hit        := npccfgfile[me.npctemplate].attackhitsound;
+var idlesnd1   := npccfgfile[me.npctemplate].idlesound1;
+var idlesnd2   := npccfgfile[me.npctemplate].idlesound2;
+var masterserial := GetObjProperty(me, &quot;master&quot;);
+
+var mypack := me.backpack;
+var caster := 0;
+var spells;
+var summons := 0;
+var chaseloop := 0;
+var guarding := 0;
+var following := 0;
+var nextwatch := ReadGameClock();
+var saywords := 0;
+var master;
+var waittime := 60;
+var escortee;
+
+program employed()
+  var type := GetObjProperty(me, &quot;MerchantType&quot;);
+  Adjustment(me, type);
+  SetAnchor( me.x, me.y, 20, 0 );
+  Detach();
+  var online;
+  online := EnumerateOnlineCharacters();
+  foreach char in online
+    if(char.serial == masterserial)
+      master := char;
+      break;
+    endif
+  endforeach
+  if(!master)
+    master := SystemFindObjectBySerial(CInt(masterserial), SYSFIND_SEARCH_OFFLINE_MOBILES);
+  endif
+  me.setmaster(master);
+  if(!me.backpack)
+    mypack := CreateItemAtLocation(1, 1, 0, 0xe75,1, me.realm);
+    EquipItem(me, mypack);
+  endif
+  var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+  if(GetObjProperty(me, &quot;MerchantType&quot;) == &quot;Mage&quot;)
+    caster := 1;
+    spells := GetConfigStringArray(npccfg[me.npctemplate], &quot;spell&quot;);
+  endif
+  SetWarMode(0);
+  SetObjProperty(me, &quot;serial&quot;, me.serial);
+  MainAILoop();
+endprogram
+
+function Adjustment(who, type)
+  if(type == &quot;Mage&quot;)
+    ExpandStats(who, 100, 80, 100);
+    SetBaseSkillBaseValue(who, SKILLID_MAGERY,          1000);
+    SetBaseSkillBaseValue(who, SKILLID_EVALINT,         1000);
+    SetBaseSkillBaseValue(who, SKILLID_MAGICRESISTANCE, 900);
+    SetBaseSkillBaseValue(who, SKILLID_TACTICS,         700);
+    SetBaseSkillBaseValue(who, SKILLID_WRESTLING,       700);
+  elseif(type == &quot;Thief&quot;)
+    ExpandStats(who, 80, 100, 25);
+    SetBaseSkillBaseValue(who, SKILLID_FENCING,         1000);
+    SetBaseSkillBaseValue(who, SKILLID_MAGICRESISTANCE, 60);
+    SetBaseSkillBaseValue(who, SKILLID_TACTICS,         80);
+    SetBaseSkillBaseValue(who, SKILLID_ANATOMY,         600);
+  elseif(type == &quot;Paladin&quot;)
+    ExpandStats(who, 100, 100, 50);
+    SetBaseSkillBaseValue(who, SKILLID_MAGICRESISTANCE, 800);
+    SetBaseSkillBaseValue(who, SKILLID_TACTICS,         1000);
+    SetBaseSkillBaseValue(who, SKILLID_SWORDSMANSHIP,   1000);
+    SetBaseSkillBaseValue(who, SKILLID_MACEFIGHTING,    1000);
+    SetBaseSkillBaseValue(who, SKILLID_FENCING,         1000);
+    SetBaseSkillBaseValue(who, SKILLID_WRESTLING,       900);
+    SetBaseSkillBaseValue(who, SKILLID_ANATOMY,         1000);
+  elseif((type == &quot;Fighter1&quot;) || (type == &quot;Fighter2&quot;) || (type == &quot;Fighter3&quot;) || (type == &quot;Fighter4&quot;))
+    ExpandStats(who, 90, 90, 20);
+    SetBaseSkillBaseValue(who, SKILLID_MAGICRESISTANCE, 600);
+    SetBaseSkillBaseValue(who, SKILLID_TACTICS,         900);
+    SetBaseSkillBaseValue(who, SKILLID_SWORDSMANSHIP,   900);
+    SetBaseSkillBaseValue(who, SKILLID_MACEFIGHTING,    900);
+    SetBaseSkillBaseValue(who, SKILLID_FENCING,         900);
+    SetBaseSkillBaseValue(who, SKILLID_WRESTLING,       900);
+    SetBaseSkillBaseValue(who, SKILLID_ANATOMY,         900);
+  endif
+endfunction
+
+function ExpandStats(me, st, dx, it)
+  if(st)
+    if(st &lt;= 210)
+      SetBaseStrength(me,st);
+      SetStrengthMod(me, 0);
+    else
+      SetBaseStrength(me,210);
+      SetStrengthMod(me, st - 210);
+    endif
+    SetHp(me, st);
+  endif
+  if(dx)
+    if(dx &lt;= 210)
+      SetBaseDexterity(me,dx);
+      SetDexterityMod(me, 0);
+    else
+      SetBaseDexterity(me,210);
+      SetDexterityMod(me, dx - 210);
+    endif
+    SetStamina(me, dx);
+  endif
+  if(it)
+    if(it&lt;=210)
+      SetBaseIntelligence(me,it);
+      SetIntelligenceMod(me, 0);
+    else
+      SetBaseIntelligence(me,210);
+      SetIntelligenceMod(me, it - 210);
+    endif
+    SetMana(me, it);
+  endif
+endfunction
+
+function MainAILoop()
+  var ev;
+  nextwatch := ReadGameClock();
+  var mhp;
+  EnableMainEvents();
+  escortee := 0;
+  while(1)
+    if(ReadGameClock() &gt; CInt(GetObjProperty(me, &quot;Timer&quot;)))
+	  Release();
+    endif
+    mhp := GetHp(me);
+    ev := os::wait_for_event(waittime);
+    case (ev.type)
+	  SYSEVENT_SPEECH:     ProcessSpeech(ev);
+	  SYSEVENT_ENGAGED:    if(ev.source)
+	  	                     Fight(ev.source);
+	  	                   endif
+	  SYSEVENT_DAMAGED:        if(GetHp(me) &lt; mhp)
+                             PlaySoundEffect(me,dmgsound);
+                           endif
+                           if(ev.source)
+	  	                     Fight(ev.source);
+	  	                   endif
+	  SYSEVENT_ITEM_GIVEN:     if(ev.source.serial == masterserial)
+			                 TakeItem(ev);
+		                   endif
+	  EVID_ALL_ATTACK_CMD: Fight(ev.target);
+	  EVID_ALL_FOLLOW_CMD: following := 1;
+                           escortee := ev.target;
+	  SYSEVENT_ALL_GUARD_CMD:  guarding := ev.target;
+		                   PrintTextAbove(me,&quot;*guarding &quot; + guarding.name + &quot;*&quot;);
+    endcase
+    if(following == 1)
+      Follow();
+    else
+      if(guarding)
+	waittime := 3;
+	Guard();
+      else
+        waittime := 60;
+      endif
+    endif
+  endwhile
+endfunction
+
+function ProcessSpeech(ev)
+  if(ev.source.serial != masterserial)
+	return;
+  endif
+  if(!master)
+	RestartScript(me);
+  endif
+  var evtext := lower(ev.text);
+  var ph := SplitWords(me.name);
+  var mename := lower(ph[1]);
+  if(evtext[mename + &quot; kill&quot;] || evtext[mename + &quot; attack&quot;] || evtext[&quot;all kill&quot;] || evtext[&quot;all attack&quot;])
+	var what := Target(master, TGTOPT_HARMFUL + TGTOPT_CHECK_LOS);
+    if(what)
+      if(what.serial == ev.source.serial)
+		return;
+	  elseif(evtext[&quot;all kill&quot;] || evtext[&quot;all attack&quot;])
+		AllCommand(EVID_ALL_ATTACK_CMD, what);
+	  else
+        Fight(what);
+	  endif
+	endif
+  elseif(evtext[mename + &quot; stop&quot;] || evtext[&quot;all stop&quot;])
+	guarding := 0;
+	following := 0;
+  elseif((evtext[mename + &quot; come&quot;]) || (evtext[&quot;all come&quot;]))
+	var done := 0;
+	chaseloop := 0;
+	while(done == 0)
+	  chaseloop := chaseloop +1;
+	  done := CloseDistance(ev.source);
+	  if(chaseloop &gt; 25)
+		done :=1;
+	  endif
+	endwhile
+  elseif(evtext[mename + &quot; follow me&quot;])
+    escortee := ev.source;
+    following := 1;
+  elseif(evtext[mename + &quot; follow&quot;])
+	var what := Target(master, TGTOPT_CHECK_LOS);
+	if(what)
+      escortee := what;
+      following := 1;
+	endif
+  elseif(evtext[&quot;all follow me&quot;])
+	AllCommand(EVID_ALL_FOLLOW_CMD, ev.source);
+  elseif(evtext[&quot;all follow&quot;])
+	var what := Target(master, TGTOPT_CHECK_LOS);
+	if(what)
+	  AllCommand(EVID_ALL_FOLLOW_CMD, what);
+	endif
+  elseif(evtext[mename + &quot; dismiss&quot;] || (evtext[&quot;all dismiss&quot;]))
+	Release();
+  elseif(evtext[mename + &quot; guard me&quot;])
+	guarding := ev.source;
+	PrintTextAbove(me,&quot;I'm guarding you.&quot;);
+  elseif(evtext[mename + &quot; guard&quot;])
+    say(&quot;Who should I guard?&quot;);
+    var what := Target(master, TGTOPT_HELPFUL + TGTOPT_CHECK_LOS);
+	if(what.isA(POLCLASS_UOBJECT))
+      guarding := what;
+	  PrintTextAbove(me,&quot;I'm guarding &quot; + guarding.name +&quot;.&quot;);
+	endif
+  elseif (evtext[&quot;all guard me&quot;])
+	guarding := ev.source;
+	PrintTextAbove(me,&quot;I'm guarding you.&quot;);
+  elseif (evtext[&quot;all guard&quot;])
+    say(&quot;Who should I guard?&quot;);
+	var what := Target(master, TGTOPT_HELPFUL + TGTOPT_CHECK_LOS);
+	if(GetHp(what))
+      AllCommand(SYSEVENT_ALL_GUARD_CMD, what);
+	endif
+  elseif(evtext[mename + &quot; fetch&quot;]  || (evtext[mename + &quot; get&quot;]))
+    say(&quot;very well&quot;);
+	fetch();
+  elseif(evtext[mename + &quot; drop&quot;])
+    say(&quot;As you wish.&quot;);
+	drop();
+  elseif((evtext[mename + &quot; info&quot;]) || (evtext[mename + &quot; status&quot;]))
+    var clk := GetObjProperty(me, &quot;Timer&quot;) - ReadGameClock();
+    var days := clk / 10800;
+    say(&quot;I will continue to work for you for &quot; + days + &quot; days.&quot;);
+  endif
+endfunction
+
+function Fight(opponent)
+  if(caster)
+    if(GetMana(me) &lt; (GetIntelligence(me) / 2))
+      say(&quot;I must meditate first.&quot;);
+      meditationloop();
+      return;
+    endif
+  endif
+  var oldfollowing := following;
+  SetDexterityMod(me, 0);
+  following := 0;
+  if (opponent.serial == me.serial)
+    return;
+  endif
+  TurnToward(opponent);
+  SetOpponent(opponent);
+  var ev;
+  var loops := 0;
+  while((opponent) &amp;&amp; (!opponent.dead || !opponent.hidden || !opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 15))
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+    ev := wait_for_event(waittime);
+    case (ev.type)
+	  EVID_ALL_ATTACK_CMD: opponent := ev.target;
+	                       SetOpponent( opponent );
+	  EVID_ALL_FOLLOW_CMD: following := ev.target;
+	  SYSEVENT_ALL_GUARD_CMD:  guarding := ev.target;
+		                   PrintTextAbove(me,&quot;*guarding &quot; + guarding.name + &quot;*&quot;);
+	  SYSEVENT_SPEECH:     ProcessSpeech(ev);
+	  SYSEVENT_ENGAGED:
+	  SYSEVENT_DAMAGED:        if(ev.source == opponent)
+                             PlaySoundEffect(me,dmgsound);
+                           endif
+                           if(ev.source)
+			                 if(ev.source != opponent)
+				               if((!CheckLineOfSight(me, opponent)) || (RandomInt(8)==1))
+					             opponent := ev.source;
+					             SetOpponent(opponent);
+				               endif
+			                 endif
+			                 TurnToward(opponent);
+		                   endif
+	  EVID_PEACEMADE:      SetWarMode(0);
+		                   opponent := 0;
+		                   following := oldfollowing;
+		                   return;
+    endcase
+	if(following)
+	  SetWarMode(0);
+	  opponent := 0;
+	  return;
+	endif
+	if(caster)
+	  if((RandomInt(3)+1) == 2)
+		sleep(1);
+		cast_offensive_spell(me,opponent);
+	  endif
+    endif
+	if(loops &gt; 100 )
+	  RestartScript(me);
+	  return;
+	endif
+  endwhile
+  SetWarMode(0);
+  opponent := 0;
+  if(caster)
+    if(GetMana(me) &lt; (GetIntelligence(me) / 2))
+      say(&quot;I must meditate.&quot;);
+      meditationloop();
+      return;
+    endif
+  endif
+  following := oldfollowing;
+endfunction
+
+function meditationloop()
+  PlaySoundEffect(me, 0xfa);
+  say(&quot;*meditating*&quot;);
+  var ev;
+  var healparms := array;
+  healparms[1] := &quot;#MOB&quot;;
+  healparms[2] := me;
+  healparms[3] := me;
+  while(GetMana(me) &lt; GetIntelligence(me))
+    SetMana(me, GetMana(me) + 2);
+	ev := wait_for_event(2);
+	case (ev.type)
+      EVID_DAMAGED: if(ListPoisonsByType(me, &quot;defaultPoison&quot;).size() &gt; 1)
+                      say(&quot;An Nox&quot;);
+                      start_script( &quot;:spells:cure&quot;, healparms );
+                      sleep(2);
+                    endif
+                    if(ev.source)
+                      if(ev.source.serial != me.serial)
+                        Fight(ev.source);
+                      endif
+                    endif
+	  EVID_ENGAGED: if(ev.source)
+                      if(ev.source.serial != me.serial)
+                        Fight(ev.source);
+                      endif
+                    endif
+    endcase
+  endwhile
+endfunction
+
+function CloseDistance(opponent)
+  case (Distance(me, opponent))
+    1:
+    0:       return 1;
+    default: if(!RunToward(opponent))
+               return 1;
+             else
+               return 0;
+             endif
+  endcase
+endfunction
+
+function Release()
+	PrintTextAbovePrivate(me, &quot;I have decided to terminate my employment with you.&quot;, master);
+	me.setmaster(0);
+	EraseObjProperty(me, &quot;master&quot;);
+	EraseObjProperty(me, &quot;serial&quot;);
+	EraseObjProperty(me, &quot;script&quot;);
+	SetAnchor(me.x,me.y,10,1);
+	me.script := npccfgfile[me.npctemplate].script;
+	RestartScript(me);
+endfunction
+
+function fetch()
+  var tobj := Target(master);
+  if(tobj.container)
+    say(&quot;Um. I can't pick that up.&quot;);
+    return;
+  endif
+  var times := 0;
+  while((Distance(me, tobj) &gt; 1) &amp;&amp; (times &lt;= 5) &amp;&amp; CheckLineOfSight(me,tobj))
+    if(!walktoward(tobj))
+      sleepms(100);
+      times := times + 1;
+    else
+      times := 0;
+    endif
+  endwhile
+  if((Accessible(me,tobj)) &amp;&amp; (CheckLineOfSight(me,tobj)))
+    if(!MoveItemToContainer(tobj, mypack))
+      say(&quot;That is too heavy.&quot;);
+      return;
+    endif
+  else
+    say(&quot;But I cannot reach that.&quot;);
+  endif
+endfunction
+
+function drop()
+  foreach myitems in EnumerateItemsInContainer(mypack)
+	if (myitems.container.serial == mypack.serial)
+      MoveItemToLocation(myitems, me.x, me.y, me.z,0);
+	  sleepms(100);
+	endif
+  endforeach
+endfunction
+
+function TakeItem(ev)
+  var item := ev.item;
+  var amt := item.amount;
+  var timeleft := GetObjProperty(me, &quot;Timer&quot;);
+  var cost := GetObjProperty(me, &quot;HireCost&quot;);
+  var days := amt / cost;
+  if(CInt(item.objtype) == 0xeed)
+    days := days * 10800;
+    timeleft := timeleft + days;
+    SetObjProperty(me, &quot;Timer&quot;, (ReadGameClock() + timeleft));
+	PrintTextAbove(me,&quot;I'll just apply that towards my wages.&quot;);
+	DestroyItem(ev.item);
+	return;
+  else
+    var yourpack := ev.source.backpack;
+    MoveItemToContainer(item, yourpack);
+    say(&quot;I have no need for this&quot;);
+  endif
+endfunction
+
+function Guard()
+  if( nextwatch &lt;= ReadGameClock() )
+    nextwatch := ReadGameClock() + 7;
+    if( RandomInt(8)==1 )
+      PrintTextAbove(me,&quot;*guarding &quot; + guarding.name + &quot;*&quot;);
+    endif
+    foreach mob in ListHostiles( guarding, 9, 0 );
+      Fight(mob);
+      return;
+    endforeach
+  endif
+  if( (!GetStrength(guarding)) || (guarding.dead) || (dist(me,guarding) &gt; 15) )
+    guarding := 0;
+  endif
+endfunction
+
+function Follow()
+  var d := Distance(me, escortee);
+  if(d &gt; 15)
+    following := 0;
+    say(&quot;My employer seems to have abandoned me.&quot;);
+    waittime := 60;
+  else
+    if(d &lt;= 2)
+       waittime := 1;
+    elseif(d &gt; 6)
+      var ma := 200 - CInt(GetDexterity(me));
+      SetDexterityMod(me, CInt(GetDexterityMod(me)) + ma);
+      RunToward(escortee);
+      SetDexterityMod(me, CInt(GetDexterityMod(me)) - ma);
+      waittime := 0;
+    else
+      var ma := 200 - CInt(GetDexterity(me));
+      SetDexterityMod(me, CInt(GetDexterityMod(me)) + ma);
+      walktoward(escortee);
+      SetDexterityMod(me, CInt(GetDexterityMod(me)) - ma);
+      waittime := 0;
+    endif
+  endif
+  if( (!GetStrength(escortee)) || (escortee.dead) || (dist(me,escortee) &gt; 15) )
+    guarding := 0;
+  endif
+  if(guarding)
+    Guard();
+  endif
+endfunction
+
+function AllCommand(evtype,what)
+  var mobs := ListMobilesNearLocation(master.x, master.y, master.z, 9, me.realm);
+  var eve := struct;
+  eve.+type := evtype;
+  eve.+source := me;
+  eve.+target := what;
+  SendEvent(me, eve);
+  foreach mob in mobs
+	if((GetObjProperty(mob, &quot;master&quot;) == me.master.serial) &amp;&amp; (mob.npctemplate == &quot;employed&quot;))
+	  SendEvent(mob, eve);
+	endif
+  endforeach
+endfunction
+
+function flee(opponent)
+  var runs := 0;
+  say(&quot;Argh! Run for your lives!&quot;);
+  while((Distance(me, opponent) &lt; 20) &amp;&amp; (runs &lt; 50))
+	RunAwayFrom(opponent);
+	runs := runs +1;
+	wait_for_event(0);
+  endwhile
+  say(&quot;Whew&quot;);
+  RestartScript(me);
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(SYSEVENT_SPEECH);
+  EnableEvents(SYSEVENT_ENGAGED);
+  EnableEvents(SYSEVENT_DAMAGED);
+  EnableEvents(SYSEVENT_ITEM_GIVEN);
+  EnableEvents(EVID_PEACEMADE);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH);
+  DisableEvents(SYSEVENT_ENGAGED);
+  DisableEvents(SYSEVENT_DAMAGED);
+  DisableEvents(SYSEVENT_ITEM_GIVEN);
+  DisableEvents(EVID_PEACEMADE);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/entranced.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/entranced.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/entranced.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,42 @@
+use npc;
+use os;
+use uo;
+
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;include/dist&quot;;
+
+var me := Self();
+
+program entranced()
+
+	var y := GetObjProperty(me, &quot;bardmaster&quot;);
+	var follower := &quot;no&quot;;
+	foreach x in EnumerateOnlineCharacters()
+		if (x.serial == y)
+			follower := x;
+		endif
+	endforeach
+
+	if (follower == &quot;no&quot;)
+		say(&quot;* The enchantment is broken! *&quot;);
+		me.script := GetObjProperty(me, &quot;script&quot;);
+		RestartScript(me);
+		EraseObjProperty(me, &quot;entrancedscript&quot;);
+		EraseObjProperty(me, &quot;bardmaster&quot;);
+		return 0;
+	endif
+
+	EraseObjProperty(me, &quot;bardmaster&quot;);
+
+	while (GetHp(me))
+
+	WalkToward(follower);
+
+	sleep(1);
+
+	endwhile
+
+endprogram
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/escortee.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/escortee.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/escortee.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,250 @@
+use npc;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;ai/main/mainLoopGood&quot;;
+include &quot;ai/combat/animalCombatEvent&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;include/skillLists&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:begging:begging&quot;;
+
+const HALT_THRESHOLD := 2;
+var following;
+var waittime;
+var escortee;
+var next_wander := ReadGameClock() + 10;
+var ev;
+var txt;
+var killtime := 0;
+var master;
+var spells := {};
+var me := Self();
+var cast_pct;
+var num_casts;
+var count_casts;
+var summons := 3;
+var graphics;
+var num_changes;
+var will_cast;
+var will_breathe;
+var flee_point;
+
+var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+var speechelem := FindConfigElem(npccfg, me.npctemplate);
+spells := GetConfigStringArray(speechelem, &quot;spell&quot;);
+cast_pct := speechelem.cast_pct;
+num_casts  := speechelem.num_casts;
+count_casts  := speechelem.count_casts;
+if(!cast_pct)
+  cast_pct := 10;
+endif
+flee_point := speechelem.flee_point;
+if(!flee_point)
+  flee_point := 10;
+endif
+
+program CastleGuard()
+  run_script_to_completion(&quot;:npcutils:NPCKeeper&quot;, me);
+  drop_anchor();
+  EnableEvents( SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED );
+  EnableEvents(SYSEVENT_OPPONENT_MOVED);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  set_priority(10);
+  var ph := SplitWords(me.name);
+  var myname := lower(ph[1]);
+  var destination := GetObjProperty(me, &quot;Dest&quot;);
+  SetObjProperty(me, &quot;Waiting&quot;, 1);
+  waittime := 120;
+  escortee := 0;
+  var arrived := 0;
+  while (1)
+    ev := os::wait_for_event(waittime);
+    case(ev.type)
+      SYSEVENT_SPEECH:      txt := lower(ev.text);
+                        if(txt[&quot;destination&quot;])
+                          TurnToward(ev.source);
+                          say(&quot;I am waiting for my escort to &quot; + destination + &quot;. Will you take me?&quot;);
+                        elseif(txt[&quot;i will take thee&quot;])
+                          if(!escortee)
+                            TurnToward(ev.source);
+                            escortee := ev.source;
+                            SetObjProperty(me, &quot;Escortee&quot;, (ev.source).serial);
+                            say(&quot;Lead on. You will recieve your payment when we reach &quot; + destination +&quot;.&quot;);
+                            SetAnchor( me.x, me.y, 20, 0 );
+                            killtime := ReadGameClock() + 1800;
+                            following := 1;
+                            waittime := 0;
+                          endif
+                        endif
+      SYSEVENT_ENGAGED:     say(&quot;Aaahhh! Help! Help!  I'm being oppressed!&quot;);
+                        Fight(ev.source);
+      SYSEVENT_DAMAGED:     if(ev.source)
+                          Fight(ev.source);
+                        else
+                          say( &quot;What sinister force is this!&quot; );
+                        endif
+    endcase
+	if(ReadGameClock() &gt;= next_wander)
+	  begpurse(me);
+	  if(!GetObjProperty(me, &quot;Waiting&quot;))
+        wander();
+      endif
+      next_wander := ReadGameClock() + 10;
+    elseif((ReadGameClock() &gt; killtime) &amp;&amp; (killtime != 0))
+      MoveCharacterToLocation(me, 1, 1, 0, MOVECHAR_FORCELOCATION);
+      SetObjProperty(me, &quot;guardkill&quot;, 1);
+      ApplyRawDamage(me, GetHp(me) + 100);
+      break;
+    endif
+    if(escortee)
+      arrived := checkdestination(me, destination);
+      if(arrived == 1)
+        idleloop();
+      endif
+    endif
+    if(following == 1)
+      waittime := 0;
+      Follow();
+    else
+      waittime := 10;
+    endif
+  endwhile
+endprogram
+
+function checkdestination(me, destination);
+  var coords := SplitWords(GetObjProperty(me, &quot;Coords&quot;));
+  var x1 := CInt(coords[1]);
+  var y1 := CInt(coords[2]);
+  var x2 := CInt(coords[3]);
+  var y2 := CInt(coords[4]);
+  if((me.x &gt;= x1) &amp;&amp; (me.x &lt;= x2))
+    if((me.y &gt;= y1) &amp;&amp; (me.y &lt;= y2))
+      say(&quot;We have arrived at &quot; + destination + &quot;. Here is your pay.&quot;);
+      case(GetObjProperty(me, &quot;Type&quot;))
+        &quot;peasant1&quot;:  CreateItemInContainer(escortee.backpack, 0xeed, RandomInt(50) + 200);
+        &quot;Mage&quot;:      CreateItemInContainer(escortee.backpack, 0xeed, RandomInt(150) + 250);
+        &quot;seeker&quot;:    CreateItemInContainer(escortee.backpack, 0xeed, RandomInt(150) + 350);
+        &quot;peasant2&quot;:  CreateItemInContainer(escortee.backpack, 0xeed, RandomInt(150) + 500);
+      endcase
+      return 1;
+    endif
+  endif
+  return 0;
+endfunction
+
+function idleloop()
+  while (1)
+    ev := os::wait_for_event(10);
+    case(ev.type)
+      SYSEVENT_SPEECH:      txt := lower(ev.text);
+                        if(txt[&quot;destination&quot;])
+                          TurnToward(ev.source);
+                          say(&quot;I do not wish to go anywhere.&quot;);
+                        elseif(txt[&quot;i will take thee&quot;])
+                          TurnToward(ev.source);
+                          say(&quot;I do not wish to go anywhere.&quot;);
+                        endif
+      SYSEVENT_ENGAGED:     say(&quot;Aaahhh! Help! Help!  I'm being oppressed!&quot;);
+                        Fight(ev.source);
+      SYSEVENT_DAMAGED:     if(ev.source)
+                          Fight(ev.source);
+                        endif
+    endcase
+	if(ReadGameClock() &gt;= next_wander)
+      wander();
+      grabloot();
+      next_wander := ReadGameClock() + 10;
+    elseif((ReadGameClock() &gt; killtime) &amp;&amp; (killtime != 0))
+      MoveCharacterToLocation(me, 1, 1, 0, MOVECHAR_FORCELOCATION);
+      ApplyRawDamage(me, GetHp(me) + 100);
+      break;
+    endif
+  endwhile
+endfunction
+
+function Follow()
+  var d := Distance(me, escortee);
+  if(d &gt; 15)
+    escortee := 0;
+	following := 0;
+    say(&quot;My escort seems to have abandoned me.&quot;);
+    waittime := 120;
+  elseif(d &lt;= 2)
+    waittime := 1;
+  else
+    if(GetObjProperty(me, &quot;Pause&quot;))
+      waittime := 2;
+    else
+      var ma := 200 - CInt(GetDexterity(me));
+      SetDexterityMod(me, CInt(GetDexterityMod(me)) + ma);
+	  walkToward(escortee);
+      SetDexterityMod(me, CInt(GetDexterityMod(me)) - ma);
+      waittime := 0;
+    endif
+  endif
+  if((!GetStrength(escortee)) || (escortee.dead) || (dist(me,escortee) &gt; 15) )
+    following := 0;
+  endif
+endfunction
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/firebreather.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/firebreather.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/firebreather.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,45 @@
+
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/fireCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+const MOVING_EFFECT_FIREBALL  := 0x36d4;
+const HALT_THRESHOLD := 8; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  var sleepdelay := 300 - (CInt(GetDexterity(me)) * 1.5);
+  if (sleepdelay &lt; 0)
+	sleepdelay := 0;
+  endif
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+	         sleepms(sleepdelay);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/goodCaster.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/goodCaster.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/goodCaster.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,84 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;:npcutils:speech&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:NPCCast&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopGood&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/spellCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;:begging:begging&quot;;
+
+const HALT_THRESHOLD := 10; // how close before he attacks?
+var LAST_BREATH := ReadGameClock();
+
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  if(GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  main_AI_loop(ReadGameClock() + 10);
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:              // the most likely, so first
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/helpPCs.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/helpPCs.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/helpPCs.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,79 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:speech&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopGood&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/warriorCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;:begging:begging&quot;;
+
+const HALT_THRESHOLD := 8; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program HelpPlayers()
+  SetWarMode( 0 );
+  main_AI_loop(ReadGameClock() + 10);
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/immobile.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/immobile.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/immobile.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,72 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopImmobile&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 5;
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  	SetWarMode( 0 );
+	main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  sleepms(100);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/immobileSpell.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/immobileSpell.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/immobileSpell.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,91 @@
+/////////////////////////////////////////////////////////////////////////////
+//
+//  killpcs.src: Kill player-characters
+//
+//  TODO: Some server support for only paying attention to 'enteredarea'
+//        and 'leftarea' events from PCs would be nice.
+//        we just use the graphic at the moment, so we'd fight
+//        NPCs too.  Oh well.
+//
+//  Author: ENS
+//
+//  Created: 4/98
+//
+//  Modified week of 6/15/99 by DW to allow speech and ranged attacks
+//
+/////////////////////////////////////////////////////////////////////////////
+
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopImmobile&quot;;
+include &quot;ai/combat/immobileFight&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;ai/combat/spellCombatEvent&quot;;
+include &quot;ai/setup/spellSetup&quot;;
+include &quot;:npcutils:NPCCast&quot;;
+
+const HALT_THRESHOLD := 10; // how close before he attacks?
+var LAST_BREATH := ReadGameClock();
+
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  sleepms(100);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/killAny.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/killAny.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/killAny.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,98 @@
+/////////////////////////////////////////////////////////////////////////////
+//
+//  killpcs.src: Kill player-characters
+//
+//  TODO: Some server support for only paying attention to 'enteredarea'
+//        and 'leftarea' events from PCs would be nice.
+//        we just use the graphic at the moment, so we'd fight
+//        NPCs too.  Oh well.
+//
+//  Author: ENS
+//
+//  Created: 4/98
+//
+//  Modified week of 6/15/99 by DW to allow speech and ranged attacks
+//
+/////////////////////////////////////////////////////////////////////////////
+
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;ai/main/mainLoopKillAny&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/main/defaultNonCombatEvent&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/main/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 10; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+    
+    drop_anchor();
+
+    EnableEvents( SYSEVENT_ENGAGED );
+    EnableEvents( SYSEVENT_DISENGAGED );
+    EnableEvents( SYSEVENT_DAMAGED );
+    EnableEvents( SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, HALT_THRESHOLD );
+    EnableEvents( SYSEVENT_OPPONENT_MOVED );
+
+    SetWarMode( 0 );
+
+	if (GetObjProperty(me, &quot;frozen&quot;))
+		me.frozen := 1;
+	endif
+
+    main_AI_loop();
+
+endprogram
+
+/////////////////////////////////////////////////////////////////////////////
+//
+//  These types fight singlemindedly, until the quarry is dead.
+//  There is no way out but death.
+//
+/////////////////////////////////////////////////////////////////////////////
+
+
+
+/////////////////////////////////////////////////////////////////////////////
+//
+//  CloseDistance - close the distance between self and an opponent.
+//  Returns: 1 if distance is 0 or 1 (no move necessary)
+//           0 if distance is &gt;= 2 (may still need to move)
+//
+//  This is a .EM-file candidate.
+//
+/////////////////////////////////////////////////////////////////////////////
+function CloseDistance( opponent )
+
+
+    case (Distance( me, opponent ))
+        1:              // the most likely, so first
+        0:
+            return 1;
+        default:
+            RunToward( opponent );
+		sleepms(500);
+            return 0;
+    endcase
+
+endfunction
+
+
+// Look around me for humans to fight.

Added: trunk/096/pkg/mobiles/oldAI/killPCs.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/killPCs.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/killPCs.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,54 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/killPCsSetup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 8; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+
+    	SetWarMode( 0 );
+    	main_AI_loop();
+
+endprogram
+
+function CloseDistance( opponent )
+
+var sleepdelay := 400 - (CInt(GetDexterity(me)) * 1.5);
+
+	if (sleepdelay &lt; 0)
+		sleepdelay := 0;
+	endif
+
+
+    case (Distance( me, opponent ))
+        1:              // the most likely, so first
+        0:
+            return 1;
+        default:
+            RunToward( opponent );
+		sleepms(sleepdelay);
+            return 0;
+    endcase
+
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/main/closeDistance.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/closeDistance.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/closeDistance.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,100 @@
+var lastface;
+var nexttry;
+
+function CloseDistance(opponent)
+  var dst := 1;
+  var d := Distance(me, opponent);
+  if (d &lt;= dst)
+    return 1;
+  elseif((d &gt;= 25) or (opponent.concealed) or (opponent.hidden))
+    return 2;
+  else
+    sleepms(3);
+    RunToward( opponent );
+    sleepms(3);
+    RunToward( opponent );
+    sleepms(3);
+    RunToward( opponent );
+    Opendoors(me);
+    if(!(CheckLineOfSight(me, opponent)) and (nexttry &lt; ReadGameClock()))
+      nexttry :=  ReadGameClock() + 5;
+      if(NavigateTo(opponent))
+        return 2;
+      endif
+    endif
+  endif
+endfunction
+
+function Opendoors(me)
+  foreach door in ListItemsNearLocation(me.x, me.y, me.z, 1, me.realm)
+    if((door.isa(POLCLASS_DOOR)) and (!door.locked))
+      if(!GetObjProperty(door, &quot;WhenOpened&quot; ))
+        start_script(&quot;:doors:openDoor&quot;, door);
+      endif
+      EraseObjProperty(door, &quot;#inuse&quot;);
+    endif
+  endforeach
+endfunction
+
+function NavigateTo(destination);
+  var dX := 0;
+  var dY := 0;
+  var maxdist := 30;
+  for X:=1 to 24
+    sleepms(1);
+    if (CheckLOSat(me, me.x + X - 12, me.y, me.z) and CheckLOSat(destination, me.x + X - 12, me.y, me.z))
+      if(coordist(destination.x , destination.y , me.x+X-12 , me.y) &lt; maxdist)
+        dX := me.x+X-12;
+        dY := me.y;
+        maxdist := coordist(destination.x , destination.y , me.x+X-12 , me.y );
+      endif
+    else
+      for Y:=1 to 24
+        if(CheckLOSat(me, me.x + X - 12, me.y + Y - 12, me.z) and CheckLOSat(destination, me.x+X-12, me.y+Y-12, me.z))
+          if(coordist(destination.x , destination.y , me.x+X-12 , me.y+Y-12 ) &lt; maxdist)
+            dX := me.x+X-12;
+            dY := me.y+Y-12;
+            maxdist := coordist(destination.x , destination.y , me.x + X - 12 , me.y);
+          endif
+        endif
+      endfor
+    endif
+  endfor
+  if(dX)
+    return CloseDistancetoLocation(dX, dY);
+  endif
+  return 1;
+endfunction
+
+function CloseDistancetoLocation(x, y)
+  var chk := 0;
+  repeat
+    RunTowardLocation(x, y);
+    RunTowardLocation(x, y);
+    RunTowardLocation(x, y);
+    var face := me.facing;
+    if(ABS(lastface - face) == 4)
+      lastface := face;
+      chk := chk + 1;
+    endif
+    lastface := face;
+  until((coordist( me.x , me.y , x , y ) &lt;= 0) or (chk &gt; 1));
+  if(chk &gt; 1)
+    return 1;
+  endif
+  return 0;
+endfunction
+
+function NavigateAway(targ)
+  var face;
+  var runaway := 0;
+  repeat
+    face := me.facing;
+    WalkToward(targ);
+    WalkToward(targ);
+    WalkToward(targ);
+    if(ABS(me.facing - face) = 4)
+      runaway := runaway + 1;
+    endif
+  until ((Distance(me, targ) &lt;= 1) or (runaway &gt; 2) or (Distance(me, targ) &gt; 20));
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/defaultNonCombatEvent.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/defaultNonCombatEvent.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/defaultNonCombatEvent.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,3 @@
+function process_noncombat_event(opponent)
+  return 0;
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/killPCsLoop.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/killPCsLoop.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/killPCsLoop.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,97 @@
+
+function main_AI_loop()
+  var ev := os::wait_for_event(0);
+  var wanders := 60;
+  var next_loot := ReadGameClock() + 20;
+  EnableMainEvents();
+  var rint := 0;
+  while(1)
+    look_around();
+    wander();
+    if(ReadGameClock() &gt; next_loot)
+      grabloot();
+      next_loot := ReadGameClock() + 10;
+    endif
+    rint := RandomInt(4) + 1;
+    if(rint == 4)
+      PlaySoundEffect(me, idlesnd1);
+    elseif(rint == 3)
+      PlaySoundEffect(me, idlesnd2);
+    endif
+    wanders := wanders +1;
+    if(wanders &gt;= 60)
+      wanders := 0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      case(ev.type)
+        SYSEVENT_ENTEREDAREA:   if((!ev.source.npctemplate) or (ev.source.script == &quot;employed&quot;) || (ev.source.script == &quot;tamed&quot;))
+                                  Fight(ev.source);
+                                endif
+        SYSEVENT_ENGAGED:       Fight(ev.source);
+        EVID_ALL_ATTACK_CMD:    Fight(ev.source);
+        SYSEVENT_DAMAGED:       Fight(ev.source);
+        EVID_HERDING:           Herding(ev);
+      endcase
+    endif
+  endwhile
+endfunction
+
+function look_around()
+  foreach npc in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    if((!npc.npctemplate) || (npc.script == &quot;employed&quot;) || (npc.script == &quot;tamed&quot;))
+      Fight(npc);
+    endif
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction  
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/loot.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/loot.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/loot.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,75 @@
+include &quot;:npcutils:NPCBackpacks&quot;;
+
+const STARTHAIR := 0x2030;
+const ENDHAIR := 0x2060;
+
+function grabloot()
+  if(GetObjProperty(me,&quot;noloot&quot;) || GetObjProperty(me, &quot;summoned&quot;))
+    return;
+  endif
+  if((me.script == &quot;animal&quot;) || (me.script == &quot;meek&quot;) || (me.script == &quot;barker&quot;) || (me.script == &quot;wolf&quot;))
+    return;
+  endif
+  var numitems := 0;
+  var mypack := 0;
+  if(!GetObjProperty(me, &quot;serial&quot;))
+    SetObjProperty(me, &quot;serial&quot;, me.serial);
+  endif
+  mypack := FindMyPack(me.serial);
+  var near_items := ListItemsNearLocation(me.x, me.y, me.z,6, me.realm);
+  foreach item in near_items
+    if(CheckLineOfSight(me, item))
+      var sh := GetStandingHeight(item.x, item.y, item.z, item.realm);
+      if(sh.multi || sh.multi.serial)
+        break;
+      endif
+      var info := CInt(GetMapInfo(item.x, item.y, me.realm).landtile);
+      if((info &gt; CInt(0x405)) &amp;&amp;(info &lt; CInt(0x456)))
+        return;
+      endif
+      if((item.objtype == UOBJ_CORPSE) &amp;&amp; (!GetObjProperty(item.objtype, &quot;npctemplate&quot;)))
+        var items := { };
+        foreach thingie in EnumerateItemsInContainer(item)
+          if((thingie.objtype &lt; STARTHAIR || thingie.objtype &gt; ENDHAIR) &amp;&amp;(!CInt(GetObjProperty(thingie,&quot;#ignoreit&quot;))))
+            items[len(items) + 1] := thingie;
+          endif
+        endforeach
+        if(len(items))
+          RunToIt(me,item);
+          if(Distance(me, item) &lt; 2)
+            foreach thingie in items
+              // Adjusted to stop any form of script lag causing items to be looted after being
+              // moved to the player's backpack.
+              if(thingie.container == item.container)
+                // Changed from mypack to me.backpack. Upon death npcs would not have the item
+                // on them for loot, causing looted stuff to be left in their storage. BAD NPC!
+                if(MoveItemToContainer(thingie, me.backpack))
+                  say(&quot;You notice &quot; + me.name + &quot; rummage through a corpse and take an item.&quot;);
+                  sleep(2);
+                  break;
+                else
+                  SetObjProperty(thingie,&quot;#ignoreit&quot;,1);
+                endif
+              endif
+            endforeach
+          endif
+        else
+          SetObjProperty(item,&quot;#ignoreit&quot;,1);
+        endif
+      endif
+      break;
+    endif
+  endforeach
+endfunction
+
+function RunToIt(me,item)
+  var numsteps;
+  for(numsteps := 0; numsteps &lt; 8; numsteps := numsteps +1)
+    if(Distance(me, item) &lt; 2)
+      return;
+    else
+      walktoward(item);
+    endif
+    look_around();
+  endfor
+endfunction 
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoop.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoop.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoop.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,96 @@
+function main_AI_loop(next_wander := 0)
+  var ev;
+  var looter := GetObjProperty(me, &quot;looter&quot;);
+  var wanders := 60;
+  look_around();
+  EnableMainEvents();
+  while(1)
+    ev := os::wait_for_event(5);
+    repeat
+      case(ev.type)
+        SYSEVENT_ENGAGED:
+        SYSEVENT_DAMAGED:     if(ev.source)
+                                Fight(ev.source);
+                                endif
+        SYSEVENT_ENTEREDAREA: if((!critter.npctemplate) ||(critter.script == &quot;tamed&quot;) || (critter.script == &quot;employed&quot;))
+                                Fight(ev.source);
+                              endif
+        EVID_HERDING:         Herding(ev);
+      endcase
+    until(!(ev := os::wait_for_event(5)));
+    if(ReadGameClock() &gt; next_wander)
+      if(!me.hidden)
+        wander();
+      endif
+      if(looter)
+        grabloot();
+      endif
+      next_wander := ReadGameClock()+1;
+      wanders := wanders +1;
+      if(wanders &gt; 60)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+    endif
+  endwhile
+endfunction
+
+function look_around()
+  foreach critter in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    if((!critter.npctemplate) ||(critter.script == &quot;tamed&quot;) || (critter.script == &quot;employed&quot;))
+      Fight(critter);
+      return;
+    endif
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  EnableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_DAMAGED + SYSEVENT_ENGAGED, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED);
+  DisableEvents(SYSEVENT_DAMAGED);
+  DisableEvents(SYSEVENT_ENTEREDAREA);
+  cleareventque();
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopAnimal.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopAnimal.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopAnimal.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,89 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  EnableMainEvents();
+  while(1)
+    wander();
+    wanders := wanders +1;
+    if(wanders &gt; 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_DAMAGED: Fight(ev.source);
+          SYSEVENT_ENGAGED: Fight(ev.source);
+          EVID_HERDING:     Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(5)));
+    endif
+   endwhile
+endfunction
+
+function RunLikeHell(opponent)
+  var ev;
+  while((opponent)&amp;&amp; not(opponent.dead || opponent.hidden || opponent.concealed)&amp;&amp;(dist(me,opponent)&lt; 25))
+    WalkAwayFrom(opponent);
+    repeat
+      case(ev.type)
+        SYSEVENT_DAMAGED:  Fight(ev.source);  return;
+      endcase
+    until(!(ev := os::wait_for_event(1)));
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopBarker.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopBarker.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopBarker.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,149 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var mynoise := bark();
+  EnableMainEvents();
+  while(1)
+    wander();
+    wanders := wanders +1;
+    if(wanders &gt; 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_ENTEREDAREA: if(!ev.source.isA(POLCLASS_NPC))
+                                  PlaySoundEffect(me, mynoise);
+                                endif
+          SYSEVENT_DAMAGED:     Fight(ev.source);
+          SYSEVENT_ENGAGED:     RunLikeHell(ev.source);
+          EVID_HERDING:           Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(2)));
+    endif
+  endwhile
+endfunction
+
+function RunLikeHell(opponent)
+  var ev;
+  while((opponent)&amp;&amp; not(opponent.dead || opponent.hidden || opponent.concealed)&amp;&amp;(dist(me,opponent)&lt; 25))
+    WalkAwayFrom(opponent);
+    repeat
+      case(ev.type)
+        SYSEVENT_DAMAGED: if(RandomInt(3)==1)
+                            Fight(ev.source);
+                            return;
+                          endif
+      endcase
+    until(!(ev := os::wait_for_event(1)));
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function bark()
+  var noise := 0;
+  case(me.graphic)
+    0x06: case(RandomInt(3))   //bird
+            0: noise := 0x1b;
+            1: noise := 0x18;
+            2: noise := 0x277;
+          endcase
+    0xc9: noise := 0x6b;       //cat
+    0xe7:
+    0xe9:
+    0xe8:
+    0xd8: noise := 0x7a;       //cow
+    0xd9: case(RandomInt(2))   //dog
+            0: noise := 0x86;
+            1: noise := 0x87;
+          endcase
+    0xd1: case(RandomInt(2))   //goat
+            0: noise := 0x9a;
+            1: noise := 0x9b;
+          endcase
+    0xcb: noise := 0xc6;       //pig
+    0xcc:
+    0xc8:
+    0xe2:
+    0xe4: case(RandomInt(4))   //horses
+            0: noise := 0xa9;
+            1: noise := 0xaa;
+            2: noise := 0xab;
+            3: noise := 0xac;
+          endcase
+    0x51: case(RandomInt(4))   //toad
+            0: noise := 0x267;
+            1: noise := 0x268;
+            2: noise := 0x26a;
+            3: noise := 0x26d;
+          endcase
+    0xd3: case(RandomInt(5))   //bears
+            0: noise := 0xa4;
+            1: noise := 0xa5;
+            2: noise := 0xa6;
+            3: noise := 0xa7;
+            4: noise := 0xa8;
+          endcase
+    0x1d: case(RandomInt(3))   //gorilla
+            0: noise := 0x9f;
+            1: noise := 0xa0;
+            2: noise := 0xa2;
+          endcase
+  endcase
+  return noise;
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopBladeSpirit.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopBladeSpirit.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopBladeSpirit.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,51 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 0;
+  EnableMainEvents();
+  look_around();
+  while(1)
+    ev := os::wait_for_event(1);
+	if(wanders &gt; 60)
+	  wanders :=0;
+	  ev := sleepmode();
+	endif
+	if(ev)
+	  repeat
+	    case(ev.type)
+          SYSEVENT_ENTEREDAREA:
+          EVID_ENGAGED:
+          EVID_DAMAGED:         Fight(ev.source);
+	    endcase
+      until(!(ev := os::wait_for_event(1)));
+    endif
+    look_around();
+    wander();
+	wanders := wanders +1;
+  endwhile
+endfunction
+
+function look_around()
+  var him, dista;
+  var dis := 20;
+  foreach critter in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    dista := Distance(me, critter);
+    if(dista &lt; dis)
+      if((critter.npctemplate != &quot;bladespirit&quot;) &amp;&amp; (critter.npctemplate != &quot;vortex&quot;))
+        him := critter;
+        dis := dista;
+      endif
+    endif
+  endforeach
+  if(him)
+    Fight(him);
+  endif
+endfunction
+
+function EnableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + EVID_LEFTAREA + EVID_DISENGAGED + EVID_OPPONENT_MOVED);
+  EnableEvents(EVID_ENGAGED + EVID_DAMAGED + EVID_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(EVID_ENGAGED + EVID_DAMAGED + EVID_ENTEREDAREA);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopCat.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopCat.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopCat.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,89 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var hatelist := &quot;bird eagle rat chicken&quot;;
+  EnableMainEvents();
+  while(1)
+    wander();
+    wanders := wanders +1;
+    if(wanders &gt; 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_ENTEREDAREA: if(!ev.source.isA(POLCLASS_NPC))
+                                  PlaySoundEffect(me, 0x6b);
+                                elseif(hatelist[ev.source.npctemplate])
+                                  Fight(ev.source);
+                                endif
+          SYSEVENT_DAMAGED:
+          SYSEVENT_ENGAGED:     Fight(ev.source);
+          EVID_HERDING:         Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(2)));
+    endif
+  endwhile
+endfunction
+
+function look_around()
+  var hatelist := &quot;bird eagle rat chicken&quot;;
+  foreach critter in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    if((critter.npctemplate)&amp;&amp;(hatelist[critter.npctemplate]))
+      Fight(critter);
+      return;
+    endif
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopChicken.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopChicken.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopChicken.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,103 @@
+const GFX_UNSHORN_SHEEP := 0xcf;
+const GFX_SHORN_SHEEP := 0xdf;
+
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var nextlay := CInt(ReadGameClock()+ 3600);
+  var nextbark := ReadGameClock()+ 30;
+  var next_wander := 0;
+  EnableMainEvents();
+  while(1)
+    if(ReadGameClock()&gt; next_wander)
+      wander();
+      next_wander := ReadGameClock() + 5;
+      wanders := wanders + 1;
+      if(wanders &gt; 60)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_DAMAGED: RunLikeHell(ev.source);
+          SYSEVENT_ENGAGED: RunLikeHell(ev.source);
+          EVID_HERDING:     Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(5)));
+    endif
+    if(ReadGameClock()&gt; nextlay)
+      nextlay := ReadGameClock()+ 2600 + CInt(3800 * RandomInt(2));
+      CreateItemAtLocation(me.x, me.y, me.z, &quot;egg&quot;, 1, me.realm);
+    endif
+    if(ReadGameClock()&gt; nextbark)
+      nextbark := ReadGameClock() + ((RandomInt(5) + 1)* 60);
+      PlaySoundEffect(me,0x70);
+    endif
+  endwhile
+endfunction
+
+function RunLikeHell(opponent)
+  var ev;
+  while((opponent)&amp;&amp; not (opponent.dead || opponent.hidden || opponent.concealed)&amp;&amp; (dist(me,opponent)&lt; 25))
+    RunAwayFrom(opponent);
+    repeat
+    until(!(ev := os::wait_for_event(1)));
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED + SYSEVENT_ENTEREDAREA);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED, 8);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopCow.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopCow.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopCow.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,95 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 0;
+  EnableMainEvents();
+  EnableEvents(SYSEVENT_DOUBLECLICKED);
+  while(1)
+    wander();
+    wanders := wanders +1;
+    if(wanders &gt; 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_DOUBLECLICKED: print(&quot;tipped&quot;);
+          if(((RandomInt(19) + 1) == 10) || (ev.source.cmdlevel &gt;= 3))
+                                    PlaySoundEffect(me, 0x79);
+                                    PerformAction(me, CInt(0x8));
+                                  endif
+          SYSEVENT_DAMAGED:       Fight(ev.source);
+          SYSEVENT_ENGAGED:       Fight(ev.source);
+          EVID_HERDING:           Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(5)));
+    endif
+   endwhile
+endfunction
+
+function RunLikeHell(opponent)
+  var ev;
+  while((opponent)&amp;&amp; not(opponent.dead || opponent.hidden || opponent.concealed)&amp;&amp;(dist(me,opponent)&lt; 25))
+    WalkAwayFrom(opponent);
+    repeat
+      case(ev.type)
+        SYSEVENT_DAMAGED:  Fight(ev.source);  return;
+      endcase
+    until(!(ev := os::wait_for_event(1)));
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopCrier.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopCrier.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopCrier.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,69 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var next_wander := ReadGameClock();
+  EnableMainEvents();
+  while(1)
+    if(ReadGameClock() &gt; next_wander)
+      SpoutTheNews();
+      wanders := wanders +1;
+      next_wander := ReadGameClock()+60;
+      if(wanders &gt; 60)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+    else
+      ev := os::wait_for_event(60);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_SPEECH:  if(!ev.source.isA(POLCLASS_NPC))
+                              if(lower(ev.text) == &quot;news&quot;)
+                                wanders :=0;
+                                next_wander := ReadGameClock()+60;
+                                SpoutTheNews();
+                              endif
+                            endif
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED: Fight(ev.source);
+                            ReturnHome();
+        endcase
+      until(!(ev := os::wait_for_event(60)));
+    endif
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  DisableEvents(SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED, HALT_THRESHOLD);
+  EnableEvents(SYSEVENT_SPEECH, 3);
+  DisableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED);
+  DisableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function SpoutTheNews()
+  var news := GetGlobalProperty(&quot;news&quot;);
+  if(!news)
+    say(&quot;No news is good news.&quot;);
+    return;
+  endif
+  var i;
+  for(i := 1; i &lt;= len(news); i := i + 1)
+    say(news[i]);
+    sleep(2);
+  endfor
+endfunction
+
+function ReturnHome()
+  var myhome := GetObjProperty(me,&quot;myhome&quot;);
+  MoveCharacterToLocation(me,myhome[1],myhome[2],myhome[3],MOVECHAR_FORCELOCATION);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopGood.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopGood.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopGood.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,49 @@
+function main_AI_loop(next_wander := 0)
+  var ev;
+  var wanders := 60;
+  /*var next_loot := ReadGameClock() + 20;*/  // variable unused in this AI type
+  EnableMainEvents();
+  while(1)
+    if(ReadGameClock() &gt; next_wander)
+      wander();
+      next_wander := ReadGameClock()+3;
+      wanders := wanders +1;
+      if(wanders &gt; 60)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_SPEECH:     if(!ev.source.isA(POLCLASS_NPC))
+                                 wanders :=0;
+                                 next_wander := ReadGameClock()+30;
+                                 check_speech(ev.text, ev.source);
+                               endif
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED:    Fight(ev.source);
+          SYSEVENT_ITEM_GIVEN: next_wander := ReadGameClock()+60;
+                               TakeItem(ev.source,ev.item);
+        endcase
+      until(!(ev := os::wait_for_event(5)));
+    endif
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED, HALT_THRESHOLD);
+  EnableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED);
+  DisableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopImmobile.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopImmobile.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopImmobile.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,42 @@
+function main_AI_loop()
+  var next_wander := ReadGameClock() + 10;
+  var ev;
+  var wanders := 120;
+  EnableMainEvents();
+  while(1)
+    if(ReadGameClock() &gt; next_wander)
+      wanders := wanders +1;
+      next_wander := ReadGameClock()+120;
+      if(wanders &gt; 60)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+    else
+      ev := os::wait_for_event(120);
+    endif
+    repeat
+      if(ev)
+        case(ev.type)
+          SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) ||(((ev.source).script == &quot;employed&quot;) ||((ev.source).script == &quot;tamed&quot;)))
+                                  Fight(ev.source);
+                                endif
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED:     Fight(ev.source);
+        endcase
+      endif
+    until(!(ev := os::wait_for_event(120)));
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopKillAny.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopKillAny.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopKillAny.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,87 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var next_loot := ReadGameClock() + 20;
+  EnableMainEvents();
+  look_around();
+  while(1)
+    if(ReadGameClock() &gt; next_loot)
+      grabloot();
+      next_loot := ReadGameClock() + 5;
+    else
+      wander();
+    endif
+    wanders := wanders +1;
+    if(wanders &gt; 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_ENTEREDAREA:
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED:     Fight(ev.source);
+          EVID_HERDING:         Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(1)));
+    endif
+   endwhile
+endfunction
+
+function look_around()
+  foreach critter in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    Fight(critter);
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopMeek.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopMeek.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopMeek.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,98 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var next_loot := ReadGameClock() + 20;
+  var next_wander := 0;
+  EnableMainEvents();
+  while(1)
+    if(ReadGameClock() &gt; next_loot)
+      grabloot();
+      next_loot := ReadGameClock() + 10;
+      ev := os::wait_for_event(3);
+    else
+      if(ReadGameClock() &gt; next_wander)
+        wander();
+        wanders := wanders +1;
+        next_wander := ReadGameClock()+4;
+        if(wanders &gt; 60)
+          wanders :=0;
+          ev := sleepmode();
+        else
+          ev := os::wait_for_event(3);
+        endif
+      else
+        ev := os::wait_for_event(3);
+      endif
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_SPEECH:     if(!ev.source.isA(POLCLASS_NPC))
+                                 next_wander := ReadGameClock() + 30;
+                                 check_speech(ev.text, ev.source);
+                               endif
+          SYSEVENT_DAMAGED:
+          SYSEVENT_ENGAGED:    Run(ev.source);
+          SYSEVENT_ITEM_GIVEN: next_wander := ReadGameClock()+60;
+                               TakeItem(ev.source,ev.item);
+          EVID_HERDING:        Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(1)));
+    endif
+ endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED, HALT_THRESHOLD);
+  EnableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED);
+  DisableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopQuestie.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopQuestie.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopQuestie.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,189 @@
+include &quot;include/attributes&quot;;
+function main_AI_loop()
+
+    var ev;
+    var wanders := 60;
+    var next_offer := ReadGameClock();
+    var next_wander := 0;
+    var evtext;
+    var resetquest := 0;
+
+    EnableMainEvents();
+
+    while (1)
+
+	if (ReadGameClock() &gt; next_wander)
+        	wander();
+		next_wander := ReadGameClock()+2;
+		wanders := wanders +1;
+		if (wanders &gt; 60)
+			wanders :=0;
+			if (!look_around())
+			if (!resetquest)
+				if (master.serial == me.serial)
+					if (!slave)
+						MoveCharacterToLocation(me,1,1,0,MOVECHAR_FORCELOCATION);
+						SetObjProperty(me,&quot;guardkill&quot;,1);
+						ApplyRawDamage( me, GetMaxHp(me) + 3 );
+					endif
+				else
+					if (!master)
+						MoveCharacterToLocation(me,1, 1, 0,MOVECHAR_FORCELOCATION);
+						SetObjProperty(me,&quot;guardkill&quot;,1);
+						ApplyRawDamage( me, GetMaxHp(me) + 3 );
+					endif
+				endif
+			else
+				MoveCharacterToLocation(me,1, 1, 0,MOVECHAR_FORCELOCATION);
+				SetObjProperty(me,&quot;guardkill&quot;,1);
+				ApplyRawDamage( me, GetMaxHp(me) + 3 );
+			endif
+			endif
+			ev := sleepmode();
+	    	endif
+	else
+		ev := os::wait_for_event( 3 );
+	endif
+
+	if (ev)
+        repeat
+            case (ev.type)
+                SYSEVENT_SPEECH:
+	    		next_wander := ReadGameClock()+30;
+			evtext := lower(ev.text);
+			if (evtext[&quot;take&quot;])
+				GiveQuestItem(ev.source);
+			elseif ( next_offer &lt; ReadGameClock() )
+				next_offer := ReadGameClock()+45;
+				TurnToward(ev.source);
+				if (!OfferQuest())
+		    			check_speech(ev.text, ev.source);
+				endif
+			else
+		    		check_speech(ev.text, ev.source);
+			endif
+		SYSEVENT_ENTEREDAREA:
+		    if (!ev.source.isA(POLCLASS_NPC))
+		    	YellToFriend(ev.source);
+		    endif
+                SYSEVENT_ENGAGED:
+                SYSEVENT_DAMAGED:
+                    Fight( ev.source );
+		SYSEVENT_ITEM_GIVEN:
+		    wanders :=0;
+		    next_wander := ReadGameClock()+30;
+		    if ( GetObjProperty(ev.item,&quot;slave&quot;) == CInt(me.serial) )
+			TakeQuestItem(ev.source,ev.item);
+			resetquest := 1;
+		    else
+			TakeItem(ev.source,ev.item);
+		   endif
+            endcase
+        until (! (ev := os::wait_for_event(2)) );
+	endif
+
+   endwhile
+
+endfunction
+
+function look_around()
+
+	foreach critter in ListMobilesNearLocation( me.x,me.y,me.z, 10, me.realm );
+          if (!critter.isA(POLCLASS_NPC))
+		return 1;
+          endif
+	endforeach
+
+	return 0;
+
+endfunction
+
+function EnableMainEvents()
+
+    DisableEvents( SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED );
+    EnableEvents( SYSEVENT_SPEECH, 2 );
+    EnableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD );
+    EnableEvents( SYSEVENT_ITEM_GIVEN );
+
+endfunction
+
+function DisableMainEvents()
+
+    DisableEvents( SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA + SYSEVENT_ITEM_GIVEN );
+
+endfunction
+
+function OfferQuest()
+
+	if ( questtype &lt; 2 )
+		return OfferMailBoyQuest();
+	endif
+
+	return 0;
+
+endfunction
+
+function OfferMailBoyQuest()
+
+	var item := 0;
+	var slavetown;
+	if (me.serial == master.serial)
+		item := HasQuestItem(me, slave);
+		if (item)
+			slavetown := GetObjProperty(me,&quot;slavetown&quot;);
+			say(&quot;I have &quot;+ item.desc + &quot; that I need delivered to &quot;+slave.name+&quot; in &quot; + slavetown+&quot;.&quot;);
+			sleep(1);
+			say(&quot;If you will [take] it, &quot;+ slave.name + &quot; will pay you.&quot;);
+			return 1;
+		endif
+	else
+		if (!master)
+			return 0;
+		else
+			item := HasQuestItem(master, me);
+			slavetown := WhatTown(master);
+			if ( (item) &amp;&amp; (slavetown) )
+				say(master.name + &quot; in &quot; + slavetown + &quot; has &quot; + item.desc + &quot; for me.&quot;);
+				sleep(1);
+				say(&quot;If you will bring it to me, I will pay you.&quot;);
+				return 1;
+			endif
+		endif
+	endif
+	return 0;
+
+endfunction
+
+function GiveQuestItem(you)
+
+	var item := HasQuestItem(me, slave);
+	if (item)
+		var slavetown := GetObjProperty(me,&quot;slavetown&quot;);
+		say(&quot;Here is &quot;+item.desc+&quot; for &quot;+slave.name+&quot; in &quot;+slavetown+&quot;.&quot;);
+		say(&quot;Take it to &quot;+ slave.name + &quot; for your payment.&quot;);
+		MoveItemToContainer(item,you.backpack);
+	endif
+
+endfunction
+
+function HasQuestItem(who, forwhom)
+
+	foreach item in EnumerateItemsInContainer(who.backpack)
+		if ( GetObjProperty(item,&quot;slave&quot;) == forwhom.serial )
+			return item;
+		endif
+	endforeach
+	return 0;
+
+endfunction
+
+function TakeQuestItem(you, it)
+
+	TurnToward(you);
+	say(&quot;Oh this must be from &quot;+master.name+&quot;!  Thank you for bringing it!&quot;);
+	say(&quot;And here is your pay!&quot;);
+	DestroyItem(it);
+	var goldamount := ((RandomInt(3)+2)*100)+RandomInt(100);
+	CreateItemInContainer(you.backpack,&quot;goldcoin&quot;,goldamount);
+
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopSheep.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopSheep.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopSheep.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,122 @@
+include &quot;include/sound&quot;;
+include &quot;include/tileEffects&quot;;
+include &quot;include/attributes&quot;;
+
+
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var next_wander := 0;
+  var next_regrow := ReadGameClock() + 1800;
+  var nextbark := ReadGameClock() + 30;
+  EnableMainEvents();
+  while (1)
+    if(ReadGameClock() &gt; next_wander)
+      wander();
+      next_wander := ReadGameClock()+5;
+      wanders := wanders +1;
+      if(wanders &gt; 20)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+    else
+      ev := os::wait_for_event(15);
+    endif
+    if(ev)
+      case (ev.type)
+        SYSEVENT_DOUBLECLICKED: if(((RandomInt(499) + 1) == 250) || (ev.source.cmdlevel &gt;= 3))
+                                  PlaySoundEffect(me, 0xd7);
+                                  sleepms(10);
+                                  PlaySoundEffect(me, SFX_SPELL_EXPLOSION);
+                                  PlayStationaryEffect(me.x, me.y, me.z, FX_EXPLODE_3, 7, 0x10,0,me.realm);
+                                  sleepms(5);
+                                  MoveCharacterToLocation(me,0,0,0,MOVECHAR_FORCELOCATION);
+                                  ApplyRawDamage(me, GetHp(me) + 3);
+                                endif
+        SYSEVENT_ENGAGED:       RunLikeHell(ev.source);
+        EVID_HERDING:           Herding(ev);
+      endcase
+    endif
+    if(ReadGameClock() &gt; next_regrow)
+      next_regrow := ReadGameClock()+1800;
+      if(me.graphic == 223)
+        me.graphic := 207;
+      endif
+    endif
+    if(ReadGameClock() &gt; nextbark)
+      nextbark := ReadGameClock() + ((RandomInt(30)+1) + 60);
+      case (RandomInt(2))
+        0: PlaySoundEffect(me,0xd7);
+        1: PlaySoundEffect(me,0xd8);
+      endcase
+    endif
+  endwhile
+endfunction
+
+function RunLikeHell(opponent)
+  var ev;
+  while((opponent) &amp;&amp; not (opponent.dead || opponent.hidden || opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 25))
+        RunAwayFrom(opponent);
+    repeat
+        case (ev.type)
+      SYSEVENT_DAMAGED: if(RandomInt(3) == 1)
+                          Fight(ev.source);
+                                  return;
+                        endif
+    endcase
+    until (!(ev := os::wait_for_event(1)));
+  endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_DOUBLECLICKED + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopSlime.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopSlime.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopSlime.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,44 @@
+function main_AI_loop(next_wander := 0)
+  var ev;
+  var wanders := 60;
+  EnableMainEvents();
+  while(1)
+    ev := os::wait_for_event(5);
+    repeat
+      case(ev.type)
+        SYSEVENT_ENGAGED:
+        SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) ||(((ev.source).script == &quot;employed&quot;) ||((ev.source).script == &quot;tamed&quot;)))
+                                RunAwayFrom( ev.source);
+                              endif
+        SYSEVENT_DAMAGED:     if(ev.source)
+                                Fight( ev.source);
+                              endif
+      endcase
+    until(!(ev := os::wait_for_event(1)));
+    if(ReadGameClock() &gt; next_wander)
+      wander_around();
+      next_wander := ReadGameClock()+1;
+      wanders := wanders +1;
+      if(wanders &gt; 60)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+    endif
+ endwhile
+endfunction
+
+function look_around()
+  return;
+endfunction
+
+function EnableMainEvents()
+  EnableEvents( SYSEVENT_DAMAGED);
+  EnableEvents( SYSEVENT_ENTEREDAREA + SYSEVENT_ENGAGED, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents( SYSEVENT_ENGAGED);
+  DisableEvents( SYSEVENT_DAMAGED);
+  DisableEvents( SYSEVENT_ENTEREDAREA);
+  cleareventque();
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/mainLoopWolf.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/mainLoopWolf.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/mainLoopWolf.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,113 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var hatelist := &quot;animal cat barker tamed chicken sheep bird&quot;;
+  EnableMainEvents();
+  while(1)
+    wander();
+    wanders := wanders +1;
+    if(wanders &gt; 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_ENTEREDAREA:
+          SYSEVENT_LEFTAREA:     if(( me.npctemplate == &quot;dog&quot;) &amp;&amp;(!ev.source.npctemplate))
+                                   case(RandomInt(2))
+                                     0: PlaySoundEffect(me,0x86);
+                                     1: PlaySoundEffect(me,0x87);
+                                   endcase
+                                 elseif((ev.source.script) &amp;&amp;( hatelist[ev.source.script]))
+                                   get_help( ev.source);
+                                   Fight( ev.source);
+                                 elseif( ev.source.npctemplate == me.npctemplate)
+                                   WalkToward(ev.source);
+                                   sleepms(500);
+                                   WalkToward(ev.source);
+                                 endif
+          SYSEVENT_DAMAGED:
+          SYSEVENT_ENGAGED:      if(ev.source)
+                                   get_help( ev.source);
+                                   Fight( ev.source);
+                                 endif
+          EVID_ALL_ATTACK_CMD:   Fight( ev.source);
+          EVID_HERDING:          Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(1)));
+    endif
+  endwhile
+endfunction
+
+function look_around()
+  var hatelist := &quot;animal cat barker tamed chicken sheep bird&quot;;
+  foreach critter in ListMobilesInLineOfSight( me, HALT_THRESHOLD)
+    if((critter.script) &amp;&amp;( hatelist[critter.script]))
+      Fight( critter);
+      return;
+    endif
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents( SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents( SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA);
+endfunction
+
+function get_help( opponent)
+  var ev := struct;
+  ev.+type := EVID_ALL_ATTACK_CMD;
+  ev.+source := opponent;
+  foreach critter in ListMobilesNearLocation( me.x, me.y, me.z, HALT_THRESHOLD, me.realm)
+    if((critter.npctemplate == me.npctemplate) &amp;&amp;(critter.script != &quot;tamed&quot;) &amp;&amp;(!critter.warmode))
+      SendEvent(critter, ev);
+    endif
+  endforeach
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/meanLoop.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/meanLoop.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/meanLoop.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,99 @@
+function main_AI_loop(next_wander := 0)
+  var ev;
+  var looter := GetObjProperty(me, &quot;looter&quot;);
+  var wanders := 60;
+  look_around();
+  EnableMainEvents();
+  while(1)
+    ev := os::wait_for_event(5);
+    repeat
+      if(wanders &gt; 60)
+        wanders :=0;
+        ev := sleepmode();
+      endif
+      case(ev.type)
+        SYSEVENT_ENGAGED:
+        SYSEVENT_DAMAGED:     if(ev.source)
+                                fight(ev.source);
+                              endif
+        SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) ||(((ev.source).script == &quot;employed&quot;) ||((ev.source).script == &quot;tamed&quot;)))
+                                fight(ev.source);
+                              endif
+        EVID_HERDING:           Herding(ev);
+      endcase
+    until(!(ev := os::wait_for_event(1)));
+      if(ReadGameClock() &gt; next_wander)
+        if(!me.hidden)
+          wander();
+        endif
+        if(looter)
+          grabloot();
+        endif
+        next_wander := ReadGameClock()+1;
+        wanders := wanders +1;
+        if(wanders &gt; 60)
+          wanders :=0;
+          ev := sleepmode();
+        endif
+      endif
+   endwhile
+endfunction
+
+function look_around()
+  foreach critter in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    if(!critter.npctemplate || critter.script == &quot;tamed&quot;)
+      fight(critter);
+    endif
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  EnableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_ENGAGED + SYSEVENT_DAMAGED , HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED);
+  DisableEvents(SYSEVENT_DAMAGED);
+  DisableEvents(SYSEVENT_ENTEREDAREA);
+  cleareventque();
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/packKillPCsLoop.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/packKillPCsLoop.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/packKillPCsLoop.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,145 @@
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  var next_loot := ReadGameClock() + 20;
+  EnableMainEvents();
+  look_around();
+  while(1)
+    if(ReadGameClock() &gt; next_loot)
+      grabloot();
+      next_loot := ReadGameClock() + 5;
+    else
+      wander();
+      if(RandomInt(3) == 3)
+        if(RandomInt(1) == 1)
+          PlaySoundEffect(me, idlesnd1);
+        else
+          PlaySoundEffect(me, idlesnd2);
+        endif
+      endif
+    endif
+    wanders := wanders +1;
+    if(wanders &gt;= 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(5);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) ||(((ev.source).script == &quot;employed&quot;) ||((ev.source).script == &quot;tamed&quot;)))
+                                  foreach mobile in ListMobilesInLineOfSight(me, 10);
+                                    if(mobile.npctemplate == me.npctemplate)
+                                      var evnt := array;
+                                      evnt.+ type;
+                                      evnt.+ source;
+	                                  evnt.source := ev.source;
+	                                  evnt.type := EVID_ALL_ATTACK_CMD;
+                                      SendEvent(mobile, evnt);
+                                    endif
+                                  endforeach
+                                endif
+          EVID_ALL_ATTACK_CMD:  Fight(ev.source);
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED:     foreach mobile in ListMobilesInLineOfSight(me, 10);
+                                  if(mobile.npctemplate == me.npctemplate)
+                                    var evnt := array;
+                                    evnt.+ type;
+                                    evnt.+ source;
+	                                evnt.source := ev.source;
+	                                evnt.type := EVID_ALL_ATTACK_CMD;
+                                    SendEvent(mobile, evnt);
+                                  endif
+                                endforeach
+                                Fight(ev.source);
+          EVID_HERDING:           Herding(ev);
+        endcase
+      until(!(ev := os::wait_for_event(2)));
+    endif
+   endwhile
+endfunction
+
+function look_around()
+  foreach npc in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    if((!npc.npctemplate) ||(npc.script == &quot;tamed&quot;) ||(npc.script == &quot;employed&quot;))
+      foreach mobile in ListMobilesInLineOfSight(me, 10);
+        if(mobile.npctemplate == me.npctemplate)
+          var evnt := array;
+          evnt.+ type;
+          evnt.+ source;
+	      evnt.source := npc;
+	      evnt.type := EVID_ALL_ATTACK_CMD;
+          SendEvent(mobile, evnt);
+        endif
+       endforeach
+       Fight(npc);
+       return;
+     endif
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(EVID_HERDING);
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function get_help(opponent)
+    var inev;
+    var ev array;
+    ev.+type := EVID_ALL_ATTACK_CMD;
+    ev.+source := opponent;
+    foreach critter in ListMobilesNearLocation(me.x, me.y, me.z, 4, me.realm)
+      if((critter.npctemplate) &amp;&amp; (critter.script != &quot;employed&quot;) &amp;&amp; (critter.script != &quot;tamed&quot;) &amp;&amp; (critter.serial != me.serial))
+        SendEvent(critter, ev);
+      endif
+      inev := wait_for_event(0);
+      if(inev.type == EVID_ALL_ATTACK_CMD)
+        return;
+      endif
+    endforeach
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/setup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/setup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/setup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,65 @@
+
+var me := Self();
+var speech;
+var ammotype;
+var ammoamount;
+var theammo;
+var master;
+var spells := {};
+
+const SKILLID_HIDE := 21;
+
+var cast_pct;
+var num_casts;
+var count_casts;
+var saywords := 1;
+var graphics;
+var num_changes;
+var will_cast;
+var will_breathe;
+var flee_point;
+
+drop_anchor();
+
+if( me.name[&quot;&lt;random&gt;&quot;] )
+  SetName( me, RandomName( me ) );
+endif
+var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+var speechelem := npccfg[me.npctemplate];
+speech := GetConfigString(speechelem, &quot;speech&quot;);
+spells := GetConfigStringArray( speechelem, &quot;spell&quot; );
+cast_pct := speechelem.cast_pct;
+num_casts  := speechelem.num_casts;
+count_casts  := speechelem.count_casts;
+var equipname := speechelem.equip;
+saywords := speechelem.saywords;
+if (!cast_pct)
+  cast_pct := 10;
+endif
+flee_point := speechelem.flee_point;
+if (!flee_point)
+  flee_point := 10;
+endif
+if (equipname)
+  EquipFromTemplate(me, equipname);
+endif
+ammotype := npccfg[me.npctemplate].ammotype;
+var mybow := npccfg[me.npctemplate].missileweapon;
+if (ammotype)
+  if (me.backpack)
+    DestroyItem(me.backpack);
+  endif
+  EquipFromTemplate(me, mybow);
+  ammoamount := npccfg[me.npctemplate].ammoamount;
+  theammo := CreateItemInBackpack(me, ammotype, ammoamount);
+endif
+if (npccfg[me.npctemplate].equip)
+  EquipFromTemplate(me, npccfg[me.npctemplate].equip);
+endif
+if (lower(speechelem[&quot;alignment&quot;])==&quot;evil&quot;)
+  foreach critter in ListMobilesInLineOfSight( me, 10)
+    if (!critter.npctemplate || critter.script == &quot;tamed&quot;)
+      fight(critter);
+    endif
+  endforeach
+endif
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/sleepMode.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/sleepMode.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/sleepMode.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,62 @@
+include &quot;include/attributes&quot;;
+function sleepmode()
+  foreach critter in ListMobilesNearLocation( me.x,me.y,me.z, 15, me.realm);
+    if(!critter.isA(POLCLASS_NPC))
+      look_around();
+      break;
+    endif
+  endforeach
+  if(GetObjProperty(me,&quot;killme&quot;))
+    SetObjProperty(me, &quot;guardkill&quot;, 1);
+    MoveCharacterToLocation(me, 1, 1, 0, MOVECHAR_FORCELOCATION);
+    ApplyRawDamage(me, GetHp(me)+1);
+  endif
+  EraseObjProperty(me,&quot;#flees&quot;);
+  DisableMainEvents();
+  if(GetEffectiveSkill(me, 21) &gt; 0 )
+    me.hidden := 1;
+  endif
+  EnableEvents(SYSEVENT_ENTEREDAREA,18);
+  EnableEvents(SYSEVENT_ENGAGED);
+  EnableEvents(SYSEVENT_DAMAGED);
+  var ev;
+  while (1)
+    ev := os::wait_for_event(30);
+    repeat
+    if(RandomInt(2) == 1)
+      PlaySoundEffect(me, idlesnd1);
+    else
+      PlaySoundEffect(me, idlesnd2);
+    endif
+    case (ev.type)
+      SYSEVENT_ENGAGED:    if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if (me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      SYSEVENT_DAMAGED:    if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if (me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      EVID_ALL_ATTACK_CMD: if(me.hidden)
+                             me.hidden := 0;
+                           endif
+                           EnableMainEvents();
+                           return ev;
+      SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if(me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      EVID_HERDING:        Herding(ev);
+    endcase
+    until(!(ev := os::wait_for_event(30)));
+  endwhile
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/main/sleepModeCow.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/sleepModeCow.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/sleepModeCow.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,67 @@
+include &quot;include/attributes&quot;;
+function sleepmode()
+  foreach critter in ListMobilesNearLocation( me.x,me.y,me.z, 15, me.realm);
+    if(!critter.isA(POLCLASS_NPC))
+      look_around();
+      break;
+    endif
+  endforeach
+  if(GetObjProperty(me,&quot;killme&quot;))
+    SetObjProperty(me, &quot;guardkill&quot;, 1);
+    MoveCharacterToLocation(me, 1, 1, 0, MOVECHAR_FORCELOCATION);
+    ApplyRawDamage(me, GetHp(me)+1);
+  endif
+  EraseObjProperty(me,&quot;#flees&quot;);
+  DisableMainEvents();
+  if(GetEffectiveSkill(me, 21) &gt; 0 )
+    me.hidden := 1;
+  endif
+  EnableEvents(SYSEVENT_ENTEREDAREA,18);
+  EnableEvents(SYSEVENT_ENGAGED);
+  EnableEvents(SYSEVENT_DAMAGED);
+  var ev;
+  EnableEvents(SYSEVENT_DOUBLECLICKED);
+  while (1)
+    ev := os::wait_for_event(30);
+    repeat
+    if(RandomInt(1) == 1)
+      PlaySoundEffect(me, idlesnd1);
+    else
+      PlaySoundEffect(me, idlesnd2);
+    endif
+    case (ev.type)
+        SYSEVENT_DOUBLECLICKED: if(((RandomInt(19) + 1) == 10) || (ev.source.cmdlevel &gt;= 3))
+                                  PlaySoundEffect(me, 0x79);
+                                  PerformAction(me, CInt(0x8));
+                                endif
+      SYSEVENT_ENGAGED:    if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if (me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      SYSEVENT_DAMAGED:    if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if (me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      EVID_ALL_ATTACK_CMD: if(me.hidden)
+                             me.hidden := 0;
+                           endif
+                           EnableMainEvents();
+                           return ev;
+      SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if(me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      EVID_HERDING:        Herding(ev);
+    endcase
+    until(!(ev := os::wait_for_event(30)));
+  endwhile
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/main/sleepModeSheep.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/main/sleepModeSheep.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/main/sleepModeSheep.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,70 @@
+include &quot;include/attributes&quot;;
+function sleepmode()
+  foreach critter in ListMobilesNearLocation( me.x,me.y,me.z, 15, me.realm);
+    if(!critter.isA(POLCLASS_NPC))
+      look_around();
+      break;
+    endif
+  endforeach
+  if(GetObjProperty(me,&quot;killme&quot;))
+    SetObjProperty(me, &quot;guardkill&quot;, 1);
+    MoveCharacterToLocation(me, 1, 1, 0, MOVECHAR_FORCELOCATION);
+    ApplyRawDamage(me, GetHp(me)+1);
+  endif
+  EraseObjProperty(me,&quot;#flees&quot;);
+  DisableMainEvents();
+  if(GetEffectiveSkill(me, 21) &gt; 0 )
+    me.hidden := 1;
+  endif
+  EnableEvents(SYSEVENT_ENTEREDAREA,18);
+  EnableEvents(SYSEVENT_ENGAGED);
+  EnableEvents(SYSEVENT_DAMAGED);
+  var ev;
+  EnableEvents(SYSEVENT_DOUBLECLICKED);
+  while (1)
+    ev := os::wait_for_event(30);
+    repeat
+    if(RandomInt(1) == 1)
+      PlaySoundEffect(me, idlesnd1);
+    else
+      PlaySoundEffect(me, idlesnd2);
+    endif
+    case (ev.type)
+      SYSEVENT_DOUBLECLICKED: if(((RandomInt(499) + 1) == 250) || (ev.source.cmdlevel &gt;= 3))
+                                PlaySoundEffect(me, SFX_SPELL_EXPLOSION);
+                                PlayStationaryEffect(me.x, me.y, me.z, FX_EXPLODE_3, 7, 0x10,0, me.realm);
+                                sleepms(5);
+                                MoveCharacterToLocation(me,0,0,0,MOVECHAR_FORCELOCATION);
+                                ApplyRawDamage(me, GetHp(me) + 3);
+                              endif
+      SYSEVENT_ENGAGED:    if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if (me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      SYSEVENT_DAMAGED:    if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if (me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      EVID_ALL_ATTACK_CMD: if(me.hidden)
+                             me.hidden := 0;
+                           endif
+                           EnableMainEvents();
+                           return ev;
+      SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                             if(me.hidden)
+                               me.hidden := 0;
+                             endif
+                             EnableMainEvents();
+                             return ev;
+                           endif
+      EVID_HERDING:        Herding(ev);
+    endcase
+    until(!(ev := os::wait_for_event(30)));
+  endwhile
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/meek.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/meek.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/meek.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,160 @@
+/////////////////////////////////////////////////////////////////////////////
+//
+//  killpcs.src: Kill player-characters
+//
+//  TODO: Some server support for only paying attention to 'enteredarea'
+//        and 'leftarea' events from PCs would be nice.
+//        we just use the graphic at the moment, so we'd fight
+//        NPCs too.  Oh well.
+//
+//  Author: ENS
+//
+//  Created: 4/98
+//
+//  Modified week of 6/15/99 by DW to allow speech and ranged attacks
+//
+/////////////////////////////////////////////////////////////////////////////
+
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;:npcutils:speech&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopMeek&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+
+    	SetWarMode( 0 );
+
+    	main_AI_loop();
+
+endprogram
+
+function CloseDistance( opponent )
+
+    case (Distance( me, opponent ))
+        1:              // the most likely, so first
+        0:
+            return 1;
+        default:
+            RunToward( opponent );
+            return 0;
+    endcase
+
+endfunction
+
+function Run( opponent )
+
+    TurnAwayFrom( opponent );
+
+    DisableEvents( SYSEVENT_SPEECH );
+    DisableEvents( SYSEVENT_ITEM_GIVEN );
+
+    EnableEvents( SYSEVENT_DISENGAGED );
+
+    var waittime;
+    var loops := 0;
+
+    outer:
+    while (opponent &amp;&amp; !opponent.dead)
+	loops := loops + 1;
+        waittime := OpenDistance( opponent ) * 15;
+
+	if ( waittime )
+		break outer;
+	endif
+
+        var ev := wait_for_event( waittime );
+        case (ev.type)
+            SYSEVENT_DISENGAGED:
+                if (ev.source.serial == opponent.serial)
+                    say( &quot;Whew!&quot; );
+                    break outer;
+                endif
+            SYSEVENT_ENGAGED:
+            SYSEVENT_DAMAGED:
+		Spout();
+        endcase
+
+	if ( loops &gt; 100 )
+		Fight(opponent);
+	endif
+
+    endwhile
+
+    DisableEvents( SYSEVENT_DISENGAGED );
+    EnableEvents( SYSEVENT_ITEM_GIVEN );
+    EnableEvents( SYSEVENT_SPEECH, 2);
+
+    SetWarMode( 0 );
+
+endfunction
+
+function Spout()
+
+	case (RandomInt(60))
+	0:	say( &quot;Ack! Leave me alone!&quot; );
+	1:	say( &quot;Pick on someone your own size!&quot; );
+	2:	say( &quot;Why are you doing this?  WHY?!&quot; );
+	3:	say( &quot;Leave me be!  I've done you no harm!&quot; );
+	4:	say( &quot;Kal Ort Por&quot; );
+		say( &quot;Damn! No regs...&quot;);
+	5:	say( &quot;Ah!  But I'm too young to die!&quot; );
+	6:	say( &quot;Brute!  Fiend!  Aaaah!&quot; );
+	7:	say( &quot;He who runs and runs away, lives to run another day!&quot; );
+	8:	say( &quot;So... wanna fight eh?  Fight someone else!&quot; );
+	9:	say( &quot;Aaahh!  NPCK!!&quot; );
+	10:	say( &quot;I'm going to get help!&quot; );
+	11:	say( &quot;Ouch!  Help!!&quot; );
+	12:	say( &quot;Bet I can outrun you!&quot; );
+	13:	say( &quot;Stop!  I'm serious!  Just stop!&quot; );
+	14:	say( &quot;Aaah!  Spare me!  Please, Spare me!&quot; );
+	15:	say( &quot;Ack!  I'm innocent I tell you!&quot; );
+	16:	say( &quot;Find a more worthy opponent!&quot; );
+	17:	say( &quot;I'm not prepared to meet my maker!&quot; );
+	18:	say( &quot;Wait!  Stop!  I'm a BLEEDER!&quot; );
+	19:	say( &quot;My family will have vengeance!&quot; );
+	20:	say( &quot;Look behind you!  What is that terrible thing!?&quot; );
+	21:	say( &quot;Not in the face!  Not in the face!&quot; );
+	22:	say( &quot;Aaahhh! Help! Help!  I'm dying!&quot;);
+	23:	say( &quot;By the virtues! Why? WHY??&quot; );
+	24:	say( &quot;Perhaps it will help to confuse you if I run away some more...&quot; );
+	25:	say( &quot;Run!  Hide!  We're all gonna die!&quot; );
+	default:	return;
+	endcase
+
+	return;
+
+endfunction
+
+function OpenDistance( opponent )
+
+    case (Distance( me, opponent ))
+        20:
+            return 1;
+
+        default:
+            RunAwayFrom( opponent );
+            return 0;
+    endcase
+
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/merchant.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/merchant.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/merchant.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,147 @@
+use npc;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;include/utility&quot;;
+include &quot;include/mrcSpawn&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;include/client&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/findCity&quot;;
+include &quot;include/dist&quot;;
+include &quot;:begging:begging&quot;;
+include &quot;include/attributes&quot;;
+include &quot;:npcutils:trainSkill&quot;;
+
+const MAX_SKILLS      := 48;
+
+var me := Self();
+me.hidden := 1;
+var inv_fs, inv_pb, inv_1c, inv_rs;
+var merchant_type := GetObjProperty(me,&quot;MerchantType&quot;);
+var equipt        := GetObjProperty(me, &quot;Equipt&quot;);
+var npccfg        := ReadConfigFile(&quot;npcdesc&quot;);
+
+set_priority(50);
+
+program merchant()
+  if(!merchant_type)
+    SetObjProperty(me, &quot;MerchantType&quot;, &quot;Mage&quot;);
+    merchant_type := &quot;Mage&quot;;
+  endif
+  start_script(&quot;NPCKeeper&quot;, me);
+  var myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  if(myanchor)
+    MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+  endif
+  drop_anchor();
+  myanchor     := GetObjProperty(me, &quot;Anchor&quot;);
+  var spawnname := merchant_type + &quot; &quot; + myanchor[1] + &quot; &quot; + myanchor[2] + &quot; &quot; + myanchor[3];
+  inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+  inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+  inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+  inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+  while((!inv_rs) or (!inv_fs) or (!inv_pb) or (!inv_1c))
+    sleep(5);
+    inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+    inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+    inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+    inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+  endwhile
+  me.hidden := 0;
+  EnableEvents(SYSEVENT_ITEM_GIVEN);
+  DisableEvents(SYSEVENT_SPEECH);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+    me.frozen := 1;
+  endif
+  var next_wander := ReadGameClock() + 10;
+  const loops := 0;
+  while (1)
+    var ev;
+    ev := os::wait_for_event(120);
+    if(ev)
+      case (ev.type)
+        EVID_NODE:                var txt := lower(ev.text);
+                                  if((ev.source.cmdlevel &gt; 2) &amp;&amp; (txt[&quot;showinventory&quot;]))
+                                    SendOpenSpecialContainer(ev.source, inv_fs);
+                                  elseif((ev.source.cmdlevel &gt; 2) &amp;&amp; (txt[&quot;showrestock&quot;]))
+                                    SendOpenSpecialContainer(ev.source, inv_rs);
+                                  else
+                                    if(txt[&quot;buy&quot;])
+                                      TurnToward(ev.source);
+                                      var res := SendBuyWindow(ev.source, inv_fs, me, inv_pb);
+                                    elseif(txt[&quot;sell&quot;])
+                                      if(GetObjProperty(inv_rs, &quot;MyGold&quot;) &gt;= 1000)
+                                        TurnToward(ev.source);
+                                        var count := ModifyPCSellList(merchant_type, (ev.source).backpack);
+                                        if(count &gt;= 1)
+                                          var res := SendSellWindow(ev.source, me, inv_fs, inv_pb, inv_1c);
+                                        else
+                                          PrintTextAbovePrivate(me, &quot;You don't have anything I would be interested in.&quot;, ev.source);
+                                        endif
+                                      else
+                                        PrintTextAbovePrivate(me, &quot;I cannot afford any more of that.&quot;, ev.source );
+                                      endif
+                                    elseif((txt[&quot;vendor train&quot;]) || (txt[&quot;vendor teach&quot;]) || (txt[&quot;merchant train&quot;]) || (txt[&quot;merchant teach&quot;]))
+                                      TurnToward(ev.source);
+                                      MerchantTrain(me, ev.source, ev.text);
+                                    endif
+                                  endif
+        SYSEVENT_MERCHANT_BOUGHT: TurnToward(ev.source);
+                                  PrintTextAbovePrivate(me, &quot;The total of thy sale is &quot; + ev.amount +&quot;.&quot;, ev.source);
+                                  if(lower(merchant_type) != &quot;appraiser&quot;)
+                                    var mygold := GetObjProperty(inv_rs, &quot;MyGold&quot;);
+                                    mygold := mygold - ev.amount;
+                                    SetObjProperty(inv_rs, &quot;MyGold&quot;, mygold);
+                                  endif
+                                  foreach thing in EnumerateItemsInContainer(inv_pb)
+                                    if(MoveItemToContainer(thing, inv_fs))
+                                      SetObjProperty(thing,&quot;ClearRestock&quot;, (ReadGameClock() + 1800));
+                                      thing.buyprice  := itemconfig[thing.objtype].VendorBuysFor;
+                                      thing.sellprice := itemconfig[thing.objtype].VendorSellsFor;
+                                    else
+                                      DestroyItem(thing);
+                                    endif
+                                  endforeach
+                                  PlaySoundEffect(me, 0x38);
+        SYSEVENT_MERCHANT_SOLD:   TurnToward(ev.source);
+                                  PrintTextAbovePrivate(me, &quot;The total of thy purchase is &quot; + ev.amount +&quot;.&quot;, ev.source);
+                                  foreach thing in ListRootItemsInContainer((ev.source).backpack)
+                                    EraseObjProperty(thing, &quot;ClearRestock&quot;);
+                                  endforeach
+                                  if(lower(merchant_type) != &quot;appraiser&quot;)
+                                    var mygold := GetObjProperty(inv_rs, &quot;MyGold&quot;);
+                                    mygold := mygold + ev.amount;
+                                    SetObjProperty(inv_rs, &quot;MyGold&quot;, mygold);
+                                  endif
+                                  PlaySoundEffect(me, 0x38);
+        SYSEVENT_ITEM_GIVEN:      TrainSkill(me, ev.source, ev.item);
+      endcase
+    endif
+	if(ReadGameClock() &gt;= next_wander)
+	  begpurse(me);
+      wander();
+      if(coordist(me.x, me.y, myanchor[1], myanchor[2]) &gt; 5)
+        MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+      endif
+      next_wander := ReadGameClock() + 30;
+    endif
+  endwhile
+endprogram
+
+function Lookiehere(who, npc)
+  var ev;
+  ev := array;
+  ev.+ type;
+  ev.+ source;
+  ev.type := SYSEVENT_SPEECH;
+  ev.text := &quot;node&quot;;
+  ev.source := npc;
+  foreach thing in ListItemsNearLocationOfType(who.x, who.y, who.z, 15, 0x887b, who.realm)
+    SendEvent(thing, ev);
+  endforeach
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/packFirebreather.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/packFirebreather.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/packFirebreather.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,45 @@
+
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/packKillPCsLoop&quot;;
+include &quot;ai/combat/packFight&quot;;
+include &quot;ai/combat/fireCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+const HALT_THRESHOLD := 15;
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var FLAME_STRENGTH := npccfgfile[me.npctemplate].flamestrength;
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  var sleepdelay := 300 - (CInt(GetDexterity(me)) * 1.5);
+  if (sleepdelay &lt; 0)
+	sleepdelay := 0;
+  endif
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+	         sleepms(sleepdelay);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/person.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/person.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/person.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,116 @@
+/////////////////////////////////////////////////////////////////////////////
+//
+// Simple Townperson AI. responds to a few keywords and barks out
+// some crappy responses
+//
+// He also runs like heck if you try to attack him :)
+//
+// TODO: put all keyword / response text in a cfg file.
+//
+/////////////////////////////////////////////////////////////////////////////
+
+use npc;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:speech&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;:begging:begging&quot;;
+
+const HALT_THRESHOLD := 2; // how close before he barks?
+
+var me := Self();
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+
+program CastleGuard()
+  drop_anchor();
+  EnableEvents( SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED );
+  EnableEvents( SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, HALT_THRESHOLD );
+  EnableEvents( SYSEVENT_OPPONENT_MOVED );
+  if (GetObjProperty(me, &quot;frozen&quot;))
+        me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  set_priority(10);
+  var ev;
+  var looter := GetObjProperty( me, &quot;looter&quot; );
+  var next_wander := ReadGameClock() + 10;
+  while (1)
+    ev := os::wait_for_event( 120 );
+    case (ev.type)
+      SYSEVENT_SPEECH:  var tspeech := process_text(ev.text, &quot;default&quot;,&quot;default&quot;);
+                        if (tspeech)
+                          say(tspeech);
+                        endif
+      SYSEVENT_ENGAGED: say(&quot;Aaahhh! Help! Help!  I'm being oppressed!&quot;);
+                        Run( ev.source );
+      SYSEVENT_DAMAGED: say( &quot;Owie! Aaaagh!  That's worse than a bee sting!&quot; );
+                        if (ev.source)
+                          Run( ev.source );
+                        else
+                          say( &quot;What sinister force is this!&quot; );
+                        endif
+      SYSEVENT_ENTEREDAREA:
+      SYSEVENT_LEFTAREA:
+    endcase
+    if (ReadGameClock() &gt;= next_wander)
+      begpurse(me);
+      wander();
+      if(looter)
+        grabloot();
+      endif
+      next_wander := ReadGameClock() + 10;
+    endif
+  endwhile
+endprogram
+
+function Run( opponent )
+  TurnAwayFrom( opponent );
+  DisableEvents( SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA );
+  var waittime;
+  outer:
+  while (opponent &amp;&amp; !opponent.dead)
+    waittime := OpenDistance( opponent ) * 15;
+    var ev := wait_for_event( waittime );
+    case (ev.type)
+      SYSEVENT_SPEECH:
+      SYSEVENT_DISENGAGED:     if (ev.source.serial == opponent.serial)
+                                 say( &quot;Whew!&quot; );
+                                 break outer;
+                               endif
+      SYSEVENT_ENGAGED:
+      SYSEVENT_DAMAGED:        if (ev.source)
+                                 if (ev.source.serial != opponent.serial)
+                                   say( &quot;Ack! Leave me alone!&quot; );
+                                 else
+                                   if (ev.type == &quot;damage&quot;)
+                                     say(&quot;Ouch! Heeelp!&quot;);
+                                   endif
+                                 endif
+                               endif
+      SYSEVENT_OPPONENT_MOVED:
+      SYSEVENT_ENTEREDAREA:
+      SYSEVENT_LEFTAREA:
+    endcase
+  endwhile
+  EnableEvents( SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, HALT_THRESHOLD );
+  SetWarMode( 0 );
+endfunction
+
+function OpenDistance( opponent )
+  case (Distance( me, opponent ))
+    10:      return 1;
+    default: RunAwayFrom( opponent );
+             return 0;
+  endcase
+endfunction
+
+function look_around()
+  return 0;
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/pirate.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/pirate.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/pirate.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,102 @@
+///////////////////////////////////////////////////////////
+//
+//   Pirate
+//
+//   Author: rje
+//
+//   Date: 1/99
+//
+//   A pirate is a social character who makes a living
+//   pillaging humans near shorlines.
+//
+///////////////////////////////////////////////////////////
+use uo;
+use npc;
+use util;
+
+var me         := npc::Self();
+const aggression  := 250;
+
+include &quot;util/conflicts&quot;;
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+
+
+program Pirate()
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+    EnableEvents( SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED );
+    EnableEvents( SYSEVENT_ENTEREDAREA, 8 );
+    var next_wander := 0;
+	if (GetObjProperty(me, &quot;frozen&quot;))
+		me.frozen := 1;
+	endif
+    while (1)
+      if( badguy )
+           co_fight();
+        endif
+        var ev;
+        ev := os::wait_for_event( 120 );
+        case (ev.type)
+
+            SYSEVENT_SPEECH:      handleSpeech( ev.text );
+            SYSEVENT_ENGAGED:     co_target( ev.source );
+                              co_fight();
+            SYSEVENT_DISENGAGED:  co_untarget();
+            SYSEVENT_DAMAGED:     co_fight();
+
+            SYSEVENT_ENTEREDAREA: co_target( ev.source );
+
+        endcase
+
+	if (ReadGameClock() &gt;= next_wander)
+                wander();
+                next_wander := ReadGameClock() + 10;
+        endif
+
+        case ( RandomInt( 200 ) )
+           0: say( &quot;Yo ho yo ho!&quot; );
+           1: say( &quot;Avast there matey.&quot; );
+           2: say( &quot;Arr!&quot; );
+           3: say( &quot;Aye now...&quot; );
+           4: say( &quot;* ptui *&quot; );
+           5: say( &quot;A wee bit windy.&quot; );
+           6: say( &quot;It be fair sailin'.&quot; );
+           7: say( &quot;It be a bonny fine day.&quot; );
+           8: say( &quot;Curse these foul tides!&quot; );
+        endcase
+
+    endwhile
+
+endprogram
+
+function handleSpeech( msg )
+
+   if ( RandomInt( 2 ) == 0 )
+      return;
+   endif
+
+   if ( msg[ &quot;rootbeer&quot; ] )     say( &quot;Yo ho yo ho a pirate's life for me! &quot;);
+   elseif ( msg[ &quot;arr&quot; ] )      say( &quot;Avast there matey!&quot; );
+   elseif ( msg[ &quot;avast&quot; ] )    say( &quot;Move that thing!&quot; );
+   elseif ( msg[ &quot;that thing&quot; ])say( &quot;...and that other thing!&quot; );
+   elseif ( msg[ &quot;aweigh&quot; ] )   say( &quot;Heave!&quot; );
+   elseif ( msg[ &quot;heave&quot; ])     say( &quot;Ho!&quot; );
+   elseif ( msg[ &quot;rum&quot; ])       say( &quot;Sixteen men on a deadman's chest.&quot; );
+   elseif ( msg[ &quot;chest&quot; ])     say( &quot;Yo ho ho and a bottle of rootbeer!&quot; );
+   elseif ( msg[ &quot;ahoy&quot; ])      say( &quot;Ahoy there, matey!&quot; );
+   elseif ( msg[ &quot;argh&quot; ])      say( &quot;Arr!&quot; );
+   elseif ( msg[ &quot;grog&quot; ])      say( &quot;Aye, I'd kill fer a flagon 'o that!&quot; );
+   elseif ( msg[ &quot;parrot&quot; ])    say( &quot;Arr, I was starved so, I eats me parrot, so I did!&quot; );
+   elseif ( msg[ &quot;walk&quot; ] &amp;&amp; msg[ &quot;plank&quot; ])
+      say( &quot;Arr, ye'll surely be walkin' the plank afore sunrise tomorrer!&quot; );
+   elseif ( msg[ &quot;treasure&quot; ])
+      say( &quot;Aye now, ye be lookin' fer our buried locker, I'll wager.&quot; );
+   elseif ( msg[ &quot;locker&quot; ] )
+      say( &quot;Oh, it's safe and sound on the riverside.&quot; );
+   elseif( msg[ &quot;river&quot; ] )
+      say( &quot;Arr, the river's near Vesper, ye ken?&quot; );
+   endif
+
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/pkg.cfg
===================================================================
--- trunk/096/pkg/mobiles/oldAI/pkg.cfg	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/pkg.cfg	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,12 @@
+Enabled		1
+Name		oldAI
+
+Version		1.0
+
+CoreRequired	96
+
+Maintainer	Distro Team
+Email		<A HREF="https://lists.berlios.de/mailman/listinfo/poldistro-svn">pol-distro-support at sourceforge.net</A>
+
+#Requires none
+#Conflicts none

Added: trunk/096/pkg/mobiles/oldAI/poisonElemental.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/poisonElemental.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/poisonElemental.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,122 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:NPCCast&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/spellRestrictions&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/setup/spellSetup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 8; // how close before he attacks?
+var LAST_BREATH := ReadGameClock();
+
+var npcfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npcfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npcfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  if (GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  var sleepdelay := 400 - (CInt(GetDexterity(me)) * 1.5);
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+		     sleepms(sleepdelay);
+             return 0;
+  endcase
+endfunction
+
+function process_combat_event(opponent)
+  spellattack(opponent);
+  var plevel := Cint(GetObjProperty(me, &quot;poison_level&quot;));
+  var rint := RandomInt(8);
+  if((GetHp(me) &lt; (GetMaxHP(me) / 2)) &amp;&amp; (rint &gt;= 5))
+    CastSpell(me, me, &quot;gheal&quot;);
+  endif
+  if((plevel &gt;= 1) &amp;&amp; (rint &gt;= 5))
+    CastSpell(me, me, &quot;poison&quot;);
+  endif
+  if(((GetHp(me) * 100) / GetMaxHp(me)) &lt; flee_point)
+    EraseObjProperty(me,&quot;#flees&quot;);
+    flee(opponent);
+  endif
+endfunction
+
+function process_flee_event(opponent)
+  spellattack(opponent);
+  if((GetHp(me) &lt; (GetMaxHP(me) / 2)) &amp;&amp; (RandomInt(8) &gt;= 3))
+    CastSpell(me, me, &quot;gheal&quot;);
+    return 0;
+  endif
+  if((GetObjProperty(me, &quot;poison_level&quot;) &gt;= 1) &amp;&amp; (RandomInt(8) &gt;= 3))
+    CastSpell(me, me, &quot;poison&quot;);
+    return 0;
+  endif
+  if(((GetHp(me) * 100) / GetMaxHp(me)) &gt;= flee_point)
+    return 1;
+  endif
+endfunction
+
+function spellattack(opponent)
+  if(LAST_BREATH &gt; ReadGameClock())
+    return;
+  endif
+  if((CheckLineOfSight(me, opponent)) and (dist(me, opponent) &lt;= 15))
+    cast_offensive_spell(me, opponent);
+    LAST_BREATH := Cint(ReadGameClock() + (RandomInt(4) + 4));
+  endif
+endfunction
+
+function prepare_for_fight(opponent)
+  if(!CInt(GetObjProperty(me, &quot;mr&quot;)))
+	CastSpell(me,me,&quot;reflect&quot;);
+  endif
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function post_combat()
+  if(GetHp(me) &lt; (GetStrength(me)-10))
+	CastSpell(me,me,&quot;gheal&quot;);
+  endif
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode(0);
+  SetOpponent(0);
+  summons := 1;
+  sleep(1);
+  look_around();
+endfunction
+
+function DoPoison(you)
+  if(Distance(me,you) &lt; 2)
+    if((RandomInt(2) + 1) == 2)
+//      var poison_level := CInt(GetObjProperty(you, &quot;poison_level&quot;));
+      var passparms := { you, me, &quot;poison elemental&quot;, 5 };
+      Detach();
+      start_script(&quot;:spells:poisonDamage&quot;, passparms);
+	  SetObjProperty(you, &quot;LastHit&quot;, {me.name, me.serial, &quot;poisoncloud&quot;});
+    endif
+  endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/poisonKillPCs.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/poisonKillPCs.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/poisonKillPCs.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,37 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/poisonCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+const HALT_THRESHOLD := 8;
+var npccfgfile := ReadConfigFile(&quot;npcdesc&quot;);
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance(opponent)
+  case (Distance(me, opponent))
+    1:
+    0:       return 1;
+    default: RunToward(opponent);
+             return 0;
+  endcase
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/setup/animalSetup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/setup/animalSetup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/setup/animalSetup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,9 @@
+var me := Self();
+var flee_point := 10;
+drop_anchor();
+
+  if (GetObjProperty(me, &quot;frozen&quot;))
+        me.frozen := 1;
+  endif
+
+start_script(&quot;:npcutils:NPCKeeper&quot;, me);
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/setup/archerSetup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/setup/archerSetup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/setup/archerSetup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,4 @@
+var spells := {};
+var me := Self();
+drop_anchor();
+start_script(&quot;:npcutils:NPCKeeper&quot;, me);
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/setup/crierSetup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/setup/crierSetup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/setup/crierSetup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,21 @@
+var me := Self();
+var equipt := GetObjProperty(me, &quot;Equipt&quot;);
+
+drop_anchor();
+var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+var speechelem := npccfg[me.npctemplate];
+var speech := GetConfigString(speechelem, &quot;speech&quot;);
+var saywords := speechelem.saywords;
+var flee_point := speechelem.flee_point;
+if(!flee_point)
+  flee_point := 10;
+endif
+start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+if(!me.backpack)
+  var newbackpack := CreateItemAtLocation(me.x, me.y, me.z, 0xe75,1, me.realm);
+  var myhome := { };
+  myhome[1] := me.x;
+  myhome[2] := me.y;
+  myhome[3] := me.z;
+  SetObjProperty(me,&quot;myhome&quot;,myhome);
+endif
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/setup/killPCsSetup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/setup/killPCsSetup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/setup/killPCsSetup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,9 @@
+var me := Self();
+
+var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+var speechelem := npccfg[me.npctemplate];
+var flee_point := speechelem.flee_point;
+if(!flee_point)
+  flee_point := 10;
+endif
+start_script(&quot;:npcutils:NPCKeeper&quot;, me);
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/setup/setup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/setup/setup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/setup/setup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,42 @@
+include &quot;:npcutils:vetement&quot;;
+
+var speech;
+var ammotype;
+var ammoamount;
+var theammo;
+
+var master;
+var spells := {};
+var me := Self();
+
+var cast_pct;
+var num_casts;
+var count_casts;
+var saywords := 1;
+var summons := 3;
+
+var graphics;
+var num_changes;
+var will_cast;
+var will_breathe;
+var flee_point;
+
+	drop_anchor();
+
+var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+var speechelem := npccfg[me.npctemplate];
+speech := GetConfigString(speechelem, &quot;speech&quot;);
+spells := GetConfigStringArray( speechelem, &quot;spell&quot; );
+cast_pct := speechelem.cast_pct;
+num_casts  := speechelem.num_casts;
+count_casts  := speechelem.count_casts;
+var equipname := speechelem.equip;
+saywords := speechelem.saywords;
+if(!cast_pct)
+  cast_pct := 10;
+endif
+flee_point := speechelem.flee_point;
+if(!flee_point)
+  flee_point := 10;
+endif
+start_script(&quot;:npcutils:NPCKeeper&quot;, me);
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/setup/sheepSetup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/setup/sheepSetup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/setup/sheepSetup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,15 @@
+var me := Self();
+
+var flee_point;
+
+drop_anchor();
+
+flee_point := 10;
+
+if (!me.backpack)
+	var newbackpack := CreateItemAtLocation(me.x, me.y, me.z, 0xe75,1, me.realm);
+	EquipItem(me, newbackpack);
+	if (!RandomInt(100) )
+		me.color := 1109;
+	endif
+endif
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/setup/spellSetup.inc
===================================================================
--- trunk/096/pkg/mobiles/oldAI/setup/spellSetup.inc	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/setup/spellSetup.inc	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,49 @@
+var speech;
+var master;
+var spells := array;
+var me := Self();
+
+var cast_pct;
+var num_casts;
+var count_casts;
+var saywords := 1;
+var summons := 3;
+
+var will_cast;
+var flee_point;
+
+var pncfg := ReadConfigFile(&quot;npcdesc&quot;);
+var speechelem := pncfg[me.npctemplate];
+speech := GetConfigString(speechelem, &quot;speech&quot;);
+cast_pct := speechelem.cast_pct;
+num_casts  := speechelem.num_casts;
+count_casts  := speechelem.count_casts;
+saywords := speechelem.saywords;
+if(!cast_pct)
+  cast_pct := 10;
+endif
+flee_point := speechelem.flee_point;
+if(!flee_point)
+  flee_point := 10;
+endif
+SortSpellList();
+start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+
+function SortSpellList();
+  var spell_list := GetConfigStringArray(speechelem, &quot;spell&quot;);
+  var ct := 0;
+  foreach thing in spell_list
+    var split := SplitWords(thing);
+    var spell_name := split[1];
+    var spell_freq := Cint(split[2]);
+    if(!spell_freq)
+      spell_freq := Cint((100 - ct) / len(spells));
+    endif
+    ct := ct + spell_freq;
+    var holder := array;
+    holder.append(spell_name);
+    holder.append(ct);
+    spells.append(holder);
+  endforeach
+//  print(&quot;spells: &quot; + spells);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/sheep.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/sheep.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/sheep.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,36 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopSheep&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/sheepSetup&quot;;
+include &quot;ai/main/sleepModeSheep&quot;;
+
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0: return 1;
+    default: WalkToward(opponent);  return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/slime.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/slime.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/slime.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,57 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/slimeCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;include/client&quot;;
+
+
+const HALT_THRESHOLD := 8; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  colorme();
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0: return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function colorme()
+  if(me.color == 0)
+    case(RandomInt(10)+1)
+      1: me.color := 340;
+      2: me.color := 341;
+      3: me.color := 471;
+      4: me.color := 470;
+      5: me.color := 456;
+      6: me.color := 454;
+      7: me.color := 606;
+      8: me.color := 611;
+      9: me.color := 735;
+     10: me.color := 733;
+    endcase
+  endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/spellFire.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/spellFire.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/spellFire.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,60 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:NPCCast&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/spellFireEvent&quot;;
+include &quot;ai/setup/spellSetup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 15;
+var LAST_BREATH := ReadGameClock();
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var FLAME_STRENGTH := npccfgfile[me.npctemplate].flamestrength;
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  if (GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  var sleepdelay := 400 - (CInt(GetDexterity(me)) * 1.5);
+  case (Distance(me, opponent))
+    1:
+    0:       return 1;
+    default: RunToward(opponent);
+		     sleepms(sleepdelay);
+		     Opendoors(me);
+             return 0;
+  endcase
+endfunction
+
+function Opendoors(me)
+  foreach door in ListItemsNearLocation(me.x, me.y, me.z, 1, me.realm)
+    if(door.isa(POLCLASS_DOOR))
+      if(!GetObjProperty(door, &quot;WhenOpened&quot; ))
+        start_script(&quot;:doors:openDoor&quot;, door);
+      endif
+      EraseObjProperty(door, &quot;#inuse&quot;);
+    endif
+  endforeach
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/spellKillPCs.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/spellKillPCs.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/spellKillPCs.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,38 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/client&quot;;
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:NPCCast&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/spellCombatEvent&quot;;
+include &quot;ai/setup/spellSetup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;ai/main/closeDistance&quot;;
+
+const HALT_THRESHOLD := 15;
+var npccfgfile     := ReadConfigFile( &quot;npcdesc&quot; );
+var LAST_BREATH    := ReadGameClock();
+var FLAME_STRENGTH := npccfgfile[me.npctemplate].flamestrength;
+var idlesnd1       := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2       := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  if(GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/spiders.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/spiders.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/spiders.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,67 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/spiderCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 8; // how close before he attacks?
+const UOBJ_SPIDERWEB := 0xbf01; //fixme!
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+
+	SetWarMode( 0 );
+	main_AI_loop();
+
+endprogram
+
+/////////////////////////////////////////////////////////////////////////////
+//
+//  These types fight singlemindedly, until the quarry is dead.
+//  There is no way out but death.
+//
+/////////////////////////////////////////////////////////////////////////////
+
+
+
+/////////////////////////////////////////////////////////////////////////////
+//
+//  CloseDistance - close the distance between self and an opponent.
+//  Returns: 1 if distance is 0 or 1 (no move necessary)
+//           0 if distance is &gt;= 2 (may still need to move)
+//
+//  This is a .EM-file candidate.
+//
+/////////////////////////////////////////////////////////////////////////////
+function CloseDistance( opponent )
+
+
+    case (Distance( me, opponent ))
+        1:              // the most likely, so first
+        0:
+            return 1;
+        default:
+            RunToward( opponent );
+            return 0;
+    endcase
+
+endfunction
+
+
+// Look around me for humans to fight.

Added: trunk/096/pkg/mobiles/oldAI/tamed.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/tamed.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/tamed.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,883 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;:npcutils:NPCCast&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;include/dist&quot;;
+include &quot;include/snooping&quot;;
+include &quot;include/tileEffects&quot;;
+
+set_priority(5);
+
+const  HALT_THRESHOLD := 15;
+const  SYSEVENT_ALL_GUARD_CMD := 0x13;
+
+Const me := Self();
+var npccfgfile     := ReadConfigFile(&quot;npcdesc&quot;);
+var dmgsound       := npccfgfile[me.npctemplate].damagedsound;
+var hit            := npccfgfile[me.npctemplate].attackhitsound;
+var idlesnd1       := npccfgfile[me.npctemplate].idlesound1;
+var idlesnd2       := npccfgfile[me.npctemplate].idlesound2;
+var FLAME_STRENGTH := npccfgfile[me.npctemplate].flamestrength;
+var caster := 0;
+var spells;
+var firebreather;
+var mypack := FindPack(me.serial);
+var orneriness := npccfgfile[me.npctemplate].orneriness;
+var masterserial := GetObjProperty(me, &quot;master&quot;);
+var saywords := 0;
+var master;
+var chaseloop := 0;
+var guarding :=0;
+var following := 0;
+var nextwatch := ReadGameClock();
+var happiness := CInt(GetObjProperty(me,&quot;happiness&quot;));
+var waittime := 120;
+var LAST_BREATH := ReadGameClock();
+if((!happiness)||(happiness == error))
+  happiness := 100;
+  SetObjProperty(me,&quot;happiness&quot;, 100);
+endif
+
+program TamedAI()
+  Detach();
+  var time := ReadGameClock();
+  SetObjProperty(me,&quot;countercheck&quot;, time);
+  var parms := {};
+  parms[1] := me;
+  parms[2] := time;
+  start_script(&quot;:taming:happyCounter&quot;, parms);
+  master := SystemFindObjectBySerial(masterserial, SYSFIND_SEARCH_OFFLINE_MOBILES);
+  if(!master)
+    ApplyRawDamage(me, GetHP(me)+ 1);
+    return;
+  endif
+  me.setmaster(master);
+  if(me.name[&quot;&lt;random&gt;&quot;])
+    SetName(me, RandomName(me));
+  endif
+  if(!happiness)
+    happiness := 10;
+  endif
+  if(!orneriness)
+    orneriness := 0;
+  endif
+  if(!me.backpack)
+    var newbackpack := CreateItemAtLocation(0, 0, 0, 0xe75,1, me.realm);
+    EquipItem(me, newbackpack);
+  endif
+  SetAnchor(me.x, me.y, 20, 0);
+  var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+  if(npccfg[me.npctemplate].spell)
+    caster := 1;
+    spells := GetConfigStringArray(npccfg[me.npctemplate], &quot;spell&quot;);
+  endif
+  if(FLAME_STRENGTH)
+    firebreather := 1;
+  endif
+  SetWarMode(0);
+  SetObjProperty(me, &quot;serial&quot;, me.serial);
+  MainAILoop();
+endprogram
+
+function FindPack(myserial)
+  var mybank := OpenTamedStorageAreas();
+  var bank_obj_name := &quot;Bankbox  &quot; + Hex(myserial);
+  var bankbox := FindRootItemInStorageArea(mybank, bank_obj_name);
+  if(!bankbox)
+    if((me.graphic == 0x123)||(me.graphic == 0x124))
+      bankbox := CreateRootItemInStorageArea(mybank, bank_obj_name, 0x966b);
+    else
+      bankbox := CreateRootItemInStorageArea(mybank, bank_obj_name, UOBJ_BANKBOX);
+    endif
+  else
+    if(((me.graphic == 0x123)||(me.graphic == 0x124))&amp;&amp;((me.backpack).objtype == UOBJ_BANKBOX))
+      DestroyItem(bankbox);
+      bankbox := CreateRootItemInStorageArea(mybank, bank_obj_name, 0x966b);
+    endif
+  endif
+  return bankbox;
+endfunction
+
+function MainAILoop()
+  var ev;
+  nextwatch := ReadGameClock();
+  var mhp;
+  EnableMainEvents();
+  while(GetHp(me)&gt; 0)
+    happiness := GetObjProperty(me,&quot;happiness&quot;);
+    mhp := GetHp(me);
+    if(GetObjProperty(me, &quot;onhold&quot;))
+      HoldLoop(&quot;onhold&quot;);
+    elseif(GetObjProperty(me, &quot;stabled&quot;))
+      HoldLoop(&quot;stabled&quot;);
+    elseif(GetObjProperty(me, &quot;mounted&quot;))
+      HoldLoop(&quot;mounted&quot;);
+    else
+      if(happiness &lt; 10)
+        release();
+      endif
+      ev := os::wait_for_event(waittime);
+      case(ev.type)
+        SYSEVENT_SPEECH:        ProcessSpeech(ev);
+        SYSEVENT_ENGAGED:       Fight(ev.source);
+        SYSEVENT_DAMAGED:       if(GetHp(me)&lt; mhp)
+                                  if(ev.source)
+                                    Fight(ev.source);
+                                  endif
+                                  PlaySoundEffect(me,dmgsound);
+                                endif
+        SYSEVENT_DOUBLECLICKED: if((ev.source == master) or (ev.source.cmdlevel &gt; 2))
+                                  OpenMyPack();
+                                else
+                                  snoop(ev.source, me);
+                                endif
+        SYSEVENT_ITEM_GIVEN:    if(ev.source == master)
+                                  TakeItem(ev);
+                                endif
+        EVID_ALL_ATTACK_CMD:    Fight(ev.target);
+        EVID_ALL_FOLLOW_CMD:    following := ev.target;
+        SYSEVENT_ALL_GUARD_CMD: guarding := ev.target;
+                                PrintTextAbove(me,&quot;*Guarding &quot; + guarding.name + &quot;*&quot;);
+      endcase
+      if(master.dead)
+        dismountme(master);
+      endif  
+      if(following)
+        waittime := 0;
+        Follow();
+      elseif(guarding)
+        waittime := 7;
+        Guard();
+      else
+        waittime := 120;
+        EraseObjProperty(me,&quot;#flees&quot;);
+      endif
+    endif
+  endwhile
+endfunction
+
+function HoldLoop(type)
+  disablemainevents();
+  EnableTameEvents();
+  var ev, hl_happiness;
+  while(GetObjProperty(me, type))
+    if(type == &quot;mounted&quot;)
+      hl_happiness := GetObjProperty(me, &quot;happiness&quot;);
+      ev := os::wait_for_event(60);
+      if(hl_happiness &lt; 10)
+        release();
+      endif
+    else
+      ev := os::wait_for_event(300);
+    endif
+    case(ev.type)
+      EVID_WAKEUP:         EraseObjProperty(me, type);
+    endcase
+  endwhile
+  EnableMainEvents();
+endfunction
+
+function Fight(opponent)
+  var oldfollowing := following;
+  var flees := 0;
+  SetDexterityMod(me, 0);
+  following := 0;
+  if(opponent == me)
+    return;
+  endif
+  if (opponent.hidden)
+    return;
+  endif
+  TurnToward(opponent);
+  SetOpponent(opponent);
+  //var nextbreath := ReadGameClock(); //not used
+  var ev;
+  var loops := 0;
+  var f_waittime := 0;
+  while((opponent) &amp;&amp; (!opponent.dead || !opponent.hidden || !opponent.concealed)&amp;&amp;(dist(me,opponent)&lt; 15))
+    if(!CloseDistance(opponent))
+      loops := loops + 1;
+      f_waittime := 0;
+    else
+      if(!CheckLineOfSight(me, opponent))
+        loops := loops + 1;
+      endif
+      f_waittime := 1;
+    endif
+    ev := wait_for_event(f_waittime);
+    case(ev.type)
+      EVID_ALL_ATTACK_CMD:     opponent := ev.target;
+                               SetOpponent(opponent);
+      EVID_ALL_FOLLOW_CMD:     following := ev.target;
+      SYSEVENT_ALL_GUARD_CMD:  guarding := ev.target;
+                               PrintTextAbove(me,&quot;*Guarding &quot; + guarding.name + &quot;*&quot;);
+      SYSEVENT_SPEECH:         ProcessSpeech(ev);
+      SYSEVENT_ENGAGED:
+      SYSEVENT_DAMAGED:        if(ev.source == opponent)
+                                 PlaySoundEffect(me,dmgsound);
+                               endif
+                               if(ev.source)
+                                 if(ev.source != opponent)
+                                   if((!CheckLineOfSight(me, opponent))||(RandomInt(8)==1))
+                                     opponent := ev.source;
+                                     SetOpponent(opponent);
+                                   endif
+                                 endif
+                                 TurnToward(opponent);
+                               endif
+      EVID_PEACEMADE:          SetWarMode(0);
+                               opponent := 0;
+                               following := oldfollowing;
+                               return;
+      SYSEVENT_DOUBLECLICKED:  if((ev.source == master) or (ev.source.cmdlevel &gt; 2))
+                                 OpenMyPack();
+                               else
+                                 snoop(ev.source, me);
+                               endif
+    endcase
+    if(master.dead)
+       dismountme(master);
+    endif 
+    if(following)
+      SetWarMode(0);
+      opponent := 0;
+      return;
+    endif
+    if(firebreather and caster)
+      if(LAST_BREATH &lt;= ReadGameClock())
+        if((CheckLineOfSight(me, opponent)) and (dist(me, opponent) &lt;= 15))
+          if(RandomInt(4) == 1)
+            cast_meteor(opponent);
+          else
+	        cast_offensive_spell(me,opponent);
+          endif
+          LAST_BREATH := Cint(ReadGameClock() + (RandomInt(4) + 4));
+        endif
+      endif
+    elseif(caster)
+      if(LAST_BREATH &lt;= ReadGameClock())
+        if((CheckLineOfSight(me, opponent)) and (dist(me, opponent) &lt;= 15))
+          cast_offensive_spell(me, opponent);
+          LAST_BREATH := Cint(ReadGameClock() + (RandomInt(4) + 4));
+        endif
+      endif
+    elseif(firebreather)
+      if(LAST_BREATH &lt;= ReadGameClock())
+        if(RandomInt(4)== 1)
+          cast_meteor(opponent);
+        endif
+        LAST_BREATH := Cint(ReadGameClock() + (RandomInt(4) + 4));
+      endif
+    endif
+    if(loops &gt; 30)
+      flees := flees + 1;
+      if(flees &gt; 4)
+        flee(opponent);
+      endif
+      return;
+    endif
+  endwhile
+  SetWarMode(0);
+  opponent := 0;
+  following := oldfollowing;
+endfunction
+
+function CloseDistance(opponent)
+  case (Distance(me, opponent))
+    1:
+    0:       return 1;
+    default: if(!RunToward(opponent))
+               return 1;
+             else
+               return 0;
+             endif
+  endcase
+endfunction
+
+function Transfer()
+  if(GetObjProperty(me, &quot;summoned&quot;))
+    return;
+  endif
+  SendSysMessage(master, &quot;Transfer &quot; + me.name + &quot; to whom?&quot;);
+   var whom := Target(master, TGTOPT_NOCHECK_LOS);
+  if(!whom)
+    SendSysMessage(master, &quot;Cancelled.&quot;);
+    return;
+  endif
+  if(!whom.acctname)
+    printtextabove(me, &quot;Your pet refuses to accept that as a master.&quot;);
+    return;
+  endif
+  if(whom == master)
+    printtextabove(me, &quot;You are already my master.&quot;);
+    return;
+  endif
+  //var npccfgfile := ReadConfigFile(&quot;npcdesc&quot;); // unneeded due to global 'npccfgfile'!!
+  var tameskill  := CInt(npccfgfile[me.npctemplate].tameskill);
+  var mastaming  := GetEffectiveSkill(master, SKILLID_TAMING);
+  var maslore    := GetEffectiveSkill(master, SKILLID_ANIMALLORE)/5;
+  var tgttaming  := CInt(GetEffectiveSkill(whom, SKILLID_TAMING));
+  var tgtlore    := CInt(GetEffectiveSkill(whom, SKILLID_ANIMALLORE)/5);
+  happiness := GetObjProperty(me, &quot;happiness&quot;);
+  if(tgttaming &lt;(tameskill - 50))
+    PlaySoundEffect(me, dmgsound);
+    if(!orneriness)
+      orneriness := 1;
+    endif
+    happiness := happiness - orneriness;
+    if(happiness &lt; 10)
+      release();
+    else
+      SetObjProperty(me, &quot;happiness&quot;, happiness);
+      SendSysMessage(master, &quot;That person has no chance of controlling this beast!&quot;);
+      return;
+    endif
+  endif
+  var dif  := CInt(tameskill -((mastaming/10)+ maslore));
+  var diff := CInt((tameskill-20)-((tgttaming/10)+ tgtlore));
+  if(dif &lt; 1)
+    dif := 1;
+  endif
+  if(diff &lt; 1)
+    diff := 1;
+  endif
+  var tsm  := CInt(RandomInt(40)+(mastaming + 40));
+  var tst  := CInt(RandomInt(40)+(tgttaming + 40));
+  if(tsm &gt; dif)
+    if(tst &lt; diff)
+      PlaySoundEffect(me, dmgsound);
+      happiness := happiness - orneriness;
+      if(happiness &lt; 10)
+        release();
+      else
+        SetObjProperty(me, &quot;happiness&quot;, happiness);
+        SendSysMessage(master,&quot;Your pet refuses to accept &quot; + whom.name + &quot; as a master.&quot;);
+        return;
+      endif
+    else
+      PlaySoundEffect(me, hit);
+      SetObjProperty(me, &quot;master&quot;, whom.serial);
+      PrintTextAbove(me, me.name + &quot; accepts &quot; + whom.name+ &quot; as its new master.&quot;);
+      RestartScript(me);
+    endif
+  else
+    PlaySoundEffect(me, dmgsound);
+    happiness := happiness - orneriness;
+    SetObjProperty(me, &quot;happiness&quot;, happiness);
+    if(happiness &lt; 10)
+      release();
+    else
+      SendSysMessage(master,&quot;Your pet refuses to listen to you!&quot;);
+      return;
+    endif
+  endif
+endfunction
+
+function release()
+  if((GetObjProperty(me,&quot;onhold&quot;)) or (GetObjProperty(me,&quot;stabled&quot;)))
+    return;
+  endif
+  var char;
+  var mounted_char;
+  var onchars := EnumerateOnlineCharacters();
+  if(GetObjProperty(me,&quot;summoned&quot;) == 1)
+    if(GetObjProperty(me,&quot;mounted&quot;) == 1)
+      char := GetObjProperty(me,&quot;mounted_on&quot;);
+      foreach person in onchars
+        if(person.serial == CInt(char))
+          mounted_char := person;
+          break;
+        endif
+      endforeach
+      dismountme(mounted_char);
+    endif
+    PlayStationaryEffect(me.x, me.y, me.z, FX_SMOKE, 0xa, 0xa, 0, me.realm);
+    MoveCharacterToLocation(me,1, 1, 0,MOVECHAR_FORCELOCATION);
+    ApplyRawDamage(me, GetHp(me)+ 3);
+  else
+    if(GetObjProperty(me,&quot;mounted&quot;))
+      char := GetObjProperty(me,&quot;mounted_on&quot;);
+      foreach person in onchars
+        if(person.serial == CInt(char))
+          mounted_char := person;
+          break;
+        endif
+      endforeach
+      dismountme(mounted_char);
+    endif
+    me.script := npccfgfile[me.npctemplate].script;
+    PrintTextAbove(me, me.name + &quot; has decided it is better off without a master.&quot;);
+    me.setmaster(0);
+    EraseObjProperty(me, &quot;master&quot;);
+    EraseObjProperty(me, &quot;serial&quot;);
+    EraseObjProperty(me, &quot;script&quot;);
+    EraseObjProperty(me, &quot;happiness&quot;);
+    EraseObjProperty(me, &quot;mounted&quot;);
+    EraseObjProperty(me, &quot;mounted_on&quot;);
+    SetAnchor(me.x,me.y,10,1);
+    SetHpRegenRate(me ,(100)* 12);
+    RestartScript(me);
+  endif
+endfunction
+
+function dismountme(who)
+  var mount := GetEquipmentByLayer(who, 25);
+  me.facing := who.facing;
+  MoveCharacterToLocation(me, master.x, who.y, who.z, MOVECHAR_FORCELOCATION);
+  EraseObjProperty(me, &quot;mounted&quot;);
+  EraseObjProperty(me, &quot;mounted_on&quot;);
+  DestroyItem(mount);
+endfunction
+
+function Fetch()
+  var tobj := Target(master);
+  if(tobj.container)
+    PlaySoundEffect(me, dmgsound);
+    return;
+  endif
+  var times := 0;
+  while((Distance(me, tobj)&gt; 1)&amp;&amp;(times &lt;= 5)&amp;&amp; CheckLineOfSight(me,tobj))
+    if(!walktoward(tobj))
+      sleepms(100);
+      times := times + 1;
+    else
+      times := 0;
+    endif
+  endwhile
+  if(Accessible(me,tobj))
+    PlaySoundEffect(me, hit);
+    // Changed from mypack to me.backpack. Upon death npcs would not have the item
+    // on them for loot, causing stuff to be left in their storage. BAD NPC!
+    MoveItemToContainer(tobj, me.backpack);
+    while((Distance(me, master)&gt; 1)&amp;&amp;(times &lt;= 5)&amp;&amp; CheckLineOfSight(me,master))
+      if(!walktoward(master))
+        sleepms(100);
+        times := times + 1;
+      else
+        times := 0;
+      endif
+    endwhile
+    MoveItemToLocation(tobj, me.x, me.y, me.z, MOVEITEM_FORCELOCATION);
+  else
+    PlaySoundEffect(me, dmgsound);
+  endif
+endfunction 
+
+function Get()
+  var tobj := Target(master);
+  if(tobj.container)
+    PlaySoundEffect(me, dmgsound);
+    return;
+  endif
+  var times := 0;
+  while((Distance(me, tobj)&gt; 1)&amp;&amp;(times &lt;= 5)&amp;&amp; CheckLineOfSight(me,tobj))
+    if(!walktoward(tobj))
+      sleepms(100);
+      times := times + 1;
+    else
+      times := 0;
+    endif
+  endwhile
+  if(Accessible(me,tobj))
+    PlaySoundEffect(me, hit);
+    // Changed from mypack to me.backpack. Upon death npcs would not have the item
+    // on them for loot, causing stuff to be left in their storage. BAD NPC!
+    MoveItemToContainer(tobj, me.backpack);
+  else
+    PlaySoundEffect(me, dmgsound);
+  endif
+endfunction 
+
+function drop()
+  foreach myitems in EnumerateItemsInContainer(mypack)
+    if(myitems.container.serial == mypack.serial)
+      MoveItemToLocation(myitems, me.x, me.y, me.z,0);
+      sleepms(100);
+    endif
+  endforeach
+endfunction
+
+function speak()
+  if(RandomInt(1)+1 == 1)
+    PlaySoundEffect(me, idlesnd1);
+  else
+    PlaySoundEffect(me, idlesnd1);
+  endif
+endfunction
+
+function OpenMyPack();
+  if((me.graphic == 0x123)||(me.graphic == 0x124))
+    if(Distance(me, master)&gt; 2)
+      return;
+    endif
+    foreach item in EnumerateItemsInContainer(mypack)
+      if(item.container == me.backpack)
+        MoveItemToContainer(item, me.backpack);
+      endif
+    endforeach
+    SendOpenSpecialContainer(master, mypack);
+    return;
+  else
+    if(Distance(me, master)&gt; 1)
+      return;
+    endif
+    var alreadymounted := GetEquipmentByLayer(master, 25);
+    if(alreadymounted)
+      return;
+    endif
+    var mounttype := 0;
+    case(me.graphic)
+      0xcc: mounttype := 0x3ea2;
+      0xc8: mounttype := 0x3e9f;
+      0xe2: mounttype := 0x3ea0;
+      0xe4: mounttype := 0x3ea1;
+      0xdc: mounttype := 0x3ea6;
+      0xd2: mounttype := 0x3ea3;
+      0xda: mounttype := 0x3ea4;
+      0xdb: mounttype := 0x3ea5;
+    endcase
+    if(mounttype)
+      if(MoveCharacterToLocation(master,me.x,me.y,me.z,0))
+        master.facing := me.facing;
+        var mount := CreateItemAtLocation(1, 1, 0, 0xf021,1, me.realm);
+        mount.movable := 1;
+        print(mount);
+        if(Cint(GetObjProperty(me, &quot;summoned&quot;)) == 1)
+          SetObjProperty(mount, &quot;summoned&quot;, 1);
+        endif
+        mount.color := me.color;
+        print(MoveCharacterToLocation(me, 1, 1, 0, MOVECHAR_FORCELOCATION));
+        mount.graphic := mounttype;
+        print(EquipItem(master,mount));
+        SetObjProperty(mount,&quot;serial&quot;, me.serial);
+        SetObjProperty(me,&quot;mounted&quot;, 1);
+        SetObjProperty(me,&quot;mounted_on&quot;, master.serial);
+        mount.movable := 0;
+        guarding := 0;
+        following := 0;
+      endif
+    endif
+  endif
+endfunction
+
+function TakeItem(ev)
+  var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+  var foodtype := npccfg[me.npctemplate].food;
+  if(!foodtype)
+    foodtype := &quot;all&quot;;
+  endif
+  var cfg := ReadConfigFile(&quot;:*:food&quot;);
+  var elem := FindConfigElem(cfg,foodtype);
+  var foodarray := GetConfigStringArray(elem,&quot;food&quot;);
+  if(CStr(ev.item.objtype)in foodarray)
+    PlaySoundEffect(me, CInt(0x3b)+ RandomInt(3));
+    DestroyItem(ev.item);
+    PrintTextAbovePrivate(me,&quot;Your pet looks happier.&quot;, master);
+    SetObjProperty(me,&quot;happiness&quot;, 100);
+    return;
+  endif
+  if((me.graphic == 0x123)||(me.graphic == 0x124))
+    // Changed from mypack to me.backpack. Upon death npcs would not have the item
+    // on them for loot, causing stuff to be left in their storage. BAD NPC!
+    if(!MoveItemToContainer(ev.item, me.backpack))
+      say(&quot;*Your pet cannot hold that item*&quot;);
+      return;
+    else
+      PlaySoundEffect(me,0x49);
+    endif
+  else
+    var yourpack := ev.source.backpack;
+    MoveItemToContainer(ev.item,yourpack);
+  endif
+endfunction
+
+function Guard()
+  if(nextwatch &lt;= ReadGameClock())
+    nextwatch := ReadGameClock()+ 7;
+    if(RandomInt(8)==1)
+      PrintTextAbove(me,&quot;*Guarding &quot; + guarding.name + &quot;*&quot;);
+    endif
+    foreach mob in ListHostiles(guarding, 9, 0);
+      Fight(mob);
+      return;
+    endforeach
+  endif
+  if((!GetStrength(guarding))||(guarding.dead)||(dist(me,guarding)&gt; 15))
+    guarding := 0;
+  endif
+endfunction
+
+function Follow()
+  var d := Distance(me, following);
+  if(d &lt;= 2)
+    waittime := 1;
+  elseif(d &gt; 15)
+    following := 0;
+    waittime := 120;
+  elseif(d &gt; 6)
+    if(GetObjProperty(me, &quot;Pause&quot;))
+      waittime := 2;
+    else
+      var ma := 200 - CInt(GetDexterity(me));
+      SetDexterityMod(me, CInt(GetDexterityMod(me))+ ma);
+      RunToward(following);
+      SetDexterityMod(me, CInt(GetDexterityMod(me))- ma);
+      waittime := 0;
+    endif
+  else
+    if(GetObjProperty(me, &quot;Pause&quot;))
+      waittime := 2;
+    else
+      var ma := 200 - CInt(GetDexterity(me));
+      SetDexterityMod(me, CInt(GetDexterityMod(me))+ ma);
+      walktoward(following);
+      SetDexterityMod(me, CInt(GetDexterityMod(me))- ma);
+      waittime := 0;
+    endif
+  endif
+  if(guarding)
+    Guard();
+  endif
+endfunction
+
+function ProcessSpeech(ev)
+  if(ev.source.serial != masterserial)
+    return;
+  endif
+  if(!master)
+    RestartScript(me);
+  endif
+  var evtext := lower(ev.text);
+  var mename := lower(me.name);
+  if(evtext[mename + &quot; kill&quot;] || evtext[mename + &quot; attack&quot;] || evtext[&quot;all kill&quot;] || evtext[&quot;all attack&quot;])
+    var what := Target(master, TGTOPT_HARMFUL + TGTOPT_CHECK_LOS);
+    if(what)
+      if(what == ev.source)
+        return;
+      elseif(evtext[&quot;all kill&quot;] || evtext[&quot;all attack&quot;])
+        if(obediencecheck()== 0)
+          return;
+        endif
+        AllCommand(EVID_ALL_ATTACK_CMD, what);
+      else
+        if(obediencecheck()== 0)
+          return;
+        endif
+        Fight(what);
+      endif
+    endif
+  elseif(evtext[mename + &quot; stop&quot;] || evtext[&quot;all stop&quot;])
+    if(obediencecheck()== 0)
+      return;
+    endif
+    guarding := 0;
+    following := 0;
+  elseif((evtext[mename + &quot; come&quot;])||(evtext[&quot;all come&quot;]))
+    if(obediencecheck()== 0)
+      return;
+    endif
+    var done := 0;
+    chaseloop := 0;
+    while(done == 0)
+      chaseloop := chaseloop +1;
+      done := CloseDistance(ev.source);
+      if(chaseloop &gt; 25)
+        done :=1;
+      endif
+    endwhile
+  elseif(evtext[mename + &quot; follow&quot;])
+    if(obediencecheck()== 0)
+      return;
+    endif
+    if(evtext[&quot;follow me&quot;])
+      following := ev.source;
+    else
+      var what := Target(master, TGTOPT_CHECK_LOS);
+      if(what)
+        following := what;
+      endif
+    endif
+  elseif(evtext[&quot;all follow&quot;])
+    if(obediencecheck()== 0)
+      return;
+    endif
+    if(evtext[&quot;follow me&quot;])
+      following  := ev.source;
+    else
+      var what := Target(master, TGTOPT_CHECK_LOS);
+      if(what)
+        AllCommand(EVID_ALL_FOLLOW_CMD, what);
+      endif
+    endif
+  elseif(evtext[mename + &quot; transfer&quot;] ||(evtext[&quot;all transfer&quot;]))
+    Transfer();
+  elseif(evtext[mename + &quot; release&quot;] ||(evtext[&quot;all release&quot;]))
+    release();
+  elseif(evtext[mename + &quot; guard me&quot;])
+	guarding := ev.source;
+	PrintTextAbove(me,&quot;I'm guarding you.&quot;);
+  elseif(evtext[mename + &quot; guard&quot;])
+    say(&quot;Who should I guard?&quot;);
+    var what := Target(master, TGTOPT_HELPFUL + TGTOPT_CHECK_LOS);
+	if(what.isA(POLCLASS_UOBJECT))
+      guarding := what;
+	  PrintTextAbove(me,&quot;I'm guarding &quot; + guarding.name + &quot;.&quot;);
+	endif
+  elseif(evtext[&quot;all guard me&quot;])
+	guarding := ev.source;
+	PrintTextAbove(me,&quot;I'm guarding you.&quot;);
+  elseif(evtext[&quot;all guard&quot;])
+    say(&quot;Who should I guard?&quot;);
+	var what := Target(master, TGTOPT_HELPFUL + TGTOPT_CHECK_LOS);
+	if(GetHp(what))
+      AllCommand(SYSEVENT_ALL_GUARD_CMD, what);
+	endif
+  elseif(evtext[mename + &quot; fetch&quot;])
+    if(obediencecheck()== 0)
+      return;
+    endif
+    Fetch();
+  elseif(evtext[mename + &quot; get&quot;])
+    if(obediencecheck()== 0)
+      return;
+    endif
+    Get();
+  elseif(evtext[mename + &quot; drop&quot;])
+    if(obediencecheck()== 0)
+      return;
+    endif
+    drop();
+  elseif(evtext[mename + &quot; speak&quot;]  ||(evtext[&quot;all speak&quot;]))
+    if(obediencecheck()== 0)
+      return;
+    endif
+    speak();
+  endif
+endfunction
+
+function AllCommand(evtype,what)
+  var mobs := ListMobilesNearLocation(master.x, master.y, master.z, 9, me.realm);
+  var eve := struct;
+  eve.+type := evtype;
+  eve.+source := me;
+  eve.+target := what;
+  SendEvent(me, eve);
+  foreach mob in mobs
+    if(GetObjProperty(mob, &quot;master&quot;)== me.master.serial)
+      SendEvent(mob, eve);
+    endif
+  endforeach
+endfunction
+
+function cast_meteor(opponent)
+  var base := Cint(((FLAME_STRENGTH * GetHp(me)) / GetMaxHp(me)) / 2);
+  var dmg :=  RandomInt(base) + base;
+  PerformAction(me,0x0c);
+  PlaysoundEffect(me, 0x16b);
+  sleep(3);
+  PlayMovingEffect(me, opponent, 0x36d4, 10, 1, 1);
+  ApplyRawDamage(opponent, dmg);
+endfunction
+
+function flee(opponent)
+  var numflees := GetObjProperty(me,&quot;#flees&quot;);
+  if(numflees)
+    if(numflees &gt; 5)
+      MoveCharacterToLocation(me,1,1,0,MOVECHAR_FORCELOCATION);
+      SetObjProperty(me,&quot;guardkill&quot;,1);
+      ApplyRawDamage(me, GetMaxHp(me)+ 3);
+    else
+      numflees := numflees + 1;
+    endif
+  else
+    numflees := 1;
+  endif
+  SetObjProperty(me,&quot;#flees&quot;,numflees);
+  var runs := 0;
+  while((Distance(me, opponent)&lt; 20)&amp;&amp;(runs &lt; 50))
+    RunAwayFrom(opponent);
+    runs := runs +1;
+    wait_for_event(0);
+  endwhile
+  RestartScript(me);
+endfunction
+
+function obediencecheck()
+  var arry := { 0xcc, 0xc8, 0xe2, 0xe4, 0x123, 0x124, 0xd2, 0xdb };
+  if(me.objtype in arry)
+    return 1;
+  endif
+  var maslore    := GetEffectiveSkill(master, SKILLID_ANIMALLORE)/5;
+  var mastaming  := CInt(GetEffectiveSkill(master, SKILLID_TAMING)+ maslore);
+  var checkvalue := CInt(mastaming - 20);
+  happiness := GetObjProperty(me, &quot;happiness&quot;);
+  var happybonus := happiness/10;
+  checkvalue := checkvalue + happybonus;
+  var defiance :=(orneriness * 20)-30;
+  if(defiance &lt; 1)
+    defiance := 1;
+  endif
+  defiance := defiance + petcount();
+  var finaldefiance := CInt(defiance + RandomInt(40));
+  if(GetObjProperty(me, &quot;summoned&quot;)== 1)
+    return 1;
+  elseif(finaldefiance &gt; checkvalue)
+    PlaySoundEffect(me, dmgsound);
+    happiness := happiness - orneriness;
+    SetObjProperty(me, &quot;happiness&quot;,(happiness-1));
+    if(happiness &lt; 10)
+      release();
+    endif
+    return 0;
+  else
+    PlaySoundEffect(me,hit);
+    if(happiness &lt; 10)
+      release();
+      return 0;
+    endif
+    return 1;
+  endif
+endfunction
+
+function petcount()
+  var pets := 0;
+  var mobs := ListMobilesNearLocation(me.x,me.y,me.z,8, me.realm);
+  foreach mob in mobs
+    if((mob.script == &quot;tamed&quot;)&amp;&amp;(GetObjProperty(mob,&quot;master&quot;)==masterserial))
+      if(GetObjProperty(mob, &quot;summoned&quot;))
+        pets := pets + 0;
+      else
+        pets := pets+5;
+      endif
+    endif
+  endforeach
+  return pets;
+endfunction
+
+function EnableTameEvents()
+  EnableEvents(EVID_WAKEUP);
+endfunction
+
+function EnableMainEvents()
+  EnableEvents(SYSEVENT_SPEECH, 8);
+  EnableEvents(SYSEVENT_ENGAGED);
+  EnableEvents(SYSEVENT_DAMAGED);
+  EnableEvents(SYSEVENT_DOUBLECLICKED);
+  EnableEvents(SYSEVENT_ITEM_GIVEN);
+  EnableEvents(EVID_PEACEMADE);
+endfunction
+
+function disablemainevents()
+  DisableEvents(SYSEVENT_SPEECH);
+  DisableEvents(SYSEVENT_ENGAGED);
+  DisableEvents(SYSEVENT_DAMAGED);
+  DisableEvents(SYSEVENT_ITEM_GIVEN);
+  DisableEvents(EVID_PEACEMADE);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/townGuard.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/townGuard.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/townGuard.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,280 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/client&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;:begging:begging&quot;;
+include &quot;:npcutils:trainSkill&quot;;
+include &quot;:poisonwatcher:poisons&quot;;
+
+var flee_point := 0;
+var npccfg := ReadConfigFile(&quot;::npcdesc&quot;);
+
+const HALT_THRESHOLD := 10;
+var me := Self();
+
+var cfgfile     := ReadConfigFile(&quot;::gzone&quot;);
+var keys        := GetConfigStringKeys(cfgfile);
+var next_wander := ReadGameClock() + 30;
+var nextchk     := ReadGameClock() + 120;
+var wanders     := 9;
+var myanchor;
+
+program CastleGuard()
+  SetObjProperty(me, &quot;MerchantType&quot;, &quot;TownGuard&quot;);
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+  myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  if(myanchor)
+    MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+  endif
+  drop_anchor();
+  myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  EnableMainEvents();
+  EnableEvents(SYSEVENT_SPEECH, 2);
+  SetWarMode(0);
+  set_priority(100);
+  var ev, txt;
+  var myname := lower(SplitWords(me.name)[1]);
+  while (1)
+    ev := os::wait_for_event(30);
+	if(ev)
+      case(ev.type)
+        EVID_NODE:           foreach thing in (ev.crims)
+                               Fight(thing);
+                             endforeach
+        SYSEVENT_SPEECH:     txt := lower(ev.text);
+                             if(txt[myname] &amp;&amp; (txt[&quot;train&quot;] || txt[&quot;teach&quot;]))
+                               TurnToward(ev.source);
+                               MerchantTrain(me, ev.source, ev.text);
+                             endif
+        SYSEVENT_ENGAGED:    if((ev.source) &amp;&amp; (!ev.source.dead))
+		                       say(&quot;Thou shalt regret thine actions, swine!&quot;);
+                               Fight(ev.source);
+                             endif
+        SYSEVENT_DAMAGED:    if((ev.source) &amp;&amp; (!ev.source.dead))
+		                       say(&quot;Thou shalt regret thine actions, swine!&quot;);
+                               Fight(ev.source);
+                             endif
+        SYSEVENT_ITEM_GIVEN: TrainSkill(me, ev.source, ev.item);
+      endcase
+	endif
+	if(ReadGameClock() &gt;= next_wander)
+	  begpurse(me);
+      WanderMe();
+      next_wander := ReadGameClock() + 10;
+    endif
+    if(ReadGameClock() &gt; nextchk)
+      lookiehere();
+      nextchk := ReadGameClock() + 120;
+    endif
+  endwhile
+endprogram
+
+function WanderMe()
+  wander();
+  if(coordist(me.x, me.y, myanchor[1], myanchor[2]) &gt; 15)
+    MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+  endif
+endfunction
+
+function lookiehere()
+  foreach npc in ListMobilesNearLocation(me.x, me.y, me.z, 15, me.realm)
+    foreach listing in keys
+      var range := SplitWords(cfgfile[listing].range);
+      if((npc.x &gt;= CInt(range[1])) &amp;&amp; (npc.x &lt;= CInt(range[3])) &amp;&amp; (npc.y &gt;= CInt(range[2])) &amp;&amp; (npc.y &lt;= CInt(range[4])))
+        var timer := Cint(GetObjProperty(npc, &quot;guardstimer&quot;));
+      	if((npc.criminal) and (!npc.dead))
+          if(timer &lt; ReadGameClock())
+            SetObjProperty(npc, &quot;#guardstimer&quot;, ReadGameClock() + 15);
+      	    Fight(npc);
+          endif
+      	elseif((npc.script == &quot;tamed&quot;) || (npc.script == &quot;employed&quot;))
+      	  var master := GetObjProperty(npc, &quot;master&quot;);
+      	  if(master)
+      	    if(SystemFindObjectBySerial(master, SYSFIND_SEARCH_OFFLINE_MOBILES).criminal)
+              if(timer &lt; ReadGameClock())
+                SetObjProperty(npc, &quot;#guardstimer&quot;, ReadGameClock() + 15);
+      	        Fight(npc);
+              endif
+            endif
+          endif
+        elseif((!npccfg[npc.npctemplate].guardignore) and (npc.isA(POLCLASS_NPC)))
+          if(timer &lt; ReadGameClock())
+            SetObjProperty(npc, &quot;#guardstimer&quot;, ReadGameClock() + 15);
+      	    Fight(npc);
+          endif
+        endif
+        break;
+      endif
+      sleepms(10);
+    endforeach
+    sleepms(10);
+  endforeach
+endfunction
+
+function Fight(opponent)
+  SetAnchor( me.x, me.y, 20, 0 );
+  if(opponent.isA(POLCLASS_NPC))
+	SetObjProperty(opponent, &quot;guardkill&quot;, 1);
+  endif
+  if((opponent.cmdlevel &gt; 0) || (opponent.serial == me.serial))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  var parms := {};
+  parms[1] := me.x;
+  parms[2] := me.y;
+  parms[3] := me.z;
+  SetObjProperty(me, &quot;StartCoords&quot;, parms);
+  var tries := 0;
+  PlayStationaryEffect(me.x, me.y, me.z, 0x3728, 0xa, 0xa, me.realm);
+  while(((Distance(me, opponent) &gt; 7) || (!CheckLineOfSight(me, opponent))) and (tries &lt; 5))
+    var newx := opponent.x + RandomInt(4) - RandomInt(4);
+    var newy := opponent.y + RandomInt(4) - RandomInt(4);
+    sleepms(500);
+    MoveCharacterToLocation(me, newx, newy, opponent.z, MOVECHAR_FORCELOCATION);
+    tries := tries + 1;
+  endwhile
+  PlayStationaryEffect(me.x, me.y, me.z, 0x3728, 0xa, 0xa, 0, me.realm);
+  PlaySoundEffect(me, 0x01ff);
+  PrintTextAbove(me, &quot;Thou shalt regret thine actions, swine!&quot;);
+  SetObjProperty(opponent, &quot;guardkill&quot;, 1);
+  var oldprio := set_priority(50);
+  if(tries &gt;= 5)
+    PerformAction(me, 13);
+    ApplyRawDamage(opponent, GetHP(opponent) + 10);
+    return;
+  endif
+  SetOpponent(opponent);
+  prepare_for_fight(opponent);
+  TurnToward(opponent);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while((opponent) &amp;&amp; (!opponent.dead) &amp;&amp; (!opponent.hidden) &amp;&amp; (!opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20))
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	in_combat_event_loop(opponent, loops);
+	ev := wait_for_event(waittime);
+  endwhile
+  sleep(2);
+  post_combat();
+  return;
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode(0);
+  SetOpponent(0);
+  var allpoisons := GetAllPoisons(me);
+  if(allpoisons.size() &gt; 0)
+    sleep(1);
+    PerformAction(me, 0x22);
+    foreach poison in allpoisons
+      CureSpecific(me, poison, -1);
+    endforeach
+    PlaySoundEffect(me, 0x31);
+    sleep(1);
+  endif
+  if(GetHp(me) &lt; GetMaxHP(me))
+    sleep(1);
+    PerformAction(me, 0x22);
+    SetHp(me, GetMaxHP(me));
+    PlaySoundEffect(me, 0x32);
+    sleep(1);
+  endif
+  lookiehere();
+  sleep(1);
+  RestartScript(me);
+endfunction
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function CheckForCriminals(jerk)
+  if(jerk.dead)
+	return;
+  endif
+  if(jerk.criminal)
+	say(&quot;Thou wilt regret thine actions, swine!&quot;);
+	Fight(jerk);
+  endif
+endfunction
+
+function cleareventque()
+  var ev;
+  repeat
+  until(!(ev := os::wait_for_event(0)));
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function EnableMainEvents()
+    cleareventque();
+    DisableEvents(SYSEVENT_DISENGAGED);
+    EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED);
+    EnableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function DisableMainEvents()
+    cleareventque();
+    DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED );
+    DisableEvents(SYSEVENT_ITEM_GIVEN);
+endfunction
+
+function EnableCombatEvents()
+    EnableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function DisableCombatEvents()
+    DisableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  var allpoisons := GetAllPoisons(me);
+  if(allpoisons.size() &gt; 0)
+    sleep(1);
+    PerformAction(me, 0x22);
+    foreach poison in allpoisons
+      CureSpecific(me, poison, -1);
+    endforeach
+    PlaySoundEffect(me, 0x31);
+    sleep(1);
+  endif
+  if(GetHp(me) &lt; (GetStrength(me) / 2))
+    sleep(1);
+    PerformAction(me, 0x22);
+    SetHp(me, me.strength);
+    PlaySoundEffect(me, 0x32);
+    sleep(1);
+  endif
+  if(loops &gt; 50)
+	RestartScript(me);
+	return;
+  endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/townHealer.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/townHealer.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/townHealer.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,218 @@
+use npc;
+use basic;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;include/utility&quot;;
+include &quot;include/mrcSpawn&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCBackpacks&quot;;
+include &quot;include/client&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;include/res&quot;;
+include &quot;include/resPenalty&quot;;
+include &quot;include/findCity&quot;;
+include &quot;:begging:begging&quot;;
+include &quot;:npcutils:trainSkill&quot;;
+
+const SOUND_EFFECT_RES := 0x215;
+const ACTION_EFFECT_CAST2 := 0x11;
+const MAX_SKILLS      := 48;
+
+var me := Self();
+me.hidden := 1;
+var inv_fs, inv_pb, inv_1c, inv_rs;
+var merchant_type := GetObjProperty(me, &quot;MerchantType&quot;);
+var npccfg        := ReadConfigFile(&quot;npcdesc&quot;);
+
+set_priority(50);
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+  if(!merchant_type)
+    SetObjProperty(me, &quot;MerchantGroup&quot;, &quot;Mage&quot;);
+    merchant_type := &quot;Mage&quot;;
+  endif
+  var myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  if(myanchor)
+    MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+  endif
+  drop_anchor();
+  myanchor := GetObjProperty(me, &quot;Anchor&quot;);
+  var spawnname := merchant_type + &quot; &quot; + myanchor[1] + &quot; &quot; + myanchor[2] + &quot; &quot; + myanchor[3];
+  inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+  inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+  inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+  inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+  while((!inv_rs) or (!inv_fs) or (!inv_pb) or (!inv_1c))
+    sleep(5);
+    inv_fs := FindRootItemInStorageArea(storage, spawnname + &quot; FS&quot;);
+    inv_pb := FindRootItemInStorageArea(storage, spawnname + &quot; PB&quot;);
+    inv_1c := FindRootItemInStorageArea(storage, spawnname + &quot; 1C&quot;);
+    inv_rs := FindRootItemInStorageArea(storage, spawnname + &quot; RS&quot;);
+  endwhile
+  me.hidden := 0;
+  EnableEvents( SYSEVENT_ITEM_GIVEN);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED);
+  EnableEvents(SYSEVENT_ENTEREDAREA, 3);
+  DisableEvents(SYSEVENT_SPEECH);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+    me.frozen := 1;
+  endif
+  if(!GetObjProperty(me, &quot;MyGold&quot;))
+    SetObjProperty(me, &quot;MyGold&quot;, 1000);
+  endif
+  var next_wander := ReadGameClock() + 10;
+  const loops := 0;
+  while (1)
+    var ev;
+    ev := os::wait_for_event(120);
+    if(ev)
+      case (ev.type)
+        SYSEVENT_ENGAGED:         lookiehere(me);
+        SYSEVENT_DAMAGED:         lookiehere(me);
+        EVID_NODE:                var txt := ev.text;
+                                  if((ev.source.cmdlevel &gt; 2) &amp;&amp; (ev.text[&quot;showinventory&quot;]))
+                                    SendOpenSpecialContainer(ev.source, inv_fs);
+                                  elseif((ev.source.cmdlevel &gt; 2) &amp;&amp; (ev.text[&quot;unloadcfg&quot;]))
+                                    UnloadConfigFile(&quot;::mrcspawn&quot;);
+                                  else
+                                    if(ev.text[&quot;buy&quot;])
+                                      TurnToward(ev.source);
+                                      var res := SendBuyWindow(ev.source, inv_fs, Self(), inv_pb);
+                                      foreach thing in ListRootItemsInContainer((ev.source).backpack)
+                                        EraseObjProperty(thing, &quot;ClearRestock&quot;);
+                                      endforeach
+                                    elseif (ev.text[&quot;sell&quot;])
+                                      if(GetObjProperty(me, &quot;MyGold&quot;) &gt;= 1000)
+                                        TurnToward(ev.source);
+                                        ModifyPCSellList(merchant_type, (ev.source).backpack);
+                                        var res := SendSellWindow(ev.source, Self(), inv_fs, inv_pb, inv_1c);
+                                        if(res)
+                                          PrintTextAbovePrivate(Self(), &quot;You don't have anything I would be interested in.&quot;, ev.source);
+                                        endif
+                                      else
+                                        PrintTextAbovePrivate(Self(), &quot;I cannot afford any more of that.&quot;, ev.source );
+                                      endif
+                                    elseif((txt[&quot;vendor train&quot;]) || (txt[&quot;vendor teach&quot;]) || (txt[&quot;merchant train&quot;]) || (txt[&quot;merchant teach&quot;]))
+                                      TurnToward(ev.source);
+                                      MerchantTrain(me, ev.source, ev.text);
+                                    endif
+                                  endif
+        SYSEVENT_MERCHANT_BOUGHT: TurnToward(ev.source);
+                                  PrintTextAbovePrivate(Self(), &quot;The total of thy sale is &quot; + ev.amount+&quot;.&quot;, ev.source);
+                                  var mygold := GetObjProperty(me, &quot;MyGold&quot;);
+                                  mygold := mygold - ev.amount;
+                                  SetObjProperty(me, &quot;MyGold&quot;, mygold);
+                                  foreach item in EnumerateItemsInContainer(inv_pb)
+                                    MoveItemToContainer(item, inv_fs);
+                                    SetObjProperty(item,&quot;ClearRestock&quot;, (ReadGameClock() + 1800));
+                                    item.buyprice  := itemconfig[item.objtype].VendorBuysFor;
+                                    item.sellprice := itemconfig[item.objtype].VendorSellsFor;
+                                  endforeach
+                                  PlaySoundEffect(me, 0x38);
+        SYSEVENT_MERCHANT_SOLD:   TurnToward(ev.source);
+                                  PrintTextAbovePrivate(Self(), &quot;The total of thy purchase is &quot; + ev.amount +&quot;.&quot;, ev.source );
+                                  var mygold := GetObjProperty(me, &quot;MyGold&quot;);
+                                  mygold := mygold + ev.amount;
+                                  SetObjProperty(me, &quot;MyGold&quot;, mygold);
+                                  PlaySoundEffect(me, 0x38);
+        SYSEVENT_ITEM_GIVEN:      TrainSkill(me, ev.source, ev.item);
+        SYSEVENT_ENTEREDAREA:     if(!ev.source.isA(POLCLASS_NPC))
+                                    HealerStuff(ev.source);
+                                  endif
+      endcase
+    endif
+	if(ReadGameClock() &gt;= next_wander)
+	  begpurse(me);
+      wander();
+      if(coordist(me.x, me.y, myanchor[1], myanchor[2]) &gt; 5)
+        MoveCharacterToLocation(me, myanchor[1], myanchor[2], myanchor[3], MOVECHAR_FORCELOCATION);
+      endif
+      next_wander := ReadGameClock() + 30;
+    endif
+    lookiehere(me);
+  endwhile
+
+function HealerStuff(mobile)
+  var parms := {me, mobile};
+  start_script(&quot;doRes&quot;, parms);
+  return;
+endfunction
+
+function lookiehere(who)
+  var mobiles := ListMobilesNearLocation(who.x, who.y, who.z, 15, who.realm);
+  var guard, num, i, hogcall, guardzone, element, range, timer, elem;
+  var cfgfile := ReadConfigFile(&quot;::gzone&quot;);
+  var entries := GetConfigStringKeys(cfgfile);
+  foreach listing in entries
+    element :=  cfgfile[listing];
+    range := element.range;
+    range := SplitWords(range);
+    if((who.x &gt;= CInt(range[1])) &amp;&amp; (who.x &lt;= CInt(range[3])) &amp;&amp; (who.y &gt;= CInt(range[2])) &amp;&amp; (who.y &lt;= CInt(range[4])))
+      guardzone := 1;
+      break;
+    endif
+  endforeach
+  foreach npc in mobiles
+	if(!npc.acctname)
+	  elem := FindConfigElem(npccfg, npc.npctemplate);
+	  if(!elem.guardignore &amp;&amp; !GetObjProperty(npc, &quot;called&quot;));
+		if(npc.script != &quot;tamed&quot;)
+          case(RandomInt(4) + 1)
+            1: hogcall := &quot;Guards! They're killing people here!&quot;;
+            2: hogcall := &quot;Guards! I pay my taxes and no guards? Guards!&quot;;
+            3: hogcall := &quot;Help! They're dying here! Guards!&quot;;
+            4: hogcall := &quot;Guards! Come save us quick!&quot;;
+            5: hogcall := &quot;Ah! Help us! Guards!&quot;;
+          endcase
+          PrintTextAbove(me, hogcall);
+          if(guardzone == 1)
+		    SetObjProperty(npc, &quot;called&quot;, 1);
+            num := RandomInt(4) + 1;
+            var count := 0;
+            foreach mobile in ListMobilesNearLocation(me.x, me.y, me.z, 25, me.realm)
+              if(count == 3)
+                break;
+              else
+		        if(mobile.npctemplate == &quot;townguard&quot;)
+		          var ev := array;
+                  ev.+ type;
+                  ev.+ source;
+                  ev.type := EVID_PEACEMADE;
+                  ev.source := npc;
+                  SendEvent(mobile, ev);
+                  ev.type := SYSEVENT_ENGAGED;
+                  SendEvent(mobile, ev);
+                  count := count + 1;
+                endif
+              endif
+            endforeach
+          endif
+		endif
+	  endif
+    else
+	  timer := GetObjProperty(npc, &quot;guardstimer&quot;);
+	  if(npc.criminal &amp;&amp; (timer &lt; ReadGameClock() || timer.errortext))
+        foreach mobile in ListMobilesNearLocation(me.x, me.y, me.z, 15, me.realm)
+		  if(mobile.npctemplate == &quot;townguard&quot;)
+		    var ev := array;
+            ev.+ type;
+            ev.+ source;
+            ev.type := EVID_PEACEMADE;
+            ev.source := npc;
+            SendEvent(mobile, ev);
+            ev.type := SYSEVENT_ENGAGED;
+            SendEvent(mobile, ev);
+            SetObjProperty(npc, &quot;guardkill&quot;, 1);
+          endif
+        endforeach
+        SetObjProperty(npc, &quot;guardstimer&quot;, ReadGameClock()+60);
+	  endif
+	endif
+  endforeach
+  sleep(1);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/townPerson.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/townPerson.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/townPerson.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,239 @@
+use npc;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:speech&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;ai/main/mainLoopGood&quot;;
+include &quot;ai/combat/warriorCombatEvent&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;include/skillLists&quot;;
+include &quot;:begging:begging&quot;;
+
+const HALT_THRESHOLD := 2;
+
+program CastleGuard()
+  drop_anchor();
+  EnableEvents( SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED );
+  EnableEvents( SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, HALT_THRESHOLD );
+  EnableEvents(SYSEVENT_OPPONENT_MOVED);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  set_priority(10);
+  var ev;
+  var looter := GetObjProperty( me, &quot;looter&quot;);
+  var next_wander := ReadGameClock() + 10;
+  var txt;
+  var ph := SplitWords(me.name);
+  var myname := lower(ph[1]);
+  while (1)
+    ev := os::wait_for_event(120);
+    case(ev.type)
+      SYSEVENT_SPEECH:      var tspeech := process_text(ev.text, &quot;default&quot;,&quot;default&quot;);
+                        txt := lower(ev.text);
+                        if(tspeech)
+                          say(tspeech);
+                        elseif(txt[myname] &amp;&amp; (txt[&quot;train&quot;] || txt[&quot;teach&quot;]))
+                          TurnToward(ev.source);
+                          MerchantTrain(me, ev.source, ev.text);
+                        endif
+      SYSEVENT_ENGAGED:     say(&quot;Aaahhh! Help! Help!  I'm being oppressed!&quot;);
+                        Fight(ev.source);
+      SYSEVENT_DAMAGED:     if(ev.source)
+                          Fight(ev.source);
+                        else
+                          say( &quot;What sinister force is this!&quot; );
+                        endif
+
+      SYSEVENT_ITEM_GIVEN:  TrainSkill(me, ev.source, ev.item);
+      SYSEVENT_ENTEREDAREA:
+      SYSEVENT_LEFTAREA:
+    endcase
+	if(ReadGameClock() &gt;= next_wander)
+	  begpurse(me);
+      wander();
+	  if(looter)
+		grabloot();
+	  endif
+      next_wander := ReadGameClock() + 10;
+    endif
+  endwhile
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function MerchantTrain(me, who, text)
+  var totaltrain := 0;
+  var words := SplitWords(text);
+  var skill := words[3];
+  if(!skill)
+    var trainable := &quot;&quot;;
+    var holder := &quot;&quot;;
+    foreach thing in getskilllist(me)
+      if(holder == &quot;&quot;)
+        holder := thing;
+      else
+        holder := holder + &quot;, &quot; + thing;
+      endif
+      totaltrain := totaltrain + 1;
+    endforeach
+    trainable  := trainable + holder;
+    if(totaltrain &gt; 0)
+      say(&quot;I can train thee in the following skills:&quot;);
+      say(trainable);
+    else
+      say(&quot;I can not train thee.&quot;);
+    endif
+  else
+    skill := lower(skill);
+    skill := FindSkillId(skill);
+    var npclevel := 33;
+    var pclevel;
+    foreach thing in getskilllist(me)
+      if(lower(thing) == skill)
+        pclevel := GetEffectiveSkill(who, thing);
+        if(pclevel &gt; npclevel)
+          say(&quot;I cannot teach you anymore.&quot;);
+          return;
+        else
+          var trainmaxcost := GoldForSkillGain(npclevel, pclevel, thing);
+          say(&quot;I will train thee &quot; + thing + &quot; for &quot; + trainmaxcost + &quot; gold.&quot;);
+          SetObjProperty(who, &quot;TrainMaxCost&quot;, trainmaxcost);
+          SetObjProperty(who, &quot;TrainSkillID&quot;, thing);
+          return;
+        endif
+      endif
+    endforeach
+    say(&quot;I know not of that skill.&quot;);
+  endif
+endfunction
+
+function TrainSkill(me, who, item)
+  var variance := 0;
+  var npc_level := 0;
+  var pc_level := 0;
+  var goldreceived := 0;
+  var new_level := 0;
+  var currentnpccost := 0;
+  if((item.objtype == 0xeed) &amp;&amp; (item.amount != 0))
+    var trainmaxcost := GetObjProperty(who, &quot;TrainMaxCost&quot;);
+    var trainskillid := GetObjProperty(who, &quot;TrainSkillID&quot;);
+    if((!trainmaxcost || !trainskillid) &amp;&amp; trainskillid != 0)
+      say(&quot;I don't know what this is for, but thanks!&quot;);
+      DestroyItem(item);
+      return;
+    endif
+    if(GetEffectiveSkill(me, trainskillid))
+      npc_level    := 33;
+      pc_level     := GetEffectiveSkill(who, trainskillid);
+      goldreceived := item.amount;
+      variance     := npc_level - pc_level;
+      currentnpccost := GoldForSkillGain(npc_level, pc_level, trainskillid);
+      if(pc_level &lt; npc_level)
+        if(currentnpccost != trainmaxcost)
+          if(currentnpccost &gt; trainmaxcost)
+            npc_level := SkillGainForGold(npc_level, pc_level, trainskillid, trainmaxcost);
+            variance  := npc_level - pc_level;
+          else
+            if(goldreceived &gt; currentnpccost)
+              say(&quot;I can not train thee to that level.&quot;);
+              MoveItemToContainer(item, who.backpack);
+              return;
+            else
+              trainmaxcost := currentnpccost;
+            endif
+          endif
+        endif
+        if(trainmaxcost &lt;= goldreceived)
+          new_level := (npc_level * 10);
+          EraseObjProperty( who, &quot;TrainMaxCost&quot; );
+          EraseObjProperty( who, &quot;TrainSkillID&quot; );
+        else
+          new_level := ((pc_level + CInt((CDbl(variance) * (CDbl(goldreceived) / CDbl(trainmaxcost))))) * 10);
+          SetObjProperty( who, &quot;TrainMaxCost&quot;, trainmaxcost-goldreceived );
+        endif
+        say(&quot;Let me show you how it's done.&quot;);
+        SetBaseSkillBaseValue(who, trainskillid, new_level);
+        DestroyItem(item);
+        SendSysMessage(who, &quot;Your skill increases.&quot;);
+      else
+        say(&quot;I'm not as good as thee.  Please find another to train thee.&quot;);
+        MoveItemToContainer(item, who.backpack);
+      endif
+    else
+      say(&quot;I don't know that skill. Why don't you ask me what I can train you in?&quot;);
+      MoveItemToContainer(item, who.backpack);
+    endif
+  else
+    say(&quot;Bah, I have no use for this. Be off with ye.&quot;);
+    MoveItemToContainer(item, who.backpack);
+  endif
+endfunction
+
+function GoldForSkillGain( npc_skill, pc_skill, skillid )
+  var maxskill := npc_skill - pc_skill;
+  return maxskill*10;
+endfunction
+
+function SkillGainForGold(npc_level, pc_level, trainskillid, goldreceived)
+  return (goldreceived/10) + pc_level;
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/undead.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/undead.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/undead.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,204 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+
+const HALT_THRESHOLD := 8; // how close before he attacks?
+var me := Self();
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  start_script(&quot;:npcutils:NPCKeeper&quot;, me);
+  SetWarMode(0);
+  main_AI_loop();
+endprogram
+
+function main_AI_loop()
+  var ev;
+  var wanders := 60;
+  EnableMainEvents();
+  look_around();
+  while(1)
+    wander();
+    if((RandomInt(1) + 1) == 3)
+      if(RandomInt(1) == 1)
+        PlaySoundEffect(me, idlesnd1);
+      else
+        PlaySoundEffect(me, idlesnd2);
+      endif
+    endif
+    wanders := wanders +1;
+    if(wanders &gt;= 60)
+      wanders :=0;
+      ev := sleepmode();
+    else
+      ev := os::wait_for_event(2);
+    endif
+    if(ev)
+      repeat
+        case(ev.type)
+          SYSEVENT_ENTEREDAREA: if((!(ev.source).npctemplate) || (((ev.source).script == &quot;employed&quot;) || ((ev.source).script == &quot;tamed&quot;)))
+                                  Fight(ev.source);
+                                endif
+          EVID_ALL_ATTACK_CMD:  Fight(ev.source);
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED:     if(ev.source)
+                                  Fight(ev.source);
+                                endif
+        endcase
+      until (!(ev := os::wait_for_event(2)));
+    endif
+  endwhile
+endfunction
+
+function Fight(opponent)
+  if((opponent.cmdlevel &gt; 0) || (opponent.serial == me.serial))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  var oldprio := set_priority(50);
+  SetOpponent(opponent);
+  prepare_for_fight(opponent);
+  TurnToward(opponent);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while((opponent) &amp;&amp; (!opponent.dead) &amp;&amp; (!opponent.hidden) &amp;&amp; (!opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20))
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	in_combat_event_loop(opponent, loops);
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED:
+	  SYSEVENT_ENGAGED: if(ev.source)
+			              if(RandomInt(6)==1)
+				            if((!ev.source.npctemplate) || (ev.source.script == &quot;tamed&quot;))
+					          opponent := ev.source;
+			  		          SetOpponent(opponent);
+					          TurnToward(opponent);
+				            endif
+			              endif
+			            endif
+      EVID_PEACEMADE:   SetWarMode(0);
+			            SetOpponent(0);
+			            sleep(1);
+			            DisableCombatEvents();
+			            EnableMainEvents();
+			            return;
+	endcase
+  endwhile
+  post_combat();
+endfunction
+
+function in_combat_event_loop(opponent, loops)
+  if(loops &gt; 50)
+    if((dist(me, opponent) &gt; 12) &amp;&amp; (!CheckLineOfSight(me, opponent)))
+	  RestartScript(me);
+	  return;
+    endif
+  endif
+endfunction
+
+function post_combat()
+  DisableCombatEvents();
+  EnableMainEvents();
+  SetWarMode(0);
+  SetOpponent(0);
+  sleep(1);
+  look_around();
+endfunction
+
+function prepare_for_fight(opponent)
+  DisableMainEvents();
+  EnableCombatEvents();
+endfunction
+
+function EnableCombatEvents()
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function DisableCombatEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE);
+endfunction
+
+function look_around()
+  foreach npc in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    if((!npc.npctemplate) || (npc.script == &quot;employed&quot;) || (npc.script == &quot;tamed&quot;))
+      Fight(npc);
+      return;
+    endif
+  endforeach
+endfunction
+
+function EnableMainEvents()
+  DisableEvents(SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED);
+  EnableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD);
+endfunction
+
+function DisableMainEvents()
+  DisableEvents(SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function sleepmode()
+  foreach critter in ListMobilesNearLocation(me.x,me.y,me.z, 10, me.realm);
+    if(!critter.isA(POLCLASS_NPC))
+      return 0;
+    endif
+  endforeach
+  DisableMainEvents();
+  EnableEvents(SYSEVENT_ENTEREDAREA, 18);
+  EnableEvents(SYSEVENT_ENGAGED);
+  var ev;
+  while(1)
+    ev := os::wait_for_event(30);
+    repeat
+    if((RandomInt(1) + 1) == 1)
+      PlaySoundEffect(me, idlesnd1);
+    else
+      PlaySoundEffect(me, idlesnd2);
+    endif
+    case (ev.type)
+      SYSEVENT_ENGAGED:
+      SYSEVENT_DAMAGED:
+      EVID_ALL_ATTACK_CMD:  EnableMainEvents();
+                            return ev;
+      SYSEVENT_ENTEREDAREA: if((!ev.source.npctemplate) || (ev.source.script == &quot;employed&quot;) || (ev.source.script == &quot;tamed&quot;))
+                              EnableMainEvents();
+                              return ev;
+                            endif
+    endcase
+    until(!(ev := os::wait_for_event(30)));
+  endwhile
+endfunction
+
+function CloseDistance(opponent)
+  var sleepdelay := 400 - (CInt(GetDexterity(me)) * 1.5);
+  if(sleepdelay &lt; 0)
+    sleepdelay := 0;
+  endif
+  case (Distance(me, opponent))
+    1:
+    0:       return 1;
+    default: RunToward(opponent);
+             sleepms(sleepdelay);
+             return 0;
+  endcase
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/undeadKillPCs.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/undeadKillPCs.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/undeadKillPCs.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,39 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/killPCsLoop&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/animalCombatEvent&quot;;
+include &quot;ai/setup/killPCsSetup&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+
+const HALT_THRESHOLD := 8; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction

Added: trunk/096/pkg/mobiles/oldAI/vortexAI.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/vortexAI.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/vortexAI.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,182 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;include/client&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/combat/vortexCombatEvent&quot;;
+include &quot;ai/setup/setup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+
+const HALT_THRESHOLD := 8;
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+var masterserial := GetObjProperty(me, &quot;master&quot;);
+
+program KillPlayers()
+  var master;
+  foreach char in EnumerateOnlineCharacters()
+    if(char.serial == masterserial)
+      master := char;
+      break;
+    endif
+  endforeach
+  if(!master)
+    master := SystemFindObjectBySerial(CInt(masterserial), SYSFIND_SEARCH_OFFLINE_MOBILES);
+  endif
+  SetScriptController( master );
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance(opponent)
+  case (Distance(me, opponent))
+    1:
+    0:       return 1;
+    default: RunToward(opponent);
+             return 0;
+  endcase
+endfunction
+
+function main_AI_loop()
+  var ev;
+  var wanders := 0;
+  EnableMainEvents();
+  look_around();
+  while (1)
+    ev := os::wait_for_event(5);
+	if(wanders &gt; 60)
+	  wanders :=0;
+	  ev := sleepmode();
+	endif
+	if(ev)
+	  repeat
+	    case(ev.type)
+          SYSEVENT_ENTEREDAREA:
+          SYSEVENT_ENGAGED:
+          SYSEVENT_DAMAGED:     Fight(ev.source);
+	    endcase
+      until (! (ev := os::wait_for_event(1)) );
+    endif
+    look_around();
+    wander();
+	wanders := wanders +1;
+  endwhile
+endfunction
+
+function Fight(opponent)
+  if((opponent.cmdlevel &gt; 0) || (opponent == me))
+    SetWarMode(0);
+    opponent := 0;
+	return;
+  endif
+  var oldprio := set_priority(50);
+  SetOpponent(opponent);
+  prepare_for_fight(opponent);
+  TurnToward(opponent);
+  var loops := 0;
+  var ev;
+  var waittime := 0;
+  while((opponent) &amp;&amp; (!opponent.dead) &amp;&amp; (!opponent.hidden) &amp;&amp; (!opponent.concealed) &amp;&amp; (dist(me,opponent) &lt; 20))
+	if(!CloseDistance(opponent))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED:
+	  SYSEVENT_ENGAGED: if(ev.source)
+			              if(RandomInt(6)==1)
+					        opponent := ev.source;
+			  		        SetOpponent(opponent);
+					        TurnToward(opponent);
+			              endif
+			            endif
+	endcase
+  endwhile
+  post_combat();
+endfunction
+
+function EnableCombatEvents()
+  EnableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function DisableCombatEvents()
+  DisableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + EVID_PEACEMADE );
+endfunction
+
+function look_around()
+  var him, dista;
+  var dis := 20;
+  foreach critter in ListMobilesInLineOfSight(me, HALT_THRESHOLD)
+    dista := Distance(me, critter);
+    if(dista &lt; dis)
+      if((critter.npctemplate != &quot;bladespirit&quot;) &amp;&amp; (critter.npctemplate != &quot;vortex&quot;))
+        him := critter;
+        dis := dista;
+      endif
+    endif
+  endforeach
+  if(him)
+    Fight(him);
+  endif
+endfunction
+
+function EnableMainEvents()
+ DisableEvents( SYSEVENT_SPEECH + SYSEVENT_LEFTAREA + SYSEVENT_DISENGAGED + SYSEVENT_OPPONENT_MOVED );
+ EnableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA, HALT_THRESHOLD );
+endfunction
+
+function DisableMainEvents()
+  DisableEvents( SYSEVENT_ENGAGED + SYSEVENT_DAMAGED + SYSEVENT_ENTEREDAREA);
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/wolf.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/wolf.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/wolf.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,43 @@
+use npc;
+use os;
+use uo;
+use cfgfile;
+
+include &quot;include/eventID&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;include/dist&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;ai/main/mainLoopWolf&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/combat/defaultCombatEvent&quot;;
+include &quot;ai/setup/animalSetup&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;:npcutils:vetement&quot;;
+
+
+const HALT_THRESHOLD := 5; // how close before he attacks?
+var npccfgfile := ReadConfigFile( &quot;npcdesc&quot; );
+var idlesnd1 := CInt(npccfgfile[me.npctemplate].idlesound1);
+var idlesnd2 := CInt(npccfgfile[me.npctemplate].idlesound2);
+
+program KillPlayers()
+  SetWarMode( 0 );
+  main_AI_loop();
+endprogram
+
+function CloseDistance( opponent )
+
+    case (Distance( me, opponent ))
+        1:              // the most likely, so first
+        0:
+            return 1;
+        default:
+            RunToward( opponent );
+		sleepms(250);
+            return 0;
+    endcase
+
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/mobiles/oldAI/worker.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/worker.src	2005-10-02 09:39:20 UTC (rev 358)
+++ trunk/096/pkg/mobiles/oldAI/worker.src	2005-10-02 10:39:25 UTC (rev 359)
@@ -0,0 +1,329 @@
+use npc;
+use os;
+use uo;
+
+include &quot;include/eventID&quot;;
+include &quot;include/attributes&quot;;
+include &quot;include/sysEvent&quot;;
+include &quot;:npcutils:randName&quot;;
+include &quot;:npcutils:speech&quot;;
+include &quot;:npcutils:anchors&quot;;
+include &quot;include/dist&quot;;
+include &quot;ai/main/mainLoopGood&quot;;
+include &quot;ai/combat/warriorCombatEvent&quot;;
+include &quot;ai/combat/fight&quot;;
+include &quot;ai/main/loot&quot;;
+include &quot;:npcutils:vetement&quot;;
+include &quot;:npcutils:NPCUtil&quot;;
+include &quot;include/objtype&quot;;
+include &quot;ai/main/sleepMode&quot;;
+include &quot;include/skillLists&quot;;
+include &quot;:begging:begging&quot;;
+
+const HALT_THRESHOLD := 2;
+
+var cost;
+var following;
+var waittime;
+var escortee;
+var next_wander := ReadGameClock() + 10;
+var ev;
+var txt;
+var killtime := 0;
+var master;
+var spells := {};
+var me := Self();
+var cast_pct;
+var num_casts;
+var count_casts;
+var summons := 3;
+var graphics;
+var num_changes;
+var will_cast;
+var will_breathe;
+var flee_point;
+
+var npccfg := ReadConfigFile(&quot;npcdesc&quot;);
+var speechelem := npccfg[me.npctemplate];
+spells := GetConfigStringArray(speechelem, &quot;spell&quot;);
+cast_pct := speechelem.cast_pct;
+num_casts  := speechelem.num_casts;
+count_casts  := speechelem.count_casts;
+if(!cast_pct)
+  cast_pct := 10;
+endif
+flee_point := speechelem.flee_point;
+if(!flee_point)
+  flee_point := 10;
+endif
+
+program CastleGuard()
+  run_script_to_completion(&quot;:npcutils:NPCKeeper&quot;, me);
+  drop_anchor();
+  EnableEvents(SYSEVENT_SPEECH + SYSEVENT_ENGAGED + SYSEVENT_DISENGAGED + SYSEVENT_DAMAGED);
+  EnableEvents(SYSEVENT_ENTEREDAREA + SYSEVENT_LEFTAREA, HALT_THRESHOLD);
+  EnableEvents(SYSEVENT_OPPONENT_MOVED + SYSEVENT_ITEM_GIVEN);
+  if(GetObjProperty(me, &quot;frozen&quot;))
+	me.frozen := 1;
+  endif
+  SetWarMode( 0 );
+  set_priority(10);
+  var ev;
+  var looter := GetObjProperty( me, &quot;looter&quot;);
+  var next_wander := ReadGameClock() + 10;
+  var txt;
+  var ph := SplitWords(me.name);
+  var myname := lower(ph[1]);
+  cost := GetObjProperty(me, &quot;HireCost&quot;);
+  while (1)
+    ev := os::wait_for_event(120);
+    case(ev.type)
+      SYSEVENT_SPEECH:      var tspeech := process_text(ev.text, &quot;default&quot;,&quot;default&quot;);
+                        txt := lower(ev.text);
+                        if(tspeech)
+                          say(tspeech);
+                        elseif(txt[myname] &amp;&amp; (txt[&quot;train&quot;] || txt[&quot;teach&quot;]))
+                          TurnToward(ev.source);
+                          MerchantTrain(me, ev.source, ev.text);
+                        elseif(txt[myname] &amp;&amp; (txt[&quot;hire&quot;] || txt[&quot;work&quot;] || txt[&quot;mercenary&quot;] || txt[&quot;servant&quot;]))
+                          TurnToward(ev.source);
+                          SetObjProperty(ev.source, &quot;Hire&quot;, me.serial);
+                          say(&quot;I am available for hire for &quot; + cost + &quot; gold coins per day.&quot;);
+                        endif
+      SYSEVENT_ENGAGED:     Fight(ev.source);
+      SYSEVENT_DAMAGED:     if(ev.source)
+                          Fight(ev.source);
+                        else
+                          say(&quot;What sinister force is this!&quot;);
+                        endif
+      SYSEVENT_ITEM_GIVEN:  TrainSkill(me, ev.source, ev.item);
+      SYSEVENT_ENTEREDAREA:
+      SYSEVENT_LEFTAREA:
+    endcase
+	if(ReadGameClock() &gt;= next_wander)
+	  begpurse(me);
+      wander();
+	  if(looter)
+		grabloot();
+	  endif
+      next_wander := ReadGameClock() + 10;
+    endif
+  endwhile
+endprogram
+
+function CloseDistance( opponent )
+  case (Distance( me, opponent ))
+    1:
+    0:       return 1;
+    default: RunToward( opponent );
+             return 0;
+  endcase
+endfunction
+
+function hireme(me, who, item)
+  var amt := item.amount;
+  if(amt &lt; cost)
+    say(&quot;I will not work for any less than &quot; + cost + &quot; gold coins per day.&quot;);
+    MoveItemToContainer(item, who.backpack);
+  else
+    EraseObjProperty(who, &quot;Hire&quot;);
+    var days := amt / cost;
+    say(&quot;I will work for you for &quot; + days + &quot; days.&quot;);
+    DestroyItem(item);
+    SetObjProperty(me, &quot;master&quot;, who.serial);
+    SetObjProperty(me,&quot;script&quot;, me.script);
+    days := days * 10800;
+    SetObjProperty(me, &quot;Timer&quot;, (ReadGameClock() + days));
+    me.script := &quot;employed&quot;;
+    RestartScript(me);
+    return;
+  endif
+endfunction
+
+function MerchantTrain(me, who, text)
+  var words := SplitWords(text);
+  var skill := words[3];
+  if(!skill)
+    var trainable := &quot;&quot;;
+    var holder := &quot;&quot;;
+    var myskill, pskill;
+    var totaltrain := 0;
+    foreach thing in getskilllist(me)
+      myskill := CInt(GetObjProperty(me, thing));
+      if(!myskill)
+        myskill := 25 + RandomInt(10);
+        SetObjProperty(me, thing, myskill);
+      endif
+      pskill := GetEffectiveSkill(who, FindSkillId(thing));
+      if(pskill &lt; myskill)
+        if(holder == &quot;&quot;)
+          holder := thing;
+        else
+          holder := holder + &quot;, &quot; + thing;
+        endif
+        totaltrain := totaltrain + 1;
+      endif
+    endforeach
+    trainable  := trainable + holder;
+    if(totaltrain &gt; 0)
+      say(&quot;I can train thee in the following skills:&quot;);
+      say(trainable);
+    else
+      say(&quot;I can not train thee.&quot;);
+    endif
+  else
+    skill := lower(skill);
+    var npclevel := 0;
+    var pclevel;
+    var holder;
+    foreach thing in getskilllist(me)
+      if(lower(thing) == skill)
+        npclevel := CInt(GetObjProperty(me, thing));
+        holder := FindSkillId(thing);
+        pclevel := GetEffectiveSkill(who, holder);
+        if(pclevel &gt;= npclevel)
+          say(&quot;I cannot teach thee anymore.&quot;);
+          return;
+        else
+          var trainmaxcost := GoldForSkillGain(npclevel, pclevel, holder);
+          say(&quot;I will train thee &quot; + thing + &quot; for &quot; + trainmaxcost + &quot; gold.&quot;);
+          SetObjProperty(who, &quot;TrainMaxCost&quot;, trainmaxcost);
+          SetObjProperty(who, &quot;TrainSkillID&quot;, thing);
+          return;
+        endif
+      endif
+    endforeach
+    say(&quot;I know not of that skill.&quot;);
+  endif
+endfunction
+
+function TrainSkill(me, who, item)
+  var variance := 0;
+  var npc_level := 0;
+  var pc_level := 0;
+  var goldreceived := 0;
+  var new_level := 0;
+  var currentnpccost := 0;
+  if((item.objtype == 0xeed) &amp;&amp; (GetObjProperty(who, &quot;Hire&quot;) == me.serial))
+    hireme(me, who, item);
+    return;
+  endif
+  if((item.objtype == 0xeed) &amp;&amp; (item.amount != 0))
+    var trainmaxcost := GetObjProperty(who, &quot;TrainMaxCost&quot;);
+    var trainskillname := GetObjProperty(who, &quot;TrainSkillID&quot;);
+    var trainskillid := FindSkillId(trainskillname);
+    if((!trainmaxcost || !trainskillid) &amp;&amp; trainskillid != 0)
+      say(&quot;I don't know what this is for, but thanks!&quot;);
+      DestroyItem(item);
+      return;
+    endif
+    npc_level    := CInt(GetObjProperty(me, trainskillname));
+    pc_level     := GetEffectiveSkill(who, trainskillid);
+    goldreceived := item.amount;
+    variance     := npc_level - pc_level;
+    currentnpccost := GoldForSkillGain(npc_level, pc_level, trainskillid);
+    if(pc_level &lt; npc_level)
+      if(currentnpccost != trainmaxcost)
+        if(currentnpccost &gt; trainmaxcost)
+          npc_level := SkillGainForGold(npc_level, pc_level, trainskillid, trainmaxcost);
+          variance  := npc_level - pc_level;
+        else
+          if(goldreceived &gt; currentnpccost)
+            say(&quot;I can not train thee to that level.&quot;);
+            MoveItemToContainer(item, who.backpack);
+            return;
+          else
+            trainmaxcost := currentnpccost;
+          endif
+        endif
+      endif
+      if(trainmaxcost &lt;= goldreceived)
+        new_level := (npc_level * 10);
+        EraseObjProperty( who, &quot;TrainMaxCost&quot; );
+        EraseObjProperty( who, &quot;TrainSkillID&quot; );
+      else
+        new_level := ((pc_level + CInt((CDbl(variance) * (CDbl(goldreceived) / CDbl(trainmaxcost))))) * 10);
+        SetObjProperty( who, &quot;TrainMaxCost&quot;, trainmaxcost-goldreceived );
+      endif
+      say(&quot;Let me show you how it's done.&quot;);
+      SetBaseSkillBaseValue(who, trainskillid, new_level);
+      var skillarray := GetObjProperty(who,&quot;SkillArray&quot;);
+      if(!skillarray)
+        skillarray := {};
+        skillarray.append(trainskillid);
+        foreach thing in GetSkillIds()
+          if(GetBaseSkill(who, thing) &gt; 0)
+            skillarray.append(thing);
+          endif
+        endforeach
+        SetObjProperty(who,&quot;SkillArray&quot;, skillarray);
+      else
+        var holder := {};
+        holder.append(trainskillid);
+        foreach thing in skillarray
+          if((thing != trainskillid) and (GetBaseSkill(who, thing) &gt; 0))
+            holder.append(thing);
+          endif
+        endforeach
+        skillarray := holder;
+        SetObjProperty(who,&quot;SkillArray&quot;, skillarray);
+      endif
+      DestroyItem(item);
+      SendSysMessage(who, &quot;Your skill increases.&quot;);
+    else
+      say(&quot;I'm not as good as thee.  Please find another to train thee.&quot;);
+      MoveItemToContainer(item, who.backpack);
+    endif
+  else
+    say(&quot;Bah, I have no use for this. Be off with ye.&quot;);
+    MoveItemToContainer(item, who.backpack);
+  endif
+endfunction
+
+function GoldForSkillGain(npc_skill, pc_skill, skillid)
+  var maxskill := npc_skill - pc_skill;
+  return maxskill*10;
+endfunction
+
+function SkillGainForGold(npc_level, pc_level, trainskillid, goldreceived)
+  return (goldreceived/10) + pc_level;
+endfunction
+
+function herding(ev)
+  var holder := ev.data;
+  var lx := holder[1];
+  var ly := holder[2];
+  var loops := 0;
+  var opponent;
+  var waittime := 0;
+  while(1)
+	if(!CloseIn(me, lx, ly))
+	  loops := loops + 1;
+	  waittime := 0;
+	else
+	  loops := 0;
+	  waittime := 1;
+	endif
+	if((loops &gt;= 30) or (coordist(me.x, me.y, lx, ly) &lt;= 1))
+	  break;
+	endif
+	ev := wait_for_event(waittime);
+	case (ev.type)
+      SYSEVENT_DAMAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	  SYSEVENT_ENGAGED: opponent := ev.source;
+			  		    SetOpponent(opponent);
+					    TurnToward(opponent);
+	endcase
+  endwhile
+  Return;
+endfunction
+
+function CloseIn(me, lx, ly)
+  case (coordist(me.x, me.y, lx, ly))
+    0:       return 1;
+    default: WalkTowardLocation(lx, ly);
+             return 0;
+  endcase
+endfunction
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000336.html">[Poldistro-svn] r358 - in trunk/096/scripts: control misc
</A></li>
	<LI>Next message: <A HREF="000337.html">[Poldistro-svn] r360 - trunk/096/pkg/mobiles/oldAI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#359">[ date ]</a>
              <a href="thread.html#359">[ thread ]</a>
              <a href="subject.html#359">[ subject ]</a>
              <a href="author.html#359">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/poldistro-svn">More information about the Poldistro-svn
mailing list</a><br>
</body></html>
