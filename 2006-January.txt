From austin at berlios.de  Thu Jan  5 12:23:09 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 12:23:09 +0100
Subject: [Poldistro-svn] r1086 - in trunk/096/pkg/multis/boat: . OLD
Message-ID: <200601051123.k05BN9ve028814@sheep.berlios.de>

Author: austin
Date: 2006-01-05 12:23:07 +0100 (Thu, 05 Jan 2006)
New Revision: 1086

Added:
   trunk/096/pkg/multis/boat/OLD/
   trunk/096/pkg/multis/boat/OLD/boat.src
   trunk/096/pkg/multis/boat/OLD/itemdesc.cfg
   trunk/096/pkg/multis/boat/OLD/pkg.cfg
   trunk/096/pkg/multis/boat/OLD/plank.src
   trunk/096/pkg/multis/boat/OLD/plankControl.src
   trunk/096/pkg/multis/boat/OLD/plankUtil.inc
   trunk/096/pkg/multis/boat/OLD/plankWalk.src
   trunk/096/pkg/multis/boat/OLD/shipDeed.src
   trunk/096/pkg/multis/boat/OLD/tillerman.src
Removed:
   trunk/096/pkg/multis/boat/boat.src
   trunk/096/pkg/multis/boat/itemdesc.cfg
   trunk/096/pkg/multis/boat/pkg.cfg
   trunk/096/pkg/multis/boat/plank.src
   trunk/096/pkg/multis/boat/plankControl.src
   trunk/096/pkg/multis/boat/plankUtil.inc
   trunk/096/pkg/multis/boat/plankWalk.src
   trunk/096/pkg/multis/boat/shipDeed.src
   trunk/096/pkg/multis/boat/tillerman.src
Log:


Added: trunk/096/pkg/multis/boat/OLD/boat.src
===================================================================
--- trunk/096/pkg/multis/boat/OLD/boat.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/boat.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,790 @@
+////////////////
+//	boat.src 
+//
+//	control script for boats
+//
+//	Header replaced by Racalac 9/15/02
+//
+//	Todo/Fix: Course nav needs the "goto #" command implimented.
+//			  Tillerman string recognition causes boat to pause
+////////////////
+
+use os;
+use uo;
+use util;
+use boat;
+
+include "include/OLD/eventID";
+include "include/sysEvent";
+include ":itemutils:myUtil";
+include "include/client";
+include "include/OLD/sound";
+include ":gumps:yesno";
+include "util/key";
+include "plankUtil";
+
+const STATE_STATIONARY := 0;
+const STATE_MOVING := 1;
+const STATE_DRIFTING := 2;
+const STATE_FOLLOWING_COURSE := 3; //NOTE NEW STATE
+const DELAY_DRIFTING := 15000;
+
+/*NOTE NEW CONSTANTS*/
+const NEGONE := -1;
+const ZERO := 0;
+const POSONE := 1;
+
+var state := STATE_STATIONARY;
+var relative_direction;
+var ms_delay_between_moves := 200;
+var boat;
+var tillerman;
+var owner := GetObjProperty(boat.hold,"owner");
+var decay := GetObjProperty(boat.tillerman, "decay");
+
+/*NOTE NEW GLOBAL*/
+var first_move_toward_waypoint := 1;
+
+program autostart_boat(param)
+  boat := param;
+  if(!boat)
+    syslog( "[ERROR] [boat.src] Boat script running, but boat not found!" );
+    return;
+  endif
+  tillerman := boat.tillerman;
+  if(!tillerman)
+    syslog( "[ERROR] [boat.src] No tillerman for boat at: " +(boat.x-1) +","+ boat.y +","+ boat.z + "; destroying the boat..." );
+    DestroyMulti(boat);
+    return;
+  endif
+  EnableEvents(SYSEVENT_SPEECH, 15);
+  RegisterForSpeechEvents(tillerman, 15);
+  var nextencounter := ReadGameClock()+(RandomInt(120) + 120);
+  var nextsound := ReadGameClock()+5;
+  var driftcounter := 1;
+  //set_critical(1);
+  var x,y;
+  while(boat)
+    if(GetObjProperty(boat.hold, "#speed"))
+      state := STATE_MOVING;
+      ms_delay_between_moves := GetObjProperty(boat.hold, "#speed"); 
+      relative_direction := GetObjProperty(boat.hold, "#relativedir");
+      eraseobjproperty(boat.hold, "#speed");
+      eraseobjproperty(boat.hold, "#relativedir");    
+    endif     
+    decay := getobjproperty(boat.tillerman,"decay");
+    if((decay) and(!getobjproperty(tillerman,"nodecay")))
+      if(ReadGameClock() > decay)
+        PrintTextAbove(tillerman, "Arrrrrgh!  She's going down, Captain!  Abandon ship!");
+        sleep(4);
+        foreach item in EnumerateItemsInContainer( boat.hold )
+          DestroyItem(item);
+        endforeach
+        foreach mob in(boat.items)
+          DestroyItem(mob);
+        endforeach        
+        foreach mob in(boat.mobiles)
+          MoveCharacterToLocation(mob, 1, 1, 0,  MOVECHAR_FORCELOCATION );
+          SendSysMessage(mob, "Your ship, badly in need of maintenance, sinks beneath the waves!");
+          SendSysMessage(mob, "You awake on a distant shore...");
+        endforeach
+        if(boat.has_offline_mobiles)
+          foreach mob in(boat.offline_mobiles)
+            MoveCharacterToLocation(mob, 1, 1, 0,  MOVECHAR_FORCELOCATION );
+          endforeach
+        endif
+        DestroyMulti(boat);
+      endif
+    endif    
+    case(state)
+      STATE_MOVING:   if(ReadGameClock() > nextsound)
+                        PlayBoatSounds();
+                        nextsound := ReadGameClock()+5;
+                      endif
+                      x := boat.x;
+                      y := boat.y;
+                      MoveBoatRelative(boat, relative_direction);
+                      if(boat.x == 6 or boat.x == 5097 or boat.y == 6 or boat.y == 4089)   
+                        WorldWrap();
+                      endif
+                      if((x == boat.x) &&(y == boat.y))
+                        ms_delay_between_moves := 1000;
+                        state := STATE_DRIFTING;
+                        PrintTextAbove(tillerman, "Aaargh!  We've run ashore!");
+                        //SmackEveryone();
+                      endif
+                      sleepms(ms_delay_between_moves);
+                      if(ReadGameClock() > nextencounter)
+                        DoEncounter();
+                        nextencounter := ReadGameClock()+120;
+                      endif
+                      while(events_waiting())
+                        process_event(wait_for_event(0));
+                      endwhile
+      STATE_DRIFTING:   if(ReadGameClock() > nextsound)
+                          PlayBoatSounds();
+                          nextsound := ReadGameClock()+5;
+                        endif
+                        if(driftcounter > 15)
+                          MoveBoatRelative(boat, RandomInt(8));
+                          driftcounter := 1;
+                        else
+                          driftcounter := driftcounter + 1;
+                        endif
+                        sleepms(1000);
+                        while(events_waiting())
+                          process_event(wait_for_event(0));
+                        endwhile
+      STATE_STATIONARY: var ev := wait_for_event(120);
+                        if(ev)
+                          process_event(ev);
+                        endif
+/*NOTE NEW BOAT STATE*/
+      STATE_FOLLOWING_COURSE:
+        		x := boat.x;
+        		y := boat.y;
+        		BoatFollowCourse(boat);
+        				
+        		sleepms(ms_delay_between_moves);
+                        while(events_waiting())
+                          process_event(wait_for_event(0));
+                        endwhile
+/*END NEW BOAT STATE*/
+    endcase
+    if(ReadGameClock() > nextencounter)
+      checkres();
+      nextencounter := ReadGameClock()+120;
+    endif
+  endwhile
+endprogram
+
+function handle_speech(event)
+  var text := lower(event.text);
+  if(text["drift"] || text["raise anchor"])
+    ms_delay_between_moves := 1000;
+    state := STATE_DRIFTING;
+    PrintTextAbove(tillerman, "Aye Aye, Captain!");
+  elseif(text["forward"])
+    if(state == STATE_STATIONARY)
+      PrintTextAbove(tillerman, "The anchor is down, Captain!");
+    else
+      PrintTextAbove(tillerman, "Aye Aye, Captain!");
+      state := STATE_MOVING;
+      if(text["left"])
+        relative_direction := 7;
+      elseif(text["right"])
+        relative_direction := 1;
+      else
+        relative_direction := 0;
+      endif
+    endif
+  elseif(text["back"])
+    if(state == STATE_STATIONARY)
+      PrintTextAbove(tillerman, "The anchor is down, Captain!");
+    else
+      PrintTextAbove(tillerman, "Aye Aye, Captain!");
+      state := STATE_MOVING;
+      if(text["left"])
+        relative_direction := 5;
+      elseif(text["right"])
+        relative_direction := 3;
+      else
+        relative_direction := 4;
+      endif
+    endif
+  elseif(text["stop"] || text["furl sail"] || text["furl"])
+    PrintTextAbove(tillerman, "Aye Aye, Captain!");
+    ms_delay_between_moves := 1000;
+    state := STATE_DRIFTING;
+  elseif(text["drop anchor"])
+    PrintTextAbove(tillerman, "Aye Aye, Captain! Anchor dropped.");
+    ms_delay_between_moves := 1000;
+    state := STATE_STATIONARY;
+  elseif(text["turn right"] || text["starboard"])
+    if(state == STATE_STATIONARY)
+      PrintTextAbove(tillerman, "The anchor is down, Captain!");
+    else
+      PrintTextAbove(tillerman, "Aye Aye, Captain!");
+      TurnBoat(boat, 1);
+    endif
+  elseif(text["right"])
+    if(state == STATE_STATIONARY)
+      PrintTextAbove(tillerman, "The anchor is down, Captain!");
+    else
+      PrintTextAbove(tillerman, "Aye Aye, Captain!");
+      state := STATE_MOVING;
+      relative_direction := 2;
+    endif
+  elseif(text["turn left"] || text["port"])
+    if(state == STATE_STATIONARY)
+      PrintTextAbove(tillerman, "The anchor is down, Captain!");
+    else
+      PrintTextAbove(tillerman, "Aye Aye, Captain!");
+      TurnBoat(boat, 3);
+    endif
+  elseif(text["left"])
+    if(state == STATE_STATIONARY)
+      PrintTextAbove(tillerman, "The anchor is down, Captain!");
+    else
+      PrintTextAbove(tillerman, "Aye Aye, Captain!");
+      state := STATE_MOVING;
+      relative_direction := 6;
+    endif
+  elseif(text["come about"] || text["turn around"])
+    if(state == STATE_STATIONARY)
+      PrintTextAbove(tillerman, "The anchor is down, Captain!");
+    else
+      PrintTextAbove(tillerman, "Aye Aye, Captain! Coming about!");
+      TurnBoat(boat, 2);
+      sleep(1);
+    endif
+/*NEW MAP COURSE COMMANDS*/
+    elseif(text["set course"])
+      	PrintTextAbove(tillerman, "Select a map for me to follow.");   	
+      	var map := Target(event.source);
+      	if(!map.isa(POLCLASS_MAP))
+      		PrintTextAbove(tillerman, "Are ye dense? I need a map!"); 
+      	else
+      		SetObjProperty(tillerman, "course", map.GetPins());
+      		SetObjProperty(tillerman, "nextwaypoint", 1);
+      		PrintTextAbove(tillerman, "Arr, course plotted."); 
+      	endif
+    elseif(text["clear course"])
+    	PrintTextAbove(tillerman, "Arr, course cleared Cap'n.");
+    	EraseObjProperty(tillerman, "course");
+    	EraseObjProperty(tillerman, "nextwaypoint");
+    elseif(text["nav"])
+    	if(state != STATE_FOLLOWING_COURSE)
+    		PrintTextAbove(tillerman, "We are not currently following a course.");
+    	else
+    		PrintTextAbove(tillerman, "We are following our course.");
+    		PrintTextAbove(tillerman, "The next waypoint is #" + GetObjProperty(tillerman,"nextwaypoint"));
+    	endif
+    elseif(text["start"])
+    	if( (GetObjProperty(tillerman,"course")==error) || (GetObjProperty(tillerman,"nextwaypoint")==error))
+    		PrintTextAbove(tillerman,"Arr, set course first Cap'n.");
+    	else    		
+     		state := STATE_FOLLOWING_COURSE;
+     		SetObjProperty(tillerman, "nextwaypoint", 1);
+    		PrintTextAbove(tillerman,"Aye, sailing to first waypoint.");
+    	endif
+    elseif(text["continue"])
+    	if( (GetObjProperty(tillerman,"course")==error) || (GetObjProperty(tillerman,"nextwaypoint")==error))
+    		PrintTextAbove(tillerman,"Arr, set course first Cap'n.");
+    	else
+    	    state := STATE_FOLLOWING_COURSE;
+    		PrintTextAbove(tillerman,"Aye, moving on.");
+    	endif
+  	endif
+/*END NEW MAP COURSE COMMANDS*/
+  if(text["full"])
+    if(state != STATE_STATIONARY)
+      PrintTextAbove(tillerman, "Aye Aye, Captain! Full speed ahead!");
+      ms_delay_between_moves := 100;
+    endif
+  elseif(text["slow"])
+    if(state != STATE_STATIONARY)
+      PrintTextAbove(tillerman, "Aye Aye, Captain! ");
+      ms_delay_between_moves := 1000;
+    endif
+  endif
+  sleep(1);
+  if(text["one"])
+    if(state != STATE_STATIONARY)
+      MoveBoatRelative(boat, relative_direction);
+      state := STATE_STATIONARY;
+    endif
+  endif
+endfunction
+
+function process_event(event)
+  if(event.type == SYSEVENT_SPEECH)
+    if(CanCommandMe(event.source))
+      var text := lower(event.text);
+      if(text["drydock"])
+        PrintTextAbove(tillerman, "Aye Aye, Captain! Docking.");
+        drydock(event);
+        sleep(1);
+      elseif(text["status"])
+        decay := GetObjProperty(boat.tillerman, "decay");
+        if((decay - ReadGameClock() ) > 861000 )
+          PrintTextAbove( tillerman, "Arrh, the ship's in excellent shape! She's a fine vessel indeed, Captain!" );
+        elseif((decay - ReadGameClock() ) > 604800 )
+          PrintTextAbove( tillerman, "She's slightly worn, Captain.");
+        elseif((decay - ReadGameClock() ) > 259200 )
+          PrintTextAbove(tillerman, "She's fairly worn, Captain.");
+        elseif((decay - ReadGameClock() ) > 86400 )
+          PrintTextAbove(tillerman, "Arrr, she's greatly worn and in dire need of repair, Captain!");
+        else 
+          PrintTextAbove(tillerman, "Arrr, she's going to sink within the day if she don't get repairs soon, Captain!");
+        endif
+      else
+        foreach person in (boat.mobiles)
+          if (event.source == person)
+             handle_speech(event);
+          endif  
+        endforeach
+      endif
+    endif
+  endif
+  
+endfunction
+
+function CanCommandMe(who)
+  owner := GetObjProperty(boat.tillerman, "owner");
+  if(who.serial == owner)
+    return 1;
+  else
+    var packkey;
+    var lokid := GetObjProperty(boat.tillerman, "lockid");
+    foreach thing in EnumerateItemsInContainer(who.backpack)
+      if(GetObjProperty(thing, "lockid") == lokid)
+        packkey := 1;
+        break;
+      endif
+    endforeach
+    if(packkey == 1)
+      return 1;
+    else
+      return 0;
+    endif
+  endif
+endfunction
+
+function DoEncounter()
+  foreach who in  ListMobilesNearLocationEx(boat.x, boat.y, GetMapInfo(boat.x, boat.y, boat.realm).z, 4, LISTEX_FLAG_GHOST, boat.realm)
+    if(YesNo(who,"Resurrect?"))
+      if (who in boat.mobiles)
+        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
+        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
+        Resurrect(who);
+      endif
+    endif
+  endforeach
+  var who :=(boat.mobiles);
+  who := who[1];
+  if(!who)
+    return;
+  endif
+  var x;
+  var y;
+  var z;
+  x := RandomInt(15)-5;
+  y := RandomInt(15)-5;
+  x := x + boat.x;
+  y := y + boat.y;
+  if(x > boat.x)
+    x := x + 5;
+  else
+    x := x - 5;
+  endif
+  if(y > boat.y)
+    y := y + 5;
+  else
+    y := y - 5;
+  endif
+  z := GetMapInfo(x, y, boat.realm).z;
+  if(z >= who.z)
+    return;
+  endif
+  var it := CreateNpcFromTemplate(getcritter(), x, y, z, 0, boat.realm);
+  if(it)
+    SetObjProperty(it,"killme",1);
+  endif
+  var ev := {};
+  ev.+type := EVID_ENTEREDAREA;
+  ev.+source := who;
+  SendEvent(it, ev);
+endfunction
+
+function checkres()
+  foreach who in  ListMobilesNearLocationEx(boat.x, boat.y, GetMapInfo(boat.x, boat.y, boat.realm).z, 4, LISTEX_FLAG_GHOST, boat.realm)
+    if(who in boat.mobiles)
+      if(YesNo(who,"Resurrect?"))
+        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
+        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
+        Resurrect(who);
+      endif
+    endif
+  endforeach
+endfunction
+
+function getcritter()
+  case(RandomInt(9))
+    0: return "walrus";
+    1: return "walrus";
+    2: return "walrus";
+    3: return "walrus";
+    4: return "alligator";
+    5: return "alligator";
+    6: return "waterelemental";
+    7: return "seaserpent";
+    8: return "airelemental";
+  endcase
+endfunction
+
+function drydock(event)
+  if(GetObjProperty(event.source, "#DryDocking"))
+    SendSysMessage(event.source, "You are already doing something else.");
+    return;
+  endif
+  SetObjProperty(event.source, "#DryDocking", 1);
+  EraseObjProperty(event.source, "#DryDocking");
+  var text := lower(event.text);
+  if(!text["drydock"])
+    EraseObjProperty(event.source, "#DryDocking");
+    return;
+  endif
+  var me := event.source;
+  var items := boat.items;
+  var mobsondeck := boat.mobiles;
+
+  if(len(items) > 0)
+    PrintTextAbovePrivate(boat.tillerman, "Arrh, Captain!  You can't drydock the boat while items are on deck!", me);
+    EraseObjProperty(me, "#DryDocking");
+    return;
+  endif
+  items := EnumerateItemsInContainer(boat.hold);
+  if(len(items) > 0)
+    PrintTextAbovePrivate(boat.tillerman, "Arrh, we'd best clear out the items in the hold first, Captain!", me);
+    EraseObjProperty(me, "#DryDocking");
+    return;
+  endif
+  if(len(mobsondeck) > 0)
+    PrintTextAbovePrivate(boat.tillerman, "Arrh, Captain!  You can't drydock the boat while people are on the deck!", me);
+    EraseObjProperty(me, "#DryDocking");
+    return;
+  endif  
+  if(CanDockMe(boat, me))
+    if(!YesNo(me,"Drydock the ship?"))
+      EraseObjProperty(me, "#DryDocking");
+      return;
+    endif
+    var shiptype;
+    case(boat.objtype)
+      0x6040: shiptype := 0x6027;
+      0x6041: shiptype := 0x6028;
+      0x6042: shiptype := 0x6029;
+      0x6043: shiptype := 0x602a;
+      0x6044: shiptype := 0x602b;
+      0x6045: shiptype := 0x602c;
+    endcase
+    if(!shiptype)
+      SendSysMessage(me, "Your boat seems to be malfunctioning. Please page a GM.");
+      return;
+    endif
+    var newboat := CreateItemInContainer(me.backpack, shiptype, 1);
+    var key := FindKey(me, boat.tillerman);
+    if(!newboat)
+      SendSysMessage(me,"Could not create boat deed in your backpack!");
+      EraseObjProperty(me, "#DryDocking");
+      return;
+    endif
+    if(ReserveItem(newboat))
+      newboat.graphic := 0x14f3;
+      if(!boat.tillerman.name)
+        newboat.name := "a toy boat";
+      else
+        newboat.name := boat.tillerman.name;
+      endif
+      if(!DestroyBoat(boat))
+        DestroyItem(newboat);
+        EraseObjProperty(me, "#DryDocking");
+        return;
+      endif
+    else
+      DestroyItem(newboat);
+      EraseObjProperty(me, "#DryDocking");
+      return;
+    endif
+    if(key)
+      DestroyItem(key);
+    endif
+  endif
+  EraseObjProperty(me, "#DryDocking");
+endfunction
+
+function DestroyBoat(who)
+  var res := DestroyMulti(boat);
+  if(!res)
+    return 0;
+  endif
+  return 1;
+endfunction
+
+function SmackEveryone()
+  foreach mob in(boat.mobiles)
+    ApplyDamage(mob,RandomInt(10));
+    PerformAction(mob,0x14);
+    PlaySoundEffect(mob,0x110);
+  endforeach
+endfunction
+
+function PlayBoatSounds()
+  var who := RandomInt(len(boat.mobiles)+1);
+  var mobs :=(boat.mobiles);
+  if(RandomInt(2) == 1)
+    PlaySoundEffect(mobs[who],0x13);
+  else
+    PlaySoundEffect(mobs[who],0x14);
+  endif
+endfunction
+
+function WorldWrap()
+  var newx := boat.x;
+  var newy := boat.y;
+  if(boat.y <= 6)
+    newy := 4088;
+  elseif(boat.y >= 4089)
+    newy := 6;
+  endif
+  if(boat.x <= 6)
+    newx := 5096;
+  elseif(boat.x >= 5097)
+    newx := 6;
+  endif
+  var lockid := GetObjProperty(boat.hold, "lockid");
+  var owner := GetObjProperty(boat.hold, "owner");
+  var shiptype := boat.objtype;
+  var shipfacing, created;
+  case(tillerman.graphic)
+    0x3e4e: shipfacing := CRMULTI_FACING_NORTH;
+    0x3e55: shipfacing := CRMULTI_FACING_EAST;
+    0x3e4b: shipfacing := CRMULTI_FACING_SOUTH;
+    0x3e50: shipfacing := CRMULTI_FACING_WEST;
+    default: shipfacing := "Error!";
+  endcase
+  if(shipfacing == "Error!")
+    syslog( "[ERROR] [boat.src] Couldn't tell which way the ship was facing for the worldwrap!");
+  endif    
+  created := CreateMultiAtLocation( newx, newy, -5, shiptype, shipfacing, boat.realm);
+  if(!created)
+    syslog( "[ERROR] [boat.src] New ship couldn't be created for worldwrap!");
+    return;
+  endif
+  var oldshiphold := boat.hold;
+  var newshiphold := created.hold;
+  foreach item in EnumerateItemsInContainer( oldshiphold )
+    if(item.container == oldshiphold)
+      MoveItemToContainer(item, newshiphold);
+    endif
+  endforeach
+  foreach item in EnumerateItemsInContainer( oldshiphold )
+    MoveItemToContainer(item, newshiphold);
+  endforeach
+  foreach mob in(boat.mobiles)
+    MoveCharacterToLocation(mob,(mob.x-boat.x)+created.x,(mob.y-boat.y)+created.y, -2,  MOVECHAR_FORCELOCATION );
+  endforeach
+  if(boat.has_offline_mobiles)
+    foreach mob in(boat.offline_mobiles)
+      MoveCharacterToLocation(mob,(mob.x-boat.x)+created.x,(mob.y-boat.y)+created.y, -2,  MOVECHAR_FORCELOCATION );
+    endforeach
+  endif
+  foreach mob in(boat.items)
+    MoveitemToLocation(mob,(mob.x-boat.x)+created.x,(mob.y-boat.y)+created.y, -2,0  );
+  endforeach
+  var newtillerman := created.tillerman;
+  newtillerman.name := tillerman.name;
+  SetObjProperty( created.starboardplank, "lockid", lockid);
+  SetObjProperty( created.portplank, "lockid", lockid);
+  SetObjProperty( created.ship.starboardplank, "owner", owner );
+  SetObjProperty( created.ship.portplank, "owner", owner );
+  SetObjProperty( created.ship.starboardplank, "tillermanid", newtillerman.serial );
+  SetObjProperty( created.ship.portplank, "tillermanid", newtillerman.serial );
+  SetObjProperty( created.hold, "lockid", lockid);
+  SetObjProperty( created.hold, "owner", owner);
+  SetObjProperty( created.tillerman, "owner", owner);
+  SetObjProperty( created.tillerman, "shipserial", created.serial);
+  SetObjProperty( created.tillerman, "lockid", lockid);
+  SetObjProperty( created.tillerman, "decay", decay);
+  if(boat.starboardplank.locked == 1)
+    created.starboardplank.locked := 1;
+  endif
+  if(boat.portplank.locked == 1)  
+    created.portplank.locked := 1;
+  endif
+  if(boat.hold.locked == 1)
+    created.hold.locked := 1;
+  endif
+  SetObjProperty( created.hold, "#relativedir", relative_direction);
+  SetObjProperty( created.hold, "#speed", ms_delay_between_moves);
+  created.tillerman.usescript := ":boat:tillerman";
+  if(!DestroyMulti(boat))
+    DestroyItem(boat.tillerman);
+    syslog( "[ERROR] [boat.src] Old ship at " +(boat.x-1) +","+ boat.y +","+ boat.z + " couldn't be destroyed during worldwrap!");
+  endif
+endfunction
+
+function CanDockMe(boat, who)
+  if(GetObjProperty(boat.hold,"owner") == who.serial)
+    return 1;
+  else
+    var packkey;
+    var lokid := GetObjProperty(boat.tillerman, "lockid");
+    foreach thing in EnumerateItemsInContainer(who.backpack)
+      if(GetObjProperty(thing, "lockid") == lokid)
+        packkey := 1;
+        break;
+      endif
+    endforeach
+    if(packkey == 1)
+      return 1;
+    else
+      return 0;
+    endif
+  endif
+endfunction
+
+/*NEW MAP COURSE FUNCTIONS*/
+//follows the current course
+function BoatFollowCourse(boat)
+	var startx, starty, destx, desty;
+	var course, nextwaypoint;
+	var newpoint, newfacing, prevfacing;
+	
+	course := GetObjProperty(boat.tillerman,"course");
+	nextwaypoint := GetObjProperty(boat.tillerman,"nextwaypoint");
+	startx := boat.x;
+	starty := boat.y;
+	prevfacing := boat.facing;
+	
+	if( (course==error) || (nextwaypoint==error))
+		return;
+	endif
+	
+	destx := course[nextwaypoint].x;
+	desty := course[nextwaypoint].y;
+	
+	newpoint := lineBresenham(startx,starty,destx,desty);
+	newfacing := GetNewFacing(startx,starty,newpoint[1],newpoint[2]);
+
+	if(newfacing == error) //reached waypoint/end
+		nextwaypoint := nextwaypoint + 1;
+		first_move_toward_waypoint := 1; //so we turn toward next waypoint (includes next course follow if we're done with this one)
+		if(nextwaypoint > course.size()) //done
+			state := STATE_DRIFTING;
+			PrintTextAbove(boat.tillerman,"Arr, we've reached our destination.");
+			return;
+		else
+			SetObjProperty(boat.tillerman,"nextwaypoint",nextwaypoint);
+		endif
+		
+	else
+
+		if(first_move_toward_waypoint == 1)
+			if( prevfacing != newfacing )
+				TurnBoat(boat,Cint(DetermineTurnCode(boat,newfacing)) );
+			endif
+			first_move_toward_waypoint := 0;
+		endif
+		MoveBoat(boat,newfacing);
+		
+		if((startx == boat.x) &&(starty == boat.y)) //we didn't move. must be blocked
+    		state := STATE_DRIFTING;
+    		PrintTextAbove(tillerman, "Aaargh!  We've stopped!");
+  		endif
+  	endif
+	
+endfunction
+
+//convert facing 0-7 to turn code 0-3
+function DetermineTurnCode( boat, desired )
+
+    var current := CInt(boat.facing / 2);
+    desired := CInt(desired / 2);
+
+	
+    if ( desired < current ) 
+    	desired := desired + 4; 
+    endif
+    return (desired - current);
+endfunction
+	
+//returns the direction (x1,y1) lies from (x0,y0) in the range 0-7.
+// returns error if the 2 points are equal.
+function GetNewFacing(x0,y0,x1,y1)
+	var dx, dy;
+	var facing;
+	dx := x1 - x0;
+	dy := y1 - y0;
+	
+	case(dx)
+		NEGONE: 
+			case(dy)
+				 NEGONE: facing := 7;
+				 ZERO: facing := 6;
+				 POSONE: facing := 5;
+				 default: facing := error;
+			endcase
+		 ZERO:
+		 	case(dy)
+		 		 NEGONE: facing := 0;
+		 		 ZERO: facing := error;
+		 		 POSONE: facing := 4;
+		 		 default: facing := error;
+		    endcase
+		 POSONE:
+		 	case(dy)
+		 		 NEGONE: facing := 1;
+		 		 ZERO: facing := 2;
+		 		 POSONE: facing := 3;
+		 		 default: facing := error;
+		 	endcase
+		 default: facing := error;
+	endcase
+	
+	return facing;
+endfunction
+
+//Bresenham's line drawing algorithm. determines a line between two waypoints.
+function lineBresenham(x0, y0, x1, y1)
+    var dy;
+    dy := y1 - y0;
+    var dx;
+    dx := x1 - x0;
+    var stepx, stepy;
+
+    if (dy < 0)
+      	dy := -dy;  
+       	stepy := -1;
+    else
+      	stepy := 1;
+    endif
+        
+    if (dx < 0) 
+       	dx := -dx;
+       	stepx := -1;
+    else 
+      	stepx := 1;
+    endif
+        
+    dy := 2*dy;   
+    dx := 2*dx;    
+
+    if (dx > dy)
+        var fraction;
+        fraction := 2*dy - dx;
+        while (x0 != x1)
+        	if (fraction >= 0)
+            	y0 := y0 + stepy;
+                fraction := fraction - dx;
+           	endif
+            x0 := x0 + stepx;
+            fraction := fraction + dy;
+            return {x0, y0};
+        endwhile
+    else
+        var fraction;
+        fraction := 2*dx - dy;
+        while (y0 != y1)
+            if (fraction >= 0)
+                x0 := x0 + stepx;
+                fraction := fraction - dy;
+            endif
+            y0 := y0 + stepy;
+            fraction := fraction + dx;
+            return {x0, y0};
+        endwhile
+    endif
+endfunction
+/*END NEW MAP COURSE FUNCTIONS*/

Added: trunk/096/pkg/multis/boat/OLD/itemdesc.cfg
===================================================================
--- trunk/096/pkg/multis/boat/OLD/itemdesc.cfg	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/itemdesc.cfg	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,168 @@
+Item 0x6027
+{
+    Name                smallboatdeed
+    Desc                deed to a small boat
+    Graphic             0x14F2
+    Script              shipDeed
+    ShipObjType         smallboat
+    VendorSellsFor      12500
+    VendorBuysFor       12500
+	newbie              1
+}
+Item 0x6028
+{
+    Name                smalldragonboatdeed
+    Desc                deed to a small dragon boat
+    Graphic             0x14F2
+    Script              shipDeed
+    ShipObjType         smalldragonboat
+    VendorSellsFor      12500
+    VendorBuysFor       12500
+	newbie              1
+}
+
+
+Item 0x6029
+{
+    Name                mediumboatdeed
+    Desc                deed to a medium boat
+    Graphic             0x14F2
+    Script              shipDeed
+    ShipObjType         mediumboat
+    VendorSellsFor      14200
+    VendorBuysFor       14200
+	newbie              1
+}
+Item 0x602A
+{
+    Name                mediumdragonboatdeed
+    Desc                deed to a medium dragon boat
+    Graphic             0x14F2
+    Script              shipDeed
+    ShipObjType         mediumdragonboat
+    VendorSellsFor      14200
+    VendorBuysFor       14200
+	newbie              1
+}
+
+
+Item 0x602B
+{
+    Name                largeboatdeed
+    Desc                deed to a large boat
+    Graphic             0x14F2
+    Script              shipDeed
+    ShipObjType         largeboat
+    VendorSellsFor      15900
+    VendorBuysFor       15900
+	newbie              1
+}
+
+Item 0x602C
+{
+    Name                largedragonboatdeed
+	Desc                deed to a large dragon boat
+    Graphic             0x14F2
+    Script              shipDeed
+    ShipObjType         largedragonboat
+    VendorSellsFor      15900
+    VendorBuysFor       15900
+	newbie              1
+}
+
+Boat 0x6040
+{
+    Name                smallboat
+    Graphic             0x4000
+    MultiID             0x0000
+    OldObjtype          0x4000
+    OldObjtype          0x4001
+    OldObjtype          0x4002
+    OldObjtype          0x4003
+}
+
+Boat 0x6041
+{
+    Name                smalldragonboat
+    Graphic             0x4004
+    MultiID             0x0004
+    OldObjtype          0x4004
+    OldObjtype          0x4005
+    OldObjtype          0x4006
+    OldObjtype          0x4007
+}
+
+Boat 0x6042
+{
+    Name                mediumboat
+    Graphic             0x4008
+    MultiID             0x0008
+    OldObjtype          0x4008
+    OldObjtype          0x4009
+    OldObjtype          0x400A
+    OldObjtype          0x400B
+}
+
+Boat 0x6043
+{
+    Name                mediumdragonboat
+    Graphic             0x400C
+    MultiID             0x000C
+    OldObjtype          0x400C
+    OldObjtype          0x400D
+    OldObjtype          0x400E
+    OldObjtype          0x400F
+}
+
+Boat 0x6044
+{
+    Name                largeboat
+    Graphic             0x4010
+    MultiID             0x0010
+    OldObjtype          0x4010
+    OldObjtype          0x4011
+    OldObjtype          0x4012
+    OldObjtype          0x4013
+}
+
+Boat 0x6045
+{
+    Name                largedragonboat
+    Graphic             0x4014
+    MultiID             0x0014
+    OldObjtype          0x4014
+    OldObjtype          0x4015
+    OldObjtype          0x4016
+    OldObjtype          0x4017
+}
+
+Item 0xF010
+{
+    Name                Tillerman
+    graphic             1
+	script              tillerman
+}
+
+Item 0xF011
+{
+    Name                gangplank
+    Graphic             1
+    Lockable            1
+    RequiresAttention   0
+    DoubleclickRange    20
+    Script              plank
+    WalkOnScript        plankWalk
+    ControlScript       plankControl
+}
+
+Item 0xF012
+{
+    Name                gangplank2
+    Graphic             1
+    Lockable            1
+    RequiresAttention   0
+    DoubleclickRange    20
+    Script              plank
+    WalkOnScript        plankWalk
+    ControlScript       plankControl
+}

Added: trunk/096/pkg/multis/boat/OLD/pkg.cfg
===================================================================
--- trunk/096/pkg/multis/boat/OLD/pkg.cfg	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/pkg.cfg	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,9 @@
+# $Id: pkg.cfg 684 2005-10-27 18:48:28Z muaddiblsd $
+#
+#
+Enabled		0
+Name		boat
+Maintainer	Distro Team
+Email		distro at polserver.com
+Version		1.0
+

Added: trunk/096/pkg/multis/boat/OLD/plank.src
===================================================================
--- trunk/096/pkg/multis/boat/OLD/plank.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/plank.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,92 @@
+use os;
+use uo;
+
+include "util/key";
+include ":itemutils:objtype";
+include "plankUtil";
+
+program useplank(mob, plank)
+  set_critical(1);
+
+// Refresh the boat if he's the owner.
+var owner := GetObjProperty(plank, "owner");
+if (mob.serial == owner)
+  var tillermanid := GetObjProperty(plank, "tillermanid");
+  var tillerman := SystemFindObjectBySerial( tillermanid );
+  if (tillerman)
+    var decay := GetObjProperty(tillerman, "decay");
+    // Only give him the refresh message if the ship was less than 'in excellent shape'
+    // so he doesn't get the message every time he gets on and off the ship.
+    if ( (decay - ReadGameClock() ) < 860000 )
+          SendSysMessage(mob, "Your ship has been refreshed.");
+    endif
+    SetObjProperty( tillerman, 	  "decay",      (ReadGameClock()+ 864000));
+  endif
+endif
+  if(mob.multi.serial == plank.multi.serial)
+	TimedOpenClose(plank);
+  elseif((FK(mob, plank) == 1) ||(!plank.locked))
+	if(!IsExtended(plank))
+	  TimedOpenClose(plank);
+	else
+	  YankOntoBoat(mob,plank);
+	endif
+  else
+	PrintTextAbovePrivate(plank, "That is locked.", mob);
+  endif
+endprogram
+
+function TimedOpenClose(plank)
+  if(IsExtended(plank))
+    if(!IsPlankOccupied(plank))
+      Retract(plank);
+      EraseObjProperty(plank, "#WhenOpened");
+    endif
+  else
+    var whenopened := ReadGameClock();
+    SetObjProperty(plank, "#WhenOpened", whenopened);
+    Extend(plank);
+    repeat
+    sleep(6);
+    until(!(plank && IsPlankOccupied(plank)));
+    if(GetObjProperty(plank, "#WhenOpened") == whenopened)
+      Retract(plank);
+      EraseObjProperty(plank, "#WhenOpened");
+    endif
+  endif
+endfunction
+
+function YankOntoBoat(mob, plank)
+  var sh := GetStandingHeight(plank.x, plank.y, plank.z, plank.realm);
+  if(sh)
+    var nx :=(plank.x + plank.multi.x) / 2;
+    var ny :=(plank.y + plank.multi.y) / 2;
+    MoveCharacterToLocation(mob, nx, ny, plank.z);
+    return;
+  endif
+endfunction
+
+function CanWalkOntoPlank(plank)
+  var dx;
+  var dy;
+  case(plank.graphic)
+    GID_PLANK_EXTENDED_FACING_WEST:
+    GID_PLANK_RETRACTED_FACING_WEST:    dx := -1;
+                                        dy := 0;
+    GID_PLANK_EXTENDED_FACING_EAST:
+    GID_PLANK_RETRACTED_FACING_EAST:    dx := 1;
+                                        dy := 0;
+
+    GID_PLANK_EXTENDED_FACING_NORTH:
+    GID_PLANK_RETRACTED_FACING_NORTH:   dx := 0;
+                                        dy := -1;
+    GID_PLANK_EXTENDED_FACING_SOUTH:
+    GID_PLANK_RETRACTED_FACING_SOUTH:   dx := 0;
+                                        dy := 1;
+  endcase
+  if(GetStandingHeight(plank.x + dx, plank.y + dy, plank.z, plank.realm))
+    return 1;
+  else
+     return 0;
+  endif
+endfunction

Added: trunk/096/pkg/multis/boat/OLD/plankControl.src
===================================================================
--- trunk/096/pkg/multis/boat/OLD/plankControl.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/plankControl.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,20 @@
+/*
+ * plankcontrol - plank control script
+ *
+ * sole job is to close an open locked plank on startup.
+ *
+ */
+
+use os;
+use uo;
+
+include ":itemutils:objtype";
+include "plankUtil";
+
+set_debug(1);
+
+program plankcontrol( plank )
+    if (plank.locked && IsExtended(plank))
+        Retract( plank );
+    endif
+endprogram

Added: trunk/096/pkg/multis/boat/OLD/plankUtil.inc
===================================================================
--- trunk/096/pkg/multis/boat/OLD/plankUtil.inc	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/plankUtil.inc	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,89 @@
+include ":itemutils:objtype";
+
+const KEYSTART := 0x100e;
+const KEYEND := 0x1013;
+const KEYRING := 0x1011;
+
+function IsExtended( plank )
+  return plank.graphic in { GID_PLANK_EXTENDED_FACING_EAST, GID_PLANK_EXTENDED_FACING_WEST, GID_PLANK_EXTENDED_FACING_NORTH, GID_PLANK_EXTENDED_FACING_SOUTH };
+endfunction
+
+function IsPlankOccupied( plank )
+  return ListMobilesNearLocation( plank.x, plank.y, plank.z, 0, plank.realm ).size();
+endfunction
+
+function Extend( plank )
+  if (!IsExtended(plank))
+    TogglePlank(plank);
+  endif
+endfunction
+
+function Retract( plank )
+  if (IsExtended(plank))
+    TogglePlank(plank);
+  endif
+endfunction
+
+function TogglePlank( plank )
+  var partnertype := PlankPartner( plank.graphic );
+  if (partnertype)
+    plank.graphic := partnertype;
+  endif
+endfunction
+
+function PlankPartner( planktype )
+  case (planktype)
+    GID_PLANK_EXTENDED_FACING_EAST:  return GID_PLANK_RETRACTED_FACING_EAST;   // 0x3ed5: return 0x3eb1;
+    GID_PLANK_RETRACTED_FACING_EAST: return GID_PLANK_EXTENDED_FACING_EAST;    // 0x3eb1: return 0x3ed5;
+    GID_PLANK_EXTENDED_FACING_WEST:  return GID_PLANK_RETRACTED_FACING_WEST;   // 0x3ed4: return 0x3eb2;
+    GID_PLANK_RETRACTED_FACING_WEST: return GID_PLANK_EXTENDED_FACING_WEST;    // 0x3eb2: return 0x3ed4;
+    GID_PLANK_EXTENDED_FACING_NORTH:  return GID_PLANK_RETRACTED_FACING_NORTH; // 0x3e84: return 0x3e85;
+    GID_PLANK_RETRACTED_FACING_NORTH: return GID_PLANK_EXTENDED_FACING_NORTH;  // 0x3e85: return 0x3e84;
+    GID_PLANK_EXTENDED_FACING_SOUTH:  return GID_PLANK_RETRACTED_FACING_SOUTH; // 0x3e89: return 0x3e8a;
+    GID_PLANK_RETRACTED_FACING_SOUTH: return GID_PLANK_EXTENDED_FACING_SOUTH;  // 0x3e8a: return 0x3e89;
+    default: syslog( "Unknown plank type 0x" + Hex( planktype ) );
+             return error;
+  endcase
+endfunction
+
+function fk(me, plank)
+  var doorlockid := GetObjProperty( plank, "lockid" );
+  var keylockid;
+  var insidering;
+  var mykeys := EnumerateItemsInContainer(me.backpack);
+  foreach key in mykeys
+	if ( (key.objtype >= KEYSTART ) && (key.objtype <= KEYEND) && (key.objtype != KEYRING ) )
+	  keylockid := GetObjProperty( key, "lockid" );
+	  if ( (keylockid) && (keylockid == doorlockid) )
+		return 1;
+	  endif
+	elseif (key.objtype == KEYRING)
+	  insidering := FindMyPack(key.serial);
+	  foreach otherkey in EnumerateItemsInContainer(insidering)
+		keylockid := GetObjProperty( otherkey, "lockid" );
+		if (keylockid == doorlockid)
+		  return 1;
+		endif
+	  endforeach
+	endif
+  endforeach
+  return 0;
+endfunction
+
+function OpenTamedStorageAreas()
+  var bank := FindStorageArea( "Tamed Storage" );
+  if (!bank)
+    bank := CreateStorageArea( "Tamed Storage" );
+  endif
+  return bank;
+endfunction
+
+function FindMyPack(myserial)
+  var mybank := OpenTamedStorageAreas();
+  var bank_obj_name := "Bankbox  " + Hex(myserial);
+  var bankbox := FindRootItemInStorageArea( mybank, bank_obj_name );
+  if (!bankbox)
+    bankbox := CreateRootItemInStorageArea(mybank, bank_obj_name, UOBJ_BANKBOX  );
+  endif
+  return bankbox;
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/multis/boat/OLD/plankWalk.src
===================================================================
--- trunk/096/pkg/multis/boat/OLD/plankWalk.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/plankWalk.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,158 @@
+use os;
+use uo;
+
+include "include/client";
+include ":itemutils:objtype";
+include "util/key";
+include "plankUtil";
+
+/*
+ * the searchoffset matrix is for an east-facing plank.
+ * these will have to be rotated for the other positions
+ *   P is the plank, N is where you can't step (otherwise
+ *    this teleportation stuff wouldn't be necessary)
+ *
+ *        13 12 11
+ *        14  5  4
+ *        15  6  2
+ *        16  7  1 N P
+ *        17  8  3
+ *        18  9 10
+ *        19 20 21
+ *
+ */
+
+var searchoffset := {
+   { -2,  0 },          //  1
+   { -2, -1 },
+   { -2, +1 },
+   { -2, -2 },
+   { -3, -2 },          //  5
+   { -3, -1 },
+   { -3,  0 },
+   { -3, +1 },
+   { -3, +2 },
+   { -2, +2 },          // 10
+   { -2, -3 },
+   { -3, -3 },
+   { -4, -3 },
+   { -4, -2 },
+   { -4, -1 },          // 15
+   { -4,  0 },
+   { -4, +1 },
+   { -4, +2 },
+   { -4, +3 },
+   { -3, +3 },          // 20
+   { -2, +3 },
+   { -5,  0 },
+   { -5, +2 },
+   { -5, +3 },
+   { -5, +4 },
+   { -4, +4 },          // 20
+   { -3, +4 },
+   { -6,  0 },
+   { -6, +3 },
+   { -6, +4 },
+   { -6, +5 },
+   { -5, +5 },          // 20
+   { -4, +5 }
+};
+
+program plankwalk( who, plank, lastx, lasty, lastz )
+    if (!FindKey( who, plank ))
+        if (plank.locked)
+            var sh := GetStandingHeight( lastx, lasty, lastz, who.realm );
+            if (!sh || !sh.multi || sh.multi.serial != plank.multi.serial)
+                MoveCharacterToLocation( who, lastx, lasty, lastz, MOVECHAR_FORCELOCATION );
+                return;
+            endif
+        endif
+    endif
+
+    if (ListMobilesNearLocation( plank.x, plank.y, plank.z, 0, plank.realm ).size() > 1)
+        MoveCharacterToLocation( who, lastx, lasty, lastz, MOVECHAR_FORCELOCATION );
+        return;
+    endif
+
+    var xidx, yidx, xmul, ymul;
+
+    case (plank.graphic)
+        GID_PLANK_EXTENDED_FACING_WEST:
+            if (! (who.facing in { DIR_W, DIR_NW, DIR_SW }))
+                return;
+            endif
+            xidx := 1;
+            yidx := 2;
+            xmul := 1;
+            ymul := 1;
+
+        GID_PLANK_EXTENDED_FACING_EAST:
+            if (! (who.facing in { DIR_E, DIR_NE, DIR_SE }))
+                return;
+            endif
+            xidx := 1;
+            yidx := 2;
+            xmul := -1; // flip across x-axis
+            ymul := 1;
+
+        GID_PLANK_EXTENDED_FACING_NORTH:
+            if (! (who.facing in { DIR_N, DIR_NE, DIR_NW }))
+                return;
+            endif
+            xidx := 2;
+            yidx := 1;
+            xmul := 1;
+            ymul := +1;
+
+        GID_PLANK_EXTENDED_FACING_SOUTH:
+            if (! (who.facing in { DIR_S, DIR_SE, DIR_SW }))
+                return;
+            endif
+            xidx := 2;
+            yidx := 1;
+            xmul := 1;
+            ymul := -1; // flip across y-axis
+
+        default:
+            return;
+    endcase
+    if (CanMove( who,
+                 searchoffset[1][xidx] * xmul / 2,
+                 searchoffset[1][yidx] * ymul / 2 ))
+        return;                     // doesn't need our help!
+    endif
+
+
+    foreach offset in searchoffset
+        if (TryMove( who, offset[xidx] * xmul, offset[yidx] * ymul ))
+            return;
+        endif
+    endforeach
+endprogram
+
+function TryMove( who, dx, dy )
+    var res := 0;
+    set_critical( 1 );
+
+    var tryx := who.x + dx;
+    var tryy := who.y + dy;
+    var h := GetStandingHeight( tryx, tryy, who.z, who.realm );
+    if (h && (not h.multi)) // CHECKME should check line of sight?
+        MoveCharacterToLocation( who, tryx, tryy, h.z );
+        res := 1;
+    endif
+
+    set_critical(0);
+    return res;
+endfunction
+
+function CanMove( who, dx, dy )
+    var tryx := who.x + dx;
+    var tryy := who.y + dy;
+    var h := GetStandingHeight( tryx, tryy, who.z, who.realm );
+    if (h)
+        return 1;
+    else
+        return 0;
+    endif
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/multis/boat/OLD/shipDeed.src
===================================================================
--- trunk/096/pkg/multis/boat/OLD/shipDeed.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/shipDeed.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,128 @@
+// $Id: shipDeed.src 905 2005-11-05 08:20:50Z muaddiblsd $
+
+use cfgfile;
+use uo;
+use os;
+
+include "util/key";
+include ":itemutils:objtype";
+include ":itemutils:canAccess";
+
+program useshipdeed(who, deed)
+  if(DeedAlreadyBuiltFrom(deed))
+    PrintTextAbovePrivate(deed, "That ship has already been built.", who);
+  elseif(can_access(who, deed))
+    BuildShip(who, deed);
+  endif
+endprogram
+
+function BuildShip(who, deed)
+  var shiptype := GetShipObjtype(deed.objtype);
+  if(!shiptype)
+    PrintTextAbovePrivate(deed, "That ship deed appears to be broken.", who);
+    return;
+  endif
+  var flags := ShipFacingFlags(who.facing);
+  var where := TargetMultiPlacement(who, shiptype, flags);
+  if(!where)
+    if(deed.graphic == 5363)
+      deed.graphic := 5364;
+    elseif(deed.graphic == 5364)
+      deed.graphic := 5363;
+    endif
+    return;
+  elseif((where.x == deed.x) && (where.y == deed.y))
+    if(deed.graphic == 5363)
+      deed.graphic := 5364;
+    elseif(deed.graphic == 5364)
+      deed.graphic := 5363;
+    endif
+    return;
+  endif
+  set_critical(1);
+  if((where.x < who.x - 10) || (where.y < who.y - 10) || (where.x > who.x + 10) || (where.y > who.y + 10))
+    SendSysMessage(who, "You cannot place a boat that far away.");
+    return;
+  endif
+  var created := CreateShipKeysAndBuiltDeed(who, shiptype, where.x, where.y, where.z, flags);
+  if(created)
+    var ship := created.ship;
+    var deedtype := deed.objtype;
+    if((deed.name != "a toy boat") && (!deed.name["deed"]))
+      ship.tillerman.name := deed.name;
+    endif
+    if(DestroyItem(deed))
+      ship.starboardplank.locked    := 1;
+      ship.portplank.locked         := 1;
+      ship.hold.locked              := 1;
+      var lockid := AllocLockId();
+      SetObjProperty(ship.starboardplank, "lockid",      lockid);
+      SetObjProperty(ship.starboardplank, "owner",       who.serial);
+      SetObjProperty(ship.starboardplank, "tillermanid", ship.tillerman.serial);
+      SetObjProperty(ship.portplank,      "lockid",      lockid);
+      SetObjProperty(ship.portplank,      "owner",       who.serial);
+      SetObjProperty(ship.portplank,      "tillermanid", ship.tillerman.serial);
+      SetObjProperty(ship.hold,           "lockid",      lockid);
+      SetObjProperty(ship.tillerman,      "owner",       who.serial);
+      SetObjProperty(ship.tillerman,      "shipserial",  ship.serial);
+      SetObjProperty(ship.tillerman,      "lockid",      lockid);
+      SetObjProperty(ship.tillerman,      "shiptype",    deedtype);
+      SetObjProperty(created.packkey,     "lockid",      lockid);
+      SetObjProperty(created.packkey,     "shipserial",  ship.serial);
+      SetObjProperty(ship.tillerman,      "decay",       (ReadGameClock()+ 864000));
+      ship.tillerman.usescript := ":boat:tillerman";
+    else
+      DestroyItem(created.packkey);
+      DestroyMulti(ship);
+      SendSysMessage(who, "There was an error creating the boat.");
+    endif
+  endif
+endfunction
+
+function ShipFacingFlags(facing)
+  var flags := 0;
+  case (facing)
+    DIR_N:  flags := CRMULTI_FACING_NORTH;
+    DIR_NE: flags := CRMULTI_FACING_NORTH;
+    DIR_E:  flags := CRMULTI_FACING_EAST;
+    DIR_SE: flags := CRMULTI_FACING_SOUTH;
+    DIR_S:  flags := CRMULTI_FACING_SOUTH;
+    DIR_SW: flags := CRMULTI_FACING_SOUTH;
+    DIR_W:  flags := CRMULTI_FACING_WEST;
+    DIR_NW: flags := CRMULTI_FACING_NORTH;
+  endcase
+  return flags;
+endfunction
+
+function CreateShipKeysAndBuiltDeed(who, shiptype, x, y, z, flags)
+  var packkey := CreateItemInBackpack(who, UOBJ_COPPER_KEY);
+  if(!packkey)
+    PrintTextAbovePrivate(who, "My backpack is too full!", who);
+    return 0;
+  endif
+  var ship := CreateMultiAtLocation(x, y, z, shiptype, flags, who.realm);
+  if(!ship)
+    PrintTextAbovePrivate(who, "I can't place the ship there.", who);
+    DestroyItem(packkey);
+    return 0;
+  else
+    var result := struct;
+    result.+packkey := packkey;
+    result.+ship    := ship;
+    return result;
+  endif
+endfunction
+
+function DeedAlreadyBuiltFrom(deed)
+  if(GetObjProperty(deed, "builtserial"))
+    return 1;
+  else
+    return 0;
+  endif
+endfunction
+
+function GetShipObjtype(objtype)
+    var cfg := ReadConfigFile(":boat:itemdesc");
+    var ot := GetObjtypeByName(cfg[objtype].ShipObjType);
+    return Cint(ot);
+endfunction
\ No newline at end of file

Added: trunk/096/pkg/multis/boat/OLD/tillerman.src
===================================================================
--- trunk/096/pkg/multis/boat/OLD/tillerman.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/OLD/tillerman.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -0,0 +1,22 @@
+use os;
+use uo;
+
+include "util/key";
+include ":itemutils:objtype";
+include "plankUtil";
+
+program renameboat(you, tillerman)
+  if((GetObjProperty(tillerman,"owner") != you.serial) &&(you.cmdlevel < 2))
+	PrintTextAbove(tillerman,"Stop that, or I'll throw ye overboard!");
+	return;
+  endif
+    var boatname := RequestInput(you, tillerman, "Enter a new name for this boat.(max 40 characters)");
+  if(boatname)
+	if(len(boatname) <= 40)
+	  tillerman.name := boatname;
+	  SendSysMessage(you, "Boat is renamed.");
+	else
+	  SendSysMessage(you, "Too many characters in name.");
+	endif
+  endif
+endprogram
\ No newline at end of file

Deleted: trunk/096/pkg/multis/boat/boat.src
===================================================================
--- trunk/096/pkg/multis/boat/boat.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/boat.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,790 +0,0 @@
-////////////////
-//	boat.src 
-//
-//	control script for boats
-//
-//	Header replaced by Racalac 9/15/02
-//
-//	Todo/Fix: Course nav needs the "goto #" command implimented.
-//			  Tillerman string recognition causes boat to pause
-////////////////
-
-use os;
-use uo;
-use util;
-use boat;
-
-include "include/OLD/eventID";
-include "include/sysEvent";
-include ":itemutils:myUtil";
-include "include/client";
-include "include/OLD/sound";
-include ":gumps:yesno";
-include "util/key";
-include "plankUtil";
-
-const STATE_STATIONARY := 0;
-const STATE_MOVING := 1;
-const STATE_DRIFTING := 2;
-const STATE_FOLLOWING_COURSE := 3; //NOTE NEW STATE
-const DELAY_DRIFTING := 15000;
-
-/*NOTE NEW CONSTANTS*/
-const NEGONE := -1;
-const ZERO := 0;
-const POSONE := 1;
-
-var state := STATE_STATIONARY;
-var relative_direction;
-var ms_delay_between_moves := 200;
-var boat;
-var tillerman;
-var owner := GetObjProperty(boat.hold,"owner");
-var decay := GetObjProperty(boat.tillerman, "decay");
-
-/*NOTE NEW GLOBAL*/
-var first_move_toward_waypoint := 1;
-
-program autostart_boat(param)
-  boat := param;
-  if(!boat)
-    syslog( "[ERROR] [boat.src] Boat script running, but boat not found!" );
-    return;
-  endif
-  tillerman := boat.tillerman;
-  if(!tillerman)
-    syslog( "[ERROR] [boat.src] No tillerman for boat at: " +(boat.x-1) +","+ boat.y +","+ boat.z + "; destroying the boat..." );
-    DestroyMulti(boat);
-    return;
-  endif
-  EnableEvents(SYSEVENT_SPEECH, 15);
-  RegisterForSpeechEvents(tillerman, 15);
-  var nextencounter := ReadGameClock()+(RandomInt(120) + 120);
-  var nextsound := ReadGameClock()+5;
-  var driftcounter := 1;
-  //set_critical(1);
-  var x,y;
-  while(boat)
-    if(GetObjProperty(boat.hold, "#speed"))
-      state := STATE_MOVING;
-      ms_delay_between_moves := GetObjProperty(boat.hold, "#speed"); 
-      relative_direction := GetObjProperty(boat.hold, "#relativedir");
-      eraseobjproperty(boat.hold, "#speed");
-      eraseobjproperty(boat.hold, "#relativedir");    
-    endif     
-    decay := getobjproperty(boat.tillerman,"decay");
-    if((decay) and(!getobjproperty(tillerman,"nodecay")))
-      if(ReadGameClock() > decay)
-        PrintTextAbove(tillerman, "Arrrrrgh!  She's going down, Captain!  Abandon ship!");
-        sleep(4);
-        foreach item in EnumerateItemsInContainer( boat.hold )
-          DestroyItem(item);
-        endforeach
-        foreach mob in(boat.items)
-          DestroyItem(mob);
-        endforeach        
-        foreach mob in(boat.mobiles)
-          MoveCharacterToLocation(mob, 1, 1, 0,  MOVECHAR_FORCELOCATION );
-          SendSysMessage(mob, "Your ship, badly in need of maintenance, sinks beneath the waves!");
-          SendSysMessage(mob, "You awake on a distant shore...");
-        endforeach
-        if(boat.has_offline_mobiles)
-          foreach mob in(boat.offline_mobiles)
-            MoveCharacterToLocation(mob, 1, 1, 0,  MOVECHAR_FORCELOCATION );
-          endforeach
-        endif
-        DestroyMulti(boat);
-      endif
-    endif    
-    case(state)
-      STATE_MOVING:   if(ReadGameClock() > nextsound)
-                        PlayBoatSounds();
-                        nextsound := ReadGameClock()+5;
-                      endif
-                      x := boat.x;
-                      y := boat.y;
-                      MoveBoatRelative(boat, relative_direction);
-                      if(boat.x == 6 or boat.x == 5097 or boat.y == 6 or boat.y == 4089)   
-                        WorldWrap();
-                      endif
-                      if((x == boat.x) &&(y == boat.y))
-                        ms_delay_between_moves := 1000;
-                        state := STATE_DRIFTING;
-                        PrintTextAbove(tillerman, "Aaargh!  We've run ashore!");
-                        //SmackEveryone();
-                      endif
-                      sleepms(ms_delay_between_moves);
-                      if(ReadGameClock() > nextencounter)
-                        DoEncounter();
-                        nextencounter := ReadGameClock()+120;
-                      endif
-                      while(events_waiting())
-                        process_event(wait_for_event(0));
-                      endwhile
-      STATE_DRIFTING:   if(ReadGameClock() > nextsound)
-                          PlayBoatSounds();
-                          nextsound := ReadGameClock()+5;
-                        endif
-                        if(driftcounter > 15)
-                          MoveBoatRelative(boat, RandomInt(8));
-                          driftcounter := 1;
-                        else
-                          driftcounter := driftcounter + 1;
-                        endif
-                        sleepms(1000);
-                        while(events_waiting())
-                          process_event(wait_for_event(0));
-                        endwhile
-      STATE_STATIONARY: var ev := wait_for_event(120);
-                        if(ev)
-                          process_event(ev);
-                        endif
-/*NOTE NEW BOAT STATE*/
-      STATE_FOLLOWING_COURSE:
-        		x := boat.x;
-        		y := boat.y;
-        		BoatFollowCourse(boat);
-        				
-        		sleepms(ms_delay_between_moves);
-                        while(events_waiting())
-                          process_event(wait_for_event(0));
-                        endwhile
-/*END NEW BOAT STATE*/
-    endcase
-    if(ReadGameClock() > nextencounter)
-      checkres();
-      nextencounter := ReadGameClock()+120;
-    endif
-  endwhile
-endprogram
-
-function handle_speech(event)
-  var text := lower(event.text);
-  if(text["drift"] || text["raise anchor"])
-    ms_delay_between_moves := 1000;
-    state := STATE_DRIFTING;
-    PrintTextAbove(tillerman, "Aye Aye, Captain!");
-  elseif(text["forward"])
-    if(state == STATE_STATIONARY)
-      PrintTextAbove(tillerman, "The anchor is down, Captain!");
-    else
-      PrintTextAbove(tillerman, "Aye Aye, Captain!");
-      state := STATE_MOVING;
-      if(text["left"])
-        relative_direction := 7;
-      elseif(text["right"])
-        relative_direction := 1;
-      else
-        relative_direction := 0;
-      endif
-    endif
-  elseif(text["back"])
-    if(state == STATE_STATIONARY)
-      PrintTextAbove(tillerman, "The anchor is down, Captain!");
-    else
-      PrintTextAbove(tillerman, "Aye Aye, Captain!");
-      state := STATE_MOVING;
-      if(text["left"])
-        relative_direction := 5;
-      elseif(text["right"])
-        relative_direction := 3;
-      else
-        relative_direction := 4;
-      endif
-    endif
-  elseif(text["stop"] || text["furl sail"] || text["furl"])
-    PrintTextAbove(tillerman, "Aye Aye, Captain!");
-    ms_delay_between_moves := 1000;
-    state := STATE_DRIFTING;
-  elseif(text["drop anchor"])
-    PrintTextAbove(tillerman, "Aye Aye, Captain! Anchor dropped.");
-    ms_delay_between_moves := 1000;
-    state := STATE_STATIONARY;
-  elseif(text["turn right"] || text["starboard"])
-    if(state == STATE_STATIONARY)
-      PrintTextAbove(tillerman, "The anchor is down, Captain!");
-    else
-      PrintTextAbove(tillerman, "Aye Aye, Captain!");
-      TurnBoat(boat, 1);
-    endif
-  elseif(text["right"])
-    if(state == STATE_STATIONARY)
-      PrintTextAbove(tillerman, "The anchor is down, Captain!");
-    else
-      PrintTextAbove(tillerman, "Aye Aye, Captain!");
-      state := STATE_MOVING;
-      relative_direction := 2;
-    endif
-  elseif(text["turn left"] || text["port"])
-    if(state == STATE_STATIONARY)
-      PrintTextAbove(tillerman, "The anchor is down, Captain!");
-    else
-      PrintTextAbove(tillerman, "Aye Aye, Captain!");
-      TurnBoat(boat, 3);
-    endif
-  elseif(text["left"])
-    if(state == STATE_STATIONARY)
-      PrintTextAbove(tillerman, "The anchor is down, Captain!");
-    else
-      PrintTextAbove(tillerman, "Aye Aye, Captain!");
-      state := STATE_MOVING;
-      relative_direction := 6;
-    endif
-  elseif(text["come about"] || text["turn around"])
-    if(state == STATE_STATIONARY)
-      PrintTextAbove(tillerman, "The anchor is down, Captain!");
-    else
-      PrintTextAbove(tillerman, "Aye Aye, Captain! Coming about!");
-      TurnBoat(boat, 2);
-      sleep(1);
-    endif
-/*NEW MAP COURSE COMMANDS*/
-    elseif(text["set course"])
-      	PrintTextAbove(tillerman, "Select a map for me to follow.");   	
-      	var map := Target(event.source);
-      	if(!map.isa(POLCLASS_MAP))
-      		PrintTextAbove(tillerman, "Are ye dense? I need a map!"); 
-      	else
-      		SetObjProperty(tillerman, "course", map.GetPins());
-      		SetObjProperty(tillerman, "nextwaypoint", 1);
-      		PrintTextAbove(tillerman, "Arr, course plotted."); 
-      	endif
-    elseif(text["clear course"])
-    	PrintTextAbove(tillerman, "Arr, course cleared Cap'n.");
-    	EraseObjProperty(tillerman, "course");
-    	EraseObjProperty(tillerman, "nextwaypoint");
-    elseif(text["nav"])
-    	if(state != STATE_FOLLOWING_COURSE)
-    		PrintTextAbove(tillerman, "We are not currently following a course.");
-    	else
-    		PrintTextAbove(tillerman, "We are following our course.");
-    		PrintTextAbove(tillerman, "The next waypoint is #" + GetObjProperty(tillerman,"nextwaypoint"));
-    	endif
-    elseif(text["start"])
-    	if( (GetObjProperty(tillerman,"course")==error) || (GetObjProperty(tillerman,"nextwaypoint")==error))
-    		PrintTextAbove(tillerman,"Arr, set course first Cap'n.");
-    	else    		
-     		state := STATE_FOLLOWING_COURSE;
-     		SetObjProperty(tillerman, "nextwaypoint", 1);
-    		PrintTextAbove(tillerman,"Aye, sailing to first waypoint.");
-    	endif
-    elseif(text["continue"])
-    	if( (GetObjProperty(tillerman,"course")==error) || (GetObjProperty(tillerman,"nextwaypoint")==error))
-    		PrintTextAbove(tillerman,"Arr, set course first Cap'n.");
-    	else
-    	    state := STATE_FOLLOWING_COURSE;
-    		PrintTextAbove(tillerman,"Aye, moving on.");
-    	endif
-  	endif
-/*END NEW MAP COURSE COMMANDS*/
-  if(text["full"])
-    if(state != STATE_STATIONARY)
-      PrintTextAbove(tillerman, "Aye Aye, Captain! Full speed ahead!");
-      ms_delay_between_moves := 100;
-    endif
-  elseif(text["slow"])
-    if(state != STATE_STATIONARY)
-      PrintTextAbove(tillerman, "Aye Aye, Captain! ");
-      ms_delay_between_moves := 1000;
-    endif
-  endif
-  sleep(1);
-  if(text["one"])
-    if(state != STATE_STATIONARY)
-      MoveBoatRelative(boat, relative_direction);
-      state := STATE_STATIONARY;
-    endif
-  endif
-endfunction
-
-function process_event(event)
-  if(event.type == SYSEVENT_SPEECH)
-    if(CanCommandMe(event.source))
-      var text := lower(event.text);
-      if(text["drydock"])
-        PrintTextAbove(tillerman, "Aye Aye, Captain! Docking.");
-        drydock(event);
-        sleep(1);
-      elseif(text["status"])
-        decay := GetObjProperty(boat.tillerman, "decay");
-        if((decay - ReadGameClock() ) > 861000 )
-          PrintTextAbove( tillerman, "Arrh, the ship's in excellent shape! She's a fine vessel indeed, Captain!" );
-        elseif((decay - ReadGameClock() ) > 604800 )
-          PrintTextAbove( tillerman, "She's slightly worn, Captain.");
-        elseif((decay - ReadGameClock() ) > 259200 )
-          PrintTextAbove(tillerman, "She's fairly worn, Captain.");
-        elseif((decay - ReadGameClock() ) > 86400 )
-          PrintTextAbove(tillerman, "Arrr, she's greatly worn and in dire need of repair, Captain!");
-        else 
-          PrintTextAbove(tillerman, "Arrr, she's going to sink within the day if she don't get repairs soon, Captain!");
-        endif
-      else
-        foreach person in (boat.mobiles)
-          if (event.source == person)
-             handle_speech(event);
-          endif  
-        endforeach
-      endif
-    endif
-  endif
-  
-endfunction
-
-function CanCommandMe(who)
-  owner := GetObjProperty(boat.tillerman, "owner");
-  if(who.serial == owner)
-    return 1;
-  else
-    var packkey;
-    var lokid := GetObjProperty(boat.tillerman, "lockid");
-    foreach thing in EnumerateItemsInContainer(who.backpack)
-      if(GetObjProperty(thing, "lockid") == lokid)
-        packkey := 1;
-        break;
-      endif
-    endforeach
-    if(packkey == 1)
-      return 1;
-    else
-      return 0;
-    endif
-  endif
-endfunction
-
-function DoEncounter()
-  foreach who in  ListMobilesNearLocationEx(boat.x, boat.y, GetMapInfo(boat.x, boat.y, boat.realm).z, 4, LISTEX_FLAG_GHOST, boat.realm)
-    if(YesNo(who,"Resurrect?"))
-      if (who in boat.mobiles)
-        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
-        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
-        Resurrect(who);
-      endif
-    endif
-  endforeach
-  var who :=(boat.mobiles);
-  who := who[1];
-  if(!who)
-    return;
-  endif
-  var x;
-  var y;
-  var z;
-  x := RandomInt(15)-5;
-  y := RandomInt(15)-5;
-  x := x + boat.x;
-  y := y + boat.y;
-  if(x > boat.x)
-    x := x + 5;
-  else
-    x := x - 5;
-  endif
-  if(y > boat.y)
-    y := y + 5;
-  else
-    y := y - 5;
-  endif
-  z := GetMapInfo(x, y, boat.realm).z;
-  if(z >= who.z)
-    return;
-  endif
-  var it := CreateNpcFromTemplate(getcritter(), x, y, z, 0, boat.realm);
-  if(it)
-    SetObjProperty(it,"killme",1);
-  endif
-  var ev := {};
-  ev.+type := EVID_ENTEREDAREA;
-  ev.+source := who;
-  SendEvent(it, ev);
-endfunction
-
-function checkres()
-  foreach who in  ListMobilesNearLocationEx(boat.x, boat.y, GetMapInfo(boat.x, boat.y, boat.realm).z, 4, LISTEX_FLAG_GHOST, boat.realm)
-    if(who in boat.mobiles)
-      if(YesNo(who,"Resurrect?"))
-        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
-        PlaySoundEffect(who, SFX_SPELL_RESSURECTION);
-        Resurrect(who);
-      endif
-    endif
-  endforeach
-endfunction
-
-function getcritter()
-  case(RandomInt(9))
-    0: return "walrus";
-    1: return "walrus";
-    2: return "walrus";
-    3: return "walrus";
-    4: return "alligator";
-    5: return "alligator";
-    6: return "waterelemental";
-    7: return "seaserpent";
-    8: return "airelemental";
-  endcase
-endfunction
-
-function drydock(event)
-  if(GetObjProperty(event.source, "#DryDocking"))
-    SendSysMessage(event.source, "You are already doing something else.");
-    return;
-  endif
-  SetObjProperty(event.source, "#DryDocking", 1);
-  EraseObjProperty(event.source, "#DryDocking");
-  var text := lower(event.text);
-  if(!text["drydock"])
-    EraseObjProperty(event.source, "#DryDocking");
-    return;
-  endif
-  var me := event.source;
-  var items := boat.items;
-  var mobsondeck := boat.mobiles;
-
-  if(len(items) > 0)
-    PrintTextAbovePrivate(boat.tillerman, "Arrh, Captain!  You can't drydock the boat while items are on deck!", me);
-    EraseObjProperty(me, "#DryDocking");
-    return;
-  endif
-  items := EnumerateItemsInContainer(boat.hold);
-  if(len(items) > 0)
-    PrintTextAbovePrivate(boat.tillerman, "Arrh, we'd best clear out the items in the hold first, Captain!", me);
-    EraseObjProperty(me, "#DryDocking");
-    return;
-  endif
-  if(len(mobsondeck) > 0)
-    PrintTextAbovePrivate(boat.tillerman, "Arrh, Captain!  You can't drydock the boat while people are on the deck!", me);
-    EraseObjProperty(me, "#DryDocking");
-    return;
-  endif  
-  if(CanDockMe(boat, me))
-    if(!YesNo(me,"Drydock the ship?"))
-      EraseObjProperty(me, "#DryDocking");
-      return;
-    endif
-    var shiptype;
-    case(boat.objtype)
-      0x6040: shiptype := 0x6027;
-      0x6041: shiptype := 0x6028;
-      0x6042: shiptype := 0x6029;
-      0x6043: shiptype := 0x602a;
-      0x6044: shiptype := 0x602b;
-      0x6045: shiptype := 0x602c;
-    endcase
-    if(!shiptype)
-      SendSysMessage(me, "Your boat seems to be malfunctioning. Please page a GM.");
-      return;
-    endif
-    var newboat := CreateItemInContainer(me.backpack, shiptype, 1);
-    var key := FindKey(me, boat.tillerman);
-    if(!newboat)
-      SendSysMessage(me,"Could not create boat deed in your backpack!");
-      EraseObjProperty(me, "#DryDocking");
-      return;
-    endif
-    if(ReserveItem(newboat))
-      newboat.graphic := 0x14f3;
-      if(!boat.tillerman.name)
-        newboat.name := "a toy boat";
-      else
-        newboat.name := boat.tillerman.name;
-      endif
-      if(!DestroyBoat(boat))
-        DestroyItem(newboat);
-        EraseObjProperty(me, "#DryDocking");
-        return;
-      endif
-    else
-      DestroyItem(newboat);
-      EraseObjProperty(me, "#DryDocking");
-      return;
-    endif
-    if(key)
-      DestroyItem(key);
-    endif
-  endif
-  EraseObjProperty(me, "#DryDocking");
-endfunction
-
-function DestroyBoat(who)
-  var res := DestroyMulti(boat);
-  if(!res)
-    return 0;
-  endif
-  return 1;
-endfunction
-
-function SmackEveryone()
-  foreach mob in(boat.mobiles)
-    ApplyDamage(mob,RandomInt(10));
-    PerformAction(mob,0x14);
-    PlaySoundEffect(mob,0x110);
-  endforeach
-endfunction
-
-function PlayBoatSounds()
-  var who := RandomInt(len(boat.mobiles)+1);
-  var mobs :=(boat.mobiles);
-  if(RandomInt(2) == 1)
-    PlaySoundEffect(mobs[who],0x13);
-  else
-    PlaySoundEffect(mobs[who],0x14);
-  endif
-endfunction
-
-function WorldWrap()
-  var newx := boat.x;
-  var newy := boat.y;
-  if(boat.y <= 6)
-    newy := 4088;
-  elseif(boat.y >= 4089)
-    newy := 6;
-  endif
-  if(boat.x <= 6)
-    newx := 5096;
-  elseif(boat.x >= 5097)
-    newx := 6;
-  endif
-  var lockid := GetObjProperty(boat.hold, "lockid");
-  var owner := GetObjProperty(boat.hold, "owner");
-  var shiptype := boat.objtype;
-  var shipfacing, created;
-  case(tillerman.graphic)
-    0x3e4e: shipfacing := CRMULTI_FACING_NORTH;
-    0x3e55: shipfacing := CRMULTI_FACING_EAST;
-    0x3e4b: shipfacing := CRMULTI_FACING_SOUTH;
-    0x3e50: shipfacing := CRMULTI_FACING_WEST;
-    default: shipfacing := "Error!";
-  endcase
-  if(shipfacing == "Error!")
-    syslog( "[ERROR] [boat.src] Couldn't tell which way the ship was facing for the worldwrap!");
-  endif    
-  created := CreateMultiAtLocation( newx, newy, -5, shiptype, shipfacing, boat.realm);
-  if(!created)
-    syslog( "[ERROR] [boat.src] New ship couldn't be created for worldwrap!");
-    return;
-  endif
-  var oldshiphold := boat.hold;
-  var newshiphold := created.hold;
-  foreach item in EnumerateItemsInContainer( oldshiphold )
-    if(item.container == oldshiphold)
-      MoveItemToContainer(item, newshiphold);
-    endif
-  endforeach
-  foreach item in EnumerateItemsInContainer( oldshiphold )
-    MoveItemToContainer(item, newshiphold);
-  endforeach
-  foreach mob in(boat.mobiles)
-    MoveCharacterToLocation(mob,(mob.x-boat.x)+created.x,(mob.y-boat.y)+created.y, -2,  MOVECHAR_FORCELOCATION );
-  endforeach
-  if(boat.has_offline_mobiles)
-    foreach mob in(boat.offline_mobiles)
-      MoveCharacterToLocation(mob,(mob.x-boat.x)+created.x,(mob.y-boat.y)+created.y, -2,  MOVECHAR_FORCELOCATION );
-    endforeach
-  endif
-  foreach mob in(boat.items)
-    MoveitemToLocation(mob,(mob.x-boat.x)+created.x,(mob.y-boat.y)+created.y, -2,0  );
-  endforeach
-  var newtillerman := created.tillerman;
-  newtillerman.name := tillerman.name;
-  SetObjProperty( created.starboardplank, "lockid", lockid);
-  SetObjProperty( created.portplank, "lockid", lockid);
-  SetObjProperty( created.ship.starboardplank, "owner", owner );
-  SetObjProperty( created.ship.portplank, "owner", owner );
-  SetObjProperty( created.ship.starboardplank, "tillermanid", newtillerman.serial );
-  SetObjProperty( created.ship.portplank, "tillermanid", newtillerman.serial );
-  SetObjProperty( created.hold, "lockid", lockid);
-  SetObjProperty( created.hold, "owner", owner);
-  SetObjProperty( created.tillerman, "owner", owner);
-  SetObjProperty( created.tillerman, "shipserial", created.serial);
-  SetObjProperty( created.tillerman, "lockid", lockid);
-  SetObjProperty( created.tillerman, "decay", decay);
-  if(boat.starboardplank.locked == 1)
-    created.starboardplank.locked := 1;
-  endif
-  if(boat.portplank.locked == 1)  
-    created.portplank.locked := 1;
-  endif
-  if(boat.hold.locked == 1)
-    created.hold.locked := 1;
-  endif
-  SetObjProperty( created.hold, "#relativedir", relative_direction);
-  SetObjProperty( created.hold, "#speed", ms_delay_between_moves);
-  created.tillerman.usescript := ":boat:tillerman";
-  if(!DestroyMulti(boat))
-    DestroyItem(boat.tillerman);
-    syslog( "[ERROR] [boat.src] Old ship at " +(boat.x-1) +","+ boat.y +","+ boat.z + " couldn't be destroyed during worldwrap!");
-  endif
-endfunction
-
-function CanDockMe(boat, who)
-  if(GetObjProperty(boat.hold,"owner") == who.serial)
-    return 1;
-  else
-    var packkey;
-    var lokid := GetObjProperty(boat.tillerman, "lockid");
-    foreach thing in EnumerateItemsInContainer(who.backpack)
-      if(GetObjProperty(thing, "lockid") == lokid)
-        packkey := 1;
-        break;
-      endif
-    endforeach
-    if(packkey == 1)
-      return 1;
-    else
-      return 0;
-    endif
-  endif
-endfunction
-
-/*NEW MAP COURSE FUNCTIONS*/
-//follows the current course
-function BoatFollowCourse(boat)
-	var startx, starty, destx, desty;
-	var course, nextwaypoint;
-	var newpoint, newfacing, prevfacing;
-	
-	course := GetObjProperty(boat.tillerman,"course");
-	nextwaypoint := GetObjProperty(boat.tillerman,"nextwaypoint");
-	startx := boat.x;
-	starty := boat.y;
-	prevfacing := boat.facing;
-	
-	if( (course==error) || (nextwaypoint==error))
-		return;
-	endif
-	
-	destx := course[nextwaypoint].x;
-	desty := course[nextwaypoint].y;
-	
-	newpoint := lineBresenham(startx,starty,destx,desty);
-	newfacing := GetNewFacing(startx,starty,newpoint[1],newpoint[2]);
-
-	if(newfacing == error) //reached waypoint/end
-		nextwaypoint := nextwaypoint + 1;
-		first_move_toward_waypoint := 1; //so we turn toward next waypoint (includes next course follow if we're done with this one)
-		if(nextwaypoint > course.size()) //done
-			state := STATE_DRIFTING;
-			PrintTextAbove(boat.tillerman,"Arr, we've reached our destination.");
-			return;
-		else
-			SetObjProperty(boat.tillerman,"nextwaypoint",nextwaypoint);
-		endif
-		
-	else
-
-		if(first_move_toward_waypoint == 1)
-			if( prevfacing != newfacing )
-				TurnBoat(boat,Cint(DetermineTurnCode(boat,newfacing)) );
-			endif
-			first_move_toward_waypoint := 0;
-		endif
-		MoveBoat(boat,newfacing);
-		
-		if((startx == boat.x) &&(starty == boat.y)) //we didn't move. must be blocked
-    		state := STATE_DRIFTING;
-    		PrintTextAbove(tillerman, "Aaargh!  We've stopped!");
-  		endif
-  	endif
-	
-endfunction
-
-//convert facing 0-7 to turn code 0-3
-function DetermineTurnCode( boat, desired )
-
-    var current := CInt(boat.facing / 2);
-    desired := CInt(desired / 2);
-
-	
-    if ( desired < current ) 
-    	desired := desired + 4; 
-    endif
-    return (desired - current);
-endfunction
-	
-//returns the direction (x1,y1) lies from (x0,y0) in the range 0-7.
-// returns error if the 2 points are equal.
-function GetNewFacing(x0,y0,x1,y1)
-	var dx, dy;
-	var facing;
-	dx := x1 - x0;
-	dy := y1 - y0;
-	
-	case(dx)
-		NEGONE: 
-			case(dy)
-				 NEGONE: facing := 7;
-				 ZERO: facing := 6;
-				 POSONE: facing := 5;
-				 default: facing := error;
-			endcase
-		 ZERO:
-		 	case(dy)
-		 		 NEGONE: facing := 0;
-		 		 ZERO: facing := error;
-		 		 POSONE: facing := 4;
-		 		 default: facing := error;
-		    endcase
-		 POSONE:
-		 	case(dy)
-		 		 NEGONE: facing := 1;
-		 		 ZERO: facing := 2;
-		 		 POSONE: facing := 3;
-		 		 default: facing := error;
-		 	endcase
-		 default: facing := error;
-	endcase
-	
-	return facing;
-endfunction
-
-//Bresenham's line drawing algorithm. determines a line between two waypoints.
-function lineBresenham(x0, y0, x1, y1)
-    var dy;
-    dy := y1 - y0;
-    var dx;
-    dx := x1 - x0;
-    var stepx, stepy;
-
-    if (dy < 0)
-      	dy := -dy;  
-       	stepy := -1;
-    else
-      	stepy := 1;
-    endif
-        
-    if (dx < 0) 
-       	dx := -dx;
-       	stepx := -1;
-    else 
-      	stepx := 1;
-    endif
-        
-    dy := 2*dy;   
-    dx := 2*dx;    
-
-    if (dx > dy)
-        var fraction;
-        fraction := 2*dy - dx;
-        while (x0 != x1)
-        	if (fraction >= 0)
-            	y0 := y0 + stepy;
-                fraction := fraction - dx;
-           	endif
-            x0 := x0 + stepx;
-            fraction := fraction + dy;
-            return {x0, y0};
-        endwhile
-    else
-        var fraction;
-        fraction := 2*dx - dy;
-        while (y0 != y1)
-            if (fraction >= 0)
-                x0 := x0 + stepx;
-                fraction := fraction - dy;
-            endif
-            y0 := y0 + stepy;
-            fraction := fraction + dx;
-            return {x0, y0};
-        endwhile
-    endif
-endfunction
-/*END NEW MAP COURSE FUNCTIONS*/

Deleted: trunk/096/pkg/multis/boat/itemdesc.cfg
===================================================================
--- trunk/096/pkg/multis/boat/itemdesc.cfg	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/itemdesc.cfg	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,168 +0,0 @@
-Item 0x6027
-{
-    Name                smallboatdeed
-    Desc                deed to a small boat
-    Graphic             0x14F2
-    Script              shipDeed
-    ShipObjType         smallboat
-    VendorSellsFor      12500
-    VendorBuysFor       12500
-	newbie              1
-}
-Item 0x6028
-{
-    Name                smalldragonboatdeed
-    Desc                deed to a small dragon boat
-    Graphic             0x14F2
-    Script              shipDeed
-    ShipObjType         smalldragonboat
-    VendorSellsFor      12500
-    VendorBuysFor       12500
-	newbie              1
-}
-
-
-Item 0x6029
-{
-    Name                mediumboatdeed
-    Desc                deed to a medium boat
-    Graphic             0x14F2
-    Script              shipDeed
-    ShipObjType         mediumboat
-    VendorSellsFor      14200
-    VendorBuysFor       14200
-	newbie              1
-}
-Item 0x602A
-{
-    Name                mediumdragonboatdeed
-    Desc                deed to a medium dragon boat
-    Graphic             0x14F2
-    Script              shipDeed
-    ShipObjType         mediumdragonboat
-    VendorSellsFor      14200
-    VendorBuysFor       14200
-	newbie              1
-}
-
-
-Item 0x602B
-{
-    Name                largeboatdeed
-    Desc                deed to a large boat
-    Graphic             0x14F2
-    Script              shipDeed
-    ShipObjType         largeboat
-    VendorSellsFor      15900
-    VendorBuysFor       15900
-	newbie              1
-}
-
-Item 0x602C
-{
-    Name                largedragonboatdeed
-	Desc                deed to a large dragon boat
-    Graphic             0x14F2
-    Script              shipDeed
-    ShipObjType         largedragonboat
-    VendorSellsFor      15900
-    VendorBuysFor       15900
-	newbie              1
-}
-
-Boat 0x6040
-{
-    Name                smallboat
-    Graphic             0x4000
-    MultiID             0x0000
-    OldObjtype          0x4000
-    OldObjtype          0x4001
-    OldObjtype          0x4002
-    OldObjtype          0x4003
-}
-
-Boat 0x6041
-{
-    Name                smalldragonboat
-    Graphic             0x4004
-    MultiID             0x0004
-    OldObjtype          0x4004
-    OldObjtype          0x4005
-    OldObjtype          0x4006
-    OldObjtype          0x4007
-}
-
-Boat 0x6042
-{
-    Name                mediumboat
-    Graphic             0x4008
-    MultiID             0x0008
-    OldObjtype          0x4008
-    OldObjtype          0x4009
-    OldObjtype          0x400A
-    OldObjtype          0x400B
-}
-
-Boat 0x6043
-{
-    Name                mediumdragonboat
-    Graphic             0x400C
-    MultiID             0x000C
-    OldObjtype          0x400C
-    OldObjtype          0x400D
-    OldObjtype          0x400E
-    OldObjtype          0x400F
-}
-
-Boat 0x6044
-{
-    Name                largeboat
-    Graphic             0x4010
-    MultiID             0x0010
-    OldObjtype          0x4010
-    OldObjtype          0x4011
-    OldObjtype          0x4012
-    OldObjtype          0x4013
-}
-
-Boat 0x6045
-{
-    Name                largedragonboat
-    Graphic             0x4014
-    MultiID             0x0014
-    OldObjtype          0x4014
-    OldObjtype          0x4015
-    OldObjtype          0x4016
-    OldObjtype          0x4017
-}
-
-Item 0xF010
-{
-    Name                Tillerman
-    graphic             1
-	script              tillerman
-}
-
-Item 0xF011
-{
-    Name                gangplank
-    Graphic             1
-    Lockable            1
-    RequiresAttention   0
-    DoubleclickRange    20
-    Script              plank
-    WalkOnScript        plankWalk
-    ControlScript       plankControl
-}
-
-Item 0xF012
-{
-    Name                gangplank2
-    Graphic             1
-    Lockable            1
-    RequiresAttention   0
-    DoubleclickRange    20
-    Script              plank
-    WalkOnScript        plankWalk
-    ControlScript       plankControl
-}

Deleted: trunk/096/pkg/multis/boat/pkg.cfg
===================================================================
--- trunk/096/pkg/multis/boat/pkg.cfg	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/pkg.cfg	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,9 +0,0 @@
-# $Id: pkg.cfg 684 2005-10-27 18:48:28Z muaddiblsd $
-#
-#
-Enabled		1
-Name		boat
-Maintainer	Distro Team
-Email		distro at polserver.com
-Version		1.0
-

Deleted: trunk/096/pkg/multis/boat/plank.src
===================================================================
--- trunk/096/pkg/multis/boat/plank.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/plank.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,92 +0,0 @@
-use os;
-use uo;
-
-include "util/key";
-include ":itemutils:objtype";
-include "plankUtil";
-
-program useplank(mob, plank)
-  set_critical(1);
-
-// Refresh the boat if he's the owner.
-var owner := GetObjProperty(plank, "owner");
-if (mob.serial == owner)
-  var tillermanid := GetObjProperty(plank, "tillermanid");
-  var tillerman := SystemFindObjectBySerial( tillermanid );
-  if (tillerman)
-    var decay := GetObjProperty(tillerman, "decay");
-    // Only give him the refresh message if the ship was less than 'in excellent shape'
-    // so he doesn't get the message every time he gets on and off the ship.
-    if ( (decay - ReadGameClock() ) < 860000 )
-          SendSysMessage(mob, "Your ship has been refreshed.");
-    endif
-    SetObjProperty( tillerman, 	  "decay",      (ReadGameClock()+ 864000));
-  endif
-endif
-  if(mob.multi.serial == plank.multi.serial)
-	TimedOpenClose(plank);
-  elseif((FK(mob, plank) == 1) ||(!plank.locked))
-	if(!IsExtended(plank))
-	  TimedOpenClose(plank);
-	else
-	  YankOntoBoat(mob,plank);
-	endif
-  else
-	PrintTextAbovePrivate(plank, "That is locked.", mob);
-  endif
-endprogram
-
-function TimedOpenClose(plank)
-  if(IsExtended(plank))
-    if(!IsPlankOccupied(plank))
-      Retract(plank);
-      EraseObjProperty(plank, "#WhenOpened");
-    endif
-  else
-    var whenopened := ReadGameClock();
-    SetObjProperty(plank, "#WhenOpened", whenopened);
-    Extend(plank);
-    repeat
-    sleep(6);
-    until(!(plank && IsPlankOccupied(plank)));
-    if(GetObjProperty(plank, "#WhenOpened") == whenopened)
-      Retract(plank);
-      EraseObjProperty(plank, "#WhenOpened");
-    endif
-  endif
-endfunction
-
-function YankOntoBoat(mob, plank)
-  var sh := GetStandingHeight(plank.x, plank.y, plank.z, plank.realm);
-  if(sh)
-    var nx :=(plank.x + plank.multi.x) / 2;
-    var ny :=(plank.y + plank.multi.y) / 2;
-    MoveCharacterToLocation(mob, nx, ny, plank.z);
-    return;
-  endif
-endfunction
-
-function CanWalkOntoPlank(plank)
-  var dx;
-  var dy;
-  case(plank.graphic)
-    GID_PLANK_EXTENDED_FACING_WEST:
-    GID_PLANK_RETRACTED_FACING_WEST:    dx := -1;
-                                        dy := 0;
-    GID_PLANK_EXTENDED_FACING_EAST:
-    GID_PLANK_RETRACTED_FACING_EAST:    dx := 1;
-                                        dy := 0;
-
-    GID_PLANK_EXTENDED_FACING_NORTH:
-    GID_PLANK_RETRACTED_FACING_NORTH:   dx := 0;
-                                        dy := -1;
-    GID_PLANK_EXTENDED_FACING_SOUTH:
-    GID_PLANK_RETRACTED_FACING_SOUTH:   dx := 0;
-                                        dy := 1;
-  endcase
-  if(GetStandingHeight(plank.x + dx, plank.y + dy, plank.z, plank.realm))
-    return 1;
-  else
-     return 0;
-  endif
-endfunction

Deleted: trunk/096/pkg/multis/boat/plankControl.src
===================================================================
--- trunk/096/pkg/multis/boat/plankControl.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/plankControl.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,20 +0,0 @@
-/*
- * plankcontrol - plank control script
- *
- * sole job is to close an open locked plank on startup.
- *
- */
-
-use os;
-use uo;
-
-include ":itemutils:objtype";
-include "plankUtil";
-
-set_debug(1);
-
-program plankcontrol( plank )
-    if (plank.locked && IsExtended(plank))
-        Retract( plank );
-    endif
-endprogram

Deleted: trunk/096/pkg/multis/boat/plankUtil.inc
===================================================================
--- trunk/096/pkg/multis/boat/plankUtil.inc	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/plankUtil.inc	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,89 +0,0 @@
-include ":itemutils:objtype";
-
-const KEYSTART := 0x100e;
-const KEYEND := 0x1013;
-const KEYRING := 0x1011;
-
-function IsExtended( plank )
-  return plank.graphic in { GID_PLANK_EXTENDED_FACING_EAST, GID_PLANK_EXTENDED_FACING_WEST, GID_PLANK_EXTENDED_FACING_NORTH, GID_PLANK_EXTENDED_FACING_SOUTH };
-endfunction
-
-function IsPlankOccupied( plank )
-  return ListMobilesNearLocation( plank.x, plank.y, plank.z, 0, plank.realm ).size();
-endfunction
-
-function Extend( plank )
-  if (!IsExtended(plank))
-    TogglePlank(plank);
-  endif
-endfunction
-
-function Retract( plank )
-  if (IsExtended(plank))
-    TogglePlank(plank);
-  endif
-endfunction
-
-function TogglePlank( plank )
-  var partnertype := PlankPartner( plank.graphic );
-  if (partnertype)
-    plank.graphic := partnertype;
-  endif
-endfunction
-
-function PlankPartner( planktype )
-  case (planktype)
-    GID_PLANK_EXTENDED_FACING_EAST:  return GID_PLANK_RETRACTED_FACING_EAST;   // 0x3ed5: return 0x3eb1;
-    GID_PLANK_RETRACTED_FACING_EAST: return GID_PLANK_EXTENDED_FACING_EAST;    // 0x3eb1: return 0x3ed5;
-    GID_PLANK_EXTENDED_FACING_WEST:  return GID_PLANK_RETRACTED_FACING_WEST;   // 0x3ed4: return 0x3eb2;
-    GID_PLANK_RETRACTED_FACING_WEST: return GID_PLANK_EXTENDED_FACING_WEST;    // 0x3eb2: return 0x3ed4;
-    GID_PLANK_EXTENDED_FACING_NORTH:  return GID_PLANK_RETRACTED_FACING_NORTH; // 0x3e84: return 0x3e85;
-    GID_PLANK_RETRACTED_FACING_NORTH: return GID_PLANK_EXTENDED_FACING_NORTH;  // 0x3e85: return 0x3e84;
-    GID_PLANK_EXTENDED_FACING_SOUTH:  return GID_PLANK_RETRACTED_FACING_SOUTH; // 0x3e89: return 0x3e8a;
-    GID_PLANK_RETRACTED_FACING_SOUTH: return GID_PLANK_EXTENDED_FACING_SOUTH;  // 0x3e8a: return 0x3e89;
-    default: syslog( "Unknown plank type 0x" + Hex( planktype ) );
-             return error;
-  endcase
-endfunction
-
-function fk(me, plank)
-  var doorlockid := GetObjProperty( plank, "lockid" );
-  var keylockid;
-  var insidering;
-  var mykeys := EnumerateItemsInContainer(me.backpack);
-  foreach key in mykeys
-	if ( (key.objtype >= KEYSTART ) && (key.objtype <= KEYEND) && (key.objtype != KEYRING ) )
-	  keylockid := GetObjProperty( key, "lockid" );
-	  if ( (keylockid) && (keylockid == doorlockid) )
-		return 1;
-	  endif
-	elseif (key.objtype == KEYRING)
-	  insidering := FindMyPack(key.serial);
-	  foreach otherkey in EnumerateItemsInContainer(insidering)
-		keylockid := GetObjProperty( otherkey, "lockid" );
-		if (keylockid == doorlockid)
-		  return 1;
-		endif
-	  endforeach
-	endif
-  endforeach
-  return 0;
-endfunction
-
-function OpenTamedStorageAreas()
-  var bank := FindStorageArea( "Tamed Storage" );
-  if (!bank)
-    bank := CreateStorageArea( "Tamed Storage" );
-  endif
-  return bank;
-endfunction
-
-function FindMyPack(myserial)
-  var mybank := OpenTamedStorageAreas();
-  var bank_obj_name := "Bankbox  " + Hex(myserial);
-  var bankbox := FindRootItemInStorageArea( mybank, bank_obj_name );
-  if (!bankbox)
-    bankbox := CreateRootItemInStorageArea(mybank, bank_obj_name, UOBJ_BANKBOX  );
-  endif
-  return bankbox;
-endfunction
\ No newline at end of file

Deleted: trunk/096/pkg/multis/boat/plankWalk.src
===================================================================
--- trunk/096/pkg/multis/boat/plankWalk.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/plankWalk.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,158 +0,0 @@
-use os;
-use uo;
-
-include "include/client";
-include ":itemutils:objtype";
-include "util/key";
-include "plankUtil";
-
-/*
- * the searchoffset matrix is for an east-facing plank.
- * these will have to be rotated for the other positions
- *   P is the plank, N is where you can't step (otherwise
- *    this teleportation stuff wouldn't be necessary)
- *
- *        13 12 11
- *        14  5  4
- *        15  6  2
- *        16  7  1 N P
- *        17  8  3
- *        18  9 10
- *        19 20 21
- *
- */
-
-var searchoffset := {
-   { -2,  0 },          //  1
-   { -2, -1 },
-   { -2, +1 },
-   { -2, -2 },
-   { -3, -2 },          //  5
-   { -3, -1 },
-   { -3,  0 },
-   { -3, +1 },
-   { -3, +2 },
-   { -2, +2 },          // 10
-   { -2, -3 },
-   { -3, -3 },
-   { -4, -3 },
-   { -4, -2 },
-   { -4, -1 },          // 15
-   { -4,  0 },
-   { -4, +1 },
-   { -4, +2 },
-   { -4, +3 },
-   { -3, +3 },          // 20
-   { -2, +3 },
-   { -5,  0 },
-   { -5, +2 },
-   { -5, +3 },
-   { -5, +4 },
-   { -4, +4 },          // 20
-   { -3, +4 },
-   { -6,  0 },
-   { -6, +3 },
-   { -6, +4 },
-   { -6, +5 },
-   { -5, +5 },          // 20
-   { -4, +5 }
-};
-
-program plankwalk( who, plank, lastx, lasty, lastz )
-    if (!FindKey( who, plank ))
-        if (plank.locked)
-            var sh := GetStandingHeight( lastx, lasty, lastz, who.realm );
-            if (!sh || !sh.multi || sh.multi.serial != plank.multi.serial)
-                MoveCharacterToLocation( who, lastx, lasty, lastz, MOVECHAR_FORCELOCATION );
-                return;
-            endif
-        endif
-    endif
-
-    if (ListMobilesNearLocation( plank.x, plank.y, plank.z, 0, plank.realm ).size() > 1)
-        MoveCharacterToLocation( who, lastx, lasty, lastz, MOVECHAR_FORCELOCATION );
-        return;
-    endif
-
-    var xidx, yidx, xmul, ymul;
-
-    case (plank.graphic)
-        GID_PLANK_EXTENDED_FACING_WEST:
-            if (! (who.facing in { DIR_W, DIR_NW, DIR_SW }))
-                return;
-            endif
-            xidx := 1;
-            yidx := 2;
-            xmul := 1;
-            ymul := 1;
-
-        GID_PLANK_EXTENDED_FACING_EAST:
-            if (! (who.facing in { DIR_E, DIR_NE, DIR_SE }))
-                return;
-            endif
-            xidx := 1;
-            yidx := 2;
-            xmul := -1; // flip across x-axis
-            ymul := 1;
-
-        GID_PLANK_EXTENDED_FACING_NORTH:
-            if (! (who.facing in { DIR_N, DIR_NE, DIR_NW }))
-                return;
-            endif
-            xidx := 2;
-            yidx := 1;
-            xmul := 1;
-            ymul := +1;
-
-        GID_PLANK_EXTENDED_FACING_SOUTH:
-            if (! (who.facing in { DIR_S, DIR_SE, DIR_SW }))
-                return;
-            endif
-            xidx := 2;
-            yidx := 1;
-            xmul := 1;
-            ymul := -1; // flip across y-axis
-
-        default:
-            return;
-    endcase
-    if (CanMove( who,
-                 searchoffset[1][xidx] * xmul / 2,
-                 searchoffset[1][yidx] * ymul / 2 ))
-        return;                     // doesn't need our help!
-    endif
-
-
-    foreach offset in searchoffset
-        if (TryMove( who, offset[xidx] * xmul, offset[yidx] * ymul ))
-            return;
-        endif
-    endforeach
-endprogram
-
-function TryMove( who, dx, dy )
-    var res := 0;
-    set_critical( 1 );
-
-    var tryx := who.x + dx;
-    var tryy := who.y + dy;
-    var h := GetStandingHeight( tryx, tryy, who.z, who.realm );
-    if (h && (not h.multi)) // CHECKME should check line of sight?
-        MoveCharacterToLocation( who, tryx, tryy, h.z );
-        res := 1;
-    endif
-
-    set_critical(0);
-    return res;
-endfunction
-
-function CanMove( who, dx, dy )
-    var tryx := who.x + dx;
-    var tryy := who.y + dy;
-    var h := GetStandingHeight( tryx, tryy, who.z, who.realm );
-    if (h)
-        return 1;
-    else
-        return 0;
-    endif
-endfunction
\ No newline at end of file

Deleted: trunk/096/pkg/multis/boat/shipDeed.src
===================================================================
--- trunk/096/pkg/multis/boat/shipDeed.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/shipDeed.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,128 +0,0 @@
-// $Id: shipDeed.src 905 2005-11-05 08:20:50Z muaddiblsd $
-
-use cfgfile;
-use uo;
-use os;
-
-include "util/key";
-include ":itemutils:objtype";
-include ":itemutils:canAccess";
-
-program useshipdeed(who, deed)
-  if(DeedAlreadyBuiltFrom(deed))
-    PrintTextAbovePrivate(deed, "That ship has already been built.", who);
-  elseif(can_access(who, deed))
-    BuildShip(who, deed);
-  endif
-endprogram
-
-function BuildShip(who, deed)
-  var shiptype := GetShipObjtype(deed.objtype);
-  if(!shiptype)
-    PrintTextAbovePrivate(deed, "That ship deed appears to be broken.", who);
-    return;
-  endif
-  var flags := ShipFacingFlags(who.facing);
-  var where := TargetMultiPlacement(who, shiptype, flags);
-  if(!where)
-    if(deed.graphic == 5363)
-      deed.graphic := 5364;
-    elseif(deed.graphic == 5364)
-      deed.graphic := 5363;
-    endif
-    return;
-  elseif((where.x == deed.x) && (where.y == deed.y))
-    if(deed.graphic == 5363)
-      deed.graphic := 5364;
-    elseif(deed.graphic == 5364)
-      deed.graphic := 5363;
-    endif
-    return;
-  endif
-  set_critical(1);
-  if((where.x < who.x - 10) || (where.y < who.y - 10) || (where.x > who.x + 10) || (where.y > who.y + 10))
-    SendSysMessage(who, "You cannot place a boat that far away.");
-    return;
-  endif
-  var created := CreateShipKeysAndBuiltDeed(who, shiptype, where.x, where.y, where.z, flags);
-  if(created)
-    var ship := created.ship;
-    var deedtype := deed.objtype;
-    if((deed.name != "a toy boat") && (!deed.name["deed"]))
-      ship.tillerman.name := deed.name;
-    endif
-    if(DestroyItem(deed))
-      ship.starboardplank.locked    := 1;
-      ship.portplank.locked         := 1;
-      ship.hold.locked              := 1;
-      var lockid := AllocLockId();
-      SetObjProperty(ship.starboardplank, "lockid",      lockid);
-      SetObjProperty(ship.starboardplank, "owner",       who.serial);
-      SetObjProperty(ship.starboardplank, "tillermanid", ship.tillerman.serial);
-      SetObjProperty(ship.portplank,      "lockid",      lockid);
-      SetObjProperty(ship.portplank,      "owner",       who.serial);
-      SetObjProperty(ship.portplank,      "tillermanid", ship.tillerman.serial);
-      SetObjProperty(ship.hold,           "lockid",      lockid);
-      SetObjProperty(ship.tillerman,      "owner",       who.serial);
-      SetObjProperty(ship.tillerman,      "shipserial",  ship.serial);
-      SetObjProperty(ship.tillerman,      "lockid",      lockid);
-      SetObjProperty(ship.tillerman,      "shiptype",    deedtype);
-      SetObjProperty(created.packkey,     "lockid",      lockid);
-      SetObjProperty(created.packkey,     "shipserial",  ship.serial);
-      SetObjProperty(ship.tillerman,      "decay",       (ReadGameClock()+ 864000));
-      ship.tillerman.usescript := ":boat:tillerman";
-    else
-      DestroyItem(created.packkey);
-      DestroyMulti(ship);
-      SendSysMessage(who, "There was an error creating the boat.");
-    endif
-  endif
-endfunction
-
-function ShipFacingFlags(facing)
-  var flags := 0;
-  case (facing)
-    DIR_N:  flags := CRMULTI_FACING_NORTH;
-    DIR_NE: flags := CRMULTI_FACING_NORTH;
-    DIR_E:  flags := CRMULTI_FACING_EAST;
-    DIR_SE: flags := CRMULTI_FACING_SOUTH;
-    DIR_S:  flags := CRMULTI_FACING_SOUTH;
-    DIR_SW: flags := CRMULTI_FACING_SOUTH;
-    DIR_W:  flags := CRMULTI_FACING_WEST;
-    DIR_NW: flags := CRMULTI_FACING_NORTH;
-  endcase
-  return flags;
-endfunction
-
-function CreateShipKeysAndBuiltDeed(who, shiptype, x, y, z, flags)
-  var packkey := CreateItemInBackpack(who, UOBJ_COPPER_KEY);
-  if(!packkey)
-    PrintTextAbovePrivate(who, "My backpack is too full!", who);
-    return 0;
-  endif
-  var ship := CreateMultiAtLocation(x, y, z, shiptype, flags, who.realm);
-  if(!ship)
-    PrintTextAbovePrivate(who, "I can't place the ship there.", who);
-    DestroyItem(packkey);
-    return 0;
-  else
-    var result := struct;
-    result.+packkey := packkey;
-    result.+ship    := ship;
-    return result;
-  endif
-endfunction
-
-function DeedAlreadyBuiltFrom(deed)
-  if(GetObjProperty(deed, "builtserial"))
-    return 1;
-  else
-    return 0;
-  endif
-endfunction
-
-function GetShipObjtype(objtype)
-    var cfg := ReadConfigFile(":boat:itemdesc");
-    var ot := GetObjtypeByName(cfg[objtype].ShipObjType);
-    return Cint(ot);
-endfunction
\ No newline at end of file

Deleted: trunk/096/pkg/multis/boat/tillerman.src
===================================================================
--- trunk/096/pkg/multis/boat/tillerman.src	2005-12-29 09:18:56 UTC (rev 1085)
+++ trunk/096/pkg/multis/boat/tillerman.src	2006-01-05 11:23:07 UTC (rev 1086)
@@ -1,22 +0,0 @@
-use os;
-use uo;
-
-include "util/key";
-include ":itemutils:objtype";
-include "plankUtil";
-
-program renameboat(you, tillerman)
-  if((GetObjProperty(tillerman,"owner") != you.serial) &&(you.cmdlevel < 2))
-	PrintTextAbove(tillerman,"Stop that, or I'll throw ye overboard!");
-	return;
-  endif
-    var boatname := RequestInput(you, tillerman, "Enter a new name for this boat.(max 40 characters)");
-  if(boatname)
-	if(len(boatname) <= 40)
-	  tillerman.name := boatname;
-	  SendSysMessage(you, "Boat is renamed.");
-	else
-	  SendSysMessage(you, "Too many characters in name.");
-	endif
-  endif
-endprogram
\ No newline at end of file



From austin at berlios.de  Thu Jan  5 12:37:31 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 12:37:31 +0100
Subject: [Poldistro-svn] r1087 - in trunk/096/pkg/multis/boat: . config deed multi plank tiller
Message-ID: <200601051137.k05BbVpA006372@sheep.berlios.de>

Author: austin
Date: 2006-01-05 12:37:28 +0100 (Thu, 05 Jan 2006)
New Revision: 1087

Added:
   trunk/096/pkg/multis/boat/commands/
   trunk/096/pkg/multis/boat/config/
   trunk/096/pkg/multis/boat/config/icp.cfg
   trunk/096/pkg/multis/boat/deed/
   trunk/096/pkg/multis/boat/deed/use.src
   trunk/096/pkg/multis/boat/include/
   trunk/096/pkg/multis/boat/itemdesc.cfg
   trunk/096/pkg/multis/boat/multi/
   trunk/096/pkg/multis/boat/multi/listener.src
   trunk/096/pkg/multis/boat/pkg.cfg
   trunk/096/pkg/multis/boat/plank/
   trunk/096/pkg/multis/boat/plank/methods.src
   trunk/096/pkg/multis/boat/plank/use.src
   trunk/096/pkg/multis/boat/plank/walkOn.src
   trunk/096/pkg/multis/boat/tiller/
   trunk/096/pkg/multis/boat/tiller/methods.src
   trunk/096/pkg/multis/boat/tiller/use.src
Log:
Setting up the boat package (since it didnt compile before)

Added: trunk/096/pkg/multis/boat/config/icp.cfg
===================================================================
--- trunk/096/pkg/multis/boat/config/icp.cfg	2006-01-05 11:23:07 UTC (rev 1086)
+++ trunk/096/pkg/multis/boat/config/icp.cfg	2006-01-05 11:37:28 UTC (rev 1087)
@@ -0,0 +1,13 @@
+ICP Register
+{
+	Name		Boat
+	Version		1.0
+
+	Description	Boat stuff of course!
+
+	Creator		Austin
+	C_Email		AustinHeilman at gmail.com
+
+	Maintainer	Distro Team
+	M_Email		distro at polserver.com
+}
\ No newline at end of file

Added: trunk/096/pkg/multis/boat/deed/use.src
===================================================================

Added: trunk/096/pkg/multis/boat/itemdesc.cfg
===================================================================
--- trunk/096/pkg/multis/boat/itemdesc.cfg	2006-01-05 11:23:07 UTC (rev 1086)
+++ trunk/096/pkg/multis/boat/itemdesc.cfg	2006-01-05 11:37:28 UTC (rev 1087)
@@ -0,0 +1,161 @@
+# $Id$
+#
+#
+
+//
+// Important boat pieces
+//
+Item 0xF010
+{
+	Name			Tillerman
+	Graphic			1
+
+	Script			tiller/use
+	MethodScript		tiller/methods
+}
+Item 0xF011
+{
+	Name			gangplank
+	Graphic			1
+	Lockable		1
+	RequiresAttention	0
+	DoubleClickRange	20
+
+	Script			plank/use
+	MethodScript		plank/methods
+	WalkOnScript		plank/walkOn
+}
+Item 0xF012
+{
+	Name			gangplank2
+	Graphic			1
+	Lockable		1
+	RequiresAttention 	0
+	DoubleClickRange	20
+
+	Script			plank/use
+	MethodScript		plank/methods
+	WalkOnScript		plank/walkOn
+}
+// Hold can be found in the containers package.
+
+//
+// Boat deeds
+//
+Item 0x6027
+{
+	Name			smallboatdeed
+	Desc			deed to a small boat
+	Graphic			0x14F2
+	Script			deed/use
+	ShipObjType		smallboat
+	VendorSellsFor		12500
+	VendorBuysFor		12500
+	Newbie			1
+}
+Item 0x6028
+{
+	Name			smalldragonboatdeed
+	Desc			deed to a small dragon boat
+	Graphic			0x14F2
+	Script			deed/use
+	ShipObjType		smalldragonboat
+	VendorSellsFor		12500
+	VendorBuysFor		12500
+	Newbie			1
+}
+
+
+Item 0x6029
+{
+	Name			mediumboatdeed
+	Desc			deed to a medium boat
+	Graphic			0x14F2
+	Script			deed/use
+	ShipObjType		mediumboat
+	VendorSellsFor		14200
+	VendorBuysFor		14200
+	Newbie			1
+}
+Item 0x602A
+{
+	Name			mediumdragonboatdeed
+	Desc			deed to a medium dragon boat
+	Graphic			0x14F2
+	Script			deed/use
+	ShipObjType		mediumdragonboat
+	VendorSellsFor		14200
+	VendorBuysFor		14200
+	Newbie			1
+}
+
+
+Item 0x602B
+{
+	Name			largeboatdeed
+	Desc			deed to a large boat
+	Graphic			0x14F2
+	Script			deed/use
+	ShipObjType		largeboat
+	VendorSellsFor		15900
+	VendorBuysFor		15900
+	Newbie			1
+}
+
+Item 0x602C
+{
+	Name			largedragonboatdeed
+	Desc			deed to a large dragon boat
+	Graphic			0x14F2
+	Script			deed/use
+	ShipObjType		largedragonboat
+	VendorSellsFor		15900
+	VendorBuysFor		15900
+	Newbie			1
+}
+
+//
+// Boats (Multis) 
+//
+
+Boat 0x6040
+{
+	Name			smallboat
+	Graphic			0x4000
+	MultiID			0x0000
+}
+
+Boat 0x6041
+{
+	Name			smalldragonboat
+	Graphic			0x4004
+	MultiID			0x0004
+}
+
+Boat 0x6042
+{
+	Name			mediumboat
+	Graphic			0x4008
+	MultiID			0x0008
+}
+
+Boat 0x6043
+{
+	Name			mediumdragonboat
+	Graphic			0x400C
+	MultiID			0x000C
+}
+
+Boat 0x6044
+{
+	Name			largeboat
+	Graphic			0x4010
+	MultiID			0x0010
+}
+
+Boat 0x6045
+{
+	Name			largedragonboat
+	Graphic			0x4014
+	MultiID			0x0014
+}

Added: trunk/096/pkg/multis/boat/multi/listener.src
===================================================================

Added: trunk/096/pkg/multis/boat/pkg.cfg
===================================================================
--- trunk/096/pkg/multis/boat/pkg.cfg	2006-01-05 11:23:07 UTC (rev 1086)
+++ trunk/096/pkg/multis/boat/pkg.cfg	2006-01-05 11:37:28 UTC (rev 1087)
@@ -0,0 +1,17 @@
+# $Id$
+#
+#
+Enabled		1
+Name		boat
+
+Version		1.0
+
+CoreRequired	96
+
+Creator		Austin Heilman
+Email		AustinHeilman at gmail.com
+Maintainer	Distro Team
+Email		distro at polserver.com
+
+#Requires	none
+#Conflicts	none

Added: trunk/096/pkg/multis/boat/plank/methods.src
===================================================================

Added: trunk/096/pkg/multis/boat/plank/use.src
===================================================================

Added: trunk/096/pkg/multis/boat/plank/walkOn.src
===================================================================

Added: trunk/096/pkg/multis/boat/tiller/methods.src
===================================================================

Added: trunk/096/pkg/multis/boat/tiller/use.src
===================================================================



From austin at berlios.de  Thu Jan  5 12:42:32 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 12:42:32 +0100
Subject: [Poldistro-svn] r1088 - trunk/096/pkg/multis/boat/config
Message-ID: <200601051142.k05BgWT0012177@sheep.berlios.de>

Author: austin
Date: 2006-01-05 12:42:29 +0100 (Thu, 05 Jan 2006)
New Revision: 1088

Added:
   trunk/096/pkg/multis/boat/config/commands.cfg
   trunk/096/pkg/multis/boat/config/panks.cfg
Log:


Added: trunk/096/pkg/multis/boat/config/commands.cfg
===================================================================
--- trunk/096/pkg/multis/boat/config/commands.cfg	2006-01-05 11:37:28 UTC (rev 1087)
+++ trunk/096/pkg/multis/boat/config/commands.cfg	2006-01-05 11:42:29 UTC (rev 1088)
@@ -0,0 +1,120 @@
+# $Id$
+#
+#
+
+######
+#
+# Turn = TurnBoat(boat, #)
+# Move = MoveBoatRelative(boat, direction)
+#
+# Anchor - 1 = Up 2 = Down
+# If the anchor is down, the tillerman will not obey any commands until it is raised.
+#
+# Stop - 1 = Stops the boat from the last command.
+#
+# Speed - x.x Multiplied by boats 'normal' speed. ( default_speed * speed )
+# Full ahead could be .5, slow could be 2.0 
+# The lower the number, the faster the boat will go.
+#
+###### 
+
+command heirarchy
+{
+	CMD	stop
+	CMD	forward right
+	CMD	forward left
+	CMD	forward
+	CMD	back right
+	CMD	back left
+	CMD	back
+	CMD	turn right
+	CMD	turn left
+	CMD	left
+	CMD	right
+	CMD	come about
+	
+	// Speed commands go here, not sure how they look though.
+	
+	CMD	raise the anchor
+	CMD	lower the anchor
+}
+
+//-=[ Stop ]=-----------------------
+command stop
+{
+	stop		1
+}
+
+//-=[ Forward Commands ]=-----------
+command	forward
+{
+	move		1
+	direction	0
+}
+command forward right
+{
+	move		1
+	direction	1
+}
+command forward left
+{
+	move		1
+	direction	7
+}
+
+//-=[ Back Commands ]=-------------
+command back
+{
+	move		1
+	direction	4
+}
+command back right
+{
+	move		1
+	direction	3
+}
+command back left
+{
+	move		1
+	direction	5
+}
+
+//-=[ Turn Commands ]=-------------
+
+command turn right
+{
+	turn		1
+}
+command turn left
+{
+	turn		3
+}
+
+command come about
+{
+	turn		2
+}
+
+//-=[ Movement Commands]=----------
+
+command left
+{
+	move		1
+	direction	6
+}
+command right
+{
+	move		1
+	direction	2
+}
+
+//-=[ Anchor Commands]=------------
+
+command lower the anchor
+{
+	Anchor		2
+}
+command raise the anchor
+{
+	Anchor		1
+}
\ No newline at end of file

Added: trunk/096/pkg/multis/boat/config/panks.cfg
===================================================================
--- trunk/096/pkg/multis/boat/config/panks.cfg	2006-01-05 11:37:28 UTC (rev 1087)
+++ trunk/096/pkg/multis/boat/config/panks.cfg	2006-01-05 11:42:29 UTC (rev 1088)
@@ -0,0 +1,48 @@
+# $Id$
+# 
+# Used to manage planks.
+# Tells it what graphics change to what and is used to determine if a plank is extended or not.
+
+Plank 0x3ED5
+{
+	Extended	1
+	ChangeTo	0x3EB1
+}
+Plank 0x3EB1
+{
+	Extended	0
+	ChangeTo	0x3ED5
+}
+
+Plank 0x3ED4
+{
+	Extended	1
+	ChangeTo	0x3EB2
+}
+Plank 0x3EB2
+{
+	Extended	0
+	ChangeTo	0x3ED4
+}
+
+Plank 0x3E84
+{
+	Extended	1
+	ChangeTo	0x3E85
+}
+Plank 0x3E85
+{
+	Extended	0
+	ChangeTo	0x3E84
+}
+
+Plank 0x3E89
+{
+	Extended	1
+	ChangeTo	0x3E8A
+}
+Plank 0x3E8A
+{
+	Extended	0
+	ChangeTo	0x3E89
+}



From austin at berlios.de  Thu Jan  5 12:44:31 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 12:44:31 +0100
Subject: [Poldistro-svn] r1089 - trunk/096/scripts/misc
Message-ID: <200601051144.k05BiVZ4013425@sheep.berlios.de>

Author: austin
Date: 2006-01-05 12:44:29 +0100 (Thu, 05 Jan 2006)
New Revision: 1089

Modified:
   trunk/096/scripts/misc/boat.src
Log:


Modified: trunk/096/scripts/misc/boat.src
===================================================================
--- trunk/096/scripts/misc/boat.src	2006-01-05 11:42:29 UTC (rev 1088)
+++ trunk/096/scripts/misc/boat.src	2006-01-05 11:44:29 UTC (rev 1089)
@@ -12,8 +12,6 @@
 use os;
 
 
-program autostart_boat(param)
-	start_script(":boat:boat", param);
-
-	return;
+Program CoreScript_Boat(multi)
+	return start_script(":boat:multi/listener", multi);
 endprogram



From austin at berlios.de  Thu Jan  5 13:23:43 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 13:23:43 +0100
Subject: [Poldistro-svn] r1090 - in trunk/096/pkg/multis/boat: config include multi
Message-ID: <200601051223.k05CNhnp000055@sheep.berlios.de>

Author: austin
Date: 2006-01-05 13:23:42 +0100 (Thu, 05 Jan 2006)
New Revision: 1090

Added:
   trunk/096/pkg/multis/boat/config/planks.cfg
   trunk/096/pkg/multis/boat/include/cmdParser.inc
Removed:
   trunk/096/pkg/multis/boat/config/panks.cfg
Modified:
   trunk/096/pkg/multis/boat/config/commands.cfg
   trunk/096/pkg/multis/boat/multi/listener.src
Log:


Modified: trunk/096/pkg/multis/boat/config/commands.cfg
===================================================================
--- trunk/096/pkg/multis/boat/config/commands.cfg	2006-01-05 11:44:29 UTC (rev 1089)
+++ trunk/096/pkg/multis/boat/config/commands.cfg	2006-01-05 12:23:42 UTC (rev 1090)
@@ -20,15 +20,15 @@
 
 command heirarchy
 {
-	CMD	stop
+	CMD	Stop
 	CMD	forward right
 	CMD	forward left
 	CMD	forward
 	CMD	back right
 	CMD	back left
 	CMD	back
-	CMD	turn right
-	CMD	turn left
+	CMD	Turn right
+	CMD	Turn left
 	CMD	left
 	CMD	right
 	CMD	come about
@@ -42,70 +42,70 @@
 //-=[ Stop ]=-----------------------
 command stop
 {
-	stop		1
+	Stop		1
 }
 
 //-=[ Forward Commands ]=-----------
 command	forward
 {
-	move		1
-	direction	0
+	Move		1
+	Direction	0
 }
 command forward right
 {
-	move		1
-	direction	1
+	Move		1
+	Direction	1
 }
 command forward left
 {
-	move		1
-	direction	7
+	Move		1
+	Direction	7
 }
 
 //-=[ Back Commands ]=-------------
 command back
 {
-	move		1
-	direction	4
+	Move		1
+	Direction	4
 }
 command back right
 {
-	move		1
-	direction	3
+	Move		1
+	Direction	3
 }
 command back left
 {
-	move		1
-	direction	5
+	Move		1
+	Direction	5
 }
 
 //-=[ Turn Commands ]=-------------
 
 command turn right
 {
-	turn		1
+	Turn		1
 }
 command turn left
 {
-	turn		3
+	Turn		3
 }
 
 command come about
 {
-	turn		2
+	Turn		2
 }
 
 //-=[ Movement Commands]=----------
 
 command left
 {
-	move		1
-	direction	6
+	Move		1
+	Direction	6
 }
 command right
 {
-	move		1
-	direction	2
+	Move		1
+	Direction	2
 }
 
 //-=[ Anchor Commands]=------------

Deleted: trunk/096/pkg/multis/boat/config/panks.cfg
===================================================================
--- trunk/096/pkg/multis/boat/config/panks.cfg	2006-01-05 11:44:29 UTC (rev 1089)
+++ trunk/096/pkg/multis/boat/config/panks.cfg	2006-01-05 12:23:42 UTC (rev 1090)
@@ -1,48 +0,0 @@
-# $Id$
-# 
-# Used to manage planks.
-# Tells it what graphics change to what and is used to determine if a plank is extended or not.
-
-Plank 0x3ED5
-{
-	Extended	1
-	ChangeTo	0x3EB1
-}
-Plank 0x3EB1
-{
-	Extended	0
-	ChangeTo	0x3ED5
-}
-
-Plank 0x3ED4
-{
-	Extended	1
-	ChangeTo	0x3EB2
-}
-Plank 0x3EB2
-{
-	Extended	0
-	ChangeTo	0x3ED4
-}
-
-Plank 0x3E84
-{
-	Extended	1
-	ChangeTo	0x3E85
-}
-Plank 0x3E85
-{
-	Extended	0
-	ChangeTo	0x3E84
-}
-
-Plank 0x3E89
-{
-	Extended	1
-	ChangeTo	0x3E8A
-}
-Plank 0x3E8A
-{
-	Extended	0
-	ChangeTo	0x3E89
-}

Copied: trunk/096/pkg/multis/boat/config/planks.cfg (from rev 1088, trunk/096/pkg/multis/boat/config/panks.cfg)

Added: trunk/096/pkg/multis/boat/include/cmdParser.inc
===================================================================
--- trunk/096/pkg/multis/boat/include/cmdParser.inc	2006-01-05 11:44:29 UTC (rev 1089)
+++ trunk/096/pkg/multis/boat/include/cmdParser.inc	2006-01-05 12:23:42 UTC (rev 1090)
@@ -0,0 +1,58 @@
+/*
+ * $Id$
+ *
+ */
+
+use os;
+use cfgfile;
+
+/*
+ * ParseCommands(text, last_cmd)
+ * 
+ * Purpose:
+ * Takes in spoken text and finds boat commands inside of it.
+ * Returns valid commands in the order they were issued.
+ *
+ * Parameters:
+ * text:	Text to parse for commands.
+ *
+ * Return Value:
+ * Returns an array of strings.
+ *
+ */
+function ParseCommands(byref text)
+	var cmd_cfg := ReadConfigFile(":boat:config/commands");
+	var cmd_elem := GetConfigStringArray(cmd_cfg["heirarchy"], "CMD");
+	
+	text := Lower(text);
+		
+	var match := 0, pos := 0;
+	foreach cmd in ( cmd_elem )
+		pos := pos + 1;
+		cmd := Lower(cmd);
+		while ( text[cmd] )
+			text[cmd] := "[["+CStr(pos)+"]] ";
+			match := 1;
+			sleepms(2);
+		endwhile
+		sleepms(2);
+	endforeach
+	if ( match == 0 )
+		return 0;
+	endif
+
+	var cmd_list := array{};
+	text := SplitWords(text);
+	foreach cmd in ( text )
+		if ( cmd["[["] && cmd["]]"] )
+			cmd["[["] := "";
+			cmd["]]"] := "";
+			cmd := cmd_list[CInt(cmd)];
+			cmd_list.Append(cmd);
+		endif
+		sleepms(2);
+	endforeach
+	text := "";
+
+	return cmd_list;
+endfunction
\ No newline at end of file

Modified: trunk/096/pkg/multis/boat/multi/listener.src
===================================================================
--- trunk/096/pkg/multis/boat/multi/listener.src	2006-01-05 11:44:29 UTC (rev 1089)
+++ trunk/096/pkg/multis/boat/multi/listener.src	2006-01-05 12:23:42 UTC (rev 1090)
@@ -0,0 +1,128 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+use boat;
+use cfgfile;
+
+include "include/sysEvent";
+include ":boat:cmdParser";
+
+program BoatController(boat)
+	Initialize(boat);
+	
+	var repeat_cmd;
+	var last_sound;
+	
+	while ( boat )
+		var ev;
+		
+		if ( repeat_cmd != -1 && !Events_Waiting() )
+			while ( !ev )
+				if ( last_sound < polcore().systime-120 )
+					PlaySoundEffect(boat, 0x14);
+					last_sound := polcore().systime;
+				endif
+				// If there are no commands, and no incoming speech 
+				// then make the event wait really long so boats take up very
+				// little cpu time when they are not in use.
+				// This is where they enter a sleep-mode.
+				ev := Wait_For_Event(120);
+			endwhile
+		endif
+		if ( !ev )
+			ev := Wait_For_Event(0);
+		endif
+				
+		var delay := (boat.tillerman).GetSpeed();
+		sleepms(delay);		
+				
+		if ( ev.text )
+			if ( (boat.tillerman).IsOnBoat(boat, ev.source) )
+				if ( (boat.tillerman).CanCommand(ev.source) )
+					var cmd_list := ParseCommands(ev.text);
+					foreach command in ( cmd_list )
+						repeat_cmd := DoCommand(boat, command);
+						sleepms(2);
+					endforeach
+				endif
+			endif
+		elseif ( repeat_cmd != -1 )
+			var boat_x := boat.x;
+			var boat_y := boat.y;
+			ClosePlanks(boat);
+			MoveBoatRelative(boat, repeat_cmd);
+			if ( boat.x == boat_x && boat_y == boat.y )
+				repeat_cmd := -1;
+			endif
+		endif
+	endwhile
+endprogram
+
+function Initialize(boat)
+	while ( !(boat.tillerman).GetOwner() )
+		sleep(2);
+	endwhile
+	
+	SetObjProperty(boat.tillerman, "#PID", GetPid());
+	
+	//ToDo:
+	//Consider checking the size of the boat then set this accordingly.
+	RegisterForSpeechEvents(boat, 15);
+	
+	return 1;
+endfunction
+
+function DoCommand(byref boat, byref cmd)
+	var cmd_cfg := ReadConfigFile(":boat:config/commands");
+	var cmd_elem := GetConfigStringArray(cmd_cfg[cmd], "CMD");
+	
+	if ( cmd_elem.Anchor == 2 )
+		if ( !(boat.tillerman).IsAnchored() )
+			(boat.tillerman).SetAnchorStatus(1);
+			PrintTextAbove(boat.tillerman, "The anchor has been lowered.");
+		else
+			PrintTextAbove(boat.tillerman, "The anchor has already been lowered.");
+		endif
+		return -1;
+	elseif ( cmd_elem.Anchor == 1 )
+		if ( (boat.tillerman).IsAnchored() )
+			(boat.tillerman).SetAnchorStatus(0);
+			PrintTextAbove(boat.tillerman, "The anchor has been raised.");
+		else
+			PrintTextAbove(boat.tillerman, "The anchor is already raised.");
+		endif
+		return -1;
+	endif
+	
+	if ( !(boat.tillerman).IsAnchored() )
+		if ( cmd_elem.Turn )
+			ClosePlanks(boat);
+			TurnBoat(boat, cmd_elem.Turn);
+			return -1;
+		elseif ( cmd_elem.Stop )
+			return -1;
+		elseif ( cmd_elem.Move )
+			MoveBoatRelative(boat, cmd_elem.Direction);
+			return cmd_elem.Direction; // Keep following this command
+		endif
+	endif
+	
+	return -1;
+endfunction
+
+function ClosePlanks(byref boat)
+	var plank_a := boat.starboardplank;
+	var plank_b := boat.portplank;
+	
+	if ( plank_a.Extended() )
+		plank_a.Retract(0);
+	endif
+	
+	if ( plank_b.Extended() )
+		plank_b.Retract(0);
+	endif
+endfunction



From austin at berlios.de  Thu Jan  5 13:42:58 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 13:42:58 +0100
Subject: [Poldistro-svn] r1091 - trunk/096/pkg/multis/boat/plank
Message-ID: <200601051242.k05CgwLF008791@sheep.berlios.de>

Author: austin
Date: 2006-01-05 13:42:48 +0100 (Thu, 05 Jan 2006)
New Revision: 1091

Modified:
   trunk/096/pkg/multis/boat/plank/methods.src
Log:


Modified: trunk/096/pkg/multis/boat/plank/methods.src
===================================================================
--- trunk/096/pkg/multis/boat/plank/methods.src	2006-01-05 12:23:42 UTC (rev 1090)
+++ trunk/096/pkg/multis/boat/plank/methods.src	2006-01-05 12:42:48 UTC (rev 1091)
@@ -0,0 +1,59 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use cfgfile;
+
+program Install()
+	return 1;
+endprogram
+
+//Public functions
+exported function Extend(plank)
+	if ( !Extended(plank) )
+		plank.graphic := ConfigInfo(plank).ChangeTo;
+	else
+		return 0;
+	endif
+endfunction
+
+exported function Retract(plank)
+	if ( Extended(plank) )
+		if ( CInt(Occupied(plank).size()) < 1 )
+			plank.graphic := ConfigInfo(plank).ChangeTo;
+			return 1;
+		else
+			return 0;
+		endif
+	else
+		return 0;
+	endif
+endfunction
+
+exported function Toggle(plank)
+	if ( Extended(plank) )
+		Retract(plank);
+	else
+		Extend(plank);
+	endif
+endfunction
+
+exported function Extended(plank)
+	return ConfigInfo(plank).Extended;
+endfunction
+
+exported function Occupied(plank)
+	return ListMobilesNearLocationEX(plank.x, plank.y, plank.z, 0, LISTEX_FLAG_NORMAL+LISTEX_FLAG_HIDDEN+LISTEX_FLAG_GHOST);
+endfunction
+
+exported function MoveOnto(plank, mobile)
+	MoveObjectToLocation(mobile, plank.x, plank.y, plank.z+1, plank.realm, MOVECHAR_FORCELOCATION);
+endfunction
+
+//Private function
+function ConfigInfo(plank)
+	var config := ReadConfigFile(":boat:config/planks");
+	return config[plank.graphic];
+endfunction
\ No newline at end of file



From austin at berlios.de  Thu Jan  5 13:55:04 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 13:55:04 +0100
Subject: [Poldistro-svn] r1092 - trunk/096/pkg/multis/boat/plank
Message-ID: <200601051255.k05Ct4SU016030@sheep.berlios.de>

Author: austin
Date: 2006-01-05 13:55:02 +0100 (Thu, 05 Jan 2006)
New Revision: 1092

Modified:
   trunk/096/pkg/multis/boat/plank/use.src
   trunk/096/pkg/multis/boat/plank/walkOn.src
Log:


Modified: trunk/096/pkg/multis/boat/plank/use.src
===================================================================
--- trunk/096/pkg/multis/boat/plank/use.src	2006-01-05 12:42:48 UTC (rev 1091)
+++ trunk/096/pkg/multis/boat/plank/use.src	2006-01-05 12:55:02 UTC (rev 1092)
@@ -0,0 +1,30 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+
+include ":locksandkeys:includes/locks";
+
+program UsePlank(who, plank)
+	detach();
+	if ( plank.Extended() )
+		if ( (who.multi).serial != (plank.multi).serial )
+			if ( Distance(who, plank) <= 2 )
+				MoveCharacterToLocation(who, plank.x, plank.y, plank.z+1, MOVECHAR_FORCELOCATION);
+			endif
+		else
+			plank.Retract(who);
+		endif
+	else
+		if ( plank.locked )
+			PrintTextAbovePrivate(plank, "That is locked.", who);
+			return 0;
+		endif
+		
+		plank.Extend(who);
+	endif
+	
+	return 1;
+endprogram

Modified: trunk/096/pkg/multis/boat/plank/walkOn.src
===================================================================
--- trunk/096/pkg/multis/boat/plank/walkOn.src	2006-01-05 12:42:48 UTC (rev 1091)
+++ trunk/096/pkg/multis/boat/plank/walkOn.src	2006-01-05 12:55:02 UTC (rev 1092)
@@ -0,0 +1,11 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+
+program PlankWalkOn(who, plank)
+	return 1;
+endprogram



From austin at berlios.de  Thu Jan  5 14:41:30 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 14:41:30 +0100
Subject: [Poldistro-svn] r1093 - trunk/096/pkg/multis/boat/tiller
Message-ID: <200601051341.k05DfUM7009302@sheep.berlios.de>

Author: austin
Date: 2006-01-05 14:41:29 +0100 (Thu, 05 Jan 2006)
New Revision: 1093

Modified:
   trunk/096/pkg/multis/boat/tiller/methods.src
   trunk/096/pkg/multis/boat/tiller/use.src
Log:


Modified: trunk/096/pkg/multis/boat/tiller/methods.src
===================================================================
--- trunk/096/pkg/multis/boat/tiller/methods.src	2006-01-05 12:55:02 UTC (rev 1092)
+++ trunk/096/pkg/multis/boat/tiller/methods.src	2006-01-05 13:41:29 UTC (rev 1093)
@@ -0,0 +1,140 @@
+use uo;
+use boat;
+use os;
+
+include "include/string";
+
+program Install()
+	return 1;
+endprogram
+
+exported function GetMulti(tiller)
+	return SystemFindBoatBySerial((tiller.multi).serial);
+endfunction
+
+exported function IsOnBoat(tiller, boat, mobile)
+	if ( (mobile.multi).serial == boat.serial )
+		return 1;
+	else
+		return 0;
+	endif
+endfunction
+
+exported function CanCommand(tiller, mobile)
+	if ( IsOwner(tiller, mobile) )
+		return 1;
+	elseif ( IsCrewMate(tiller, mobile) )
+		return 1;
+	else
+		return 0;
+	endif
+endfunction
+
+exported function IsOwner(tiller, mobile)
+	if ( mobile.serial == GetOwner(tiller).serial )
+		return 1;
+	else
+		return 0;
+	endif
+endfunction
+
+exported function GetOwner(tiller)
+	return GetObjProperty(tiller, "Owner");
+endfunction
+
+exported function SetOwner(tiller, owner)
+	var info := struct;
+	info.+name := owner.name;
+	info.+serial := owner.serial;
+	info.+acctname := owner.acctname;
+	
+	return SetObjProperty(tiller, "Owner", info);
+endfunction
+
+exported function GetCrewMates(tiller)
+	var crew_mates := GetObjProperty(tiller, "CrewMates");
+	if ( crew_mates == error )
+		crew_mates := array;
+		SetCrewMates(tiller, crew_mates);
+	endif
+	
+	return crew_mates;
+endfunction
+
+exported function RemoveCrewMate(tiller, index)
+	var crew_mates := GetCrewMates(tiller);
+	var crew_mate := crew_mates[index];
+	crew_mates.erase(index);
+	SetCrewMates(tiller, crew_mates);
+	
+	return crew_mate;
+endfunction
+
+exported function AddCrewMate(tiller, mobile, index)
+	var crew_mates := GetCrewMates(tiller);
+	
+	var info := struct;
+	info.+name := mobile.name;
+	info.+serial := mobile.serial;
+	info.+acctname := mobile.acctname;
+	
+	crew_mates[index] := info;
+	
+	SetCrewMates(tiller, crew_mates);
+endfunction
+
+exported function IsCrewMate(tiller, mobile)
+	var crew_mates := GetCrewMates(tiller);
+	var i;
+	for ( i:=1; i<=crew_mates.size(); i:=i+1 )
+		if ( crew_mates[i].name == mobile.name )
+			return i;
+		endif
+	endfor
+	
+	return 0;
+endfunction
+
+exported function SetCrewMates(tiller, list)
+	SetObjProperty(tiller, "CrewMates", list);
+endfunction
+
+exported function GetCondition(tiller)
+	var condition := GetObjProperty(tiller, "Condition");
+	
+	return condition;
+endfunction
+
+exported function SetCondition(tiller, value)
+	SetObjProperty(tiller, "Condition", value);
+endfunction
+
+exported function GetSpeed(tiller)
+	var speed := GetObjProperty(tiller, "Speed");
+	if ( !speed )
+		SetSpeed(tiller, 350);
+	endif
+	
+	return CInt(speed);
+endfunction
+
+exported function SetSpeed(tiller, value)
+	SetObjProperty(tiller, "Speed", value);
+endfunction
+
+exported function SetAnchorStatus(tiller, value)
+	var tiller_name := tiller.desc;
+	if ( value )
+		SetObjProperty(tiller, "Anchored", 1);
+		SetName(tiller, tiller_name+" [Anchored]");
+	else
+		EraseObjProperty(tiller, "Anchored");
+		tiller_name[" [Anchored]"] := "";
+		tiller_name := RemoveSpaces(tiller_name, CLR_LEADING_SPACES+CLR_TRAILING_SPACES+CLR_DOUBLE_SPACES);
+		SetName(tiller, tiller_name);
+	endif
+endfunction
+
+exported function IsAnchored(tiller)
+	return GetObjProperty(tiller, "Anchored");
+endfunction

Modified: trunk/096/pkg/multis/boat/tiller/use.src
===================================================================
--- trunk/096/pkg/multis/boat/tiller/use.src	2006-01-05 12:55:02 UTC (rev 1092)
+++ trunk/096/pkg/multis/boat/tiller/use.src	2006-01-05 13:41:29 UTC (rev 1093)
@@ -0,0 +1,12 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+
+include ":gumps:gumps";
+
+program UseScript(who, tillerman)
+	return 1;
+endprogram



From austin at berlios.de  Thu Jan  5 16:15:11 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 16:15:11 +0100
Subject: [Poldistro-svn] r1094 - in trunk/096/pkg/skills/magery/spellScripts: circle4 circle6 circle7
Message-ID: <200601051515.k05FFBNU030381@sheep.berlios.de>

Author: austin
Date: 2006-01-05 16:15:11 +0100 (Thu, 05 Jan 2006)
New Revision: 1094

Modified:
   trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src
   trunk/096/pkg/skills/magery/spellScripts/circle6/mark.src
   trunk/096/pkg/skills/magery/spellScripts/circle7/gate.src
Log:
Updated spell scripts to contain pseudo code for how they should work (making them compile)

Modified: trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src	2006-01-05 13:41:29 UTC (rev 1093)
+++ trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src	2006-01-05 15:15:11 UTC (rev 1094)
@@ -15,278 +15,32 @@
 
 program SpellScript(params)
 	var who := params[1];
-	var runebook_info := params[2].targ;
+	var recall_rune := params[2];
 	//var info := params[2];
 	params := 0; // No longer needed
 
-	if( TypeOf(runebook_info) == "Array" )
-		RunebookRecall(who, runebook_info);
-		return 1;
-	endif
-
 	var prompt := "Select an object to recall from.";
-	var recall_rune := MS_Target(who, 0, prompt, TGTOPT_CHECK_LOS+TGTOPT_NEUTRAL);
-	if( (recall_rune.objtype != UOBJ_RUNE) && (recall_rune.objtype != 0x6100))
+	recall_rune := MS_Target(who, recall_rune, prompt, TGTOPT_CHECK_LOS+TGTOPT_NEUTRAL);
+	if( !recall_rune.IsRecallRune() )
 		SendSysMessage(who, "You can only cast that on a recall rune or runebook.");
 		return 0;
-	endif
-	if( !ReserveItem(recall_rune) )
+	elseif( !ReserveItem(recall_rune) )
+		SendSysMessage(who, "That is already being used.");		
 		return 0;
-	endif
-
-	if( GetObjProperty(recall_rune, "Vendored") )
+	elseif( GetObjProperty(recall_rune, "Vendored") )
 		SendSysMessage(who, "You cannot recall off of runes on a vendor.");
 		return 0;
 	endif
-	var rune_settings;
-	case(recall_rune.objtype)
-		UOBJ_RUNE: rune_settings := recall_rune.GetDestination();
-		0x6100: rune_settings := GetObjProperty(recall_rune, "Destination");
-	endcase
-	if( TypeOf(rune_settings) != "Struct" )
-		SendSysMessage(who, "That item is not marked.");
+	
+	var dest := recall_rune.GetDestination();
+	if ( !dest )
+		SendSysMessage(who, "That rune is not marked.");
 		return 0;
 	endif
-
-	var tox := CInt(rune_settings.x);
-	var toy := CInt(rune_settings.y);
-	var toz := CInt(rune_settings.z);
-	var torealm :=  rune_settings.realm;
-	if(!torealm)
-		torealm := "britannia";
-	endif
-
-	if( !isValidLoc(tox,toy,torealm) )
-		SendSysMessage(who, "Invalid recall location.");
-		if( recall_rune.objtype == 0x6100 )
-			RemoveRunebookDefault(recall_rune);
-			return 0;
-		else
-			DestroyItem(recall_rune);
-			return 0;
-		endif
-	endif
-
-	PlaySoundEffect(who, 0x210);
-
-	if( (who.x >= 5120) && (who.x <= 5375) && (who.y >= 0) && (who.y <= 255) )
-		SendSysMessage(who, "Your spell fails and consumes the rune!");
-		if(recall_rune.objtype == UOBJ_RUNE)
-			DestroyItem(recall_rune);
-		elseif(recall_rune.objtype == 0x6100)
-			RemoveRunebookDefault(recall_rune);
-		endif
-		return 0;
-	endif
-
-	var signs := ListItemsNearLocationOfType( tox, toy, toz, 30, 0x7060, torealm);
-	foreach sign in signs
-		var infoarr := GetObjProperty(sign, "homeinfo");
-		if( infoarr )
-			if( (tox >= infoarr[2]) && (tox <= infoarr[4]) && (toy >= infoarr[3]) && (toy <= infoarr[5]) )
-				SendSysMessage(who, "Something is blocking the location.");
-				return 0;
-				break;
-			endif
-		endif
-	endforeach
-
-	var multicheck := CreateItemAtLocation(1, 1, 0, 0xeed, 1, torealm);
-	multicheck.invisible := 1;
-	if( !MoveItemToLocation(multicheck, tox, toy, toz, MOVEITEM_NORMAL) )
-		SendSysMessage(who, "Something is blocking the location.");
-		if(recall_rune.objtype == UOBJ_RUNE)
-			DestroyItem(recall_rune);
-		elseif(recall_rune.objtype == 0x6100)
-			RemoveRunebookDefault(recall_rune);
-		endif
-		return 0;
-	endif
-	if(multicheck.multi)
-		SendSysMessage(who,"Something is blocking the location.");
-		if(recall_rune.objtype == UOBJ_RUNE)
-			DestroyItem(recall_rune);
-		elseif(recall_rune.objtype == 0x6100)
-			RemoveRunebookDefault(recall_rune);
-		endif
-		return 0;
-	endif
-	DestroyItem(multicheck);
-	case(recall_rune.objtype)
-		UOBJ_RUNE: recall_rune.SendToDestination(who);
-		0x6100: MoveObjectToLocation(who, tox, toy, toz, torealm, MOVEOBJECT_FORCELOCATION);
-	endcase
-	PlaySoundEffect(who, 0x1fd);
-	return 1;
+	/*
+	 * Check if destination is a multi here.
+	 *
+	 */
+	 
+	 recall_rune.SendToDestination(recall_rune, who);
 endprogram
-
-function RemoveRunebookDefault(runebook)
-	var tox := CInt(GetObjProperty( runebook, "x" ));
-	var toy := CInt(GetObjProperty( runebook, "y" ));
-	var toz := CInt(GetObjProperty( runebook, "z" ));
-	var torealm := GetObjProperty( runebook, "realm" );
-	var rune_list := GetRuneList(runebook);
-
-	foreach rune_entry in rune_list
-		if( (Cint(rune_list.X) == tox) && (Cint(rune_list.Y) == toy) && (Cint(rune_list.Z) == toz) && (Cint(rune_list.Realm) == torealm) )
-			rune_list.Erase(rune_entry);
-		endif
-	endforeach
-
-	SetObjProperty(runebook, "%RuneList%", rune_list);
-	EraseObjProperty(runebook, "x");
-	EraseObjProperty(runebook, "y");
-	EraseObjProperty(runebook, "z");
-	EraseObjProperty(runebook, "realm");
-	return 1;
-endfunction
-
-
-function RemoveRunebookEntry(runebook, rune_info)
-	var tox := CInt(rune_info.X);
-	var toy := CInt(rune_info.Y);
-	var toz := CInt(rune_info.Z);
-	var torealm :=  rune_info.Realm;
-	var rune_list := GetRuneList(runebook);
-
-	foreach rune_entry in rune_list
-		if( (Cint(rune_list.X) == tox) && (Cint(rune_list.Y) == toy) && (Cint(rune_list.Z) == toz) && (Cint(rune_list.Realm) == torealm) )
-			rune_list.Erase(rune_entry);
-		endif
-	endforeach
-
-	SetObjProperty(runebook, "%RuneList%", rune_list);
-	EraseObjProperty(runebook, "x");
-	EraseObjProperty(runebook, "y");
-	EraseObjProperty(runebook, "z");
-	EraseObjProperty(runebook, "realm");
-	return 1;
-endfunction
-
-
-function RunebookRecall(who, runebook_info)
-	var runebook := runebook_info[1];
-	var rune_info := runebook_info[2];
-	var use_charge := runebook_info[3];
-
-	var spell_elem := MS_GetSpellsCfgElem(32);
-
-	if ( !CheckReagents(who, spell_elem, use_charge) )
-		FailSpell(who);
-		return 0;
-	endif
-
-	if( !ReserveItem(runebook) )
-		return 0;
-	endif
-
-	if( GetObjProperty(runebook, "Vendored") )
-		SendSysMessage(who, "You cannot recall off of runebooks on a vendor.");
-		return 0;
-	endif
-
-	if( TypeOf(rune_info) != "Struct" )
-		SendSysMessage(who, "That item is not marked.");
-		return 0;
-	endif
-
-	var tox := CInt(rune_info.x);
-	var toy := CInt(rune_info.y);
-	var toz := CInt(rune_info.z);
-	var torealm :=  rune_info.realm;
-	if(!torealm)
-		torealm := "britannia";
-	endif
-
-	if( !isValidLoc(tox,toy,torealm) )
-		SendSysMessage(who, "Invalid recall location.");
-		RemoveRunebookEntry(runebook, rune_info);
-		return 0;
-	endif
-
-	PlaySoundEffect(who, 0x210);
-
-	if( (who.x >= 5120) && (who.x <= 5375) && (who.y >= 0) && (who.y <= 255) )
-		SendSysMessage(who, "Your spell fails and consumes the rune!");
-		RemoveRunebookEntry(runebook, rune_info);
-		return 0;
-	endif
-
-	var signs := ListItemsNearLocationOfType( tox, toy, toz, 30, 0x7060, torealm);
-	foreach sign in signs
-		var infoarr := GetObjProperty(sign, "homeinfo");
-		if( infoarr )
-			if( (tox >= infoarr[2]) && (tox <= infoarr[4]) && (toy >= infoarr[3]) && (toy <= infoarr[5]) )
-				SendSysMessage(who, "Something is blocking the location.");
-				return 0;
-				break;
-			endif
-		endif
-	endforeach
-
-	var multicheck := CreateItemAtLocation(1, 1, 0, 0xeed, 1, torealm);
-	multicheck.invisible := 1;
-	if( !MoveItemToLocation(multicheck, tox, toy, toz, MOVEITEM_NORMAL) )
-		SendSysMessage(who, "Something is blocking the location.");
-		return 0;
-	endif
-	if(multicheck.multi)
-		SendSysMessage(who,"A house is blocking the location.");
-		RemoveRunebookEntry(runebook, rune_info);
-		return 0;
-	endif
-	DestroyItem(multicheck);
-	MoveObjectToLocation( who, tox, toy, toz, torealm );
-	PlaySoundEffect(who, 0x1fd);
-	return 1;
-endfunction
-
-function CheckReagents(who, byref spell_elem, scroll)
-	if ( who.npctemplate )
-		// NPCs don't need reagents to cast.
-		return 1;
-	elseif ( scroll.isA(POLCLASS_ITEM) )
-		return SubtractAmount(scroll, 1);
-	elseif ( scroll == 1 )
-		// Added scroll/1 check for passing 1 to override reg
-		// and scroll check. IE: runebooks, wands, etc.
-		return 1;
-	endif
-
-	var reagent_costs := GetConfigStringDictionary(spell_elem, "RegCost");
-
-	// Before consuming, verify that there is enough of everything.
-	foreach amount in ( reagent_costs )
-		amount := CInt(amount);
-		if ( !amount )
-			amount := 1;
-		endif
-		var objtype := GetObjTypeByName(_amount_iter);
-
-		if ( AmountInContainer(who.backpack, objtype) < amount )
-			SendSysMessage(who, "You do not have enough "+GetObjTypeDesc(objtype, (amount>1)));
-			return 0;
-		endif
-		sleepms(2);
-	endforeach
-	// Consume reagents - CInt() and < 1 checks already done in previous loop.
-	// Foreach is a pointer!
-	foreach amount in ( reagent_costs )
-		ConsumeSubstance(who.backpack, GetObjTypeByName(_amount_iter), amount);
-		sleepms(2);
-	endforeach
-
-	return 1;
-endfunction
-
-
-function FailSpell(who)
-	// Simple function for handling effects when a caster
-	// fails the casting.
-	who.frozen := 0;
-	EraseObjProperty(who, "#medding");
-	PlayObjectCenteredEffect(who, GFX_FIZZLE, 5, 50);
-	PlaySoundEffect(who, SFX_SPELL_FAIL);
-
-	return 1;
-endfunction

Modified: trunk/096/pkg/skills/magery/spellScripts/circle6/mark.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle6/mark.src	2006-01-05 13:41:29 UTC (rev 1093)
+++ trunk/096/pkg/skills/magery/spellScripts/circle6/mark.src	2006-01-05 15:15:11 UTC (rev 1094)
@@ -19,31 +19,24 @@
 	var prompt := "Select a recall rune to mark.";
 	var recall_rune := MS_Target(who, 0, prompt, TGTOPT_CHECK_LOS+TGTOPT_NEUTRAL);
 
-	if( recall_rune.objtype != UOBJ_RUNE )
+	if( !recall_rune.IsRecallRune() )
 		SendSysMessage(who, "You can only cast that on a recall rune!");
 		return 0;
-	endif
-	if( !Accessible(who, recall_rune) )
+	elseif( !Accessible(who, recall_rune) )
 		SendSysMessage(who, "You can't reach that!");
 		return 0;
-	endif
-	if( !ReserveItem(recall_rune) )
+	elseif( !ReserveItem(recall_rune) )
 		SendSysMessage(who, "Your spell fizzles.");
 		return 0;
-	endif
-	if( GetObjProperty(recall_rune, "Vendored") )
+	elseif( GetObjProperty(recall_rune, "Vendored") )
 		SendSysMessage(who, "You cannot mark runes on a vendor.");
 		return 0;
-	endif
-
-	if( who.multi )
+	elseif( who.multi )
 		SendSysMessage(who, "You cannot mark runes here.");
 		PlaySoundEffect(who, 0x005d);
 		PlayObjectCenteredEffect(who, 0x3735, 0x0a, 0x1e);
 		return 0;
-	endif
-
-	if( ((who.x >= 5120) && (who.x <= 5375) && (who.y >= 0) && (who.y <= 255)) || (who.multi) )
+	elseif( ((who.x >= 5120) && (who.x <= 5375) && (who.y >= 0) && (who.y <= 255)) || (who.multi) )
 		SendSysMessage(who, "You cannot mark runes here.");
 		return 0;
 	endif

Modified: trunk/096/pkg/skills/magery/spellScripts/circle7/gate.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle7/gate.src	2006-01-05 13:41:29 UTC (rev 1093)
+++ trunk/096/pkg/skills/magery/spellScripts/circle7/gate.src	2006-01-05 15:15:11 UTC (rev 1094)
@@ -15,337 +15,38 @@
 
 program SpellScript(params)
 	var who := params[1];
-	var runebook_info := params[2].targ;
+	var recall_rune := params[2];
 	//var info := params[2];
 	params := 0; // No longer needed
 
-	if( TypeOf(runebook_info) == "Array" )
-		RunebookGate(who, runebook_info);
-		return 1;
-	endif
-
 	var prompt := "Select an object to gate from.";
-	var recall_rune := MS_Target(who, 0, prompt, TGTOPT_CHECK_LOS+TGTOPT_NEUTRAL);
-	if( (recall_rune.objtype != UOBJ_RUNE) && (recall_rune.objtype != 0x6100))
+	recall_rune := MS_Target(who, recall_rune, prompt, TGTOPT_CHECK_LOS+TGTOPT_NEUTRAL);
+	if( !recall_rune.IsRecallRune() )
 		SendSysMessage(who, "You can only cast that on a recall rune or runebook.");
 		return 0;
-	endif
-	if( !ReserveItem(recall_rune) )
+	elseif( !ReserveItem(recall_rune) )
+		SendSysMessage(who, "That is already being used.");
 		return 0;
-	endif
-
-	if( GetObjProperty(recall_rune, "Vendored") )
+	elseif( GetObjProperty(recall_rune, "Vendored") )
 		SendSysMessage(who, "You cannot recall off of runes on a vendor.");
 		return 0;
 	endif
 
-	var rune_settings;
-	case(recall_rune.objtype)
-		UOBJ_RUNE: rune_settings := recall_rune.GetDestination();
-		0x6100: rune_settings := GetObjProperty(recall_rune, "Destination");
-	endcase
-	if( TypeOf(rune_settings) != "Struct" )
-		SendSysMessage(who, "That item is not marked.");
+	var dest := recall_rune.GetDestination();
+	if ( !dest )
+		SendSysMessage(who, "That rune is not marked.");
 		return 0;
 	endif
-
-	var tox := CInt(rune_settings.x);
-	var toy := CInt(rune_settings.y);
-	var toz := CInt(rune_settings.z);
-	var torealm :=  rune_settings.realm;
-	if(!torealm)
-		torealm := "britannia";
-	endif
-
-	if( !isValidLoc(tox,toy,torealm) )
-		SendSysMessage(who, "Invalid recall location.");
-		if( recall_rune.objtype == 0x6100 )
-			RemoveRunebookDefault(recall_rune);
-			return 0;
-		else
-			DestroyItem(recall_rune);
-			return 0;
-		endif
-	endif
-
-	PlaySoundEffect(who, 0x210);
-
-	if( (who.x >= 5120) && (who.x <= 5375) && (who.y >= 0) && (who.y <= 255) )
-		SendSysMessage(who, "Your spell fails and consumes the rune!");
-		if(recall_rune.objtype == UOBJ_RUNE)
-			DestroyItem(recall_rune);
-		elseif(recall_rune.objtype == 0x6100)
-			RemoveRunebookDefault(recall_rune);
-		endif
-		return 0;
-	endif
-
-	var signs := ListItemsNearLocationOfType( tox, toy, toz, 30, 0x7060, torealm);
-	foreach sign in signs
-		var infoarr := GetObjProperty(sign, "homeinfo");
-		if( infoarr )
-			if( (tox >= infoarr[2]) && (tox <= infoarr[4]) && (toy >= infoarr[3]) && (toy <= infoarr[5]) )
-				SendSysMessage(who, "Something is blocking the location.");
-				return 0;
-				break;
-			endif
-		endif
-	endforeach
-
-	var multicheck := CreateItemAtLocation(1, 1, 0, 0xeed, 1, torealm);
-	multicheck.invisible := 1;
-	if( !MoveItemToLocation(multicheck, tox, toy, toz, MOVEITEM_NORMAL) )
-		SendSysMessage(who, "Something is blocking the location.");
-		if(recall_rune.objtype == UOBJ_RUNE)
-			DestroyItem(recall_rune);
-		elseif(recall_rune.objtype == 0x6100)
-			RemoveRunebookDefault(recall_rune);
-		endif
-		return 0;
-	endif
-	if(multicheck.multi)
-		SendSysMessage(who,"Something is blocking the location.");
-		if(recall_rune.objtype == UOBJ_RUNE)
-			DestroyItem(recall_rune);
-		elseif(recall_rune.objtype == 0x6100)
-			RemoveRunebookDefault(recall_rune);
-		endif
-		return 0;
-	endif
-	DestroyItem(multicheck);
-
-	var wx := who.x;
-	var wy := who.y;
-	var wz := who.z;
-	PlayStationaryEffect( wx, wy, wz, 6899, 1, 30, 0, who.realm );
-	PlayStationaryEffect( tox, toy, toz, 6899, 1, 30, 0, torealm );
-	sleepms(2800);
-	set_critical( 1 );
-	var gate1 := CreateItemAtLocation( wx, wy, wz, UOBJ_BLUE_MOONGATE, 1, who.realm );
-	gate1.movable := 0;
-	var gate2 := CreateItemAtLocation( tox, toy, toz, UOBJ_BLUE_MOONGATE, 1, torealm );
-	gate2.movable := 0;
-	if( !gate1 )
-		DestroyItem(gate2);
-		SendSysMessage(who, "Something is interfering with the spell.");
-		return 0;
-	endif
-	if( !gate2 )
-		DestroyItem(gate1);
-		SendSysMessage(who, "Something is interfering with the spell.");
-		return 0;
-	endif
-	set_critical(0);
-	var dest := dictionary{ "x" -> gate2.x, "y" -> gate2.y, "z" -> gate2.z, "realm" -> gate2.realm};
-	SetObjProperty( gate1, "Destination", dest );
-	dest := dictionary{ "x" -> gate1.x, "y" -> gate1.y, "z" -> gate1.z, "realm" -> gate1.realm};
-	SetObjProperty( gate2, "Destination", dest );
-	Detach();
-	sleep(30);
-	set_critical(1);
-	DestroyItem( gate1 );
-	DestroyItem( gate2 );
-	set_critical(0);
+	/*
+	 * Check if destination is a multi here.
+	 *
+	 */
+	
+	//
+	// Create moongate object
+	// Detach with ReleaseScript(pid)
+	// Wait
+	// Remove moongate
+	//
 	return 1;
 endprogram
-
-function RemoveRunebookDefault(runebook)
-	var tox := CInt(GetObjProperty( runebook, "x" ));
-	var toy := CInt(GetObjProperty( runebook, "y" ));
-	var toz := CInt(GetObjProperty( runebook, "z" ));
-	var torealm := GetObjProperty( runebook, "realm" );
-	var rune_list := GetRuneList(runebook);
-
-	foreach rune_entry in rune_list
-		if( (Cint(rune_list.X) == tox) && (Cint(rune_list.Y) == toy) && (Cint(rune_list.Z) == toz) && (Cint(rune_list.Realm) == torealm) )
-			rune_list.Erase(rune_entry);
-		endif
-	endforeach
-
-	SetObjProperty(runebook, "%RuneList%", rune_list);
-	EraseObjProperty(runebook, "x");
-	EraseObjProperty(runebook, "y");
-	EraseObjProperty(runebook, "z");
-	EraseObjProperty(runebook, "realm");
-	return 1;
-endfunction
-
-
-function RemoveRunebookEntry(runebook, rune_info)
-	var tox := CInt(rune_info.X);
-	var toy := CInt(rune_info.Y);
-	var toz := CInt(rune_info.Z);
-	var torealm :=  rune_info.Realm;
-	var rune_list := GetRuneList(runebook);
-
-	foreach rune_entry in rune_list
-		if( (Cint(rune_list.X) == tox) && (Cint(rune_list.Y) == toy) && (Cint(rune_list.Z) == toz) && (Cint(rune_list.Realm) == torealm) )
-			rune_list.Erase(rune_entry);
-		endif
-	endforeach
-
-	SetObjProperty(runebook, "%RuneList%", rune_list);
-	EraseObjProperty(runebook, "x");
-	EraseObjProperty(runebook, "y");
-	EraseObjProperty(runebook, "z");
-	EraseObjProperty(runebook, "realm");
-	return 1;
-endfunction
-
-
-function RunebookGate(who, runebook_info)
-	var runebook := runebook_info[1];
-	var rune_info := runebook_info[2];
-
-	if( !ReserveItem(runebook) )
-		return 0;
-	endif
-
-	var spell_elem := MS_GetSpellsCfgElem(52);
-	if ( !CheckReagents(who, spell_elem, 0) )
-		FailSpell(who);
-		return 0;
-	endif
-
-	if( GetObjProperty(runebook, "Vendored") )
-		SendSysMessage(who, "You cannot recall off of runebooks on a vendor.");
-		return 0;
-	endif
-
-	if( TypeOf(rune_info) != "Struct" )
-		SendSysMessage(who, "That item is not marked.");
-		return 0;
-	endif
-
-	var tox := CInt(rune_info.x);
-	var toy := CInt(rune_info.y);
-	var toz := CInt(rune_info.z);
-	var torealm :=  rune_info.realm;
-	if(!torealm)
-		torealm := "britannia";
-	endif
-
-	if( !isValidLoc(tox,toy,torealm) )
-		SendSysMessage(who, "Invalid recall location.");
-		RemoveRunebookEntry(runebook, rune_info);
-		return 0;
-	endif
-
-	PlaySoundEffect(who, 0x210);
-
-	if( (who.x >= 5120) && (who.x <= 5375) && (who.y >= 0) && (who.y <= 255) )
-		SendSysMessage(who, "Your spell fails and consumes the rune!");
-		RemoveRunebookEntry(runebook, rune_info);
-		return 0;
-	endif
-
-	var signs := ListItemsNearLocationOfType( tox, toy, toz, 30, 0x7060, torealm);
-	foreach sign in signs
-		var infoarr := GetObjProperty(sign, "homeinfo");
-		if( infoarr )
-			if( (tox >= infoarr[2]) && (tox <= infoarr[4]) && (toy >= infoarr[3]) && (toy <= infoarr[5]) )
-				SendSysMessage(who, "Something is blocking the location.");
-				return 0;
-				break;
-			endif
-		endif
-	endforeach
-
-	var multicheck := CreateItemAtLocation(1, 1, 0, 0xeed, 1, torealm);
-	multicheck.invisible := 1;
-	if( !MoveItemToLocation(multicheck, tox, toy, toz, MOVEITEM_NORMAL) )
-		SendSysMessage(who, "Something is blocking the location.");
-		return 0;
-	endif
-	if(multicheck.multi)
-		SendSysMessage(who,"A house is blocking the location.");
-		RemoveRunebookEntry(runebook, rune_info);
-		return 0;
-	endif
-	DestroyItem(multicheck);
-
-	var wx := who.x;
-	var wy := who.y;
-	var wz := who.z;
-	PlayStationaryEffect( wx, wy, wz, 6899, 1, 30, 0, who.realm );
-	PlayStationaryEffect( tox, toy, toz, 6899, 1, 30, 0, torealm );
-	sleepms(2800);
-	set_critical( 1 );
-	var gate1 := CreateItemAtLocation( wx, wy, wz, UOBJ_BLUE_MOONGATE, 1, who.realm );
-	gate1.movable := 0;
-	var gate2 := CreateItemAtLocation( tox, toy, toz, UOBJ_BLUE_MOONGATE, 1, torealm );
-	gate2.movable := 0;
-	if( !gate1 )
-		DestroyItem(gate2);
-		SendSysMessage(who, "Something is interfering with the spell.");
-		return 0;
-	endif
-	if( !gate2 )
-		DestroyItem(gate1);
-		SendSysMessage(who, "Something is interfering with the spell.");
-		return 0;
-	endif
-	set_critical(0);
-	var dest := dictionary{ "x" -> gate2.x, "y" -> gate2.y, "z" -> gate2.z, "realm" -> gate2.realm};
-	SetObjProperty( gate1, "Destination", dest );
-	dest := dictionary{ "x" -> gate1.x, "y" -> gate1.y, "z" -> gate1.z, "realm" -> gate1.realm};
-	SetObjProperty( gate2, "Destination", dest );
-	Detach();
-	sleep(30);
-	set_critical(1);
-	DestroyItem( gate1 );
-	DestroyItem( gate2 );
-	set_critical(0);
-	return 1;
-endfunction
-
-
-function CheckReagents(who, byref spell_elem, scroll)
-	if ( who.npctemplate )
-		// NPCs don't need reagents to cast.
-		return 1;
-	elseif ( scroll.isA(POLCLASS_ITEM) )
-		return SubtractAmount(scroll, 1);
-	elseif ( scroll == 1 )
-		// Added scroll/1 check for passing 1 to override reg
-		// and scroll check. IE: runebooks, wands, etc.
-		return 1;
-	endif
-
-	var reagent_costs := GetConfigStringDictionary(spell_elem, "RegCost");
-
-	// Before consuming, verify that there is enough of everything.
-	foreach amount in ( reagent_costs )
-		amount := CInt(amount);
-		if ( !amount )
-			amount := 1;
-		endif
-		var objtype := GetObjTypeByName(_amount_iter);
-
-		if ( AmountInContainer(who.backpack, objtype) < amount )
-			SendSysMessage(who, "You do not have enough "+GetObjTypeDesc(objtype, (amount>1)));
-			return 0;
-		endif
-		sleepms(2);
-	endforeach
-	// Consume reagents - CInt() and < 1 checks already done in previous loop.
-	// Foreach is a pointer!
-	foreach amount in ( reagent_costs )
-		ConsumeSubstance(who.backpack, GetObjTypeByName(_amount_iter), amount);
-		sleepms(2);
-	endforeach
-
-	return 1;
-endfunction
-
-
-function FailSpell(who)
-	// Simple function for handling effects when a caster
-	// fails the casting.
-	who.frozen := 0;
-	EraseObjProperty(who, "#medding");
-	PlayObjectCenteredEffect(who, GFX_SPELL_FAIL, 5, 50);
-	PlaySoundEffect(who, SFX_SPELL_FAIL);
-
-	return 1;
-endfunction



From austin at berlios.de  Thu Jan  5 16:15:44 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 16:15:44 +0100
Subject: [Poldistro-svn] r1095 - trunk/096/pkg/skills/magery/spellScripts/circle4
Message-ID: <200601051515.k05FFifb030464@sheep.berlios.de>

Author: austin
Date: 2006-01-05 16:15:44 +0100 (Thu, 05 Jan 2006)
New Revision: 1095

Modified:
   trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src
Log:


Modified: trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src	2006-01-05 15:15:11 UTC (rev 1094)
+++ trunk/096/pkg/skills/magery/spellScripts/circle4/recall.src	2006-01-05 15:15:44 UTC (rev 1095)
@@ -42,5 +42,5 @@
 	 *
 	 */
 	 
-	 recall_rune.SendToDestination(recall_rune, who);
+	 recall_rune.SendToDestination(who);
 endprogram



From austin at berlios.de  Thu Jan  5 16:18:33 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 16:18:33 +0100
Subject: [Poldistro-svn] r1096 - trunk/096/pkg/multis/boat/plank
Message-ID: <200601051518.k05FIXjV030828@sheep.berlios.de>

Author: austin
Date: 2006-01-05 16:18:33 +0100 (Thu, 05 Jan 2006)
New Revision: 1096

Modified:
   trunk/096/pkg/multis/boat/plank/use.src
Log:


Modified: trunk/096/pkg/multis/boat/plank/use.src
===================================================================
--- trunk/096/pkg/multis/boat/plank/use.src	2006-01-05 15:15:44 UTC (rev 1095)
+++ trunk/096/pkg/multis/boat/plank/use.src	2006-01-05 15:18:33 UTC (rev 1096)
@@ -5,8 +5,6 @@
 
 use uo;
 
-include ":locksandkeys:includes/locks";
-
 program UsePlank(who, plank)
 	detach();
 	if ( plank.Extended() )



From austin at berlios.de  Thu Jan  5 16:26:53 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 16:26:53 +0100
Subject: [Poldistro-svn] r1097 - trunk/096/pkg/commands/gm
Message-ID: <200601051526.k05FQrS0031657@sheep.berlios.de>

Author: austin
Date: 2006-01-05 16:26:53 +0100 (Thu, 05 Jan 2006)
New Revision: 1097

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Few small updates..
I still have no clue how im gonna make the data change buttons work :-D

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-05 15:18:33 UTC (rev 1096)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-05 15:26:53 UTC (rev 1097)
@@ -23,8 +23,8 @@
 CONST START_Y	:= 55;
 CONST END_Y	:= 410;
 
-const MENU_BTN	:= 0xA0;
-const DATA_BTN	:= 0xF0;
+CONST MENU_BTN	:= 0xA0; // Value of the first menu button.
+CONST DATA_BTN	:= 0xF0; // Value of the first data changing button.
 
 unload_scripts("");
 
@@ -66,6 +66,8 @@
 			cur_gump := input - MENU_BTN;
 		endif
 		
+		SendSysMessage(who, "Input->"+input);
+		
 		if ( !input )
 			break;
 		elseif ( !who.connected )



From austin at berlios.de  Thu Jan  5 16:34:13 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 16:34:13 +0100
Subject: [Poldistro-svn] r1098 - in trunk/096: config pkg/items/moongates
Message-ID: <200601051534.k05FYDdC032671@sheep.berlios.de>

Author: austin
Date: 2006-01-05 16:34:13 +0100 (Thu, 05 Jan 2006)
New Revision: 1098

Modified:
   trunk/096/config/itemdesc.cfg
   trunk/096/pkg/items/moongates/itemdesc.cfg
Log:


Modified: trunk/096/config/itemdesc.cfg
===================================================================
--- trunk/096/config/itemdesc.cfg	2006-01-05 15:26:53 UTC (rev 1097)
+++ trunk/096/config/itemdesc.cfg	2006-01-05 15:34:13 UTC (rev 1098)
@@ -598,17 +598,6 @@
 	VendorBuysFor		15
 }
 
-Item 0x6008
-{
-	Name			permmoongate
-	Graphic			0xF6C
-	Facing			2
-	WalkOnScript		moongate
-	SaveOnExit		1
-	Movable			0
-}
-
-
 #####################################
 #		ObjTypes 0xEE00 - 0xEFFF - Test objtypes			#
 #####################################

Modified: trunk/096/pkg/items/moongates/itemdesc.cfg
===================================================================
--- trunk/096/pkg/items/moongates/itemdesc.cfg	2006-01-05 15:26:53 UTC (rev 1097)
+++ trunk/096/pkg/items/moongates/itemdesc.cfg	2006-01-05 15:34:13 UTC (rev 1098)
@@ -1,4 +1,16 @@
 # System moongate
+
+Item 0x6008
+{
+	Name			permmoongate
+	Graphic			0xF6C
+	Facing			2
+	WalkOnScript		moonGate/walkOn
+	SaveOnExit		1
+	Movable			0
+}
+
+
 Item 0x6201
 {
 	Name           		SystemMoonGate
@@ -19,7 +31,7 @@
 
 	Movable			0
 
-	WalkOnScript		:walkon:teleport/walkOn
+	WalkOnScript		moonGate/walkOn
 }
 
 Item 0xDDA
@@ -29,6 +41,8 @@
 	Facing			2
 
 	Movable			0
+	
+	moonGate/walkOn
 }
 
 Item 0x1FD4
@@ -38,6 +52,8 @@
 	Facing			2
 
 	Movable			0
+	
+	moonGate/walkOn
 }
 
 Item 0x1fe7
@@ -48,4 +64,6 @@
 	Facing			2
 
 	Movable			0
+	
+	moonGate/walkOn
 }
\ No newline at end of file



From austin at berlios.de  Thu Jan  5 16:36:04 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 16:36:04 +0100
Subject: [Poldistro-svn] r1099 - in trunk/096: config pkg/mobiles/oldAI pkg/skills/lockpicking
Message-ID: <200601051536.k05Fa4cO000317@sheep.berlios.de>

Author: austin
Date: 2006-01-05 16:36:04 +0100 (Thu, 05 Jan 2006)
New Revision: 1099

Modified:
   trunk/096/config/itemdesc.cfg
   trunk/096/pkg/mobiles/oldAI/pirate.src
   trunk/096/pkg/skills/lockpicking/itemdesc.cfg
Log:


Modified: trunk/096/config/itemdesc.cfg
===================================================================
--- trunk/096/config/itemdesc.cfg	2006-01-05 15:34:13 UTC (rev 1098)
+++ trunk/096/config/itemdesc.cfg	2006-01-05 15:36:04 UTC (rev 1099)
@@ -240,16 +240,6 @@
 	VendorBuysFor		3
 }
 
-Item 0x14fb
-{
-	Name			lockpick
-	Desc			lockpick%s%
-	Script			pickLock
-	VendorSellsFor		12
-	VendorBuysFor		4
-}
-
-
 Item 0x3946
 {
 	Name			energyfield

Modified: trunk/096/pkg/mobiles/oldAI/pirate.src
===================================================================
--- trunk/096/pkg/mobiles/oldAI/pirate.src	2006-01-05 15:34:13 UTC (rev 1098)
+++ trunk/096/pkg/mobiles/oldAI/pirate.src	2006-01-05 15:36:04 UTC (rev 1099)
@@ -17,7 +17,6 @@
 var me         := npc::Self();
 const aggression  := 250;
 
-include "util/conflicts";
 include "include/OLD/eventID";
 include "include/sysEvent";
 include ":npcutils:names";
@@ -33,10 +32,7 @@
 		me.frozen := 1;
 	endif
     while (1)
-      if( badguy )
-           co_fight();
-        endif
-        var ev;
+       var ev;
         ev := os::wait_for_event( 120 );
         case (ev.type)
 

Modified: trunk/096/pkg/skills/lockpicking/itemdesc.cfg
===================================================================
--- trunk/096/pkg/skills/lockpicking/itemdesc.cfg	2006-01-05 15:34:13 UTC (rev 1098)
+++ trunk/096/pkg/skills/lockpicking/itemdesc.cfg	2006-01-05 15:36:04 UTC (rev 1099)
@@ -0,0 +1,10 @@
+Item 0x14FB
+{
+	Name			lockpick
+	Desc			lockpick%s%
+
+	VendorSellsFor		12
+	VendorBuysFor		4
+	
+	Script			lockPicking
+}



From austin at berlios.de  Thu Jan  5 16:37:30 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 5 Jan 2006 16:37:30 +0100
Subject: [Poldistro-svn] r1100 - in trunk/096: config pkg/items/traps
Message-ID: <200601051537.k05FbUfS000528@sheep.berlios.de>

Author: austin
Date: 2006-01-05 16:37:29 +0100 (Thu, 05 Jan 2006)
New Revision: 1100

Modified:
   trunk/096/config/itemdesc.cfg
   trunk/096/pkg/items/traps/itemdesc.cfg
Log:


Modified: trunk/096/config/itemdesc.cfg
===================================================================
--- trunk/096/config/itemdesc.cfg	2006-01-05 15:36:04 UTC (rev 1099)
+++ trunk/096/config/itemdesc.cfg	2006-01-05 15:37:29 UTC (rev 1100)
@@ -599,14 +599,6 @@
 #####################################
 
 
-Item 0x6204
-{
-	Name			firetrap
-	Graphic			0x1b71
-	WalkOnScript		fireTrap
-	Movable			0
-}
-
 Item 0x7008
 {
 	Name			playervendordeed

Modified: trunk/096/pkg/items/traps/itemdesc.cfg
===================================================================
--- trunk/096/pkg/items/traps/itemdesc.cfg	2006-01-05 15:36:04 UTC (rev 1099)
+++ trunk/096/pkg/items/traps/itemdesc.cfg	2006-01-05 15:37:29 UTC (rev 1100)
@@ -15,6 +15,13 @@
     Damage	3d5
 }
 
+Item 0x6204
+{
+	Name			firetrap
+	Graphic			0x1b71
+	Movable			0
+}
+
 Item 0x1103
 {
     Name	sawtrap1



From austin at berlios.de  Fri Jan  6 22:26:50 2006
From: austin at berlios.de (austin at BerliOS)
Date: Fri, 6 Jan 2006 22:26:50 +0100
Subject: [Poldistro-svn] r1101 - trunk/096/pkg/items/blood/config
Message-ID: <200601062126.k06LQorH002683@sheep.berlios.de>

Author: austin
Date: 2006-01-06 22:26:49 +0100 (Fri, 06 Jan 2006)
New Revision: 1101

Modified:
   trunk/096/pkg/items/blood/config/icp.cfg
Log:
email fix!

Modified: trunk/096/pkg/items/blood/config/icp.cfg
===================================================================
--- trunk/096/pkg/items/blood/config/icp.cfg	2006-01-05 15:37:29 UTC (rev 1100)
+++ trunk/096/pkg/items/blood/config/icp.cfg	2006-01-06 21:26:49 UTC (rev 1101)
@@ -6,7 +6,7 @@
 	Description	Manages creation and removal of blood in the game.
 	
 	Creator		Austin
-	C_Email		Austin at tsse.net
+	C_Email		AustinHeilman at gmail.com
 	
 	Maintainer	
 	M_Email	



From austin at berlios.de  Sat Jan  7 07:38:00 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sat, 7 Jan 2006 07:38:00 +0100
Subject: [Poldistro-svn] r1102 - in trunk/096: config pkg/skills/cartography pkg/skills/cartography/sextant
Message-ID: <200601070638.k076c0Hn016616@sheep.berlios.de>

Author: austin
Date: 2006-01-07 07:37:57 +0100 (Sat, 07 Jan 2006)
New Revision: 1102

Added:
   trunk/096/pkg/skills/cartography/sextant/
   trunk/096/pkg/skills/cartography/sextant/use.src
Modified:
   trunk/096/config/itemdesc.cfg
   trunk/096/pkg/skills/cartography/itemdesc.cfg
Log:


Modified: trunk/096/config/itemdesc.cfg
===================================================================
--- trunk/096/config/itemdesc.cfg	2006-01-06 21:26:49 UTC (rev 1101)
+++ trunk/096/config/itemdesc.cfg	2006-01-07 06:37:57 UTC (rev 1102)
@@ -154,15 +154,6 @@
 	Weight			1/10
 }
 
-Item  0x1057
-{
-	Name			Sextant
-	Desc			sextant
-	Script			coords
-	VendorSellsFor		15
-	VendorBuysFor		7
-}
-
 Item 0x1078
 {
 	Name			hides

Modified: trunk/096/pkg/skills/cartography/itemdesc.cfg
===================================================================
--- trunk/096/pkg/skills/cartography/itemdesc.cfg	2006-01-06 21:26:49 UTC (rev 1101)
+++ trunk/096/pkg/skills/cartography/itemdesc.cfg	2006-01-07 06:37:57 UTC (rev 1102)
@@ -1,6 +1,17 @@
 # $Id$
 #
 #
+
+Item  0x1057
+{
+	Name			Sextant
+	Desc			sextant
+	Script			sextant/use
+	VendorSellsFor		15
+	VendorBuysFor		7
+}
+
+
 Item 0x6400
 {
 	Name		mapmakerspen1

Added: trunk/096/pkg/skills/cartography/sextant/use.src
===================================================================
--- trunk/096/pkg/skills/cartography/sextant/use.src	2006-01-06 21:26:49 UTC (rev 1101)
+++ trunk/096/pkg/skills/cartography/sextant/use.src	2006-01-07 06:37:57 UTC (rev 1102)
@@ -0,0 +1,41 @@
+/* $Id$
+ *
+ */
+
+use uo;
+use math;
+
+program useScript(who, sextant)
+	PrintTextAbovePrivate(who, ToSextant(who.x, who.y), who);
+	
+	return 1;
+endprogram
+
+
+function ToSextant(x, y)
+	var latitude_direction, longitude_direction;
+	var latitude_degrees, longitude_degrees;
+	var latitude_minutes, longitude_minutes;
+	
+	latitude_degrees := (y-1624)*0.087890625;
+	longitude_degrees := (x-1323)*0.0703125;
+	
+	if ( latitude_degrees < 0 )
+		latitude_direction := "N";
+	else
+		latitude_direction := "S";
+	endif
+	
+	if ( longitude_degrees < 0 )
+		longitude_direction := "W";
+	else
+		longitude_direction := "E";
+	endif
+	
+	latitude_degrees := Abs(latitude_degrees);
+	longitude_degrees := Abs(longitude_degrees);
+	latitude_minutes := CInt((CInt((latitude_degrees-Floor(latitude_degrees))*100)*60)/100);
+	longitude_minutes := CInt((CInt((longitude_degrees-Floor(longitude_degrees))*100)*60)/100);
+	
+	return(Floor(latitude_degrees) + "o " + latitude_minutes + "'" + latitude_direction + ", " + Floor(longitude_degrees) + "o " + longitude_minutes + "'" + longitude_direction);
+endfunction
\ No newline at end of file



From austin at berlios.de  Sat Jan  7 16:27:15 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sat, 7 Jan 2006 16:27:15 +0100
Subject: [Poldistro-svn] r1103 - in trunk/096/pkg/skills/magery: config include
Message-ID: <200601071527.k07FRF3D027774@sheep.berlios.de>

Author: austin
Date: 2006-01-07 16:27:15 +0100 (Sat, 07 Jan 2006)
New Revision: 1103

Added:
   trunk/096/pkg/skills/magery/config/spells_ex.cfg
   trunk/096/pkg/skills/magery/include/spells_ex.inc
Log:
Support for converting spell names to their ID #.

Added: trunk/096/pkg/skills/magery/config/spells_ex.cfg
===================================================================
--- trunk/096/pkg/skills/magery/config/spells_ex.cfg	2006-01-07 06:37:57 UTC (rev 1102)
+++ trunk/096/pkg/skills/magery/config/spells_ex.cfg	2006-01-07 15:27:15 UTC (rev 1103)
@@ -0,0 +1,6 @@
+Elem	NameToId
+{
+	// Name		ID #
+	Clumsy		1
+	CreateFood	2
+}

Added: trunk/096/pkg/skills/magery/include/spells_ex.inc
===================================================================
--- trunk/096/pkg/skills/magery/include/spells_ex.inc	2006-01-07 06:37:57 UTC (rev 1102)
+++ trunk/096/pkg/skills/magery/include/spells_ex.inc	2006-01-07 15:27:15 UTC (rev 1103)
@@ -0,0 +1,31 @@
+/* $Id$
+ *
+ */
+
+use uo;
+use os;
+use cfgfile;
+
+include ":magery:spells";
+
+/*
+ * MS_SpellNameToId(spell_name)
+ *
+ * Purpose
+ * Converts the name of a spell to its ID number.
+ *
+ * Parameters
+ * spell_name:	Name of the spell to convert
+ *
+ * Return value
+ * Returns an integer if a spell Id was found.
+ * Returns 0 if the spell name is invalid.
+ *
+ */
+  
+function MS_SpellNameToId(spell_name)
+	var spellex_cfg := ReadConfigFile(":magery:config/spells_ex");
+	var cfg_elem := spellex_cfg["NameToId"];
+	
+	return GetConfigInt(cfg_elem, spell_name);
+endfunction



From austin at berlios.de  Sat Jan  7 16:41:26 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sat, 7 Jan 2006 16:41:26 +0100
Subject: [Poldistro-svn] r1104 - in trunk/096/pkg/mobiles/brainAI: . scripts/combat
Message-ID: <200601071541.k07FfQwh029610@sheep.berlios.de>

Author: austin
Date: 2006-01-07 16:41:25 +0100 (Sat, 07 Jan 2006)
New Revision: 1104

Added:
   trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src
Modified:
   trunk/096/pkg/mobiles/brainAI/npcdesc.cfg
Log:
Working on making magic casting npcs work.

Modified: trunk/096/pkg/mobiles/brainAI/npcdesc.cfg
===================================================================
--- trunk/096/pkg/mobiles/brainAI/npcdesc.cfg	2006-01-07 15:27:15 UTC (rev 1103)
+++ trunk/096/pkg/mobiles/brainAI/npcdesc.cfg	2006-01-07 15:41:25 UTC (rev 1104)
@@ -265,7 +265,7 @@
 ##########################################
 # Utility
 ##########################################
-NPCTemplate banker
+NPCTemplate Banker
 {
 	// Primary NPC settings
 	Name			<random> the banker
@@ -319,7 +319,7 @@
 	CProp	GuardKill	i1
 }
 
-NPCTemplate healer
+NPCTemplate Healer
 {
 	// Primary NPC settings
 	Name			<random> the healer
@@ -376,7 +376,7 @@
 ##########################################
 # Animals
 ##########################################
-NPCTemplate cow
+NPCTemplate Cow
 {
 	// Primary NPC settings
 	Name			a cow
@@ -441,7 +441,7 @@
 	// CProps (eww!)
 }
 
-NPCTemplate sheep
+NPCTemplate Sheep
 {
 	// Primary NPC Settings
 	Name			a sheep
@@ -515,3 +515,77 @@
 	CProp  Fame		i1
 }
 
+##########################################
+# Orcs
+##########################################
+
+NPCTemplate OrcMage
+{
+	// Primary NPC information
+	Name			<random> the orc mage
+	Script			:brainAI:brain
+	ObjType			0x11
+	Color			0
+	TrueColor		0
+	Gender			0
+	AR			15
+	RunSpeed		115
+	Alignment		evil
+	Category		Orc
+
+	// Attributes
+	Strength		150
+	Intelligence		145
+	Dexterity		115
+
+	// Vitals
+	HITS			150
+	MANA			145
+	STAM			115
+
+	// Intrinsic Weapon
+	AttackSpeed		30
+	AttackDamage		3d5
+	AttackAttribute		Wrestling
+	AttackHitSound		0x1B3
+	AttackMissSound		0x239
+	AttackHitScript		:combat:mainHitScript
+	
+	// Brain AI Settings
+	AISetting	AreaSize	i10
+	AISetting	CycleWait	i10
+	AISetting	FleeLevel	i10 // 10%
+	AISetting	IdleTicks	i10
+	AISetting	SleepWait	i100
+	AISetting	SpellWords	i1
+
+	// Brain AI Nerves
+	AIScript	Combat		:brainAI:scripts/combat/spellCombat
+	AIScript	EnterArea	:brainAI:bundled/exampleNPC/enteredArea
+	AIScript	Init		:brainAI:bundled/exampleNPC/init
+	AIScript	LeftArea	:brainAI:bundled/exampleNPC/leftArea
+	AIScript	LookAround	:brainAI:bundled/exampleNPC/lookAround
+	AIScript	Sleep		:brainAI:bundled/exampleNPC/sleep
+	AIScript	ShouldWatch	:brainAI:bundled/exampleNPC/shouldWatch
+	AIScript	EndFight	:brainAI:bundled/exampleNPC/endFight
+
+	// Skinning Info
+	// Skinning	ItemName	Amount
+	Skinning	RawRibs		1
+
+	// Settings other scripts use...
+	NameTemplate	Orc
+	Spell		MagicArrow	10
+	Spell		Telekinesis	5
+	Spell		Paralyze	5
+	Spell		Curse		5
+	Spell		Harm		15
+	Spell		Poison		5
+	Spell		FireBall	15
+	Spell		Lightning	15
+	Spell		EBolt		10
+	Spell		Explosion	10
+	Spell		FlameStrike	5
+
+	// CProps (eww!)
+}

Added: trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src	2006-01-07 15:27:15 UTC (rev 1103)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src	2006-01-07 15:41:25 UTC (rev 1104)
@@ -0,0 +1,124 @@
+/*
+ * $Id*
+ *
+ */
+
+use uo;
+use os;
+
+include ":brainAI:npcNerves";
+include ":brainAI:npcCommands";
+include ":attributes:attributes";
+include ":magery:spells_ex";
+include "include/shapes";
+include "include/client";
+include "include/sounds";
+include "include/facings";
+include "include/damage";
+
+program BrainNerve(params)
+	var npc		:= params[1];
+	var nerve_name	:= params[2];
+	var event	:= params[3];
+	var settings	:= params[4];
+	var scripts	:= params[5];
+	params := 0; // Not needed anymore.
+
+	//Store it here so it does not have to do the math over and over.
+	var flee_level := AP_GetVitalMaximumValue(npc, "Hits") * (CDbl(settings["FleeLevel"])/100.0);
+	
+	var opponent := event.source;
+	var flee_mode := 0;
+
+	AI_SetOpponent(npc, opponent);
+
+	while( npc )
+		var dist := Distance(npc, opponent);
+		if ( ShouldFlee(npc, flee_level, flee_mode) )
+			flee_mode := 1;
+			AI_WarMode(npc, 0);
+			AI_Move(npc, opponent, NEMOVE_AWAY, NEMOVE_RUN, WAKEUP, 100);
+		elseif ( DoneFighting(npc, opponent, dist) )
+			if ( scripts.Exists("EndFight") )
+				params := array{opponent, settings, scripts};
+				AI_StartNerve(npc, "EndFight", scripts["EndFight"].script, params);
+			else
+				AI_WarMode(npc, 0);
+			endif
+			AI_EndNerve(npc, nerve_name);
+		elseif ( dist <= settings["MinRange"] )
+			AI_Move(npc, opponent, NEMOVE_AWAY, NEMOVE_RUN, WAKEUP, (settings["MinRange"]-dist));
+		elseif( dist > settings["MaxRange"] )
+			AI_Move(npc, opponent, NEMOVE_TOWARD, NEMOVE_RUN, WAKEUP, (dist-settings["MaxRange"]));
+		else
+			npc.facing := GetFacing(npc.x, npc.y, opponent.x, opponent.y);
+		endif
+
+		SpecialAttack(npc, opponent, dist);
+
+		sleepms(400);
+		AI_ClearThoughts(npc, CLR_NERVE);
+	endwhile
+endprogram
+
+function DoneFighting(npc, opponent, byref dist)
+	if ( opponent.dead )
+		return 1;
+	elseif ( !opponent )
+		return 1;
+	elseif ( opponent.hidden )
+		return 1;
+	elseif ( opponent.concealed > npc.cmdlevel )
+		return 1;
+	elseif ( dist > 20 )
+		return 1;
+	elseif ( dist > 10 && !CheckLineOfSight(npc, opponent) )
+		return 1;
+	endif
+
+	return 0;
+endfunction
+
+function ShouldFlee(npc, byref flee_level, byref flee_mode)
+	if ( flee_mode )
+		return 1;
+	elseif ( AP_GetVital(npc, "Hits") < flee_level )
+		return 1;
+	endif
+
+	return 0;
+endfunction
+
+function SpecialAttack(npc, opponent, byref dist)
+	if ( GetObjProperty(npc, "#medding") )
+		return 0;
+	elseif ( CInt(GetObjProperty(npc, "#NextCast")) > ReadGameClock() )
+		return 0;
+	elseif ( AP_GetVital(npc, MANA) <= 10 )
+		return 0;
+	elseif ( !CheckLineOfSight(npc, opponent) )
+		return 0;
+	elseif ( dist > 16 )
+		return 0;
+	endif
+	
+	var npc_elem := NPC_GetNPCConfig(npc.npctemplate);
+	var spell_list := GetConfigStringArray(npc_elem, "Spell");
+	var cast_spell := spell_list[RandomInt(spell_list.Size())+1];
+	cast_spell := SplitWords(cast_spell);
+	var spell_id := MS_SpellNameToId(cast_spell[1]);
+	
+	if ( !spell_id )
+		return 0;
+	elseif ( RandomInt(100) > CInt(cast_spell[2]) )
+		return 0;
+	endif
+	
+	var script := Start_Script(":magery:spellStarter", {npc, spell_id, 0, opponent});
+	if ( script.errortext )
+		PrintTextAbove(npc, script.errortext);
+		return 0;
+	endif
+	
+	return 1;
+endfunction
\ No newline at end of file



From austin at berlios.de  Sat Jan  7 16:41:53 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sat, 7 Jan 2006 16:41:53 +0100
Subject: [Poldistro-svn] r1105 - trunk/096/batchfiles
Message-ID: <200601071541.k07FfroP029677@sheep.berlios.de>

Author: austin
Date: 2006-01-07 16:41:53 +0100 (Sat, 07 Jan 2006)
New Revision: 1105

Modified:
   trunk/096/batchfiles/ecompile.bat
Log:
Finally got around to adding Tiko's compile directory addition.

Modified: trunk/096/batchfiles/ecompile.bat
===================================================================
--- trunk/096/batchfiles/ecompile.bat	2006-01-07 15:41:25 UTC (rev 1104)
+++ trunk/096/batchfiles/ecompile.bat	2006-01-07 15:41:53 UTC (rev 1105)
@@ -14,16 +14,18 @@
 ECHO ========================
 ECHO Command        Purpose
 ECHO  [ a ] - Compile a specific script.
-ECHO  [ b ] - Compile all .src scripts.
-ECHO  [ c ] - Compile all scripts and output to POL\ecompile.log
+ECHO  [ b ] - Compile a directory.
+ECHO  [ c ] - Compile all .src scripts.
+ECHO  [ d ] - Compile all scripts and output to POL\ecompile.log
 ECHO.
 ECHO  [ x ] - Back
 
 SET /p CMD=Command:
 
 IF /i "%CMD%" == "a" GOTO :COMPILE_SCRIPT()
-IF /i "%CMD%" == "b" GOTO :COMPILE_ALL_SCRIPTS()
-IF /i "%CMD%" == "c" GOTO :COMPILE_ALL_SCRIPTS_OPTXT()
+IF /i "%CMD%" == "b" GOTO :COMPILE_DIRECTORY()
+IF /i "%CMD%" == "c" GOTO :COMPILE_ALL_SCRIPTS()
+IF /i "%CMD%" == "d" GOTO :COMPILE_ALL_SCRIPTS_OPTXT()
 IF /i "%CMD%" == "x" GOTO :QUIT()
 
 ECHO.
@@ -41,6 +43,12 @@
 %ECOMPILE_PATH% %CMD%
 GOTO RETURN_TO_MENU()
 
+REM -- COMPILE_DIRECTORY() FUNCTION
+:COMPILE_DIRECTORY()
+SET /p CMD="Path to DIRECTORY:"
+%ECOMPILE_PATH% -b -r %CMD%
+GOTO RETURN_TO_MENU()
+
 REM -- COMPILE_ALL_SCRIPTS() FUNCTION
 :COMPILE_ALL_SCRIPTS()
 %ECOMPILE_PATH% -b -r



From austin at berlios.de  Sat Jan  7 16:53:30 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sat, 7 Jan 2006 16:53:30 +0100
Subject: [Poldistro-svn] r1106 - in trunk/096/pkg/mobiles/brainAI: . scripts/combat
Message-ID: <200601071553.k07FrUkh030771@sheep.berlios.de>

Author: austin
Date: 2006-01-07 16:53:29 +0100 (Sat, 07 Jan 2006)
New Revision: 1106

Modified:
   trunk/096/pkg/mobiles/brainAI/npcdesc.cfg
   trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src
Log:


Modified: trunk/096/pkg/mobiles/brainAI/npcdesc.cfg
===================================================================
--- trunk/096/pkg/mobiles/brainAI/npcdesc.cfg	2006-01-07 15:41:53 UTC (rev 1105)
+++ trunk/096/pkg/mobiles/brainAI/npcdesc.cfg	2006-01-07 15:53:29 UTC (rev 1106)
@@ -558,6 +558,9 @@
 	AISetting	IdleTicks	i10
 	AISetting	SleepWait	i100
 	AISetting	SpellWords	i1
+	AISetting	CastWait	i6
+	AISetting	MinRange	i1
+	AISetting	MaxRange	i10
 
 	// Brain AI Nerves
 	AIScript	Combat		:brainAI:scripts/combat/spellCombat

Modified: trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src	2006-01-07 15:41:53 UTC (rev 1105)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src	2006-01-07 15:53:29 UTC (rev 1106)
@@ -46,7 +46,7 @@
 				AI_WarMode(npc, 0);
 			endif
 			AI_EndNerve(npc, nerve_name);
-		elseif ( dist <= settings["MinRange"] )
+		elseif ( dist < settings["MinRange"] )
 			AI_Move(npc, opponent, NEMOVE_AWAY, NEMOVE_RUN, WAKEUP, (settings["MinRange"]-dist));
 		elseif( dist > settings["MaxRange"] )
 			AI_Move(npc, opponent, NEMOVE_TOWARD, NEMOVE_RUN, WAKEUP, (dist-settings["MaxRange"]));
@@ -54,7 +54,7 @@
 			npc.facing := GetFacing(npc.x, npc.y, opponent.x, opponent.y);
 		endif
 
-		SpecialAttack(npc, opponent, dist);
+		SpecialAttack(npc, opponent, settings, dist);
 
 		sleepms(400);
 		AI_ClearThoughts(npc, CLR_NERVE);
@@ -89,7 +89,7 @@
 	return 0;
 endfunction
 
-function SpecialAttack(npc, opponent, byref dist)
+function SpecialAttack(npc, opponent, byref settings, byref dist)
 	if ( GetObjProperty(npc, "#medding") )
 		return 0;
 	elseif ( CInt(GetObjProperty(npc, "#NextCast")) > ReadGameClock() )
@@ -98,7 +98,7 @@
 		return 0;
 	elseif ( !CheckLineOfSight(npc, opponent) )
 		return 0;
-	elseif ( dist > 16 )
+	elseif ( dist > settings["MaxRange"] )
 		return 0;
 	endif
 	
@@ -120,5 +120,7 @@
 		return 0;
 	endif
 	
+	SetObjProperty(npc, "#NextCast", ReadGameClock()+settings["CastWait"]);
+	
 	return 1;
 endfunction
\ No newline at end of file



From austin at berlios.de  Sun Jan  8 03:59:43 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 8 Jan 2006 03:59:43 +0100
Subject: [Poldistro-svn] r1107 - trunk/096/pkg/items/vomit/config
Message-ID: <200601080259.k082xhqv023097@sheep.berlios.de>

Author: austin
Date: 2006-01-08 03:59:29 +0100 (Sun, 08 Jan 2006)
New Revision: 1107

Modified:
   trunk/096/pkg/items/vomit/config/icp.cfg
Log:
Fixed email address.

Modified: trunk/096/pkg/items/vomit/config/icp.cfg
===================================================================
--- trunk/096/pkg/items/vomit/config/icp.cfg	2006-01-07 15:53:29 UTC (rev 1106)
+++ trunk/096/pkg/items/vomit/config/icp.cfg	2006-01-08 02:59:29 UTC (rev 1107)
@@ -5,7 +5,7 @@
 	Description	Manages creation and removal of vomit tiles.
 		
 	Creator		Austin Heilman
-	C_Email		Austin at tsse.net
+	C_Email		AustinHeilman at gmail.com
 	
 	Maintainer	
 	M_Email		



From austin at berlios.de  Mon Jan  9 03:25:19 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 03:25:19 +0100
Subject: [Poldistro-svn] r1108 - trunk/096/pkg/mobiles/brainAI/scripts/combat
Message-ID: <200601090225.k092PJO4023080@sheep.berlios.de>

Author: austin
Date: 2006-01-09 03:25:10 +0100 (Mon, 09 Jan 2006)
New Revision: 1108

Added:
   trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src
Log:
Generic combat script for archery/melee.

Added: trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src	2006-01-08 02:59:29 UTC (rev 1107)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src	2006-01-09 02:25:10 UTC (rev 1108)
@@ -0,0 +1,108 @@
+/*
+ * $Id*
+ *
+ */
+
+use uo;
+use os;
+
+include ":brainAI:npcNerves";
+include ":brainAI:npcCommands";
+include ":attributes:attributes";
+include ":magery:spells_ex";
+include ":combat:weaponInfo";
+include "include/shapes";
+include "include/client";
+include "include/sounds";
+include "include/facings";
+include "include/damage";
+
+program BrainNerve(params)
+	var npc		:= params[1];
+	var nerve_name	:= params[2];
+	var event	:= params[3];
+	var settings	:= params[4];
+	var scripts	:= params[5];
+	params := 0; // Not needed anymore.
+
+	//Store it here so it does not have to do the math over and over.
+	var flee_level := AP_GetVitalMaximumValue(npc, "Hits") * (CDbl(settings["FleeLevel"])/100.0);
+	
+	var opponent := event.source;
+	var flee_mode := 0;
+
+	AI_SetOpponent(npc, opponent);
+	
+	var min_range, max_range;
+	SetupRanges(npc, min_range, max_range);
+	
+	while( npc )
+		var dist := Distance(npc, opponent);
+		if ( ShouldFlee(npc, flee_level, flee_mode) )
+			flee_mode := 1;
+			AI_WarMode(npc, 0);
+			AI_Move(npc, opponent, NEMOVE_AWAY, NEMOVE_RUN, WAKEUP, 100);
+		elseif ( DoneFighting(npc, opponent, dist) )
+			if ( scripts.Exists("EndFight") )
+				params := array{opponent, settings, scripts};
+				AI_StartNerve(npc, "EndFight", scripts["EndFight"].script, params);
+			else
+				AI_WarMode(npc, 0);
+			endif
+			AI_EndNerve(npc, nerve_name);
+		elseif ( dist < min_range )
+			AI_Move(npc, opponent, NEMOVE_AWAY, NEMOVE_RUN, WAKEUP, (settings["MinRange"]-dist));
+		elseif( dist > max_range )
+			AI_Move(npc, opponent, NEMOVE_TOWARD, NEMOVE_RUN, WAKEUP, (dist-settings["MaxRange"]));
+		else
+			npc.facing := GetFacing(npc.x, npc.y, opponent.x, opponent.y);
+		endif
+		
+		//To-Do:
+		// If using archery and out of ammo or can't use missile weapon
+		// switch to a melee weapon and call SetupRanges() again
+		//
+
+		sleepms(400);
+		AI_ClearThoughts(npc, CLR_NERVE);
+	endwhile
+endprogram
+
+function DoneFighting(npc, opponent, byref dist)
+	if ( opponent.dead )
+		return 1;
+	elseif ( !opponent )
+		return 1;
+	elseif ( opponent.hidden )
+		return 1;
+	elseif ( opponent.concealed > npc.cmdlevel )
+		return 1;
+	elseif ( dist > 20 )
+		return 1;
+	elseif ( dist > 10 && !CheckLineOfSight(npc, opponent) )
+		return 1;
+	endif
+
+	return 0;
+endfunction
+
+function ShouldFlee(npc, byref flee_level, byref flee_mode)
+	if ( flee_mode )
+		return 1;
+	elseif ( AP_GetVital(npc, "Hits") < flee_level )
+		return 1;
+	endif
+
+	return 0;
+endfunction
+
+function SetupRanges(npc, byref min_range, byref max_range)
+	// To support having distance for archery weapons or being close up for a melee weapon.
+	min_range := CInt(CS_GetWeaponInfo(npc.weapon, "MinRange"));
+	max_range := CInt(CS_GetWeaponInfo(npc.weapon, "MaxRange"));
+	if ( !max_range )
+		max_range := 1;
+	endif
+	
+	return 1;
+endfunction
\ No newline at end of file



From austin at berlios.de  Mon Jan  9 03:41:54 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 03:41:54 +0100
Subject: [Poldistro-svn] r1109 - trunk/096/pkg/mobiles/brainAI/include
Message-ID: <200601090241.k092fs1g029971@sheep.berlios.de>

Author: austin
Date: 2006-01-09 03:41:34 +0100 (Mon, 09 Jan 2006)
New Revision: 1109

Added:
   trunk/096/pkg/mobiles/brainAI/include/commonFunctions.inc
Log:
Functions to make some nerve scripts less redundant.

Added: trunk/096/pkg/mobiles/brainAI/include/commonFunctions.inc
===================================================================
--- trunk/096/pkg/mobiles/brainAI/include/commonFunctions.inc	2006-01-09 02:25:10 UTC (rev 1108)
+++ trunk/096/pkg/mobiles/brainAI/include/commonFunctions.inc	2006-01-09 02:41:34 UTC (rev 1109)
@@ -0,0 +1,66 @@
+/* $Id$
+ * 
+ * Description
+ * Common code found in just about every nerve script.
+ * This include file exists to reduce redundancy.
+ * 
+ */
+
+use uo;
+
+include ":attributes:attributes";
+
+ 
+//==========
+// Non nerve specific functions
+//==========
+
+
+
+//==========
+// Combat Nerve Functions
+//==========
+
+/* NPC_GetFleeLevel(npc, flee_percent)
+ * 
+ * Purpose
+ * Calculates the hit point level when an npc should run away.
+ *
+ * Parameters
+ * npc:			NPC that the nerve belongs to. 
+ * flee_percent:	Percentage of hit points that the NPC will flee at.
+ *
+ * Return Value
+ * Returns an integer.
+ *
+ */
+function NPC_GetFleeLevel(npc, flee_percent)
+	return CInt(CDbl(AP_GetVitalMaximumValue(npc, "Hits")) * (CDbl(flee_percent)/100.0));
+endfunction
+
+/* NPC_SetupRanges(npc, min_range, max_range)
+ *
+ * Purpose
+ * Sets up the minimum and maximum distances the npc will allow its self to be
+ * in relation to its opponent. These are based on its weapon settings.
+ *
+ * Parameters
+ * NPC:		NPC the nerve belongs to.
+ * min_range:	Minimum range variable to set.
+ * max_range:	Maximum range variable to set.
+ *
+ * Return value
+ * No return value.
+ *
+ */
+function NPC_WeaponRanges(npc, byref min_range, byref max_range)
+	// To support having distance for archery weapons or being close up for a melee weapon.
+	min_range := CInt(CS_GetWeaponInfo(npc.weapon, "MinRange"));
+	max_range := CInt(CS_GetWeaponInfo(npc.weapon, "MaxRange"));
+	if ( !max_range )
+		max_range := 1;
+	endif
+	
+	return 1;
+endfunction
+



From austin at berlios.de  Mon Jan  9 05:17:48 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 05:17:48 +0100
Subject: [Poldistro-svn] r1110 - trunk/096/pkg/mobiles/brainAI/scripts/combat
Message-ID: <200601090417.k094HmV8014779@sheep.berlios.de>

Author: austin
Date: 2006-01-09 05:17:47 +0100 (Mon, 09 Jan 2006)
New Revision: 1110

Modified:
   trunk/096/pkg/mobiles/brainAI/scripts/combat/fireBeetle.src
   trunk/096/pkg/mobiles/brainAI/scripts/combat/genericAnimal.src
   trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src
   trunk/096/pkg/mobiles/brainAI/scripts/combat/rigger.src
   trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src
Log:
Updated to support commonFunctions.inc

Modified: trunk/096/pkg/mobiles/brainAI/scripts/combat/fireBeetle.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/fireBeetle.src	2006-01-09 02:41:34 UTC (rev 1109)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/fireBeetle.src	2006-01-09 04:17:47 UTC (rev 1110)
@@ -8,6 +8,7 @@
 
 include ":brainAI:npcNerves";
 include ":brainAI:npcCommands";
+include ":brainAI:commonFunctions";
 include ":attributes:attributes";
 include "include/shapes";
 include "include/client";
@@ -24,7 +25,7 @@
 	params := 0; // Not needed anymore.
 
 	//Store it here so it does not have to do the math over and over.
-	var flee_level := AP_GetVitalMaximumValue(npc, "Hits") * (CDbl(settings["FleeLevel"])/100.0);
+	var flee_level := NPC_GetFleeLevel(npc, settings["FleeLevel"]);
 
 	var opponent := event.source;
 	var flee_mode := 0;

Modified: trunk/096/pkg/mobiles/brainAI/scripts/combat/genericAnimal.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/genericAnimal.src	2006-01-09 02:41:34 UTC (rev 1109)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/genericAnimal.src	2006-01-09 04:17:47 UTC (rev 1110)
@@ -6,6 +6,7 @@
 
 include ":brainAI:npcNerves";
 include ":brainAI:npcCommands";
+include ":brainAI:commonFunctions";
 include ":attributes:attributes";
 
 program BrainNerve(params)
@@ -17,7 +18,7 @@
 	params := 0; // Not needed anymore.
 
 	//Store it here so it does not have to do the math over and over.
-	var flee_level := AP_GetVitalMaximumValue(npc, "Hits") * (CDbl(settings["FleeLevel"])/100.0);
+	var flee_level := NPC_GetFleeLevel(npc, settings["FleeLevel"]);
 
 	var opponent := event.source;
 	var flee_mode := 0;

Modified: trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src	2006-01-09 02:41:34 UTC (rev 1109)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src	2006-01-09 04:17:47 UTC (rev 1110)
@@ -8,12 +8,9 @@
 
 include ":brainAI:npcNerves";
 include ":brainAI:npcCommands";
+include ":brainAI:commonFunctions";
 include ":attributes:attributes";
-include ":magery:spells_ex";
 include ":combat:weaponInfo";
-include "include/shapes";
-include "include/client";
-include "include/sounds";
 include "include/facings";
 include "include/damage";
 
@@ -26,7 +23,7 @@
 	params := 0; // Not needed anymore.
 
 	//Store it here so it does not have to do the math over and over.
-	var flee_level := AP_GetVitalMaximumValue(npc, "Hits") * (CDbl(settings["FleeLevel"])/100.0);
+	var flee_level := NPC_GetFleeLevel(npc, settings["FleeLevel"]);
 	
 	var opponent := event.source;
 	var flee_mode := 0;
@@ -34,7 +31,7 @@
 	AI_SetOpponent(npc, opponent);
 	
 	var min_range, max_range;
-	SetupRanges(npc, min_range, max_range);
+	NPC_WeaponRanges(npc, byref min_range, byref max_range);
 	
 	while( npc )
 		var dist := Distance(npc, opponent);
@@ -95,14 +92,3 @@
 
 	return 0;
 endfunction
-
-function SetupRanges(npc, byref min_range, byref max_range)
-	// To support having distance for archery weapons or being close up for a melee weapon.
-	min_range := CInt(CS_GetWeaponInfo(npc.weapon, "MinRange"));
-	max_range := CInt(CS_GetWeaponInfo(npc.weapon, "MaxRange"));
-	if ( !max_range )
-		max_range := 1;
-	endif
-	
-	return 1;
-endfunction
\ No newline at end of file

Modified: trunk/096/pkg/mobiles/brainAI/scripts/combat/rigger.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/rigger.src	2006-01-09 02:41:34 UTC (rev 1109)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/rigger.src	2006-01-09 04:17:47 UTC (rev 1110)
@@ -5,6 +5,7 @@
 
 include ":brainAI:npcNerves";
 include ":brainAI:npcCommands";
+include ":brainAI:commonFunctions";
 include ":attributes:attributes";
 include ":timedscripts:timedScripts";
 
@@ -17,7 +18,7 @@
 	params := 0; // Not needed anymore.
 
 	//Store it here so it does not have to do the math over and over.
-	var flee_level := AP_GetVitalMaximumValue(npc, "Hits") * (CDbl(settings["FleeLevel"])/100.0);
+	var flee_level := NPC_GetFleeLevel(npc, settings["FleeLevel"]);
 	
 	var opponent := event.source;
 	var flee_mode := 0;

Modified: trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src	2006-01-09 02:41:34 UTC (rev 1109)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/spellCombat.src	2006-01-09 04:17:47 UTC (rev 1110)
@@ -8,11 +8,9 @@
 
 include ":brainAI:npcNerves";
 include ":brainAI:npcCommands";
+include ":brainAI:commonFunctions";
 include ":attributes:attributes";
 include ":magery:spells_ex";
-include "include/shapes";
-include "include/client";
-include "include/sounds";
 include "include/facings";
 include "include/damage";
 
@@ -25,7 +23,7 @@
 	params := 0; // Not needed anymore.
 
 	//Store it here so it does not have to do the math over and over.
-	var flee_level := AP_GetVitalMaximumValue(npc, "Hits") * (CDbl(settings["FleeLevel"])/100.0);
+	var flee_level := NPC_GetFleeLevel(npc, settings["FleeLevel"]);
 	
 	var opponent := event.source;
 	var flee_mode := 0;



From austin at berlios.de  Mon Jan  9 05:26:25 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 05:26:25 +0100
Subject: [Poldistro-svn] r1111 - trunk/096/pkg/mobiles/brainAI/scripts/combat
Message-ID: <200601090426.k094QPSi015791@sheep.berlios.de>

Author: austin
Date: 2006-01-09 05:26:25 +0100 (Mon, 09 Jan 2006)
New Revision: 1111

Added:
   trunk/096/pkg/mobiles/brainAI/scripts/combat/runAway.src
Log:
For NPCs that run away when attacked.

Added: trunk/096/pkg/mobiles/brainAI/scripts/combat/runAway.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/runAway.src	2006-01-09 04:17:47 UTC (rev 1110)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/runAway.src	2006-01-09 04:26:25 UTC (rev 1111)
@@ -0,0 +1,79 @@
+/* $Id: genericAnimal.src 1110 2006-01-09 04:17:47Z austin $
+ *
+ */
+use uo;
+use os;
+
+include ":brainAI:npcNerves";
+include ":brainAI:npcCommands";
+
+program BrainNerve(params)
+	var npc		:= params[1];
+	var nerve_name	:= params[2];
+	var event	:= params[3];
+	var settings	:= params[4];
+	var scripts	:= params[5];
+	params := 0; // Not needed anymore.
+	
+	var opponent := event.source;
+
+	while ( npc )
+		var dist := Distance(npc, opponent);
+		if ( DoneFighting(npc, opponent, dist) )
+			if ( scripts.Exists("EndFight") )
+				params := array{opponent, settings, scripts};
+				AI_StartNerve(npc, "EndFight", scripts["EndFight"].script, params);
+			else
+				AI_WarMode(npc, 0);
+			endif
+			AI_EndNerve(npc, nerve_name);
+		else
+			AI_Move(npc, opponent, NEMOVE_AWAY, NEMOVE_RUN, WAKEUP, 100);
+		endif
+		
+		sleepms(400);
+		While ( Events_Waiting() )
+			CheckForEvent(npc, event);
+		endwhile
+	endwhile
+endprogram
+
+function DoneFighting(npc, opponent, byref dist)
+	if ( opponent.dead )
+		return 1;
+	elseif ( !opponent )
+		return 1;
+	elseif ( opponent.hidden )
+		return 1;
+	elseif ( opponent.concealed > npc.cmdlevel )
+		return 1;
+	elseif ( dist > 20 )
+		return 1;
+	elseif ( dist > 10 && !CheckLineOfSight(npc, opponent) )
+		return 1;
+	endif
+
+	return 0;
+endfunction
+
+// Need more stuff here, should have events checked for peacemaking
+// and provocation.
+function CheckForEvent(npc, byref event)
+	// Temp added for stopping ecompile spam
+	npc := npc;
+	event := wait_for_event(0);
+	if ( event )
+		var source := event.source;
+		case ( event.type )
+			SYSEVENT_ENGAGED: source := source; // Added temp for stopping ecompile spam
+				break;
+			SYSEVENT_DAMAGED:
+				break;
+			default:
+				break;
+		endcase
+		event := 0;
+	endif
+
+	return 1;
+endfunction



From muaddiblsd at berlios.de  Mon Jan  9 10:05:33 2006
From: muaddiblsd at berlios.de (muaddiblsd at BerliOS)
Date: Mon, 9 Jan 2006 10:05:33 +0100
Subject: [Poldistro-svn] r1112 - in trunk/096: . config
Message-ID: <200601090905.k0995XvE003382@sheep.berlios.de>

Author: muaddiblsd
Date: 2006-01-09 10:05:33 +0100 (Mon, 09 Jan 2006)
New Revision: 1112

Modified:
   trunk/096/CoreChanges-096.txt
   trunk/096/config/servspecopt.cfg
Log:


Modified: trunk/096/CoreChanges-096.txt
===================================================================
--- trunk/096/CoreChanges-096.txt	2006-01-09 04:26:25 UTC (rev 1111)
+++ trunk/096/CoreChanges-096.txt	2006-01-09 09:05:33 UTC (rev 1112)
@@ -1,4 +1,10 @@
 -- POL096 --
+01-09 MuadDib
+        Changed: Added check for No Decay timer on items when resetting decay time.
+        Fixed: AOS Tooltips will now correctly show the Reputation of mobiles. In order
+               to see Invul correctly, InvulTag MUST be set to 2 due to the Reputation
+               color being handled fully client-side (No way around this).
+
 12-10 MuadDib
         Changed: Various changes involving item dropping and creation and setting of
                  decayat properties to help with instant decay.

Modified: trunk/096/config/servspecopt.cfg
===================================================================
--- trunk/096/config/servspecopt.cfg	2006-01-09 04:26:25 UTC (rev 1111)
+++ trunk/096/config/servspecopt.cfg	2006-01-09 09:05:33 UTC (rev 1112)
@@ -81,6 +81,9 @@
 # 0x20 = enable common AOS features (tooltip thing/fight system book, but
 #        not AOS monsters/map/skills (0xB9 controls))
 #
+# Be sure to set InvulTag to 2 if using AOSTooltip setting. This is so the Invul
+# color will show correctly in the tooltips.
+#
 UOFeatureEnable=0x00
 
 #
@@ -102,7 +105,7 @@
 # If set to 2 (only use this if your shard is for 3.x+ Clients!) it will remove the
 # invul tag on their name, and make them highlightable as Yellow/Gold instead!
 #
-InvulTag=2
+InvulTag=1
 
 #
 # MaxPathFindRange



From austin at berlios.de  Mon Jan  9 12:00:43 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 12:00:43 +0100
Subject: [Poldistro-svn] r1113 - trunk/096/pkg/skills/magery
Message-ID: <200601091100.k09B0hrk016486@sheep.berlios.de>

Author: austin
Date: 2006-01-09 12:00:42 +0100 (Mon, 09 Jan 2006)
New Revision: 1113

Modified:
   trunk/096/pkg/skills/magery/spells.cfg
Log:
Updated delays to match stratics.

Modified: trunk/096/pkg/skills/magery/spells.cfg
===================================================================
--- trunk/096/pkg/skills/magery/spells.cfg	2006-01-09 09:05:33 UTC (rev 1112)
+++ trunk/096/pkg/skills/magery/spells.cfg	2006-01-09 11:00:42 UTC (rev 1113)
@@ -1,3 +1,9 @@
+# $Id
+#
+# http://uo.stratics.com/content/guides/magic.shtml
+#
+#
+
 Spell 1
 {
 	SpellId		1
@@ -7,7 +13,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	PowerWords	Uus Jux
 	Circle		1
@@ -25,7 +31,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	Circle		1
 	PowerWords	In Mani Ylem
@@ -44,7 +50,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	PowerWords	Rel Wis
 	Circle		1
@@ -62,7 +68,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	PowerWords	In Mani
 	Circle		1
@@ -81,7 +87,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	PowerWords	In Por Ylem
 	Circle		1
@@ -99,7 +105,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	PowerWords	In Lor
 	Circle		1
@@ -117,7 +123,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	PowerWords	Flam Sanct
 	Circle		1
@@ -136,7 +142,7 @@
 
 	Difficulty	1
 	ManaCost	4
-	Delay		1000
+	Delay		500
 
 	PowerWords	Des Mani
 	Circle		1
@@ -154,7 +160,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	Ex Uus
 	Circle		2
@@ -172,7 +178,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	Uus Wis
 	Circle		2
@@ -190,7 +196,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	An Nox
 	Circle		2
@@ -208,7 +214,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	An Mani
 	Circle		2
@@ -226,7 +232,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	In Jux
 	Circle		2
@@ -245,7 +251,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	An Jux
 	Circle		2
@@ -264,7 +270,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	Uus Sanct
 	Circle		2
@@ -283,7 +289,7 @@
 
 	Difficulty	1
 	ManaCost	6
-	Delay		2000
+	Delay		1000
 
 	PowerWords	Uus Mani
 	Circle		2
@@ -301,8 +307,8 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
-
+	Delay		1500
+	
 	PowerWords	Rel Sanct
 	Circle		3
 
@@ -319,7 +325,7 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
+	Delay		1500
 
 	PowerWords	Vas Flam
 	Circle		3
@@ -337,7 +343,7 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
+	Delay		1500
 
 	PowerWords	An Por
 	Circle		3
@@ -356,7 +362,7 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
+	Delay		1500
 
 	PowerWords	In Nox
 	Circle		3
@@ -373,7 +379,7 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
+	Delay		1500
 
 	PowerWords	Ort Por Ylem
 	Circle		3
@@ -391,7 +397,7 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
+	Delay		1500
 
 	PowerWords	Rel Por
 	Circle		3
@@ -409,7 +415,7 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
+	Delay		1500
 
 	PowerWords	Ex Por
 	Circle		3
@@ -427,7 +433,7 @@
 
 	Difficulty	1
 	ManaCost	9
-	Delay		3000
+	Delay		1500
 
 	PowerWords	In Sanct Ylem
 	Circle		3
@@ -445,7 +451,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	Vas An Nox
 	Circle		4
@@ -464,7 +470,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	Vas Uus Sanct
 	Circle		4
@@ -484,7 +490,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	Des Sanct
 	Circle		4
@@ -503,7 +509,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	In Flam Grav
 	Circle		4
@@ -522,7 +528,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	In Vas Mani
 	Circle		4
@@ -542,7 +548,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	Por Ort Grav
 	Circle		4
@@ -561,7 +567,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	Ort Rel
 	Circle		4
@@ -580,7 +586,7 @@
 
 	Difficulty	1
 	ManaCost	11
-	Delay		4000
+	Delay		2000
 
 	PowerWords	Kal Ort Por
 	Circle		4
@@ -599,7 +605,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	In Jux Hur Ylem
 	Circle		5
@@ -618,7 +624,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	An Grav
 	Circle		5
@@ -638,7 +644,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	Kal In Ex
 	Circle		5
@@ -657,7 +663,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	In Jux Sanct
 	Circle		5
@@ -676,7 +682,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	Por Corp Wis
 	Circle		5
@@ -696,7 +702,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	An Ex Por
 	Circle		5
@@ -715,7 +721,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	In Nox Grav
 	Circle		5
@@ -734,7 +740,7 @@
 
 	Difficulty	1
 	ManaCost	14
-	Delay		5000
+	Delay		2500
 
 	PowerWords	Kal Xen
 	Circle		5
@@ -753,7 +759,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	An Ort
 	Circle		6
@@ -772,7 +778,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	Corp Por
 	Circle		6
@@ -790,7 +796,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	Vas Ort Flam
 	Circle		6
@@ -809,7 +815,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	An Lor Xen
 	Circle		6
@@ -827,7 +833,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	Kal Por Ylem
 	Circle		6
@@ -846,7 +852,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	Vas Des Sanct
 	Circle		6
@@ -866,7 +872,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	In Ex Grav
 	Circle		6
@@ -885,7 +891,7 @@
 
 	Difficulty	1
 	ManaCost	20
-	Delay		6000
+	Delay		3000
 
 	PowerWords	Wis  Quas
 	Circle		6
@@ -903,7 +909,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	Vas Ort Grav
 	Circle		7
@@ -923,7 +929,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	In Sanct Grav
 	Circle		7
@@ -943,7 +949,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	Kal Vas Flam
 	Circle		7
@@ -961,7 +967,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	Vas Rel Por
 	Circle		7
@@ -980,7 +986,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	Ort Sanct
 	Circle		7
@@ -1000,7 +1006,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	Vas An Ort
 	Circle		7
@@ -1020,7 +1026,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	Kal Des Flam Ylem
 	Circle		7
@@ -1040,7 +1046,7 @@
 
 	Difficulty	1
 	ManaCost	40
-	Delay		7000
+	Delay		3500
 
 	PowerWords	Vas Ylem Rel
 	Circle		7
@@ -1059,7 +1065,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	PowerWords	In Vas Por
 	Circle		8
@@ -1079,7 +1085,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	PowerWords	Vas Corp Por
 	Animation	0x11
@@ -1100,7 +1106,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	PowerWords	An Corp
 	Circle		8
@@ -1119,7 +1125,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	Animation	0x11
 	PowerWords	Kal Vas Xen Hur
@@ -1139,7 +1145,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	Animation	0x11
 	PowerWords	Kal Vas Xen Corp
@@ -1160,7 +1166,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	Animation	0x11
 	PowerWords	Kal Vas Xen Ylem
@@ -1180,7 +1186,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	Animation	0x11
 	PowerWords	Kal Vas Xen Flam
@@ -1201,7 +1207,7 @@
 
 	Difficulty	1
 	ManaCost	50
-	Delay		8000
+	Delay		4000
 
 	Animation	0x11
 	PowerWords	Kal Vas Xen An Flam



From austin at berlios.de  Mon Jan  9 12:37:35 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 12:37:35 +0100
Subject: [Poldistro-svn] r1114 - in trunk/096/pkg: mobiles/timedScripts mobiles/timedScripts/config mobiles/timedScripts/subScripts mobiles/timedScripts/subScripts/magery skills/magery/spellScripts/circle1
Message-ID: <200601091137.k09BbZaQ030002@sheep.berlios.de>

Author: austin
Date: 2006-01-09 12:37:31 +0100 (Mon, 09 Jan 2006)
New Revision: 1114

Added:
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/clumsy.src
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src
   trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src
Modified:
   trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg
   trunk/096/pkg/mobiles/timedScripts/timerControl.src
Log:
Support for the clumsy spell.


Modified: trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg	2006-01-09 11:00:42 UTC (rev 1113)
+++ trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg	2006-01-09 11:37:31 UTC (rev 1114)
@@ -126,3 +126,15 @@
 	EndMessage		You feel sober again.
 	MaxDuration		300	//  minutes
 }
+
+
+#--=[ Magery Skill ]=-----------------------------
+
+TimerElem clumsy
+{
+	Name			Clumsy
+	Script			subScripts/magery/clumsy
+	CureScript		subScripts/magery/endClumsy
+	
+	NoCure			1
+}

Added: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/clumsy.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/clumsy.src	2006-01-09 11:00:42 UTC (rev 1113)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/clumsy.src	2006-01-09 11:37:31 UTC (rev 1114)
@@ -0,0 +1,32 @@
+/*
+ * $Id$
+ *
+ */
+ 
+use uo;
+use os;
+
+include ":attributes:attributes";
+
+program poisonScript(params)
+	var mobile := params[1];
+	var attacker := params[2];
+	params := 0; // Not needed anymore.
+	
+	if ( GetObjProperty(mobile, "#ClumsyMod") )
+		// Condition is met if the mobile logs out and back in.
+		// Prevents mod from being applied twice.
+		return 0;
+	endif
+	
+	// Stratics reports - ((8 + (Evaluate Intelligence)/10 - (Resist)/10)
+	var cast_points := CInt(AP_GetSkill(attacker, EVALUATING_INTELLIGENCE)) / 10;
+	var defense := CInt(AP_GetSkill(mobile, RESISTING_SPELLS)) / 10;
+	var points := (8 + (cast_points - defense)) * -1;
+	
+	SetObjProperty(mobile, "#ClumsyMod", points);
+	AP_ModifyStatMod(mobile, DEXTERITY, points);
+	
+	return 1;
+endprogram
+

Added: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src	2006-01-09 11:00:42 UTC (rev 1113)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src	2006-01-09 11:37:31 UTC (rev 1114)
@@ -0,0 +1,20 @@
+/*
+ * $Id$
+ *
+ */
+ 
+use uo;
+use os;
+
+include ":attributes:attributes";
+
+program cureScript(params)
+	var mobile := params[1];
+	
+	var points := CInt(GetObjProperty(mobile, "#ClumsyMod"));	
+	AP_ModifyStatMod(mobile, DEXTERITY, points);
+	EraseObjProperty(mobile, "#ClumsyMod");
+	
+	return 1;
+endprogram
+

Modified: trunk/096/pkg/mobiles/timedScripts/timerControl.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/timerControl.src	2006-01-09 11:00:42 UTC (rev 1113)
+++ trunk/096/pkg/mobiles/timedScripts/timerControl.src	2006-01-09 11:37:31 UTC (rev 1114)
@@ -1,3 +1,8 @@
+/*
+ * $Id$
+ *
+ */
+
 use uo;
 use os;
 use util;
@@ -96,7 +101,7 @@
 		KillTimedScript(mobile, timer_list.pid, timer_list, _timer_iter);
 
 		if( elem_info.LogOffScript )
-			var script := start_script(elem_info.LogOffScript, {mobile});
+			var script := start_script(elem_info.LogOffScript, {mobile, "LogOff"});
 			if( script.errortext )
 				Print("Error::LogOff() - ["+elem_info.LogOffScript+"] "+script.errortext);
 			endif

Added: trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src	2006-01-09 11:00:42 UTC (rev 1113)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src	2006-01-09 11:37:31 UTC (rev 1114)
@@ -0,0 +1,31 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+
+include ":attributes:attributes";
+include ":timedscripts:timedScripts";
+include ":magery:spells";
+
+program SpellScript(params)
+	var who := params[1];
+	var info := params[2];
+	params := 0; // No longer needed
+	
+	var targ := MS_Target(who, info.targ, "Select a target.", TGTOPT_CHECK_LOS+TGTOPT_HARMFUL);
+	if ( !targ.IsA(POLCLASS_MOBILE) )
+		SendSysMessage(who, "Cancelled.");
+		return 0;
+	endif
+	
+	//To-Do:
+	// Check for reflection here and if need-be, change the target.
+	
+	// Note: Stratics gives no duration formula - i'm assuming 60 seconds.	
+	TS_StartTimer(targ, "clumsy", 60, who);
+	
+	return 1;
+endprogram



From austin at berlios.de  Mon Jan  9 12:40:02 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 12:40:02 +0100
Subject: [Poldistro-svn] r1115 - trunk/096/pkg/mobiles/timedScripts/subScripts/magery
Message-ID: <200601091140.k09Be2BH032737@sheep.berlios.de>

Author: austin
Date: 2006-01-09 12:40:00 +0100 (Mon, 09 Jan 2006)
New Revision: 1115

Removed:
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src
Log:
will re-add with camelcasing for the file name.

Deleted: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src	2006-01-09 11:37:31 UTC (rev 1114)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endclumsy.src	2006-01-09 11:40:00 UTC (rev 1115)
@@ -1,20 +0,0 @@
-/*
- * $Id$
- *
- */
- 
-use uo;
-use os;
-
-include ":attributes:attributes";
-
-program cureScript(params)
-	var mobile := params[1];
-	
-	var points := CInt(GetObjProperty(mobile, "#ClumsyMod"));	
-	AP_ModifyStatMod(mobile, DEXTERITY, points);
-	EraseObjProperty(mobile, "#ClumsyMod");
-	
-	return 1;
-endprogram
-



From austin at berlios.de  Mon Jan  9 12:42:17 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 12:42:17 +0100
Subject: [Poldistro-svn] r1116 - in trunk/096/pkg/mobiles/timedScripts: config subScripts/magery
Message-ID: <200601091142.k09BgHU1002866@sheep.berlios.de>

Author: austin
Date: 2006-01-09 12:42:10 +0100 (Mon, 09 Jan 2006)
New Revision: 1116

Added:
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endClumsy.src
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endFeebleMind.src
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src
Modified:
   trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg
Log:
Added support for the feebleMind spell.
endClumsy has correct camel casing in the file name.

Modified: trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg	2006-01-09 11:40:00 UTC (rev 1115)
+++ trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg	2006-01-09 11:42:10 UTC (rev 1116)
@@ -95,7 +95,7 @@
 
 #--=[ Odors ]=------------------------------------
 
-TimerElem poostink
+TimerElem pooStink
 {
 	Name			Poo Stink
 	Script			subScripts/odors/poostink
@@ -138,3 +138,12 @@
 	
 	NoCure			1
 }
+
+TimerElem feebleMind
+{
+	Name			Clumsy
+	Script			subScripts/magery/feebleMind
+	CureScript		subScripts/magery/endFeebleMind
+	
+	NoCure			1
+}

Added: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endClumsy.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endClumsy.src	2006-01-09 11:40:00 UTC (rev 1115)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endClumsy.src	2006-01-09 11:42:10 UTC (rev 1116)
@@ -0,0 +1,20 @@
+/*
+ * $Id$
+ *
+ */
+ 
+use uo;
+use os;
+
+include ":attributes:attributes";
+
+program cureScript(params)
+	var mobile := params[1];
+	
+	var points := CInt(GetObjProperty(mobile, "#ClumsyMod"));	
+	AP_ModifyStatMod(mobile, DEXTERITY, points);
+	EraseObjProperty(mobile, "#ClumsyMod");
+	
+	return 1;
+endprogram
+

Added: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endFeebleMind.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endFeebleMind.src	2006-01-09 11:40:00 UTC (rev 1115)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endFeebleMind.src	2006-01-09 11:42:10 UTC (rev 1116)
@@ -0,0 +1,20 @@
+/*
+ * $Id$
+ *
+ */
+ 
+use uo;
+use os;
+
+include ":attributes:attributes";
+
+program cureScript(params)
+	var mobile := params[1];
+	
+	var points := CInt(GetObjProperty(mobile, "#FeebleMindMod"));	
+	AP_ModifyStatMod(mobile, INTELLIGENCE, points);
+	EraseObjProperty(mobile, "#FeebleMindMod");
+	
+	return 1;
+endprogram
+

Added: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src	2006-01-09 11:40:00 UTC (rev 1115)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src	2006-01-09 11:42:10 UTC (rev 1116)
@@ -0,0 +1,32 @@
+/*
+ * $Id$
+ *
+ */
+ 
+use uo;
+use os;
+
+include ":attributes:attributes";
+
+program poisonScript(params)
+	var mobile := params[1];
+	var attacker := params[2];
+	params := 0; // Not needed anymore.
+	
+	if ( GetObjProperty(mobile, "#ClumsyMod") )
+		// Condition is met if the mobile logs out and back in.
+		// Prevents mod from being applied twice.
+		return 0;
+	endif
+	
+	// Stratics reports - ((8 + (Evaluate Intelligence)/10 - (Resist)/10)
+	var cast_points := CInt(AP_GetSkill(attacker, EVALUATING_INTELLIGENCE)) / 10;
+	var defense := CInt(AP_GetSkill(mobile, RESISTING_SPELLS)) / 10;
+	var points := (8 + (cast_points - defense)) * -1;
+	
+	SetObjProperty(mobile, "#FeebleMindMod", points);
+	AP_ModifyStatMod(mobile, INTELLIGENCE, points);
+	
+	return 1;
+endprogram
+



From austin at berlios.de  Mon Jan  9 12:45:15 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 12:45:15 +0100
Subject: [Poldistro-svn] r1117 - trunk/096/scripts/include
Message-ID: <200601091145.k09BjFKQ004663@sheep.berlios.de>

Author: austin
Date: 2006-01-09 12:45:14 +0100 (Mon, 09 Jan 2006)
New Revision: 1117

Modified:
   trunk/096/scripts/include/sounds.inc
Log:
heal sound added

Modified: trunk/096/scripts/include/sounds.inc
===================================================================
--- trunk/096/scripts/include/sounds.inc	2006-01-09 11:42:10 UTC (rev 1116)
+++ trunk/096/scripts/include/sounds.inc	2006-01-09 11:45:14 UTC (rev 1117)
@@ -51,6 +51,7 @@
 	SFX_BIGFOOT_1		:= 0x120,
 	SFX_BIGFOOT_2		:= 0x121,
 	
+	SFX_HEAL		:= 0x1F3,
 	SFX_RESURRECT		:= 0x215
 endenum
 



From austin at berlios.de  Mon Jan  9 12:49:27 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 12:49:27 +0100
Subject: [Poldistro-svn] r1118 - trunk/096/pkg/skills/magery/spellScripts/circle1
Message-ID: <200601091149.k09BnRXk006676@sheep.berlios.de>

Author: austin
Date: 2006-01-09 12:49:25 +0100 (Mon, 09 Jan 2006)
New Revision: 1118

Added:
   trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src
   trunk/096/pkg/skills/magery/spellScripts/circle1/heal.src
Log:
Heal and feebleMind spells.

Added: trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src	2006-01-09 11:45:14 UTC (rev 1117)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src	2006-01-09 11:49:25 UTC (rev 1118)
@@ -0,0 +1,31 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+
+include ":attributes:attributes";
+include ":timedscripts:timedScripts";
+include ":magery:spells";
+
+program SpellScript(params)
+	var who := params[1];
+	var info := params[2];
+	params := 0; // No longer needed
+	
+	var targ := MS_Target(who, info.targ, "Select a target.", TGTOPT_CHECK_LOS+TGTOPT_HARMFUL);
+	if ( !targ.IsA(POLCLASS_MOBILE) )
+		SendSysMessage(who, "Cancelled.");
+		return 0;
+	endif
+	
+	//To-Do:
+	// Check for reflection here and if need-be, change the target.
+	
+	// Note: Stratics gives no duration formula - i'm assuming 60 seconds.	
+	TS_StartTimer(targ, "feebleMind", 60, who);
+	
+	return 1;
+endprogram

Added: trunk/096/pkg/skills/magery/spellScripts/circle1/heal.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/heal.src	2006-01-09 11:45:14 UTC (rev 1117)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/heal.src	2006-01-09 11:49:25 UTC (rev 1118)
@@ -0,0 +1,36 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+
+include ":attributes:attributes";
+include ":timedscripts:timedScripts";
+include ":magery:spells";
+include "include/client";
+include "include/sounds";
+
+program SpellScript(params)
+	var who := params[1];
+	var info := params[2];
+	params := 0; // No longer needed
+	
+	var targ := MS_Target(who, info.targ, "Select a target.", TGTOPT_CHECK_LOS+TGTOPT_HELPFUL);
+	if ( !targ.IsA(POLCLASS_MOBILE) )
+		SendSysMessage(who, "Cancelled.");
+		return 0;
+	endif
+	
+	// Stratics reports - ((Magery / 10) + (1 to 3))
+	var points := (CInt(AP_GetSkill(who, MAGERY)) / 10) + RandomDiceRoll("1d3");
+	
+	PlayObjectCenteredEffect(targ, GFX_BLUE_SPARKLE_SWIRL, 7, 16);
+	PlaySoundEffect(targ, SFX_HEAL);
+	HealDamage(targ, points);
+	
+	SendSysMessage(who, "You healed "+points+" damage.");
+	
+	return 1;
+endprogram



From austin at berlios.de  Mon Jan  9 12:53:17 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 12:53:17 +0100
Subject: [Poldistro-svn] r1119 - in trunk/096/pkg/mobiles/timedScripts: config subScripts/magery
Message-ID: <200601091153.k09BrHNK007512@sheep.berlios.de>

Author: austin
Date: 2006-01-09 12:53:15 +0100 (Mon, 09 Jan 2006)
New Revision: 1119

Added:
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endWeaken.src
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/weaken.src
Modified:
   trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg
   trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src
Log:
Added the weaken spell.
Fixed a cprop oopsie in feebleMind.

Modified: trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg	2006-01-09 11:49:25 UTC (rev 1118)
+++ trunk/096/pkg/mobiles/timedScripts/config/timedScripts.cfg	2006-01-09 11:53:15 UTC (rev 1119)
@@ -141,9 +141,18 @@
 
 TimerElem feebleMind
 {
-	Name			Clumsy
+	Name			Feeble Mind
 	Script			subScripts/magery/feebleMind
 	CureScript		subScripts/magery/endFeebleMind
 	
 	NoCure			1
 }
+
+TimerElem weaken
+{
+	Name			Weaken
+	Script			subScripts/magery/weaken
+	CureScript		subScripts/magery/endWeaken
+	
+	NoCure			1
+}
\ No newline at end of file

Added: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endWeaken.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endWeaken.src	2006-01-09 11:49:25 UTC (rev 1118)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/endWeaken.src	2006-01-09 11:53:15 UTC (rev 1119)
@@ -0,0 +1,20 @@
+/*
+ * $Id$
+ *
+ */
+ 
+use uo;
+use os;
+
+include ":attributes:attributes";
+
+program cureScript(params)
+	var mobile := params[1];
+	
+	var points := CInt(GetObjProperty(mobile, "#WeakenMod"));	
+	AP_ModifyStatMod(mobile, STRENGTH, points);
+	EraseObjProperty(mobile, "#WeakenMod");
+	
+	return 1;
+endprogram
+

Modified: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src	2006-01-09 11:49:25 UTC (rev 1118)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/feebleMind.src	2006-01-09 11:53:15 UTC (rev 1119)
@@ -13,7 +13,7 @@
 	var attacker := params[2];
 	params := 0; // Not needed anymore.
 	
-	if ( GetObjProperty(mobile, "#ClumsyMod") )
+	if ( GetObjProperty(mobile, "#FeebleMindMod") )
 		// Condition is met if the mobile logs out and back in.
 		// Prevents mod from being applied twice.
 		return 0;

Added: trunk/096/pkg/mobiles/timedScripts/subScripts/magery/weaken.src
===================================================================
--- trunk/096/pkg/mobiles/timedScripts/subScripts/magery/weaken.src	2006-01-09 11:49:25 UTC (rev 1118)
+++ trunk/096/pkg/mobiles/timedScripts/subScripts/magery/weaken.src	2006-01-09 11:53:15 UTC (rev 1119)
@@ -0,0 +1,32 @@
+/*
+ * $Id$
+ *
+ */
+ 
+use uo;
+use os;
+
+include ":attributes:attributes";
+
+program poisonScript(params)
+	var mobile := params[1];
+	var attacker := params[2];
+	params := 0; // Not needed anymore.
+	
+	if ( GetObjProperty(mobile, "#WeakenMod") )
+		// Condition is met if the mobile logs out and back in.
+		// Prevents mod from being applied twice.
+		return 0;
+	endif
+	
+	// Stratics reports - ((8 + (Evaluate Intelligence)/10 - (Resist)/10)
+	var cast_points := CInt(AP_GetSkill(attacker, EVALUATING_INTELLIGENCE)) / 10;
+	var defense := CInt(AP_GetSkill(mobile, RESISTING_SPELLS)) / 10;
+	var points := (8 + (cast_points - defense)) * -1;
+	
+	SetObjProperty(mobile, "#WeakenMod", points);
+	AP_ModifyStatMod(mobile, STRENGTH, points);
+	
+	return 1;
+endprogram
+



From austin at berlios.de  Mon Jan  9 14:27:42 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 14:27:42 +0100
Subject: [Poldistro-svn] r1120 - in trunk/096: pkg/skills/magery/spellScripts/circle1 scripts/include
Message-ID: <200601091327.k09DRgUl027382@sheep.berlios.de>

Author: austin
Date: 2006-01-09 14:27:40 +0100 (Mon, 09 Jan 2006)
New Revision: 1120

Added:
   trunk/096/pkg/skills/magery/spellScripts/circle1/heal.ecl
   trunk/096/pkg/skills/magery/spellScripts/circle1/weaken.src
Modified:
   trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src
   trunk/096/pkg/skills/magery/spellScripts/circle1/createFood.src
   trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src
   trunk/096/scripts/include/sounds.inc
Log:
Updated to support sounds and special effect.
Added needed sounds to sounds.inc

Modified: trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src	2006-01-09 11:53:15 UTC (rev 1119)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/clumsy.src	2006-01-09 13:27:40 UTC (rev 1120)
@@ -9,6 +9,8 @@
 include ":attributes:attributes";
 include ":timedscripts:timedScripts";
 include ":magery:spells";
+include "include/client";
+include "include/sounds";
 
 program SpellScript(params)
 	var who := params[1];
@@ -24,6 +26,9 @@
 	//To-Do:
 	// Check for reflection here and if need-be, change the target.
 	
+	PlaySoundEffect(targ, SFX_CURE);
+	PlayObjectCenteredEffect(targ, GFX_RED_SPARKLES, 7, 7);	
+	
 	// Note: Stratics gives no duration formula - i'm assuming 60 seconds.	
 	TS_StartTimer(targ, "clumsy", 60, who);
 	

Modified: trunk/096/pkg/skills/magery/spellScripts/circle1/createFood.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/createFood.src	2006-01-09 11:53:15 UTC (rev 1119)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/createFood.src	2006-01-09 13:27:40 UTC (rev 1120)
@@ -9,6 +9,7 @@
 include ":attributes:attributes";
 include ":magery:spells";
 include ":food&drink:food";
+include "include/sounds";
 
 program SpellScript(params)
 	var who := params[1];
@@ -17,6 +18,8 @@
 	
 	var food_item := RandomFoodObjType();
 	
+	PlaySoundEffect(who, SFX_CREATE_FOOD);
+	
 	var food := CreateItemInBackPack(who, food_item, 1);
 	food.movable := 1;
 	

Modified: trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src	2006-01-09 11:53:15 UTC (rev 1119)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/feebleMind.src	2006-01-09 13:27:40 UTC (rev 1120)
@@ -9,6 +9,8 @@
 include ":attributes:attributes";
 include ":timedscripts:timedScripts";
 include ":magery:spells";
+include "include/client";
+include "include/sounds";
 
 program SpellScript(params)
 	var who := params[1];
@@ -24,6 +26,9 @@
 	//To-Do:
 	// Check for reflection here and if need-be, change the target.
 	
+	PlaySoundEffect(targ, SFX_FEEBLE_MIND);
+	PlayObjectCenteredEffect(targ, GFX_RED_SPARKLES, 7, 7);
+	
 	// Note: Stratics gives no duration formula - i'm assuming 60 seconds.	
 	TS_StartTimer(targ, "feebleMind", 60, who);
 	

Added: trunk/096/pkg/skills/magery/spellScripts/circle1/heal.ecl
===================================================================
(Binary files differ)


Property changes on: trunk/096/pkg/skills/magery/spellScripts/circle1/heal.ecl
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/096/pkg/skills/magery/spellScripts/circle1/weaken.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/weaken.src	2006-01-09 11:53:15 UTC (rev 1119)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/weaken.src	2006-01-09 13:27:40 UTC (rev 1120)
@@ -0,0 +1,36 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+
+include ":attributes:attributes";
+include ":timedscripts:timedScripts";
+include ":magery:spells";
+include "include/client";
+include "include/sounds";
+
+program SpellScript(params)
+	var who := params[1];
+	var info := params[2];
+	params := 0; // No longer needed
+	
+	var targ := MS_Target(who, info.targ, "Select a target.", TGTOPT_CHECK_LOS+TGTOPT_HARMFUL);
+	if ( !targ.IsA(POLCLASS_MOBILE) )
+		SendSysMessage(who, "Cancelled.");
+		return 0;
+	endif
+	
+	//To-Do:
+	// Check for reflection here and if need-be, change the target.
+	
+	PlaySoundEffect(targ, SFX_WEAKEN);
+	PlayObjectCenteredEffect(targ, GFX_RED_SPARKLES, 7, 7);	
+	
+	// Note: Stratics gives no duration formula - i'm assuming 60 seconds.	
+	TS_StartTimer(targ, "weaken", 60, who);
+	
+	return 1;
+endprogram

Modified: trunk/096/scripts/include/sounds.inc
===================================================================
--- trunk/096/scripts/include/sounds.inc	2006-01-09 11:53:15 UTC (rev 1119)
+++ trunk/096/scripts/include/sounds.inc	2006-01-09 13:27:40 UTC (rev 1120)
@@ -50,11 +50,14 @@
 	SFX_BELLOWS		:= 0x2C,
 	SFX_BIGFOOT_1		:= 0x120,
 	SFX_BIGFOOT_2		:= 0x121,
-	
+	SFX_CURE		:= 0x1E1,
+	SFX_CREATE_FOOD		:= 0x1E3,
+	SFX_FEEBLE_MIND		:= 0x1E5,
 	SFX_HEAL		:= 0x1F3,
-	SFX_RESURRECT		:= 0x215
+	SFX_RESURRECT		:= 0x215,
+	SFX_WEAKEN		:= 0x1E7
 endenum
 
 enum CUSTOM_SOUNDS
-	SFX_SPELL_FAIL		:= 0x5D // Really aligator 1
+	SFX_SPELL_FAIL		:= 0x5D // Really SFX_ALIGATOR_1
 endenum
\ No newline at end of file



From austin at berlios.de  Mon Jan  9 14:56:51 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 14:56:51 +0100
Subject: [Poldistro-svn] r1121 - trunk/096/pkg/skills/magery/spellScripts/circle1
Message-ID: <200601091356.k09DupPL001758@sheep.berlios.de>

Author: austin
Date: 2006-01-09 14:56:50 +0100 (Mon, 09 Jan 2006)
New Revision: 1121

Added:
   trunk/096/pkg/skills/magery/spellScripts/circle1/nightSight.src
Log:
night sight spell.. close enough to the description on stratics :P

Added: trunk/096/pkg/skills/magery/spellScripts/circle1/nightSight.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/nightSight.src	2006-01-09 13:27:40 UTC (rev 1120)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/nightSight.src	2006-01-09 13:56:50 UTC (rev 1121)
@@ -0,0 +1,35 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+
+include ":attributes:attributes";
+include ":timedscripts:timedScripts";
+include ":magery:spells";
+include "include/client";
+include "include/sounds";
+
+program SpellScript(params)
+	var who := params[1];
+	var info := params[2];
+	params := 0; // No longer needed
+	
+	var targ := MS_Target(who, info.targ, "Select a target.", TGTOPT_CHECK_LOS+TGTOPT_HARMFUL);
+	if ( !targ.IsA(POLCLASS_MOBILE) )
+		SendSysMessage(who, "Cancelled.");
+		return 0;
+	endif
+		
+	PlaySoundEffect(targ, SFX_BLESS);
+	PlayObjectCenteredEffect(targ, GFX_BLUE_SPARKLES, 10, 10);	
+	
+	// Stratics reports that if the TARGET has less than 10.0 skill, the spell will have no effect.
+	if ( AP_GetSkill(targ, MAGERY) > 10.0 )
+		targ.SetLightLevel(0, CInt(AP_GetSkill(who, MAGERY)) * 60);
+	endif
+	
+	return 1;
+endprogram



From austin at berlios.de  Mon Jan  9 15:40:45 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 15:40:45 +0100
Subject: [Poldistro-svn] r1122 - trunk/096/pkg/skills/magery/spellScripts/circle1
Message-ID: <200601091440.k09EejRT007573@sheep.berlios.de>

Author: austin
Date: 2006-01-09 15:40:45 +0100 (Mon, 09 Jan 2006)
New Revision: 1122

Added:
   trunk/096/pkg/skills/magery/spellScripts/circle1/magicArrow.src
Log:
Skeleton of magic arrow finished.
Stratics isnt specific enough on how it works.

Added: trunk/096/pkg/skills/magery/spellScripts/circle1/magicArrow.src
===================================================================
--- trunk/096/pkg/skills/magery/spellScripts/circle1/magicArrow.src	2006-01-09 13:56:50 UTC (rev 1121)
+++ trunk/096/pkg/skills/magery/spellScripts/circle1/magicArrow.src	2006-01-09 14:40:45 UTC (rev 1122)
@@ -0,0 +1,45 @@
+/*
+ * $Id$
+ *
+ */
+
+use uo;
+use os;
+
+include ":attributes:attributes";
+include ":timedscripts:timedScripts";
+include ":magery:spells";
+include "include/client";
+include "include/sounds";
+include "include/damage";
+
+program SpellScript(params)
+	var who := params[1];
+	var info := params[2];
+	params := 0; // No longer needed
+
+	var targ := MS_Target(who, info.targ, "Select a target.", TGTOPT_CHECK_LOS+TGTOPT_HARMFUL);
+	if ( !targ.IsA(POLCLASS_MOBILE) )
+		SendSysMessage(who, "Cancelled.");
+		return 0;
+	endif
+
+	PlayMovingEffect(who, targ, GFX_SMALL_FIREBALL, 5, 1);
+	PlaySoundEffect(who, SFX_MAGIC_ARROW);
+
+	//To-Do:
+	// Check for reflection here.
+
+	/* From Statics
+	 * Causes up to 14 to 18 Fire damage on a character with no resists.
+	 * Damage depends on caster's Evaluate Intelligence and Inscription skill.
+	 * - UNFORTUNATELY NO SOLID FORMULA IS PROVIDED >:(
+	 */
+	var points := 14 + RandomDiceRoll("1d4");
+	
+	// Figure out resistance here?
+	
+	ApplyDamageEX(targ, points, DMG_FIRE, who);
+
+	return 1;
+endprogram



From austin at berlios.de  Mon Jan  9 15:41:09 2006
From: austin at berlios.de (austin at BerliOS)
Date: Mon, 9 Jan 2006 15:41:09 +0100
Subject: [Poldistro-svn] r1123 - trunk/096/scripts/include
Message-ID: <200601091441.k09Ef96q007702@sheep.berlios.de>

Author: austin
Date: 2006-01-09 15:41:08 +0100 (Mon, 09 Jan 2006)
New Revision: 1123

Modified:
   trunk/096/scripts/include/sounds.inc
Log:
Added more needed sounds for magery.

Modified: trunk/096/scripts/include/sounds.inc
===================================================================
--- trunk/096/scripts/include/sounds.inc	2006-01-09 14:40:45 UTC (rev 1122)
+++ trunk/096/scripts/include/sounds.inc	2006-01-09 14:41:08 UTC (rev 1123)
@@ -50,10 +50,12 @@
 	SFX_BELLOWS		:= 0x2C,
 	SFX_BIGFOOT_1		:= 0x120,
 	SFX_BIGFOOT_2		:= 0x121,
+	SFX_BLESS		:= 0x1EB,
 	SFX_CURE		:= 0x1E1,
 	SFX_CREATE_FOOD		:= 0x1E3,
 	SFX_FEEBLE_MIND		:= 0x1E5,
 	SFX_HEAL		:= 0x1F3,
+	SFX_MAGIC_ARROW		:= 0x1E6,
 	SFX_RESURRECT		:= 0x215,
 	SFX_WEAKEN		:= 0x1E7
 endenum



From austin at berlios.de  Thu Jan 12 12:25:59 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 12 Jan 2006 12:25:59 +0100
Subject: [Poldistro-svn] r1124 - trunk/096/pkg/commands/include
Message-ID: <200601121125.k0CBPxlg005505@sheep.berlios.de>

Author: austin
Date: 2006-01-12 12:25:58 +0100 (Thu, 12 Jan 2006)
New Revision: 1124

Modified:
   trunk/096/pkg/commands/include/goAdd.inc
Log:
Fixes a bug where locations were being stored as a dictionary but accessed as a struct.

Modified: trunk/096/pkg/commands/include/goAdd.inc
===================================================================
--- trunk/096/pkg/commands/include/goAdd.inc	2006-01-09 14:41:08 UTC (rev 1123)
+++ trunk/096/pkg/commands/include/goAdd.inc	2006-01-12 11:25:58 UTC (rev 1124)
@@ -115,7 +115,7 @@
 
 	z := GetMapInfo(x, y, realm).z;
 
-	var temp := dictionary;
+	var temp := struct;
 	temp.+Name := lower(name);
 	temp.+Realm := lower(realm);
 	temp.+X := x;



From austin at berlios.de  Thu Jan 12 12:30:14 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 12 Jan 2006 12:30:14 +0100
Subject: [Poldistro-svn] r1125 - trunk/096/pkg/multis/boat
Message-ID: <200601121130.k0CBUEKk006150@sheep.berlios.de>

Author: austin
Date: 2006-01-12 12:30:08 +0100 (Thu, 12 Jan 2006)
New Revision: 1125

Modified:
   trunk/096/pkg/multis/boat/itemdesc.cfg
Log:
Correctly defines boat multis in the correct 0x4--- object type range (how many distros has this spanded?)

Modified: trunk/096/pkg/multis/boat/itemdesc.cfg
===================================================================
--- trunk/096/pkg/multis/boat/itemdesc.cfg	2006-01-12 11:25:58 UTC (rev 1124)
+++ trunk/096/pkg/multis/boat/itemdesc.cfg	2006-01-12 11:30:08 UTC (rev 1125)
@@ -118,42 +118,42 @@
 // Boats (Multis) 
 //
 
-Boat 0x6040
+Boat 0x4000
 {
 	Name			smallboat
 	Graphic			0x4000
 	MultiID			0x0000
 }
 
-Boat 0x6041
+Boat 0x4004
 {
 	Name			smalldragonboat
 	Graphic			0x4004
 	MultiID			0x0004
 }
 
-Boat 0x6042
+Boat 0x4008
 {
 	Name			mediumboat
 	Graphic			0x4008
 	MultiID			0x0008
 }
 
-Boat 0x6043
+Boat 0x400C
 {
 	Name			mediumdragonboat
 	Graphic			0x400C
 	MultiID			0x000C
 }
 
-Boat 0x6044
+Boat 0x4010
 {
 	Name			largeboat
 	Graphic			0x4010
 	MultiID			0x0010
 }
 
-Boat 0x6045
+Boat 0x4014
 {
 	Name			largedragonboat
 	Graphic			0x4014



From austin at berlios.de  Thu Jan 12 12:32:18 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 12 Jan 2006 12:32:18 +0100
Subject: [Poldistro-svn] r1126 - trunk/096/pkg/multis/boat/plank
Message-ID: <200601121132.k0CBWInW008370@sheep.berlios.de>

Author: austin
Date: 2006-01-12 12:32:10 +0100 (Thu, 12 Jan 2006)
New Revision: 1126

Modified:
   trunk/096/pkg/multis/boat/plank/use.src
Log:
Fixes bug with method script usage.

Modified: trunk/096/pkg/multis/boat/plank/use.src
===================================================================
--- trunk/096/pkg/multis/boat/plank/use.src	2006-01-12 11:30:08 UTC (rev 1125)
+++ trunk/096/pkg/multis/boat/plank/use.src	2006-01-12 11:32:10 UTC (rev 1126)
@@ -21,7 +21,7 @@
 			return 0;
 		endif
 		
-		plank.Extend(who);
+		plank.Extend();
 	endif
 	
 	return 1;



From austin at berlios.de  Thu Jan 12 12:36:23 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 12 Jan 2006 12:36:23 +0100
Subject: [Poldistro-svn] r1127 - trunk/096/scripts/misc
Message-ID: <200601121136.k0CBaN1h013560@sheep.berlios.de>

Author: austin
Date: 2006-01-12 12:36:21 +0100 (Thu, 12 Jan 2006)
New Revision: 1127

Modified:
   trunk/096/scripts/misc/boat.src
Log:
Better output incase the controller script doesn't start.

Modified: trunk/096/scripts/misc/boat.src
===================================================================
--- trunk/096/scripts/misc/boat.src	2006-01-12 11:32:10 UTC (rev 1126)
+++ trunk/096/scripts/misc/boat.src	2006-01-12 11:36:21 UTC (rev 1127)
@@ -9,9 +9,16 @@
  * which can be found in /pkg/systems/boat/
  *
  */
+use uo;
 use os;
 
-
 Program CoreScript_Boat(multi)
-	return start_script(":boat:multi/listener", multi);
+	var result := start_script(":boat:multi/listener", multi);
+	
+	if ( result.errortext )
+		PrintTextAbove(multi, "Error initializing control script");
+		PrintTextAbove(multi, ""+result.errortext);
+	endif
+	
+	return result;
 endprogram



From austin at berlios.de  Thu Jan 12 13:25:12 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 12 Jan 2006 13:25:12 +0100
Subject: [Poldistro-svn] r1128 - in trunk/096/pkg/multis/boat: commands commands/gm include multi tiller
Message-ID: <200601121225.k0CCPCUj006768@sheep.berlios.de>

Author: austin
Date: 2006-01-12 13:25:11 +0100 (Thu, 12 Jan 2006)
New Revision: 1128

Added:
   trunk/096/pkg/multis/boat/commands/gm/
   trunk/096/pkg/multis/boat/commands/gm/restartboat.src
Modified:
   trunk/096/pkg/multis/boat/include/cmdParser.inc
   trunk/096/pkg/multis/boat/multi/listener.src
   trunk/096/pkg/multis/boat/tiller/methods.src
   trunk/096/pkg/multis/boat/tiller/use.src
Log:
Added a command to restart a boat's controller script (.restartboat)
Fixed issues with the parser and listener script.
Boats will now correctly move around and follow commands.



Added: trunk/096/pkg/multis/boat/commands/gm/restartboat.src
===================================================================
--- trunk/096/pkg/multis/boat/commands/gm/restartboat.src	2006-01-12 11:36:21 UTC (rev 1127)
+++ trunk/096/pkg/multis/boat/commands/gm/restartboat.src	2006-01-12 12:25:11 UTC (rev 1128)
@@ -0,0 +1,34 @@
+/* $Id$
+ *
+ *
+ */
+
+use uo;
+use os;
+
+program RestartBoat(who)
+	SendSysMessage(who, "Target the tillerman.");
+	var targ := target(who);
+	
+	if ( !targ.IsTillerMan() )
+		SendSysMessage(who, "Cancelled");
+		return 0;
+	endif
+	
+	var process := GetProcess(GetObjProperty(targ, "#PID"));
+	process.Kill();
+	EraseObjProperty(targ, "#PID");
+	
+	var multi := targ.multi;
+	
+	var result := start_script(":boat:multi/listener", multi);
+	
+	if ( result.errortext )
+		PrintTextAbove(multi.tillerman, "Error initializing control script");
+		PrintTextAbove(multi.tillerman, ""+result.errortext);
+	else
+		SendSysMessage(who, "Done!");
+	endif
+	
+	return result;
+endprogram
\ No newline at end of file

Modified: trunk/096/pkg/multis/boat/include/cmdParser.inc
===================================================================
--- trunk/096/pkg/multis/boat/include/cmdParser.inc	2006-01-12 11:36:21 UTC (rev 1127)
+++ trunk/096/pkg/multis/boat/include/cmdParser.inc	2006-01-12 12:25:11 UTC (rev 1128)
@@ -20,14 +20,18 @@
  * Returns an array of strings.
  *
  */
-function ParseCommands(byref text)
+function ParseCommands(text)
 	var cmd_cfg := ReadConfigFile(":boat:config/commands");
-	var cmd_elem := GetConfigStringArray(cmd_cfg["heirarchy"], "CMD");
+	if ( cmd_cfg.errortext )
+		SysLog("Error - Unable to open :boat:config/commands.cfg");
+		return cmd_cfg;
+	endif	
 	
+	var cmd_list := GetConfigStringArray(cmd_cfg["heirarchy"], "CMD");
 	text := Lower(text);
 		
 	var match := 0, pos := 0;
-	foreach cmd in ( cmd_elem )
+	foreach cmd in ( cmd_list )
 		pos := pos + 1;
 		cmd := Lower(cmd);
 		while ( text[cmd] )
@@ -41,18 +45,18 @@
 		return 0;
 	endif
 
-	var cmd_list := array{};
+	var cmd_order := array{};
 	text := SplitWords(text);
 	foreach cmd in ( text )
 		if ( cmd["[["] && cmd["]]"] )
 			cmd["[["] := "";
 			cmd["]]"] := "";
 			cmd := cmd_list[CInt(cmd)];
-			cmd_list.Append(cmd);
+			cmd_order.Append(cmd);
 		endif
 		sleepms(2);
 	endforeach
 	text := "";
 
-	return cmd_list;
+	return cmd_order;
 endfunction
\ No newline at end of file

Modified: trunk/096/pkg/multis/boat/multi/listener.src
===================================================================
--- trunk/096/pkg/multis/boat/multi/listener.src	2006-01-12 11:36:21 UTC (rev 1127)
+++ trunk/096/pkg/multis/boat/multi/listener.src	2006-01-12 12:25:11 UTC (rev 1128)
@@ -20,7 +20,7 @@
 	while ( boat )
 		var ev;
 		
-		if ( repeat_cmd != -1 && !Events_Waiting() )
+		if ( repeat_cmd == -1 && !Events_Waiting() )
 			while ( !ev )
 				if ( last_sound < polcore().systime-120 )
 					PlaySoundEffect(boat, 0x14);
@@ -41,6 +41,7 @@
 		sleepms(delay);		
 				
 		if ( ev.text )
+			
 			if ( (boat.tillerman).IsOnBoat(boat, ev.source) )
 				if ( (boat.tillerman).CanCommand(ev.source) )
 					var cmd_list := ParseCommands(ev.text);
@@ -63,22 +64,35 @@
 endprogram
 
 function Initialize(boat)
-	while ( !(boat.tillerman).GetOwner() )
-		sleep(2);
-	endwhile
-	
 	SetObjProperty(boat.tillerman, "#PID", GetPid());
 	
-	//ToDo:
-	//Consider checking the size of the boat then set this accordingly.
-	RegisterForSpeechEvents(boat, 15);
+	if ( !(boat.tillerman).GetOwner() )
+		SetName(boat.tillerman, "a tiller man [awaiting owner]");
+		while ( !(boat.tillerman).GetOwner() )
+			sleep(2);
+		endwhile
+		var name := (boat.tillerman).desc;
+		name[" [awaiting owner]"] := "";
+		SetName(boat.tillerman, name);
+	endif
 	
+	// Ensures the boat only listens as far as it needs to from its mid-point (usually the mast)
+	var foot_print := boat.footprint;
+	var bow_dist := CoordinateDistance(foot_print.xmin, foot_print.ymin, boat.x, boat.y);
+	var stern_dist := CoordinateDistance(foot_print.xmax, foot_print.ymax, boat.x, boat.y);
+	if ( bow_dist > stern_dist )
+		foot_print := bow_dist;
+	else
+		foot_print := stern_dist;
+	endif
+	RegisterForSpeechEvents(boat, foot_print);
+	
 	return 1;
 endfunction
 
 function DoCommand(byref boat, byref cmd)
 	var cmd_cfg := ReadConfigFile(":boat:config/commands");
-	var cmd_elem := GetConfigStringArray(cmd_cfg[cmd], "CMD");
+	var cmd_elem := cmd_cfg[cmd];
 	
 	if ( cmd_elem.Anchor == 2 )
 		if ( !(boat.tillerman).IsAnchored() )

Modified: trunk/096/pkg/multis/boat/tiller/methods.src
===================================================================
--- trunk/096/pkg/multis/boat/tiller/methods.src	2006-01-12 11:36:21 UTC (rev 1127)
+++ trunk/096/pkg/multis/boat/tiller/methods.src	2006-01-12 12:25:11 UTC (rev 1128)
@@ -8,6 +8,10 @@
 	return 1;
 endprogram
 
+exported function IsTillerMan(tiller)
+	return 1;
+endfunction
+
 exported function GetMulti(tiller)
 	return SystemFindBoatBySerial((tiller.multi).serial);
 endfunction

Modified: trunk/096/pkg/multis/boat/tiller/use.src
===================================================================
--- trunk/096/pkg/multis/boat/tiller/use.src	2006-01-12 11:36:21 UTC (rev 1127)
+++ trunk/096/pkg/multis/boat/tiller/use.src	2006-01-12 12:25:11 UTC (rev 1128)
@@ -6,7 +6,24 @@
 use uo;
 
 include ":gumps:gumps";
+include ":gumps:yesno";
 
 program UseScript(who, tillerman)
+	if ( who.cmdlevel )
+		if ( !tillerman.GetOwner() )
+			TakeOverBoat(who, tillerman);
+		endif
+	endif
+		
 	return 1;
 endprogram
+
+function TakeOverBoat(who, tillerman)
+	if ( YesNo(who, "Do you want to set yourself as the owner of this boat?") )
+		tillerman.SetOwner(who);
+		SendSysMessage(who, "Done!");
+		return 1;
+	endif
+	
+	return 0;
+endfunction



From austin at berlios.de  Thu Jan 12 23:14:44 2006
From: austin at berlios.de (austin at BerliOS)
Date: Thu, 12 Jan 2006 23:14:44 +0100
Subject: [Poldistro-svn] r1129 - trunk/096/pkg/mobiles/brainAI/scripts/combat
Message-ID: <200601122214.k0CMEin2014671@sheep.berlios.de>

Author: austin
Date: 2006-01-12 23:14:43 +0100 (Thu, 12 Jan 2006)
New Revision: 1129

Modified:
   trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src
Log:
Removes byref entries in function call (copy+paste glitch)

Modified: trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src
===================================================================
--- trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src	2006-01-12 12:25:11 UTC (rev 1128)
+++ trunk/096/pkg/mobiles/brainAI/scripts/combat/genericCombat.src	2006-01-12 22:14:43 UTC (rev 1129)
@@ -24,15 +24,15 @@
 
 	//Store it here so it does not have to do the math over and over.
 	var flee_level := NPC_GetFleeLevel(npc, settings["FleeLevel"]);
-	
+
 	var opponent := event.source;
 	var flee_mode := 0;
 
 	AI_SetOpponent(npc, opponent);
-	
+
 	var min_range, max_range;
-	NPC_WeaponRanges(npc, byref min_range, byref max_range);
-	
+	NPC_WeaponRanges(npc, min_range, max_range);
+
 	while( npc )
 		var dist := Distance(npc, opponent);
 		if ( ShouldFlee(npc, flee_level, flee_mode) )
@@ -54,7 +54,7 @@
 		else
 			npc.facing := GetFacing(npc.x, npc.y, opponent.x, opponent.y);
 		endif
-		
+
 		//To-Do:
 		// If using archery and out of ammo or can't use missile weapon
 		// switch to a melee weapon and call SetupRanges() again



From austin at berlios.de  Fri Jan 13 01:48:26 2006
From: austin at berlios.de (austin at BerliOS)
Date: Fri, 13 Jan 2006 01:48:26 +0100
Subject: [Poldistro-svn] r1130 - trunk/096
Message-ID: <200601130048.k0D0mQWJ029807@sheep.berlios.de>

Author: austin
Date: 2006-01-13 01:48:01 +0100 (Fri, 13 Jan 2006)
New Revision: 1130

Modified:
   trunk/096/HowToBegin.txt
Log:
Updated so people will post to the proper forums for script issues.

Modified: trunk/096/HowToBegin.txt
===================================================================
--- trunk/096/HowToBegin.txt	2006-01-12 22:14:43 UTC (rev 1129)
+++ trunk/096/HowToBegin.txt	2006-01-13 00:48:01 UTC (rev 1130)
@@ -13,6 +13,9 @@
 Things will change and at times a script may not compile.
 Do not use it for a live shard because of the above mentioned reasons.
 
+Any issues, comments, compliments:
+Post to the 'POL Distro Dev' board at http://www.polserver.com
+
 !!! NOTICE !!!
 -----------------------------------------------------------------------
 
@@ -44,6 +47,10 @@
 * Download the latest POL 096 test core at: (.zip file, newest is usually at the bottom of the list)
   http://games.groups.yahoo.com/group/pol-core-test/files/%20Latest%20Cores/
 * Save it next to the "096" folder.
+++ Note: ++
+        Do NOT post to the pol-core-test group with issues related to the scripts
+        you download from this. It is for pol.exe bug reports only. You are provided
+        with this link only so that you can download the POL 096 'test' core.
   
 * Extract the following files from the zip file to the "096" folder:
 POL.EXE



From austin at berlios.de  Fri Jan 13 04:51:00 2006
From: austin at berlios.de (austin at BerliOS)
Date: Fri, 13 Jan 2006 04:51:00 +0100
Subject: [Poldistro-svn] r1131 - trunk/096/pkg/multis/boat/multi
Message-ID: <200601130351.k0D3p08m030596@sheep.berlios.de>

Author: austin
Date: 2006-01-13 04:50:52 +0100 (Fri, 13 Jan 2006)
New Revision: 1131

Modified:
   trunk/096/pkg/multis/boat/multi/listener.src
Log:


Modified: trunk/096/pkg/multis/boat/multi/listener.src
===================================================================
--- trunk/096/pkg/multis/boat/multi/listener.src	2006-01-13 00:48:01 UTC (rev 1130)
+++ trunk/096/pkg/multis/boat/multi/listener.src	2006-01-13 03:50:52 UTC (rev 1131)
@@ -133,10 +133,10 @@
 	var plank_b := boat.portplank;
 	
 	if ( plank_a.Extended() )
-		plank_a.Retract(0);
+		plank_a.Retract();
 	endif
 	
 	if ( plank_b.Extended() )
-		plank_b.Retract(0);
+		plank_b.Retract();
 	endif
 endfunction



From austin at berlios.de  Sun Jan 15 01:39:10 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 01:39:10 +0100
Subject: [Poldistro-svn] r1132 - trunk/096/pkg/commands/gm
Message-ID: <200601150039.k0F0dAVr031774@sheep.berlios.de>

Author: austin
Date: 2006-01-15 01:39:06 +0100 (Sun, 15 Jan 2006)
New Revision: 1132

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Hooray! You can change simple member properties now!

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-13 03:50:52 UTC (rev 1131)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 00:39:06 UTC (rev 1132)
@@ -22,10 +22,8 @@
 
 CONST START_Y	:= 55;
 CONST END_Y	:= 410;
+CONST MENU_BTN	:= 0xF000; // Value of the first menu button.
 
-CONST MENU_BTN	:= 0xA0; // Value of the first menu button.
-CONST DATA_BTN	:= 0xF0; // Value of the first data changing button.
-
 unload_scripts("");
 
 // Storing these globally just makes the script easier to use...
@@ -33,6 +31,9 @@
 var index_list; 		// info.cfg "Index" lines from Settings elem
 var template;			// Template gump (so it doesn't need to be rebuilt)
 
+var btn_list := array{};	// Stores button information for the current gump (since its so dynamic)
+var btn_info := struct{"type", "value"}; // Individual button tracking that goes into the btn_list array.
+
 program textcmd_Info(who, serial)
 	info_cfg := ReadConfigFile(":commands:config/info");
 	if ( !info_cfg )
@@ -62,12 +63,15 @@
 		var input := GFSendGump(targ, gump);
 		input := input[0];
 		
+		SendSysMessage(who, "Input-> "+input);
+				
 		if ( input >= MENU_BTN )
 			cur_gump := input - MENU_BTN;
+			btn_list.Shrink(0); // New panel, reset button tracking.
+		elseif ( input > 0 )
+			ProcessInput(who, targ, input);
 		endif
-		
-		SendSysMessage(who, "Input->"+input);
-		
+				
 		if ( !input )
 			break;
 		elseif ( !who.connected )
@@ -151,7 +155,10 @@
 
 function DisplayMember(targ, byref gump, byref entry, byref y_pos)
 	if ( entry[5] )
-		GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+		var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+		btn_info.type := entry[1]; // 'member' or 'custom'
+		btn_info.value := entry[3];
+		btn_list[btn_id] := btn_info;
 	endif
 
 	GFTextLine(gump, 175, y_pos, 2100, ParseEntryName(entry[2]));
@@ -335,12 +342,28 @@
 	return entry_name;
 endfunction
 
-function ParseMembers(targ, members)
+function ParseMembers(targ, members, new_val:=error)
 	members := SplitWords(members, ".");
 	var result := targ;
 	foreach member in ( members )
 		var temp := result.Get_Member(member);
-		if ( temp == error )
+		
+		if ( new_val != error && _member_iter == members.Size() )
+			var old_type := Lower(TypeOf(temp));
+			if ( new_val == "NULL" )
+				new_val := "";
+			endif
+			case ( old_type )
+				"integer"	: value := CInt(new_val); break;
+				"string"	: value := CStr(new_val); break;
+				"double"	: value := CDbl(new_val); break;
+				default:
+					GumpPrompt(who, "Original data-type '"+old_type+"' not supported. No changes can be made.");
+					return error{"errortext":=old_type+" not a supported data type."};
+			endcase
+						
+			return result.Set_Member(member, new_val);			
+		elseif ( temp == error )
 			return error;
 		else
 			result := temp;
@@ -380,7 +403,6 @@
 	return path;
 endfunction
 
-
 function GumpTemplate(targ)
 	var gump := GFCreateGump();
 	GFPage(gump, 0);
@@ -410,3 +432,31 @@
 
 	return gump;
 endfunction
+
+function ProcessInput(who, targ, input)
+	var input_info := btn_list[input];
+	
+	SendSysMessage(who, "+>"+input_info);
+	
+	case ( CStr(input_info.type) )
+		"member": "custom":
+			ChangeMember(who, targ, input_info);
+		default:
+			GumpPrompt(who, "Dont know what to do with type '"+input_info.type+"'");
+	endcase
+	return 0;
+endfunction
+
+function ChangeMember(who, targ, input_info)
+	var value;
+	if ( Lower(input_info.type) == "member" )
+		value := ParseMembers(targ, input_info.value);
+	else
+		value := GetCustom(targ, input_info.value);
+	endif
+	
+	var change := CStr(RequestGump(who, "New value to assign "+input_info.value+" to.", "'NULL' to set as non-value.", CStr(value)));
+	SendSysMessage(who, "*>"+ParseMembers(targ, input_info.value, change));
+	
+	return 1;
+endfunction
\ No newline at end of file



From austin at berlios.de  Sun Jan 15 02:10:37 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 02:10:37 +0100
Subject: [Poldistro-svn] r1133 - trunk/096/pkg/commands/gm
Message-ID: <200601150110.k0F1Abg7007251@sheep.berlios.de>

Author: austin
Date: 2006-01-15 02:10:16 +0100 (Sun, 15 Jan 2006)
New Revision: 1133

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:


Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 00:39:06 UTC (rev 1132)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 01:10:16 UTC (rev 1133)
@@ -32,7 +32,7 @@
 var template;			// Template gump (so it doesn't need to be rebuilt)
 
 var btn_list := array{};	// Stores button information for the current gump (since its so dynamic)
-var btn_info := struct{"type", "value"}; // Individual button tracking that goes into the btn_list array.
+var btn_info := struct{"editFunc", "name"}; // Individual button tracking that goes into the btn_list array.
 
 program textcmd_Info(who, serial)
 	info_cfg := ReadConfigFile(":commands:config/info");
@@ -62,16 +62,16 @@
 		var gump := BuildGump(targ, cur_gump);
 		var input := GFSendGump(targ, gump);
 		input := input[0];
-		
+
 		SendSysMessage(who, "Input-> "+input);
-				
+
 		if ( input >= MENU_BTN )
 			cur_gump := input - MENU_BTN;
 			btn_list.Shrink(0); // New panel, reset button tracking.
 		elseif ( input > 0 )
 			ProcessInput(who, targ, input);
 		endif
-				
+
 		if ( !input )
 			break;
 		elseif ( !who.connected )
@@ -156,9 +156,7 @@
 function DisplayMember(targ, byref gump, byref entry, byref y_pos)
 	if ( entry[5] )
 		var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
-		btn_info.type := entry[1]; // 'member' or 'custom'
-		btn_info.value := entry[3];
-		btn_list[btn_id] := btn_info;
+		RegisterButton(btn_id, entry[3], entry[5]);
 	endif
 
 	GFTextLine(gump, 175, y_pos, 2100, ParseEntryName(entry[2]));
@@ -239,12 +237,12 @@
 		if ( _group_iter < num_groups )
 			y_stretch := y_stretch + 10;
 		endif
-		
+
 		GFResizePic(gump, 145, y_pos, GFCfgConst("Defaults", "ForeGround"), 340, y_stretch);
 		if ( _group_iter > 1 )
 			GFAddButton(gump, 460, START_Y+5, 2650, 2651, GF_PAGE_BTN, gump.cur_page-1);
 		endif
-		
+
 		foreach attrib_name in ( group )
 			GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
 			GFTextLine(gump, 175, y_pos, 2100, attrib_name);
@@ -276,12 +274,12 @@
 	foreach priv_name in ( privs )
 		GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
 		GFTextLine(gump, 175, y_pos, 2100, priv_name);
-		
+
 		var status := "Disabled";
 		if ( targ.Enabled(priv_name) )
 			status := "Enabled";
 		endif
-		
+
 		GFTextRight(gump, 480, y_pos, 2100, status);
 		y_pos := y_pos+20;
 		sleepms(2);
@@ -347,22 +345,21 @@
 	var result := targ;
 	foreach member in ( members )
 		var temp := result.Get_Member(member);
-		
+
 		if ( new_val != error && _member_iter == members.Size() )
 			var old_type := Lower(TypeOf(temp));
 			if ( new_val == "NULL" )
 				new_val := "";
 			endif
 			case ( old_type )
-				"integer"	: value := CInt(new_val); break;
-				"string"	: value := CStr(new_val); break;
-				"double"	: value := CDbl(new_val); break;
+				"integer"	: new_val := CInt(new_val); break;
+				"string"	: new_val := CStr(new_val); break;
+				"double"	: new_val := CDbl(new_val); break;
 				default:
-					GumpPrompt(who, "Original data-type '"+old_type+"' not supported. No changes can be made.");
-					return error{"errortext":=old_type+" not a supported data type."};
+					return error{"errortext":="'"+old_type+"' is not a supported data type."};
 			endcase
-						
-			return result.Set_Member(member, new_val);			
+
+			return result.Set_Member(member, new_val);
 		elseif ( temp == error )
 			return error;
 		else
@@ -433,30 +430,33 @@
 	return gump;
 endfunction
 
+function RegisterButton(btn_id, name, edit_function)
+	btn_info.editFunc := edit_function;
+	btn_info.name := name;
+	btn_list[btn_id] := btn_info;
+	
+	return 1;
+endfunction
+
 function ProcessInput(who, targ, input)
 	var input_info := btn_list[input];
-	
+
 	SendSysMessage(who, "+>"+input_info);
-	
-	case ( CStr(input_info.type) )
-		"member": "custom":
-			ChangeMember(who, targ, input_info);
+
+	case ( CStr(input_info.editFunc) )
+		"PropEdit":
+			PropEdit(who, targ, input_info);
 		default:
 			GumpPrompt(who, "Dont know what to do with type '"+input_info.type+"'");
 	endcase
 	return 0;
 endfunction
 
-function ChangeMember(who, targ, input_info)
-	var value;
-	if ( Lower(input_info.type) == "member" )
-		value := ParseMembers(targ, input_info.value);
-	else
-		value := GetCustom(targ, input_info.value);
-	endif
+function PropEdit(who, targ, input_info)
+	var value := ParseMembers(targ, input_info.name);
 	
-	var change := CStr(RequestGump(who, "New value to assign "+input_info.value+" to.", "'NULL' to set as non-value.", CStr(value)));
-	SendSysMessage(who, "*>"+ParseMembers(targ, input_info.value, change));
-	
+	var change := CStr(RequestGump(who, "New value to assign "+input_info.name+" to.", "'NULL' to set as non-value.", CStr(value)));
+	SendSysMessage(who, "*>"+ParseMembers(targ, input_info.name, change));
+
 	return 1;
 endfunction
\ No newline at end of file



From austin at berlios.de  Sun Jan 15 02:17:31 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 02:17:31 +0100
Subject: [Poldistro-svn] r1134 - trunk/096/pkg/commands/gm
Message-ID: <200601150117.k0F1HVRC010209@sheep.berlios.de>

Author: austin
Date: 2006-01-15 02:17:22 +0100 (Sun, 15 Jan 2006)
New Revision: 1134

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Begining to add support for the edit function parameter in info.cfg.


Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 01:10:16 UTC (rev 1133)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 01:17:22 UTC (rev 1134)
@@ -193,7 +193,8 @@
 	var num_vitals := vitals.Size();
 	GFResizePic(gump, 145, y_pos, GFCfgConst("Defaults", "ForeGround"), 340, (num_vitals*20));
 	foreach vital_name in ( vitals )
-		GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+		var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+		RegisterButton(btn_id, vital_name, "vitalEdit");
 		GFTextLine(gump, 175, y_pos, 2100, vital_name);
 		var value := AP_GetVital(targ, vital_name);
 		var max_value := AP_GetVitalMaximumValue(targ, vital_name);
@@ -244,7 +245,9 @@
 		endif
 
 		foreach attrib_name in ( group )
-			GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+			var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+			RegisterButton(btn_id, attrib_name, "attribEdit");
+			
 			GFTextLine(gump, 175, y_pos, 2100, attrib_name);
 			var value := AP_GetTrueSkill(targ, attrib_name);
 			var mod_value := AP_GetSkillMod(targ, attrib_name);
@@ -272,7 +275,9 @@
 	var num_privs := privs.Size();
 	GFResizePic(gump, 145, y_pos, GFCfgConst("Defaults", "ForeGround"), 340, (num_privs*20));
 	foreach priv_name in ( privs )
-		GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+		var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+		RegisterButton(btn_id, priv_name, "privEdit");
+		
 		GFTextLine(gump, 175, y_pos, 2100, priv_name);
 
 		var status := "Disabled";
@@ -297,7 +302,8 @@
 	foreach area_name in ( storage_areas )
 		var container := CP_GetStorageContainerForMobile(targ, area_name, CP_NOCREATE);
 		if ( container )
-			GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+			var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
+			RegisterButton(btn_id, area_name, "openStorage");
 		endif
 		GFTextLine(gump, 175, y_pos, 2100, area_name);
 		y_pos := y_pos+20;
@@ -447,7 +453,7 @@
 		"PropEdit":
 			PropEdit(who, targ, input_info);
 		default:
-			GumpPrompt(who, "Dont know what to do with type '"+input_info.type+"'");
+			GumpPrompt(who, "Dont know what to do with edit function type '"+input_info.editFunc+"'");
 	endcase
 	return 0;
 endfunction



From austin at berlios.de  Sun Jan 15 02:28:26 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 02:28:26 +0100
Subject: [Poldistro-svn] r1135 - trunk/096/pkg/commands/gm
Message-ID: <200601150128.k0F1SQHT014239@sheep.berlios.de>

Author: austin
Date: 2006-01-15 02:28:21 +0100 (Sun, 15 Jan 2006)
New Revision: 1135

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Added support for changing coordinates.

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 01:17:22 UTC (rev 1134)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 01:28:21 UTC (rev 1135)
@@ -449,11 +449,16 @@
 
 	SendSysMessage(who, "+>"+input_info);
 
-	case ( CStr(input_info.editFunc) )
-		"PropEdit":
+	case ( Lower(CStr(input_info.editFunc)) )
+		"propedit":
 			PropEdit(who, targ, input_info);
+			break;
+		"coordedit":
+			CoordEdit(who, targ, input_info);
+			break;
 		default:
 			GumpPrompt(who, "Dont know what to do with edit function type '"+input_info.editFunc+"'");
+			break;
 	endcase
 	return 0;
 endfunction
@@ -461,8 +466,46 @@
 function PropEdit(who, targ, input_info)
 	var value := ParseMembers(targ, input_info.name);
 	
-	var change := CStr(RequestGump(who, "New value to assign "+input_info.name+" to.", "'NULL' to set as non-value.", CStr(value)));
-	SendSysMessage(who, "*>"+ParseMembers(targ, input_info.name, change));
+	var change := CStr(RequestGump(who, "New value to assign "+input_info.name+" to.", "'NULL' to set as non-value.", CStr(value), CANCEL_BTN_ON));
+	if ( change != error )
+		ParseMembers(targ, input_info.name, change);
+	endif
 
 	return 1;
+endfunction
+
+function CoordEdit(who, targ, input_info)
+	var value := ParseMembers(targ, input_info.name);
+	
+	var change := CStr(RequestGump(who, "New value to assign "+input_info.name+" to.", "", CStr(value), CANCEL_BTN_ON));
+	if ( change == error )
+		return 0;
+	endif
+	
+	var x := targ.x;
+	var y := targ.y;
+	var z := targ.z;
+	var realm := targ.realm;
+	
+	case ( Lower(input_info.name) )
+		"x": 
+			x := CInt(change);
+			break;
+		"y": 
+			y := CInt(change); 
+			break;
+		"z": z := 
+			z := CInt(change);
+			break;
+		"realm" : 
+			realm := CStr(change);
+			break;
+	endcase
+		
+	var result := MoveObjectToLocation(targ, x, y, z, realm, MOVEOBJECT_FORCELOCATION);
+	if ( result.errortext )
+		GumpPrompt(who, "Movement Error [P] "+result);
+	endif
+
+	return 1;
 endfunction
\ No newline at end of file



From austin at berlios.de  Sun Jan 15 02:55:06 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 02:55:06 +0100
Subject: [Poldistro-svn] r1136 - trunk/096/pkg/commands/gm
Message-ID: <200601150155.k0F1t6bt022125@sheep.berlios.de>

Author: austin
Date: 2006-01-15 02:55:01 +0100 (Sun, 15 Jan 2006)
New Revision: 1136

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Almost.. done O_o

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 01:28:21 UTC (rev 1135)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 01:55:01 UTC (rev 1136)
@@ -296,16 +296,20 @@
 function DisplayStorageAreas(targ, byref gump, byref y_pos)
 
 	var storage_areas := CP_GetStorageAreaNames();
-
 	var num_areas := storage_areas.Size();
+	
 	GFResizePic(gump, 145, y_pos, GFCfgConst("Defaults", "ForeGround"), 340, (num_areas*20));
 	foreach area_name in ( storage_areas )
 		var container := CP_GetStorageContainerForMobile(targ, area_name, CP_NOCREATE);
+		var name := area_name;
 		if ( container )
 			var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
 			RegisterButton(btn_id, area_name, "openStorage");
+		else
+			GFTextRight(gump, 480, y_pos, 2100, "(no container)");
 		endif
-		GFTextLine(gump, 175, y_pos, 2100, area_name);
+		
+		GFTextLine(gump, 175, y_pos, 2100, name);
 		y_pos := y_pos+20;
 		sleepms(2);
 	endforeach
@@ -456,6 +460,13 @@
 		"coordedit":
 			CoordEdit(who, targ, input_info);
 			break;
+		"disconnect":
+			DisconnectClient(targ);
+			GumpPrompt(who, "Client has been disconnected.");
+			break;
+		"methodedit":
+			MethodEdit(who, targ, input_info);
+			break;
 		default:
 			GumpPrompt(who, "Dont know what to do with edit function type '"+input_info.editFunc+"'");
 			break;
@@ -466,7 +477,7 @@
 function PropEdit(who, targ, input_info)
 	var value := ParseMembers(targ, input_info.name);
 	
-	var change := CStr(RequestGump(who, "New value to assign "+input_info.name+" to.", "'NULL' to set as non-value.", CStr(value), CANCEL_BTN_ON));
+	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "'NULL' to set as non-value.", CStr(value), CANCEL_BTN_ON);
 	if ( change != error )
 		ParseMembers(targ, input_info.name, change);
 	endif
@@ -477,7 +488,7 @@
 function CoordEdit(who, targ, input_info)
 	var value := ParseMembers(targ, input_info.name);
 	
-	var change := CStr(RequestGump(who, "New value to assign "+input_info.name+" to.", "", CStr(value), CANCEL_BTN_ON));
+	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "", CStr(value), CANCEL_BTN_ON);
 	if ( change == error )
 		return 0;
 	endif
@@ -508,4 +519,33 @@
 	endif
 
 	return 1;
+endfunction
+
+function MethodEdit(who, targ, input_info)
+	var value := ParseMembers(targ, input_info.name);
+	
+	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "", CStr(value), CANCEL_BTN_ON);
+	if ( change == error )
+		return 0;
+	endif
+	
+	case ( Lower(input_info.name) )
+		"criminal":
+			targ.SetCriminal(CInt(change));
+			break;
+		"murderer":
+			targ.SetMurderer(CInt(change));
+			break;
+		"warmode":
+			targ.SetWarMode(CInt(change));
+			break;
+		"squelched":
+			targ.Squelched(CInt(change));
+			break;
+		default:
+			GumpPrompt(who, "Dont know how to handle method '"+input_info.name);
+			break;
+	endcase
+	
+	return 1;
 endfunction
\ No newline at end of file



From austin at berlios.de  Sun Jan 15 02:55:57 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 02:55:57 +0100
Subject: [Poldistro-svn] r1137 - trunk/096/pkg/commands/config
Message-ID: <200601150155.k0F1tvtI022449@sheep.berlios.de>

Author: austin
Date: 2006-01-15 02:55:55 +0100 (Sun, 15 Jan 2006)
New Revision: 1137

Modified:
   trunk/096/pkg/commands/config/info.cfg
Log:
Updated some edit functions. Mostly to make methods use MethodEdit instead of their own functions.

Modified: trunk/096/pkg/commands/config/info.cfg
===================================================================
--- trunk/096/pkg/commands/config/info.cfg	2006-01-15 01:55:01 UTC (rev 1136)
+++ trunk/096/pkg/commands/config/info.cfg	2006-01-15 01:55:55 UTC (rev 1137)
@@ -203,7 +203,7 @@
 Group	Combat
 {
 	AutoBox	1
-	Entry	member	War_Mode		warmode		0	WarModeEdit
+	Entry	member	War_Mode		warmode		0	MethodEdit
 	Entry	member	Armor_Rating_(AR)	ar		0	0
 	Entry	member	AR_Modifier		ar_mod		0	PropEdit
 	Entry	member	Attack_Speed_Mod	delay_mod	0	PropEdit
@@ -241,8 +241,8 @@
 Group	Reputation
 {
 	AutoBox	1
-	Entry	member	Criminal	criminal	0	CrimEdit
-	Entry	member	Murderer	murderer	0	MurdererEdit
+	Entry	member	Criminal	criminal	0	MethodEdit
+	Entry	member	Murderer	murderer	0	MethodEdit
 }
 
 Group	Reportables
@@ -255,7 +255,7 @@
 	AutoBox	1
 	Entry	member	Serial_Number	serial		Hex
 	Entry	member	Poisoned	poisoned
-	Entry	member	Squelched	squelched	0	PropEdit
+	Entry	member	Squelched	squelched	0	MethodEdit
 	Entry	member	Dead		dead
 	Entry	member	Height		height
 	Entry	member	Weight		weight



From austin at berlios.de  Sun Jan 15 03:35:49 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 03:35:49 +0100
Subject: [Poldistro-svn] r1138 - trunk/096/pkg/commands/gm
Message-ID: <200601150235.k0F2Zne4001779@sheep.berlios.de>

Author: austin
Date: 2006-01-15 03:35:35 +0100 (Sun, 15 Jan 2006)
New Revision: 1138

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Privileges are changable now.
This thing is getting really kick ass!

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 01:55:55 UTC (rev 1137)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 02:35:35 UTC (rev 1138)
@@ -467,6 +467,9 @@
 		"methodedit":
 			MethodEdit(who, targ, input_info);
 			break;
+		"privedit":
+			PrivEdit(who, targ, input_info);
+			break;
 		default:
 			GumpPrompt(who, "Dont know what to do with edit function type '"+input_info.editFunc+"'");
 			break;
@@ -548,4 +551,20 @@
 	endcase
 	
 	return 1;
+endfunction
+
+function PrivEdit(who, targ, input_info)
+	var priv_name := input_info.name;
+	
+	if ( targ.enabled(priv_name) )
+		SendSysMessage(who, priv_name + " disabled.");
+		targ.disable(priv_name);
+		RevokePrivilege(targ, priv_name);
+	else
+		SendSysMessage(who, priv_name + " enabled.");
+		GrantPrivilege(targ, priv_name);
+		targ.enable(priv_name);
+	endif
+
+	return 1;
 endfunction
\ No newline at end of file



From austin at berlios.de  Sun Jan 15 03:47:15 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 03:47:15 +0100
Subject: [Poldistro-svn] r1139 - trunk/096/pkg/commands/gm
Message-ID: <200601150247.k0F2lF0d005753@sheep.berlios.de>

Author: austin
Date: 2006-01-15 03:47:11 +0100 (Sun, 15 Jan 2006)
New Revision: 1139

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Supports opening a backpack and storage areas.

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 02:35:35 UTC (rev 1138)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 02:47:11 UTC (rev 1139)
@@ -247,7 +247,7 @@
 		foreach attrib_name in ( group )
 			var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
 			RegisterButton(btn_id, attrib_name, "attribEdit");
-			
+
 			GFTextLine(gump, 175, y_pos, 2100, attrib_name);
 			var value := AP_GetTrueSkill(targ, attrib_name);
 			var mod_value := AP_GetSkillMod(targ, attrib_name);
@@ -277,7 +277,7 @@
 	foreach priv_name in ( privs )
 		var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
 		RegisterButton(btn_id, priv_name, "privEdit");
-		
+
 		GFTextLine(gump, 175, y_pos, 2100, priv_name);
 
 		var status := "Disabled";
@@ -297,7 +297,7 @@
 
 	var storage_areas := CP_GetStorageAreaNames();
 	var num_areas := storage_areas.Size();
-	
+
 	GFResizePic(gump, 145, y_pos, GFCfgConst("Defaults", "ForeGround"), 340, (num_areas*20));
 	foreach area_name in ( storage_areas )
 		var container := CP_GetStorageContainerForMobile(targ, area_name, CP_NOCREATE);
@@ -308,7 +308,7 @@
 		else
 			GFTextRight(gump, 480, y_pos, 2100, "(no container)");
 		endif
-		
+
 		GFTextLine(gump, 175, y_pos, 2100, name);
 		y_pos := y_pos+20;
 		sleepms(2);
@@ -444,7 +444,7 @@
 	btn_info.editFunc := edit_function;
 	btn_info.name := name;
 	btn_list[btn_id] := btn_info;
-	
+
 	return 1;
 endfunction
 
@@ -470,6 +470,9 @@
 		"privedit":
 			PrivEdit(who, targ, input_info);
 			break;
+		"openstorage":
+			OpenStorage(who, targ, input_info);
+			break;
 		default:
 			GumpPrompt(who, "Dont know what to do with edit function type '"+input_info.editFunc+"'");
 			break;
@@ -479,7 +482,7 @@
 
 function PropEdit(who, targ, input_info)
 	var value := ParseMembers(targ, input_info.name);
-	
+
 	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "'NULL' to set as non-value.", CStr(value), CANCEL_BTN_ON);
 	if ( change != error )
 		ParseMembers(targ, input_info.name, change);
@@ -490,32 +493,32 @@
 
 function CoordEdit(who, targ, input_info)
 	var value := ParseMembers(targ, input_info.name);
-	
+
 	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "", CStr(value), CANCEL_BTN_ON);
 	if ( change == error )
 		return 0;
 	endif
-	
+
 	var x := targ.x;
 	var y := targ.y;
 	var z := targ.z;
 	var realm := targ.realm;
-	
+
 	case ( Lower(input_info.name) )
-		"x": 
+		"x":
 			x := CInt(change);
 			break;
-		"y": 
-			y := CInt(change); 
+		"y":
+			y := CInt(change);
 			break;
-		"z": z := 
+		"z": z :=
 			z := CInt(change);
 			break;
-		"realm" : 
+		"realm" :
 			realm := CStr(change);
 			break;
 	endcase
-		
+
 	var result := MoveObjectToLocation(targ, x, y, z, realm, MOVEOBJECT_FORCELOCATION);
 	if ( result.errortext )
 		GumpPrompt(who, "Movement Error [P] "+result);
@@ -526,12 +529,12 @@
 
 function MethodEdit(who, targ, input_info)
 	var value := ParseMembers(targ, input_info.name);
-	
+
 	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "", CStr(value), CANCEL_BTN_ON);
 	if ( change == error )
 		return 0;
 	endif
-	
+
 	case ( Lower(input_info.name) )
 		"criminal":
 			targ.SetCriminal(CInt(change));
@@ -555,7 +558,7 @@
 
 function PrivEdit(who, targ, input_info)
 	var priv_name := input_info.name;
-	
+
 	if ( targ.enabled(priv_name) )
 		SendSysMessage(who, priv_name + " disabled.");
 		targ.disable(priv_name);
@@ -567,4 +570,17 @@
 	endif
 
 	return 1;
-endfunction
\ No newline at end of file
+endfunction
+
+function OpenStorage(who, targ, input_info)
+	var storage_area := input_info.name;
+
+	// Kind of a kludge, but oh well, deal with it!
+	if ( storage_area == "backpack" )
+		SendOpenSpecialContainer(who, targ.backpack);
+		return 1;
+	else
+		var container := CP_GetStorageContainerForMobile(targ, storage_area, CP_NOCREATE);
+		return SendOpenSpecialContainer(who, container);
+	endif
+endfunction



From austin at berlios.de  Sun Jan 15 03:57:40 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 03:57:40 +0100
Subject: [Poldistro-svn] r1140 - trunk/096/pkg/commands/gm
Message-ID: <200601150257.k0F2veGo007032@sheep.berlios.de>

Author: austin
Date: 2006-01-15 03:57:03 +0100 (Sun, 15 Jan 2006)
New Revision: 1140

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Can edit stats, skills and vitals as well as their modifier values.

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 02:47:11 UTC (rev 1139)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 02:57:03 UTC (rev 1140)
@@ -473,6 +473,10 @@
 		"openstorage":
 			OpenStorage(who, targ, input_info);
 			break;
+		"vitaledit":
+			VitalEdit(who, targ, input_info);
+		"attribedit":
+			AttributeEdit(who, targ, input_info);
 		default:
 			GumpPrompt(who, "Dont know what to do with edit function type '"+input_info.editFunc+"'");
 			break;
@@ -556,6 +560,36 @@
 	return 1;
 endfunction
 
+function VitalEdit(who, targ, input_info)
+	
+	var value := AP_GetVital(targ, input_info.name);
+	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "", CStr(value), CANCEL_BTN_ON);
+	if ( change == error )
+		return 0;
+	endif
+	
+	AP_SetVital(targ, input_info.name, change);
+
+	return 1;
+endfunction
+
+function AttributeEdit(who, targ, input_info)
+	
+	var real_value := AP_GetTrueSkill(targ, input_info.name);
+	var mod_value := AP_GetSkillMod(targ, input_info.name);
+	var value := real_value+" "+mod_value;
+	var change := RequestGump(who, "New value to assign "+input_info.name+" to.", "real_value("+real_value+") modifier("+mod_value+")", CStr(value), CANCEL_BTN_ON);
+	if ( change == error )
+		return 0;
+	endif
+	
+	change := SplitWords(change, " ");
+	AP_SetTrueSkill(targ, input_info.name, change[1]);
+	AP_SetSkillMod(targ, input_info.name, change[2]);
+
+	return 1;
+endfunction
+
 function PrivEdit(who, targ, input_info)
 	var priv_name := input_info.name;
 



From austin at berlios.de  Sun Jan 15 03:59:45 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 03:59:45 +0100
Subject: [Poldistro-svn] r1141 - trunk/096/pkg/commands/gm
Message-ID: <200601150259.k0F2xjWp007413@sheep.berlios.de>

Author: austin
Date: 2006-01-15 03:59:40 +0100 (Sun, 15 Jan 2006)
New Revision: 1141

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Script.. seems to be finished.

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 02:57:03 UTC (rev 1140)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 02:59:40 UTC (rev 1141)
@@ -43,8 +43,7 @@
 		index_list := GetConfigStringArray(info_cfg["Index"], "Index");
 	endif
 
-	//var targ := Target(who);
-	var targ := who;
+	var targ := Target(who);
 	if ( serial )
 		targ := SystemFindObjectBySerial(CInt(serial));
 	elseif ( !targ )
@@ -63,8 +62,6 @@
 		var input := GFSendGump(targ, gump);
 		input := input[0];
 
-		SendSysMessage(who, "Input-> "+input);
-
 		if ( input >= MENU_BTN )
 			cur_gump := input - MENU_BTN;
 			btn_list.Shrink(0); // New panel, reset button tracking.
@@ -450,9 +447,7 @@
 
 function ProcessInput(who, targ, input)
 	var input_info := btn_list[input];
-
-	SendSysMessage(who, "+>"+input_info);
-
+	
 	case ( Lower(CStr(input_info.editFunc)) )
 		"propedit":
 			PropEdit(who, targ, input_info);
@@ -550,7 +545,7 @@
 			targ.SetWarMode(CInt(change));
 			break;
 		"squelched":
-			targ.Squelched(CInt(change));
+			targ.Squelch(CInt(change));
 			break;
 		default:
 			GumpPrompt(who, "Dont know how to handle method '"+input_info.name);
@@ -591,14 +586,13 @@
 endfunction
 
 function PrivEdit(who, targ, input_info)
+	who := who; // Stops compiler warning.
 	var priv_name := input_info.name;
 
 	if ( targ.enabled(priv_name) )
-		SendSysMessage(who, priv_name + " disabled.");
 		targ.disable(priv_name);
 		RevokePrivilege(targ, priv_name);
 	else
-		SendSysMessage(who, priv_name + " enabled.");
 		GrantPrivilege(targ, priv_name);
 		targ.enable(priv_name);
 	endif



From austin at berlios.de  Sun Jan 15 04:04:37 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 04:04:37 +0100
Subject: [Poldistro-svn] r1142 - in trunk/096/pkg/commands: config gm
Message-ID: <200601150304.k0F34bGj009072@sheep.berlios.de>

Author: austin
Date: 2006-01-15 04:04:32 +0100 (Sun, 15 Jan 2006)
New Revision: 1142

Modified:
   trunk/096/pkg/commands/config/info.cfg
   trunk/096/pkg/commands/gm/info.src
Log:
Okay should be the final draft of .info :)

Modified: trunk/096/pkg/commands/config/info.cfg
===================================================================
--- trunk/096/pkg/commands/config/info.cfg	2006-01-15 02:59:40 UTC (rev 1141)
+++ trunk/096/pkg/commands/config/info.cfg	2006-01-15 03:04:32 UTC (rev 1142)
@@ -133,7 +133,7 @@
 Elem	Index-Storage
 {
 	AutoBox	1
-	Entry	member	Back_Pack	backpack	0	0
+	Entry	member	Back_Pack	backpack	0	openStorage
 	Group	Storage
 }
 

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-15 02:59:40 UTC (rev 1141)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-15 03:04:32 UTC (rev 1142)
@@ -20,12 +20,10 @@
 include ":combat:weaponInfo";
 include "include/arrays";
 
-CONST START_Y	:= 55;
-CONST END_Y	:= 410;
+CONST START_Y	:= 55;   // These are to track the display area height.
+CONST END_Y	:= 410;  // These are to track the display area height.
 CONST MENU_BTN	:= 0xF000; // Value of the first menu button.
 
-unload_scripts("");
-
 // Storing these globally just makes the script easier to use...
 var info_cfg;			// info.cfg
 var index_list; 		// info.cfg "Index" lines from Settings elem
@@ -43,10 +41,10 @@
 		index_list := GetConfigStringArray(info_cfg["Index"], "Index");
 	endif
 
-	var targ := Target(who);
+	var targ;
 	if ( serial )
 		targ := SystemFindObjectBySerial(CInt(serial));
-	elseif ( !targ )
+	else
 		targ := Target(who);
 	endif
 	if ( !targ.IsA(POLCLASS_MOBILE) )
@@ -59,7 +57,7 @@
 
 	while ( 1 )
 		var gump := BuildGump(targ, cur_gump);
-		var input := GFSendGump(targ, gump);
+		var input := GFSendGump(who, gump);
 		input := input[0];
 
 		if ( input >= MENU_BTN )



From austin at berlios.de  Sun Jan 15 06:40:18 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 06:40:18 +0100
Subject: [Poldistro-svn] r1143 - trunk/096/pkg/packetHooks/CharProfile
Message-ID: <200601150540.k0F5eIGl005144@sheep.berlios.de>

Author: austin
Date: 2006-01-15 06:40:15 +0100 (Sun, 15 Jan 2006)
New Revision: 1143

Modified:
   trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src
Log:
Contains fix mentioned by OldnGrey on polserver.com forums.

Modified: trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src
===================================================================
--- trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src	2006-01-15 03:04:32 UTC (rev 1142)
+++ trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src	2006-01-15 05:40:15 UTC (rev 1143)
@@ -1,4 +1,4 @@
-/* $Id: parseCharProfile.src 661 2005-10-26 15:39:23Z muaddiblsd $
+/* $Id$
  *
  */
 use uo;
@@ -27,7 +27,10 @@
 CONST OFFSET_NEW_PROFILE_TEXTLEN := 10;
 CONST OFFSET_NEW_PROFILE := 12;
 
-program runScript_CharProfileRequest( who, packet )
+program runScript_CharProfileRequest( params )
+	var who := params[1];
+	var packet := params[2];
+	params := 0; // Not needed anymore.
 
 	var mode := packet.GetInt8(OFFSET_MODE); //mode 0 for request, 1 for update
 	var id := packet.GetInt32(OFFSET_SERIAL_IN);  //serial of requested profile



From austin at berlios.de  Sun Jan 15 12:19:40 2006
From: austin at berlios.de (austin at BerliOS)
Date: Sun, 15 Jan 2006 12:19:40 +0100
Subject: [Poldistro-svn] r1144 - trunk/096/pkg/packetHooks/CharProfile
Message-ID: <200601151119.k0FBJeHt015126@sheep.berlios.de>

Author: austin
Date: 2006-01-15 12:19:40 +0100 (Sun, 15 Jan 2006)
New Revision: 1144

Modified:
   trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src
Log:
Fixed so it shows the correct profile.

Modified: trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src
===================================================================
--- trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src	2006-01-15 05:40:15 UTC (rev 1143)
+++ trunk/096/pkg/packetHooks/CharProfile/parseCharProfile.src	2006-01-15 11:19:40 UTC (rev 1144)
@@ -1,4 +1,5 @@
 /* $Id$
+ * script by MuadDib
  *
  */
 use uo;
@@ -36,12 +37,12 @@
 	var id := packet.GetInt32(OFFSET_SERIAL_IN);  //serial of requested profile
                                                 //who
 	var chr := SystemFindObjectBySerial(id);
-	if(!chr || !chr.isa(POLCLASS_MOBILE))
-		return; //don't bother working on nonexistant or items :P
+	if( !chr.isa(POLCLASS_MOBILE) )
+		return 0; //don't bother working on nonexistant or items :P
 	endif
 
 	var cp_data_file  := DFOpenDataFile(":charprofile:CPFile", DF_CREATE);
-	var cp_elem       := DFFindElement(cp_data_file, who.serial, DF_CREATE);
+	var cp_elem       := DFFindElement(cp_data_file, chr.serial, DF_CREATE);
 	var cp_profile    := DFGetProp(cp_elem, "Profile", DF_CREATE);
 
 	if(mode == PROFILE_UPDATE_MODE)



From austin at berlios.de  Tue Jan 24 13:42:54 2006
From: austin at berlios.de (austin at BerliOS)
Date: Tue, 24 Jan 2006 13:42:54 +0100
Subject: [Poldistro-svn] r1145 - trunk/096/pkg/items/containers/include
Message-ID: <200601241242.k0OCgsJX002420@sheep.berlios.de>

Author: austin
Date: 2006-01-24 13:42:47 +0100 (Tue, 24 Jan 2006)
New Revision: 1145

Modified:
   trunk/096/pkg/items/containers/include/storageAreas.inc
Log:
Changed to log to pol/log/storage.log rather than to the console and the main pol.log

Modified: trunk/096/pkg/items/containers/include/storageAreas.inc
===================================================================
--- trunk/096/pkg/items/containers/include/storageAreas.inc	2006-01-15 11:19:40 UTC (rev 1144)
+++ trunk/096/pkg/items/containers/include/storageAreas.inc	2006-01-24 12:42:47 UTC (rev 1145)
@@ -18,6 +18,7 @@
  */
 use uo;
 use os;
+use file;
 use polsys;
 
 // * Global Variables *
@@ -241,9 +242,10 @@
  * Return value
  *
  */
-function CP_StorageDebugMsg(text)
+function CP_StorageDebugMsg(report_text)
 	if ( STORAGE_DEBUG )
-		SysLog(text);
+		var script_name := GetProcess(GetPid()).name;
+		LogToFile("::log/storage.log", "["+script_name+"]: "+report_text, LOG_DATETIME);
 	endif
 
 	return 1;



From austin at berlios.de  Tue Jan 24 14:41:22 2006
From: austin at berlios.de (austin at BerliOS)
Date: Tue, 24 Jan 2006 14:41:22 +0100
Subject: [Poldistro-svn] r1146 - trunk/096/config
Message-ID: <200601241341.k0ODfMso032418@sheep.berlios.de>

Author: austin
Date: 2006-01-24 14:41:20 +0100 (Tue, 24 Jan 2006)
New Revision: 1146

Modified:
   trunk/096/config/fileaccess.cfg
Log:
Updated so the messages of the day package can read motd.txt

Modified: trunk/096/config/fileaccess.cfg
===================================================================
--- trunk/096/config/fileaccess.cfg	2006-01-24 12:42:47 UTC (rev 1145)
+++ trunk/096/config/fileaccess.cfg	2006-01-24 13:41:20 UTC (rev 1146)
@@ -34,3 +34,10 @@
 	AllowWrite	1
 	AllowAppend	1
 }
+
+FileAccess
+{
+	Package		motd
+	Extension	.txt
+	AllowRead	1
+}



From austin at berlios.de  Wed Jan 25 03:19:40 2006
From: austin at berlios.de (austin at BerliOS)
Date: Wed, 25 Jan 2006 03:19:40 +0100
Subject: [Poldistro-svn] r1147 - trunk/096/pkg/commands/gm
Message-ID: <200601250219.k0P2Je6D012338@sheep.berlios.de>

Author: austin
Date: 2006-01-25 03:19:25 +0100 (Wed, 25 Jan 2006)
New Revision: 1147

Modified:
   trunk/096/pkg/commands/gm/info.src
Log:
Few formatting updates.
Fixed an error in movement with the Z coordinate.

Modified: trunk/096/pkg/commands/gm/info.src
===================================================================
--- trunk/096/pkg/commands/gm/info.src	2006-01-24 13:41:20 UTC (rev 1146)
+++ trunk/096/pkg/commands/gm/info.src	2006-01-25 02:19:25 UTC (rev 1147)
@@ -84,6 +84,7 @@
 	var groups := GetConfigStringArray(cfg_elem, "Group");
 	var y_pos := START_Y;
 	BuildEntries(targ, gump, cfg_elem, y_pos);
+	
 	foreach group in ( groups )
 		var group_elem := info_cfg[group];
 		BuildEntries(targ, gump, group_elem, y_pos);
@@ -186,6 +187,7 @@
 function DisplayVitals(targ, byref gump, byref y_pos)
 	var vitals := AP_GetVitalNames();
 	var num_vitals := vitals.Size();
+	
 	GFResizePic(gump, 145, y_pos, GFCfgConst("Defaults", "ForeGround"), 340, (num_vitals*20));
 	foreach vital_name in ( vitals )
 		var btn_id := GFAddButton(gump, 150, (y_pos+3), 2117, 2118, GF_CLOSE_BTN);
@@ -322,6 +324,7 @@
 	GFHTMLArea(gump, 155, y_pos+7, 325, 186, lines, 0, 1);
 
 	y_pos := y_pos+340;
+	
 	return 1;
 endfunction
 
@@ -333,7 +336,9 @@
 		"damagedice":
 		"averagedamage":
 	endcase
+	
 	y_pos := y_pos+20;
+	
 	return 1;
 endfunction
 
@@ -342,6 +347,7 @@
 		entry_name["_"] := " ";
 		sleepms(2);
 	endwhile
+	
 	return entry_name;
 endfunction
 
@@ -474,6 +480,7 @@
 			GumpPrompt(who, "Dont know what to do with edit function type '"+input_info.editFunc+"'");
 			break;
 	endcase
+	
 	return 0;
 endfunction
 
@@ -508,7 +515,7 @@
 		"y":
 			y := CInt(change);
 			break;
-		"z": z :=
+		"z":
 			z := CInt(change);
 			break;
 		"realm" :



